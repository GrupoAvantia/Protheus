#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\MATR140.CH"
#line 2 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr140.prx"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Dialog.ch"
#line 28 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Font.ch"
#line 29 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PTMenu.ch"
#line 31 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Print.ch"
#line 33 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Colors.ch"
#line 35 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Folder.ch"
#line 37 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\msobject.ch"
#line 38 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\VKey.ch"
#line 42 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\WinApi.ch"
#line 44 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCommand.ch"
#line 47 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCSS.CH"
#line 50 "PROTHEUS.CH"
#line 18 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr140.prx"
Function Matr140( cAlias, nReg )

Local oReport

PRIVATE lAuto     := (nReg<>Nil)







IF !(FindFunction("SIGACUS_V") .and.  SIGACUS_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar sigacus.prw !!!", "Atualizar SIGACUS.PRW !!!" ))
Endif
IF !(FindFunction("SIGACUSA_V") .and.  SIGACUSA_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar sigacusa.prx !!!", "Atualizar SIGACUSA.PRX !!!" ))
Endif
IF !(FindFunction("SIGACUSB_V") .and.  SIGACUSB_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar sigacusb.prx !!!", "Atualizar SIGACUSB.PRX !!!" ))
Endif

If FindFunction("TRepInUse") .And.  TRepInUse()



	oReport:= ReportDef(nReg)
	oReport:PrintDialog()
Else
	MATR140R3( cAlias, nReg )
EndIf

Return
















Static Function ReportDef(nReg)

Local oReport
Local oSection1
Local oCell
Local oBreak
Local cTitle := If( cPaisLoc $ "ANG|PTG", "Solicitação De Compra", "Solicitacao de Compra" )


	Local cAliasSC1 := Iif(lAuto,"SC1",GetNextAlias())




















Pergunte("MTR140", .F. )











oReport := TReport():New("MTR140",cTitle,If(lAuto,Nil,"MTR140"), {|oReport| ReportPrint(oReport,cAliasSC1,nReg)},If( cPaisLoc $ "ANG|PTG", "Emissão das solicitações de compras registadas", "Emissao das solicitacoes de compras cadastradas" ))
oReport:SetLandscape()


































oSection1:= TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Solicitação De Compras", "Solicitação de Compras" ),{"SC1","SB1","SB2"},)
oSection1:SetHeaderPage()


TRCell():New(oSection1,"C1_ITEM"   ,"SC1",,,,,)
TRCell():New(oSection1,"C1_PRODUTO","SC1",,,TamSX3("C1_PRODUTO")[1]+10,,)
TRCell():New(oSection1,"DESCPROD"  ,"   ",If( cPaisLoc $ "ANG|PTG", "Descrição", "Descricao" ),,30,, {|| cDescPro })
TRCell():New(oSection1,"B2_QATU"   ,"SB2",    ,PesqPict("SB2","B2_QATU" ,12),,,)
TRCell():New(oSection1,"B1EMIN"    ,"   ","Ponto Pedido"       ,PesqPict("SB1","B1_EMIN" ,12),,,{|| RetFldProd(SB1->B1_COD,"B1_EMIN") })
TRCell():New(oSection1,"SALDOSC1"  ,"   ",If( cPaisLoc $ "ANG|PTG", "Saldo Da Sc", "Saldo da SC" )       ,PesqPict("SC1","C1_QUANT",12),,,{|| (cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE })
TRCell():New(oSection1,"C1_UM"     ,"SC1",    ,PesqPict("SC1","C1_UM"),,,)
TRCell():New(oSection1,"C1_LOCAL"  ,"SC1",    ,PesqPict("SC1","C1_LOCAL"),,,)
TRCell():New(oSection1,"B1_QE"     ,"SB1",    ,PesqPict("SB1","B1_QE",09),,,)
TRCell():New(oSection1,"B1_UPRC"   ,"SB1",    ,PesqPict("SB1","B1_UPRC",12),,,)
TRCell():New(oSection1,"LEADTIME"  ,"   ",If( cPaisLoc $ "ANG|PTG", "Tempo Total", "Lead Time" ),,,,{|| CalcPrazo((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_QUANT)})
TRCell():New(oSection1,"DTNECESS"  ,"   ","Data Necessidade",,,,{|| If(Empty((cAliasSC1)->C1_DATPRF),(cAliasSC1)->C1_EMISSAO,(cAliasSC1)->C1_DATPRF) })
TRCell():New(oSection1,"DTFORCOMP" ,"   ",If( cPaisLoc $ "ANG|PTG", "Data Para Comprar", "Data para Comprar" ),,,,{||SomaPrazo(If(Empty((cAliasSC1)->C1_DATPRF),(cAliasSC1)->C1_EMISSAO,(cAliasSC1)->C1_DATPRF), -CalcPrazo((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_QUANT)) })
oSection1:Cell("DESCPROD"):SetLineBreak()

oSection2:= TRSection():New(oSection1,If( cPaisLoc $ "ANG|PTG", "Alocações", "Empenhos" ),{"SD4","SC2"},)

TRCell():New(oSection2,"D4_OP"     ,"SD4",If( cPaisLoc $ "ANG|PTG", "Ordem De Producao", "Ordem de Producao" ),,,,)
TRCell():New(oSection2,"C2_PRODUTO","SC2",If( cPaisLoc $ "ANG|PTG", "Artigo A Ser Produzido", "Produto a Ser Produzido" ),,,,)
TRCell():New(oSection2,"D4_DATA"   ,"SD4",If( cPaisLoc $ "ANG|PTG", "Início Previsto", "Inicio Previsto" ),,,,)
TRCell():New(oSection2,"D4_QUANT"  ,"SD4",If( cPaisLoc $ "ANG|PTG", "Quantidade Necessária", "Quantidade Necessaria" ),PesqPict("SD4","D4_QUANT",12),,,)

oSection3:= TRSection():New(oSection2,If( cPaisLoc $ "ANG|PTG", "Procuras", "Demandas" ),{"SB3"},)

TRCell():New(oSection3,"MES01"		,"   ",,PesqPict("SB3","B3_Q01",11)	,11			,,)
TRCell():New(oSection3,"MES02"		,"   ",,PesqPict("SB3","B3_Q02",11)	,11			,,)
TRCell():New(oSection3,"MES03"		,"   ",,PesqPict("SB3","B3_Q03",11)	,11			,,)
TRCell():New(oSection3,"MES04"		,"   ",,PesqPict("SB3","B3_Q04",11)	,11			,,)
TRCell():New(oSection3,"MES05"		,"   ",,PesqPict("SB3","B3_Q05",11)	,11			,,)
TRCell():New(oSection3,"MES06"		,"   ",,PesqPict("SB3","B3_Q06",11)	,11			,,)
TRCell():New(oSection3,"MES07"		,"   ",,PesqPict("SB3","B3_Q07",11)	,11			,,)
TRCell():New(oSection3,"MES08"		,"   ",,PesqPict("SB3","B3_Q08",11)	,11			,,)
TRCell():New(oSection3,"MES09"		,"   ",,PesqPict("SB3","B3_Q09",11)	,11			,,)
TRCell():New(oSection3,"MES10"		,"   ",,PesqPict("SB3","B3_Q10",11)	,11			,,)
TRCell():New(oSection3,"MES11"		,"   ",,PesqPict("SB3","B3_Q11",11)	,11			,,)
TRCell():New(oSection3,"MES12"		,"   ",,PesqPict("SB3","B3_Q12",11)	,11			,,)
TRCell():New(oSection3,"B3_MEDIA"	,"SB3", ,PesqPict("SB3","B3_MEDIA",8),,,)
TRCell():New(oSection3,"B3_CLASSE"	,"SB3",,,,,)

oSection4:= TRSection():New(oSection3,If( cPaisLoc $ "ANG|PTG", "Pedido De Compras", "Pedido de Compras" ),{"SC7","SA2"},)
TRCell():New(oSection4,"C7_NUM"    ,"SC7",,,,,{|| cNumPc})
TRCell():New(oSection4,"C7_ITEM"   ,"SC7",,,,,{|| cItemPc})
TRCell():New(oSection4,"C7_FORNECE","SC7",,,,,{|| cFornec})
TRCell():New(oSection4,"C7_LOJA"   ,"SC7",,,,,{|| cLojaFor})
TRCell():New(oSection4,"A2_NOME"   ,"SA2",,,,,{|| cNomeFor})
TRCell():New(oSection4,"C7_QUANT"  ,"SC7",,PesqPict("SC7","C7_QUANT",14),,,{|| nQuant})
TRCell():New(oSection4,"C7_UM"     ,"SC7",,,,,{|| cUM})
TRCell():New(oSection4,"C7_PRECO"  ,"SC7",,PesqPict("SC7","C7_PRECO",14),,,{|| nPreco})
TRCell():New(oSection4,"C7_TOTAL"  ,"SC7",,PesqPict("SC7","C7_TOTAL",14),,,{|| nTotal})
TRCell():New(oSection4,"C7_EMISSAO","SC7",,,,,{|| dEmissao})
TRCell():New(oSection4,"C7_DATPRF" ,"SC7",,,,,{|| dDATPRF})
TRCell():New(oSection4,"PRAZO"     ,"   ",If( cPaisLoc $ "ANG|PTG", "Prz.dias", "Prz.Dias" ),"999",,,{|| dPrazo })
TRCell():New(oSection4,"C7_COND"   ,"SC7",,,,,{|| cCond})
TRCell():New(oSection4,"C7_QUJE"   ,"SC7",,,,,{|| nQuje})
TRCell():New(oSection4,"SALDORES"  ,"   ","Saldo Res.",PesqPict("SC7","C7_QUJE",14),,,{||nSaldores })
TRCell():New(oSection4,"RESIDUO"   ,"   ","Eli.",,,,{||cResiduo})


If mv_par10 == 1
	oSection5:= TRSection():New(oSection4,If( cPaisLoc $ "ANG|PTG", "Restrição produto X fornecedor", "Amarração Produto X Fornecedor" ),{"SA5","SA2","SC1"},)
	TRCell():New(oSection5,"A5_FORNECE","SA5",,,,,)
	TRCell():New(oSection5,"A5_LOJA"   ,"SA5",,,,,)
	TRCell():New(oSection5,"A2_NOME"   ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_TEL"    ,"SA2",,,41,,)
	TRCell():New(oSection5,"A2_CONTATO","SA2",,,,,)
	TRCell():New(oSection5,"A2_FAX"    ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_ULTCOM" ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_MUN"    ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_EST"    ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_RISCO"  ,"SA2",,,,,)
	TRCell():New(oSection5,"A5_CODPRF" ,"SA5",,,,,)
Else
	oSection5:= TRSection():New(oSection4,"Amarração Grupo X Fornecedor",{"SAD","SA2","SC1"},)
	TRCell():New(oSection5,"AD_FORNECE","SAD",,,,,)
	TRCell():New(oSection5,"AD_LOJA"   ,"SAD",,,,,)
	TRCell():New(oSection5,"A2_NOME"   ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_TEL"    ,"SA2",,,41,,)
	TRCell():New(oSection5,"A2_CONTATO","SA2",,,,,)
	TRCell():New(oSection5,"A2_FAX"    ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_ULTCOM" ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_MUN"    ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_EST"    ,"SA2",,,,,)
	TRCell():New(oSection5,"A2_RISCO"  ,"SA2",,,,,)
EndIf

Return(oReport)
















Static Function ReportPrint(oReport,cAliasSC1,nReg)

Local oSection1 := oReport:Section(1)
Local oSection2 := oReport:Section(1):Section(1)
Local oSection3 := oReport:Section(1):Section(1):Section(1)
Local oSection4 := oReport:Section(1):Section(1):Section(1):Section(1)
Local oSection5 := oReport:Section(1):Section(1):Section(1):Section(1):Section(1)
Local aMeses	:= {"Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set",If( cPaisLoc $ "ANG|PTG", "Nov", "Out" ),"Nov","Dez"}
Local aOrdem    := {}
Local aSavRec   := {}
Local cMes      := ""
Local cCampos   := ""
Local cEmissao  := ""
Local cGrupo    := ""
Local nX        := 0
Local nY        := 0
Local nRecnoSD4 := 0
Local nAno      := Year(dDataBase)
Local nMes      := Month(dDataBase)
Local nPrinted  := 0
Local nVlrMax   := 0
Local cLmtSol   := ""


	Local cQuery := ""
    Local cWhere := ""
    Local lQuery := .T. 





If SC1->( FieldPos( "C1_QTDREEM" ) ) > 0
	nVlrMax := val(Replicate("9",TamSX3("C1_QTDREEM")[1]))
EndIf

Private cDescPro := ""
Private cNumPc   := ""
Private cItemPc  := ""
Private cFornec  := ""
Private cLojaFor := ""
Private cNomeFor := ""
Private cUM      := ""
Private cCond    := ""
Private cResiduo := ""
Private nQuant   := 0
Private nPreco   := 0
Private nTotal   := 0
Private nQuje    := 0
Private nSaldoRes:= 0
Private dEmissao := ctod("")
Private dDATPRF  := ctod("")
Private dPrazo   := ctod("")

dbSelectArea("SC1")
dbSetOrder(1)

If lAuto
	dbGoto(nReg)
	mv_par01  := SC1->C1_NUM
	mv_par02  := SC1->C1_NUM
	mv_par03  := 1
	mv_par04  := SC1->C1_EMISSAO
	mv_par05  := SC1->C1_EMISSAO
	mv_par06  := "  "
	mv_par07  := "ZZ"
	mv_par09  := 1
	mv_par13  := 3
Else



	 	MakeSqlExpr(oReport:uParam)

	 	oReport:Section(1):BeginQuery()

		cWhere := "%"
		If mv_par03 == 2
			cWhere += " C1_QUANT <> C1_QUJE AND "
	    EndIf
		cWhere += "%"















__execSql(cAliasSC1," SELECT SC1.*, SC1.R_E_C_N_O_ SC1RECNO FROM  "+RetSqlName('SC1')+" SC1 WHERE C1_FILIAL =  '" +xFilial('SC1')+"'  AND C1_NUM >=  "+___SQLGetValue(MV_PAR01)+" AND C1_NUM <=  "+___SQLGetValue(MV_PAR02)+" AND C1_EMISSAO >=  "+___SQLGetValue(DTOS(MV_PAR04))+" AND C1_EMISSAO <=  "+___SQLGetValue(DTOS(MV_PAR05))+" AND C1_ITEM >=  "+___SQLGetValue(MV_PAR06)+" AND C1_ITEM <=  "+___SQLGetValue(MV_PAR07)+" AND  "+___SQLGetValue(CWHERE)+" SC1.D_E_L_E_T_= ' ' ORDER BY  "+ SqlOrder(SC1->(IndexKey())),{},.F.)

		oReport:Section(1):EndQuery()


















EndIf

TRPosition():New(oSection1,"SB1",1,{ || xFilial("SB1") + (cAliasSC1)->C1_PRODUTO })
TRPosition():New(oSection1,"SB2",1,{ || xFilial("SB2") + (cAliasSC1)->C1_PRODUTO + (cAliasSC1)->C1_LOCAL })
TRPosition():New(oSection1,"SB3",1,{ || xFilial("SB3") + (cAliasSC1)->C1_PRODUTO })
TRPosition():New(oSection3,"SB3",1,{ || xFilial("SB3") + (cAliasSC1)->C1_PRODUTO })
TRPosition():New(oSection1,"SD4",1,{ || xFilial("SD4") + (cAliasSC1)->C1_PRODUTO })
TRPosition():New(oSection1,"SC7",1,{ || xFilial("SC7") + (cAliasSC1)->C1_NUM + (cAliasSC1)->C1_ITEM })
TRPosition():New(oSection2,"SC2",1,{ || xFilial("SC2") + SD4->D4_OP })
TRPosition():New(oSection4,"SA2",1,{ || xFilial("SA2") + SC7->C7_FORNECE + SC7->C7_LOJA })




oReport:onPageBreak( { || oReport:SkipLine(), oSection1:PrintLine(), oReport:SkipLine(), oReport:ThinLine() })

oReport:SetMeter(SC1->(LastRec()))
dbSelectArea(cAliasSC1)


While !oReport:Cancel() .And.  !(cAliasSC1)->(Eof()) .And.  (cAliasSC1)->C1_FILIAL == xFilial("SC1") .And.  (cAliasSC1)->C1_NUM >= mv_par01 .And.  (cAliasSC1)->C1_NUM <= mv_par02

	oReport:IncMeter()

	If oReport:Cancel()
		Exit
	EndIf




	If !MtrAValOP(mv_par13,"SC1",cAliasSC1 )
		dbSkip()
		Loop
	EndIf





    cEmissao := IIf((cAliasSC1)->C1_QTDREEM > 0 , Str(If((cAliasSC1)->C1_QTDREEM < nVlrMax,(cAliasSC1)->C1_QTDREEM + 1,(cAliasSC1)->C1_QTDREEM) ,2) + If( cPaisLoc $ "ANG|PTG", "A.emissão ", "a.Emissao " ) , " " )
	oReport:SetTitle(If( cPaisLoc $ "ANG|PTG", "Solicitação De Compra", "Solicitacao de Compra" )+"     "+If( cPaisLoc $ "ANG|PTG", "Número ", "Numero " )+" "+Substr((cAliasSC1)->C1_NUM,1,6)+" "+If( cPaisLoc $ "ANG|PTG", "  c.custo : ", "  C.Custo : " )+" "+(cAliasSC1)->C1_CC+Space(20)+cEmissao )




	SB1->(dbSetOrder(1))
	SB1->(dbSeek( xFilial("SB1") + (cAliasSC1)->C1_PRODUTO ))
	cDescPro := SB1->B1_DESC
	cGrupo   := SB1->B1_GRUPO

	If AllTrim(mv_par08) == "C1_DESCRI"
		cDescPro := (cAliasSC1)->C1_DESCRI
	ElseIf AllTrim(mv_par08) == "B5_CEME"
		SB5->(dbSetOrder(1))
		If SB5->(dbSeek( xFilial("SB5") + (cAliasSC1)->C1_PRODUTO ))
			cDescPro := SB5->B5_CEME
		EndIf
	EndIf

	SC7->(dbSetOrder(1))
	SC7->(dbSeek( xFilial("SC7") + (cAliasSC1)->C1_PEDIDO + (cAliasSC1)->C1_ITEMPED ))
	cNumPc   := SC7->C7_NUM
	cItemPc  := SC7->C7_ITEM
	cFornec  := SC7->C7_FORNECE
	cLojaFor := SC7->C7_LOJA
	cCond    := SC7->C7_COND
	cUM      := SC7->C7_UM
	cResiduo := IIf(Empty(SC7->C7_RESIDUO),If( cPaisLoc $ "ANG|PTG", "Não", "Nao" ),"Sim")
	nQuant   := SC7->C7_QUANT
	nPreco   := SC7->C7_PRECO
	nTotal   := SC7->C7_TOTAL
	dEmissao := SC7->C7_EMISSAO
	dDATPRF  := SC7->C7_DATPRF
	dPrazo   := SC7->C7_DATPRF - SC7->C7_EMISSAO
	nQuje    := SC7->C7_QUJE
	nSaldoRes:= Iif(Empty(SC7->C7_RESIDUO),SC7->C7_QUANT - SC7->C7_QUJE,0)

	SA2->(dbSetOrder(1))
	SA2->(dbSeek(xFilial("SA2")+SC7->C7_FORNECE+SC7->C7_LOJA))
	cNomeFor := SA2->A2_NOME




	oSection1:Init()




	If !Empty((cAliasSC1)->C1_OBS)
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Observações:", "OBSERVACOES:" ),,oSection1:Cell("C1_ITEM"):ColPos())

		For nX := 1 To 258 Step 129
			oReport:PrintText(Substr((cAliasSC1)->C1_OBS,nX,129),,oSection1:Cell("C1_ITEM"):ColPos())
			If Empty(Substr((cAliasSC1)->C1_OBS,nX+129,129))
				Exit
			Endif
		next

		oReport:ThinLine()

	Endif




	If mv_par09 == 1
	    oReport:SkipLine()
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Requisições Empenhadas:", "REQUISICOES EMPENHADAS:" ),,oSection1:Cell("C1_ITEM"):ColPos())

		dbSelectArea("SD4")
		If !Eof()

			oSection2:Init()

			While !Eof() .And.  SD4->D4_FILIAL + SD4->D4_COD == (cAliasSC1)->C1_FILIAL + (cAliasSC1)->C1_PRODUTO

				nRecnoSD4 := SD4->(Recno())
				If SD4->D4_QUANT <> 0
					oSection2:PrintLine()
                EndIf
				SD4->(dbGoTo(nRecnoSD4))
				SD4->(dbSkip())

			EndDo

			oSection2:Finish()

        Else
        	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Não existem requisições empenhadas deste item.", "Nao existem requisicoes empenhadas deste item." ),,oSection1:Cell("C1_ITEM"):ColPos())
		EndIf

		oReport:SkipLine()
		oReport:ThinLine()

	EndIf




	oReport:SkipLine()
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Consumo Dos últimos 12 Meses:", "CONSUMO DOS ULTIMOS 12 MESES:" ),,oSection1:Cell("C1_ITEM"):ColPos())

	dbSelectArea("SB3")
	If !Eof()

		oSection3:Init()

		nAno   := Year(dDataBase)
		nMes   := Month(dDataBase)
		aOrdem := {}
	    nY     := 1

		For nX := nMes To 1 Step -1
			oSection3:Cell("MES"+StrZero(nY,2)):SetTitle("|  "+aMeses[nX]+"/"+StrZero(nAno,4))
			AADD(aOrdem,nX)
            nY++
		next

		nAno--

		For nX := 12 To nMes+1 Step -1
			oSection3:Cell("MES"+StrZero(nY,2)):SetTitle("|  "+aMeses[nX]+"/"+StrZero(nAno,4))
			AADD(aOrdem,nX)
            nY++
		next

		For nX := 1 To Len(aOrdem)
			cMes    := StrZero(aOrdem[nX],2)
			cCampos := "SB3->B3_Q"+cMes
			oSection3:Cell("MES"+StrZero(nX,2)):SetValue(&cCampos)
		next

		oSection3:PrintLine()
		oSection3:Finish()

    Else
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Não existe registo de consumo anterior deste item.", "Nao existe registro de consumo anterior deste item." ),,oSection1:Cell("C1_ITEM"):ColPos())
	EndIf




	oReport:SkipLine()
	oReport:ThinLine()
	oReport:SkipLine()
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "últimos Pedidos:", "ULTIMOS PEDIDOS:" ),,oSection1:Cell("C1_ITEM"):ColPos())

	dbSelectArea("SC7")
	dbSetOrder(4)
	Set( 9,"ON" )
	dbSeek(xFilial("SC7")+(cAliasSC1)->C1_PRODUTO+"z")
	Set( 9,"OFF" )
	dbSkip(-1)
	If (cAliasSC1)->C1_FILIAL + (cAliasSC1)->C1_PRODUTO == SC7->C7_FILIAL + SC7->C7_PRODUTO
		nPrinted := 0

		oSection4:Init()

		While !Bof() .And.  (cAliasSC1)->C1_FILIAL + (cAliasSC1)->C1_PRODUTO == SC7->C7_FILIAL + SC7->C7_PRODUTO
			nPrinted++
			If nPrinted > mv_par11
				Exit
			EndIf

			oSection4:PrintLine()

			dbSkip(-1)
		EndDo

		oSection4:Finish()

	Else
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Não existem pedidos registados para este item.", "Nao existem pedidos cadastrados para este item." ),,oSection1:Cell("C1_ITEM"):ColPos())
	EndIf




	oReport:SkipLine()
	oReport:ThinLine()
	oReport:SkipLine()
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Fornecedores:", "FORNECEDORES:" ),,oSection1:Cell("C1_ITEM"):ColPos())

	If mv_par10 == 1

		dbSelectArea("SA5")
		dbSetOrder(2)
		dbSeek(xFilial("SA5")+(cAliasSC1)->C1_PRODUTO)

		If !Eof()
			nPrinted := 0
			oSection5:Init()

			While !Eof() .And.  xFilial("SA5") + (cAliasSC1)->C1_PRODUTO == SA5->A5_FILIAL + SA5->A5_PRODUTO
				If SA2->(dbSeek(xFilial("SA2")+SA5->A5_FORNECE+SA5->A5_LOJA))
					nPrinted++
					If nPrinted > mv_par12
						Exit
					EndIf
					oSection5:PrintLine()
                EndIf

				dbSkip()
			EndDo
			oSection5:Finish()
		Else
			oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Não existem fornecedores registados para este item.", "Nao existem fornecedores cadastrados para este item." ),,oSection1:Cell("C1_ITEM"):ColPos())
		EndIf
	Else
		dbSelectArea("SAD")
		dbSetOrder(2)
		dbSeek(xFilial()+cGrupo)

		If !Eof()
			nPrinted := 0
			oSection5:Init()
			While !Eof() .And.  SAD->AD_FILIAL + SAD->AD_GRUPO == xFilial("SAD") + cGrupo
				If SA2->(dbSeek(xFilial("SA2")+SAD->AD_FORNECE+SAD->AD_LOJA))
					nPrinted++
					If nPrinted > mv_par12
						Exit
					EndIf
					oSection5:PrintLine()
                EndIf
				dbSkip()
			EndDo
        Else
			oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Não existem fornecedores registados para este item.", "Nao existem fornecedores cadastrados para este item." ),,oSection1:Cell("C1_ITEM"):ColPos())
		EndIf
		oSection5:Finish()
	EndIf




	oReport:SkipLine()
	oReport:ThinLine()
	oReport:SkipLine()

	If !Empty(SB1->B1_ALTER)
		SB2->(dbSeek(xFilial("SB2") + SB1->B1_ALTER + (cAliasSC1)->C1_LOCAL ))
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Código alternativo : ", "Codigo Alternativo : " )+" "+SB1->B1_ALTER+" "+If( cPaisLoc $ "ANG|PTG", "Saldo do alternativo :", "Saldo do Alternativo :" )+" "+Transform(SB2->B2_QATU,PesqPict("SB2","B2_QATU",12)+" "+SC1->C1_UM ),,oSection1:Cell("C1_ITEM"):ColPos())
	Else
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Código alternativo : ", "Codigo Alternativo : " ) + " " + If( cPaisLoc $ "ANG|PTG", "Não há", "Nao ha'" ),,oSection1:Cell("C1_ITEM"):ColPos())
	EndIf




	dbSelectArea(cAliasSC1)

	oReport:SkipLine()
	oReport:ThinLine()
	oReport:SkipLine()

	oReport:SkipLine()
	oReport:ThinLine()
	oReport:SkipLine()

	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "| c o n c o r r ê n c i a s                   | entrega         | observações                        | cond.pgt        | contacto          | quantidade     | preço unitário              | iva     | valor                |", "| C O N C O R R E N C I A S                   | ENTREGA         | OBSERVACOES                        | COND.PGTO        | CONTATO          | QUANTIDADE     | PRECO UNITARIO              | IPI     | VALOR                |" ),,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText("|---------------------------------------------|-----------------|------------------------------------|------------------|------------------|----------------|-----------------------------|---------|----------------------|",,oSection1:Cell("C1_ITEM"):ColPos())
	For nX :=1 To 4
	oReport:PrintText("|                                             |                 |                                    |                  |                  |                |                             |         |                      |",,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText("|---------------------------------------------|-----------------|------------------------------------|------------------|------------------|----------------|-----------------------------|---------|----------------------|",,oSection1:Cell("C1_ITEM"):ColPos())
	next
	oReport:SkipLine()
	oReport:PrintText("---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "|                 requisitante                                                                               |                    autorizante                                                                              |", "|                 REQUISITANTE                                                                               |                    AUTORIZANTE                                                                              |" ),,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText("|                                                                                                            |                                                                                                             |",,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText("|   ------------------------------------------------------------------------------------------------------   |   -------------------------------------------------------------------------------------------------------   |",,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText("|                "+PADC(AllTrim((cAliasSC1)->C1_SOLICIT),15)+"                                                                             |                    "+Iif((cAliasSC1)->(FieldPos("C1_NOMAPRO")) > 0,Padc(AllTrim((cAliasSC1)->C1_NOMAPRO),15),Space(15))+"                                                                          |",,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText("|                                                                                                            |                                                                                                             |",,oSection1:Cell("C1_ITEM"):ColPos())
	oReport:PrintText("---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",,oSection1:Cell("C1_ITEM"):ColPos())




	If Ascan(aSavRec,IIf(lQuery .And.  !lAuto ,(cAliasSC1)->SC1RECNO,Recno())) == 0
		AADD(aSavRec,IIf(lQuery .And.  !lAuto ,(cAliasSC1)->SC1RECNO,Recno()))
	Endif

	dbSelectArea(cAliasSC1)
	dbSkip()
	oSection1:Finish()
    oReport:EndPage()
EndDo




dbSelectArea("SC1")
If Len(aSavRec) > 0
	For nX:=1 to Len(aSavRec)
		dbGoto(aSavRec[nX])
		If C1_QTDREEM < nVlrMax
			RecLock("SC1", .F. )
			_FIELD->C1_QTDREEM := (C1_QTDREEM+1)
			MsUnLock()
		Else
			cLmtSol += SC1->C1_NUM + ","
		EndIf
	next
EndIf

If !Empty(cLmtSol)
	Aviso(If( cPaisLoc $ "ANG|PTG", "Aviso reemissao", "Aviso Reemissão" ),If( cPaisLoc $ "ANG|PTG", "O campo 'reemissao' (c1_qtdreem) atingiu o valor ", "O campo 'Reemissao' (C1_QTDREEM) atingiu o valor " ) + "'" + Alltrim(str(nVlrMax)) + "'" + If( cPaisLoc $ "ANG|PTG", " para os pedidos: ", " para as solicitações: " ) + SubStr(cLmtSol,1,len(cLmtSol)-1) + If( cPaisLoc $ "ANG|PTG", "Pedir ao administrador a alteração  no tamanho do campo.", ". Solicite ao administrador a alteração no tamanho do campo." ),{"OK"})
EndIf

Return Nil




















Function MATR140R3(cAlias,nReg,nOpcx)




LOCAL wnrel		:= "MATR140"
LOCAL nCol		:= 0
LOCAL cDesc1	:= If( cPaisLoc $ "ANG|PTG", "Emissão das solicitações de compras registadas", "Emissao das solicitacoes de compras cadastradas" )
LOCAL cDesc2	:= ""
LOCAL cDesc3	:= ""
STATIC aTamSXG,aTamSXG2, nPosLoja, nPosNome, nTamNome

PRIVATE lAuto	:= (nReg<>Nil)
PRIVATE Titulo	:= If( cPaisLoc $ "ANG|PTG", "Solicitação De Compra", "Solicitacao de Compra" )
PRIVATE aReturn := {If( cPaisLoc $ "ANG|PTG", "Código de barras", "Zebrado" ),10,If( cPaisLoc $ "ANG|PTG", "Administração", "Administracao" ),2,2,1,"",0}
PRIVATE aLinha	:= {}
PRIVATE Tamanho	:= "G"
PRIVATE Limite  := 220
PRIVATE nomeprog:= "MATR140"
PRIVATE nLastKey:= 0
PRIVATE cString	:= "SC1"
PRIVATE M_PAG	:= 1
PRIVATE li      := 99
If !lAuto
	cPerg := "MTR140"
EndIf



pergunte("MTR140", .F. )




















aTamSXG  := If(aTamSXG  == NIL, TamSXG("001"), aTamSXG)
aTamSXG2 := If(aTamSXG2 == NIL, TamSXG("002"), aTamSXG2)

wnrel:=SetPrint(cString,wnrel,If(!lAuto,cPerg,Nil),@Titulo,cDesc1,cDesc2,cDesc3, .F. ,, .F. ,Tamanho,,!lAuto)

If nLastKey == 27
	dbClearFilter()
	Return
Endif

SetDefault(aReturn,cString)

If nLastKey == 27
	dbClearFilter()
	Return
Endif

RptStatus({|lEnd| R140Imp(@lEnd,wnrel,cString,nReg)},Titulo)

Return













Static Function R140Imp(lEnd,wnrel,cString,nReg)

LOCAL cGrupo
LOCAL nContador
LOCAL j
LOCAL Cabec1	:= ""
LOCAL Cabec2	:= ""
LOCAL Cabec3	:= ""
LOCAL cbCont	:= 0
LOCAL aMeses	:= {"Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set",If( cPaisLoc $ "ANG|PTG", "Nov", "Out" ),"Nov","Dez"}
LOCAL aOrdem 	:= {},cMeses,nAno,nMes,cMes,cCampos,cDescri,i
LOCAL aSavRec   := {}
LOCAL cAliasSC1	:= "SC1"
LOCAL cArqInd	:= ""
LOCAL cEmissao  := ""
LOCAL nX        := 0
LOCAL lQuery    := .F. 
Local nVlrMax   := 0
Local cLmtSol   := ""

If SC1->( FieldPos( "C1_QTDREEM" ) ) > 0
	nVlrMax := val(Replicate("9",TamSX3("C1_QTDREEM")[1]))
EndIf

dbSelectArea("SC1")
dbSetOrder(1)
If lAuto
	dbGoto(nReg)
	mv_par01 := SC1->C1_NUM
	mv_par02 := SC1->C1_NUM
	mv_par03 := 1
	mv_par04 := SC1->C1_EMISSAO
	mv_par05 := SC1->C1_EMISSAO
	mv_par06 := "  "
	mv_par07 := "ZZ"
	mv_par09 := 1
	mv_par13 := 3
Else

	If (TcSrvType()#"AS/400")



		lQuery := .T. 
		cQuery := "SELECT * "
		cQuery += "   FROM "	    + RetSqlName( "SC1" ) +" SC1 "
		cQuery += "  WHERE "
		cQuery += "   C1_FILIAL   ='" + xFilial( "SC1" ) + "' AND "
		cQuery += "   C1_NUM     >='" + MV_PAR01         + "' AND "
		cQuery += "   C1_NUM     <='" + MV_PAR02         + "' AND "
		cQuery += "   C1_EMISSAO >='" + DTOS(MV_PAR04)   + "' AND "
		cQuery += "   C1_EMISSAO <='" + DTOS(MV_PAR05)   + "' AND "
		cQuery += "   C1_ITEM    >='" + MV_PAR06         + "' AND "
		cQuery += "   C1_ITEM    <='" + MV_PAR07         + "' AND "
		If mv_par03 == 2
			cQuery += "C1_QUANT<>C1_QUJE  AND "
		EndIf
		cQuery += "SC1.D_E_L_E_T_<>'*' "
		cQuery += "ORDER BY " + SqlOrder(SC1->(IndexKey()))
		cQuery := ChangeQuery(cQuery)

		cAliasSC1 := "QRYSC1"
		dbUseArea( .T. , "TOPCONN", TCGENQRY(,,cQuery), "QRYSC1", .F. , .T. )
		aEval(SC1->(dbStruct()),{|x| If(x[2]<>"C",TcSetField("QRYSC1",AllTrim(x[1]),x[2],x[3],x[4]),Nil)})
	Else

		If !Empty(mv_par01)
			SC1->(dbSeek(xFilial("SC1")+MV_PAR01, .T. ))
		Else
			cArqInd   := CriaTrab( , .F.  )
			cQuery := "C1_FILIAL=='" +xFilial("SC1")+"'.AND."
			cQuery += "C1_NUM>='"+MV_PAR01+"'.AND."
			cQuery += "C1_NUM<='"+MV_PAR02+"'.AND."
			cQuery += "DTOS(C1_EMISSAO)>='"+DTOS(MV_PAR04)+"'.AND."
			cQuery += "DTOS(C1_EMISSAO)<='"+DTOS(MV_PAR05)+"'.AND."
			cQuery += "C1_ITEM >= '"  +MV_PAR06+"'.AND."
			cQuery += "C1_ITEM <= '"  +MV_PAR07+"'"

			IndRegua( "SC1", cArqInd, IndexKey(), , cQuery )
		EndIf

	EndIf

EndIf




dbSelectArea(cAliasSC1)
SetRegua(LastRec())


While !EOF() .And.  (cAliasSC1)->C1_FILIAL==xFilial("SC1") .And.  (cAliasSC1)->C1_NUM >= mv_par01 .And.  (cAliasSC1)->C1_NUM <= mv_par02
	If lEnd
		PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
		Exit
	Endif

	IncRegua()

	If !Empty(aReturn[7]) .And.  !&(aReturn[7])
		dbSkip()
		Loop
	EndIf




	If mv_par03 == 2
		If ((cAliasSC1)->C1_QUANT - (cAliasSC1)->C1_QUJE) == 0
			dbSkip()
			Loop
		EndIf
	EndIf



	If (cAliasSC1)->C1_EMISSAO < mv_par04 .Or.  (cAliasSC1)->C1_EMISSAO > mv_par05
		dbSkip()
		Loop
	EndIf



	If !MtrAValOP(mv_par13, "SC1")
		dbSkip()
		Loop
	EndIf

	If (cAliasSC1)->C1_ITEM < mv_par06 .Or.  (cAliasSC1)->C1_ITEM > mv_par07
		dbSkip()
		Loop
	EndIf

	If (cAliasSC1)->(FieldPos("C1_QTDREEM")) > 0
    	cEmissao := IIf((cAliasSC1)->C1_QTDREEM>0,Str(If((cAliasSC1)->C1_QTDREEM < nVlrMax,(cAliasSC1)->C1_QTDREEM + 1,(cAliasSC1)->C1_QTDREEM),2)+If( cPaisLoc $ "ANG|PTG", "A.emissão ", "a.Emissao " )," ")
    EndIf

	Titulo := If( cPaisLoc $ "ANG|PTG", "Solicitação De Compra", "Solicitacao de Compra" )+"     "+If( cPaisLoc $ "ANG|PTG", "Número ", "Numero " )+" "+Substr((cAliasSC1)->C1_NUM,1,6)+" "+If( cPaisLoc $ "ANG|PTG", "  c.custo : ", "  C.Custo : " )+" "+(cAliasSC1)->C1_CC+SPACE(20)+cEmissao
	Cabec1 := If( cPaisLoc $ "ANG|PTG", "ITEM CÓDIGO ARTIGO                  DESCRIÇÃO                                SALDO       PONTO DE       SALDO DA   UNIDADE     ARMAZ         QUANT.POR        ULTIMO PREÇO        LEAD        DATA DA         DATA PARA ", "ITEM CODIGO PRODUTO                  DESCRICAO                                SALDO       PONTO DE       SALDO DA   UNIDADE     ARMAZ         QUANT.POR        ULTIMO PRECO        LEAD        DATA DA         DATA PARA " )
	Cabec2 := If( cPaisLoc $ "ANG|PTG", "                                                                              ACTUAL         PEDIDO    SOLICITAÇÃO    MEDIDA                   EMBALAGEM           DE COMPRA        TIME        NECESSIDADE      COMPRAR  ", "                                                                              ATUAL         PEDIDO    SOLICITACAO    MEDIDA                   EMBALAGEM           DE COMPRA        TIME        NECESSIDADE      COMPRAR  " )

	If li > 55
		cabec(titulo,cabec1,cabec2,nomeprog,Tamanho,IIF(aReturn[4]==1,15,18))
	EndIf




	dbSelectArea("SB1")
	dbSeek(xFilial()+(cAliasSC1)->C1_PRODUTO)
	cGrupo := SB1->B1_GRUPO

	If mv_par10 == 1
		dbSelectArea("SA5")
		dbSetOrder(2)
		dbSeek(xFilial()+(cAliasSC1)->C1_PRODUTO)
	Else
		dbSelectArea("SAD")
		dbSetOrder(2)
		dbSeek(xFilial()+cGrupo)
	EndIf

	dbSelectArea("SB2")
	dbSeek(xFilial()+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL)

	dbSelectArea("SB3")
	dbSeek(xFilial()+(cAliasSC1)->C1_PRODUTO)

	dbSelectArea("SD4")
	dbSeek(xFilial()+(cAliasSC1)->C1_PRODUTO)

	dbSelectArea("SC7")
	dbSetOrder(1)
	dbSeek(xFilial()+(cAliasSC1)->C1_NUM+(cAliasSC1)->C1_ITEM)




	cDescri := " "
	If Empty(mv_par08)
		mv_par08 := "B1_DESC"
	EndIf
	If AllTrim(mv_par08) == "C1_DESCRI"
		cDescri := (cAliasSC1)->C1_DESCRI
	EndIf
	If AllTrim(mv_par08) == "B5_CEME"
		dbSelectArea("SB5")
		dbSetOrder(1)
		dbSeek( xFilial()+(cAliasSC1)->C1_PRODUTO )
		If Found()
			cDescri := B5_CEME
		EndIf
	EndIf
	If Empty(cDescri)
		dbSelectArea("SB1")
		dbSeek( xFilial()+(cAliasSC1)->C1_PRODUTO )
		cDescri := SB1->B1_DESC
	EndIf

	A140Solic(cDescri,cAliasSC1)




	If !Empty((cAliasSC1)->C1_OBS)
		li++
		PrintOut(li,000,__PrtThinLine(),,)
		li++
		PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Observações:","OBSERVACOES:"),,)
		li++
		For i:= 1 To 258 Step 129
			PrintOut(li,003,Subs((cAliasSC1)->C1_OBS,i,129),"@!",)
			li++
			If Empty(Subs((cAliasSC1)->C1_OBS,i+129,129))
				Exit
			Endif
		next
	Endif




	li++
	If mv_par09 == 1
		PrintOut(li,000,__PrtThinLine(),,)
		li++
		PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Requisições Empenhadas:","REQUISICOES EMPENHADAS:"),,)
		PrintOut(li,069,"|",,)
		PrintOut(li,144,"|",,)
		PrintOut(li,219,"|",,)

		li++
		dbSelectArea("SD4")
		If EOF()
			PrintOut(li,002,If(cPaisLoc$"ANG|PTG","Não existem requisições empenhadas deste item.","Nao existem requisicoes empenhadas deste item."),,)
			li++
		Else

			PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Ordem de        produto a ser          início          quantidade    |     ordem de        produto a ser          início          quantidade    |     ordem de        produto a ser          início          quantidade    |","Ordem de        Produto a ser          Inicio          Quantidade    |     Ordem de        Produto a ser          Inicio          Quantidade    |     Ordem de        Produto a ser          Inicio          Quantidade    |"),,)
			li++
			PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Produção        produzido              previsto        necessária    |     produção        produzido              previsto        necessária    |     produção        produzido              previsto        necessária    |","Producao        produzido              Previsto        Necessaria    |     Producao        produzido              Previsto        Necessaria    |     Producao        produzido              Previsto        Necessaria    |"),,)
			li++
			nCol := 0
			While !EOF() .And.  D4_FILIAL+D4_COD == xFilial()+(cAliasSC1)->C1_PRODUTO
				If D4_QUANT = 0
					dbSkip()
					Loop
				Endif
				If li > 55
					cabec(titulo,cabec1,cabec2,nomeprog,Tamanho,IIF(aReturn[4]==1,15,18))
					A140Solic(cDescri,cAliasSC1)
				EndIf
				dbSelectArea("SC2")
				dbSeek(xFilial()+SD4->D4_OP)
				dbSelectArea("SD4")

				PrintOut(li,nCol,D4_OP,,)
				PrintOut(li,nCol+16,SubStr(SC2->C2_PRODUTO,1,15),,)
				PrintOut(li,nCol+38,D4_DATA,,)
				PrintOut(li,nCol+53,D4_QUANT,PesqPict("SD4","D4_QUANT",12),)
				PrintOut(li,nCol+69,"|",,)
				nCol+=75
				If nCol > 210
					li++
					nCol := 0
				EndIf

				dbSkip()
			End

			If nCol = 75
				PrintOut(li,144,"|",,)
				PrintOut(li,219,"|",,)
				li++
			Elseif nCol = 150
				PrintOut(li,219,"|",,)
				li++
			Endif

		EndIf
	EndIf

	If li > 55
		cabec(titulo,cabec1,cabec2,nomeprog,Tamanho,IIF(aReturn[4]==1,15,18))
		A140Solic(cDescri,cAliasSC1)
	EndIf




	PrintOut(li,000,__PrtThinLine(),,)
	li++
	PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Consumo Dos últimos 12 Meses:","CONSUMO DOS ULTIMOS 12 MESES:"),,)
	li++
	dbSelectArea("SB3")
	If EOF()
		PrintOut(li,002,If(cPaisLoc$"ANG|PTG","Não existe registo de consumo anterior deste item.","Nao existe registro de consumo anterior deste item."),,)
		li++
	Else
		cMeses := "   "
		nAno := YEAR(dDataBase)
		nMes := MONTH(dDataBase)
		aOrdem := {}
		For j := nMes To 1 Step -1
			cMeses += aMeses[j]+"/"+Substr(Str(nAno,4),3,2)+Space(4)
			AADD(aOrdem,j)
		next
		nAno--
		For j := 12 To nMes+1 Step -1
			cMeses += aMeses[j]+"/"+Substr(Str(nAno,4),3,2)+Space(4)
			AADD(aOrdem,j)
		next
		PrintOut(li,000,Trim(cMeses)+If(cPaisLoc$"ANG|PTG","    Média C","    Media C"),,)
		li++
		nCol := 0
		For j := 1 To Len(aOrdem)
			cMes    := StrZero(aOrdem[j],2)
			cCampos := "B3_Q"+cMes
			PrintOut(li,nCol,&cCampos,PesqPict("SB3","B3_Q01",9),)
			nCol += 10
		next
		PrintOut(li,120,B3_MEDIA,PesqPict("SB3","B3_MEDIA",8),)
		PrintOut(li,129,B3_CLASSE,,)
		li++
	EndIf




	PrintOut(li,000,__PrtThinLine(),,)
	li++
	PrintOut(li,000,If(cPaisLoc$"ANG|PTG","últimos Pedidos:","ULTIMOS PEDIDOS:"),,)
	PrintOut(li,219,"|",,)
	li++
	dbSelectArea("SC7")
	dbSetOrder(4)
	Set( 9,"ON" )
	dbSeek(xFilial()+(cAliasSC1)->C1_PRODUTO+"z")
	Set( 9,"OFF" )
	dbSkip(-1)
	If xFilial()+(cAliasSC1)->C1_PRODUTO <> C7_FILIAL+C7_PRODUTO
		PrintOut(li,002,If(cPaisLoc$"ANG|PTG","Não existem pedidos registados para este item.","Nao existem pedidos cadastrados para este item."),,)
		li++
	Else
		nPosLoja := 17
		If cPaisLoc <> "BRA"
			PrintOut(li,00,If(cPaisLoc$"ANG|PTG","Número item código do fornecedor loja  nome                                   quantidade   und.medida     vlr.unitário    valor total  emissão       necessidade    prazo  condição    qtd entregue    saldo res.   eli.  |","Numero Item Codigo do Fornecedor Loja  Nome                                   Quantidade   Und.Medida     Vlr.Unitario    Valor Total  Emissao       Necessidade    Prazo  Condicao    Qtde Entregue    Saldo Res.   Eli.  |"),,)
		Else
			PrintOut(li,00,If(cPaisLoc$"ANG|PTG","Número item código do fornecedor loja  nome                                   quantidade   und.medida   vlr.unitário    valor total    emissão       necessidade    prazo  condição    qtd entregue    saldo res.   eli.  |","Numero Item Codigo do Fornecedor Loja  Nome                                   Quantidade   Und.Medida   Vlr.Unitario    Valor Total    Emissao       Necessidade    Prazo  Condicao    Qtde Entregue    Saldo Res.   Eli.  |"),,)
		Endif
		li++
		nContador := 0
		While !BOF() .And.  xFilial()+(cAliasSC1)->C1_PRODUTO == C7_FILIAL+C7_PRODUTO

			dbSelectArea("SA2")
			dbSeek(xFilial()+SC7->C7_FORNECE+SC7->C7_LOJA)
			dbSelectArea("SC7")

			nContador++
			If nContador > mv_par11
				Exit
			EndIf

			If li > 55
				cabec(titulo,cabec1,cabec2,nomeprog,Tamanho,IIF(aReturn[4]==1,15,18))
				A140Solic(cDescri,cAliasSC1)
			EndIf

			PrintOut(li,000,C7_NUM,,)
			PrintOut(li,007,C7_ITEM,,)
			PrintOut(li,012,SubStr(C7_FORNECE,1,20),,)
			PrintOut(li,033,SubStr(C7_LOJA,1,5),,)
			PrintOut(li,039,SubStr(SA2->A2_NOME,1,34),,)
			PrintOut(li,074,C7_QUANT,PesqPict("SC7","C7_QUANT",14),)
			PrintOut(li,091,C7_UM,,)



			If cPaisLoc <> "BRA"
				PrintOut(li,104,C7_PRECO,PesqPict("SC7","c7_preco",14),)
				PrintOut(li,119,C7_TOTAL,PesqPict("SC7","c7_total",14),)
			Else
				PrintOut(li,104,C7_PRECO,Right(PesqPict("SC7","c7_preco"),14),)
				PrintOut(li,119,C7_TOTAL,Right(PesqPict("SC7","c7_total"),14),)
			Endif

			PrintOut(li,135,C7_EMISSAO,,)
			PrintOut(li,149,C7_DATPRF,,)
			PrintOut(li,165,C7_DATPRF-C7_EMISSAO,"999",)
			PrintOut(li,168,"D",,)
			PrintOut(li,171,C7_COND,,)
			PrintOut(li,182,C7_QUJE,PesqPict("SC7","C7_QUJE",14),)
			PrintOut(li,198,If(Empty(C7_RESIDUO),C7_QUANT-C7_QUJE,0),PesqPict("SC7","C7_QUJE",14),)
			PrintOut(li,213,If(Empty(C7_RESIDUO),"Nao","Sim")+"   |",,)
			li++
			dbSkip(-1)
		End
	EndIf




	PrintOut(li,000,__PrtThinLine(),,)
	li++
	PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Fornecedores:","FORNECEDORES:"),,)
	li++

	If mv_par10 == 1
		nPosLoja := 07
		nTamNome := 28
		nPosNome := 10
		If aTamSXG[1] <> aTamSXG[3]
			nPosLoja += aTamSXG[4] - aTamSXG[3]
			nPosNome += ((aTamSXG[4] - aTamSXG[3]) + (aTamSXG2[4] - aTamSXG2[3]))
			nTamNome -= ((aTamSXG[4] - aTamSXG[3]) + (aTamSXG2[4] - aTamSXG2[3]))
		Endif

		dbSelectArea("SA5")
		If EOF()
			PrintOut(li,002,If(cPaisLoc$"ANG|PTG","Não existem fornecedores registados para este item.","Nao existem fornecedores cadastrados para este item."),,)
			li++
		Else

			If aTamSXG[1] <> aTamSXG[3]
				PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Código               Lj.  Razão Social Telefone        Contacto    Fax             últ.compr.  Município      Distrito Ris Cód. No Fornec.","Codigo               Lj.  RAZAO SOCIAL Telefone        Contato    Fax             Ult.Compr.  Municipio      UF Ris Cod. no Fornec."),,)



			Else
				PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Código Lj Nome                         Telefone        Contacto    Fax             úl.compr   Município       Distrito Ris  Cód. No Fornec.","Codigo Lj Nome                         Telefone        Contato    Fax             Ul.Compr   Municipio       UF Ris  Cod. no Fornec."),,)



			Endif
			li++
			nContador := 0
			While !EOF() .And.  xFilial()+(cAliasSC1)->C1_PRODUTO == A5_FILIAL+A5_PRODUTO
				dbSelectArea("SA2")
				dbSeek(xFilial()+SA5->A5_FORNECE+SA5->A5_LOJA)
				If EOF()
					dbSelectArea("SA5")
					dbSkip()
					Loop
				EndIf
				dbSelectArea("SA5")
				nContador++
				If nContador > mv_par12
					Exit
				EndIf
				If li > 55
					cabec(titulo,cabec1,cabec2,nomeprog,Tamanho,IIF(aReturn[4]==1,15,18))
					A140Solic(cDescri,cAliasSC1)
				EndIf
				PrintOut(li,000,A5_FORNECE,,)
				PrintOut(li,nPosLoja,A5_LOJA,,)
				PrintOut(li,nPosNome,SubStr(SA2->A2_NOME,1,nTamNome),,)
				PrintOut(li,039,Substr(SA2->A2_TEL,1,15),,)
				PrintOut(li,055,Substr(SA2->A2_CONTATO,1,10),,)
				PrintOut(li,066,SA2->A2_FAX,,)
				PrintOut(li,082,SA2->A2_ULTCOM,,)
				PrintOut(li,093,Left(SA2->A2_MUN,15),,)
				PrintOut(li,109,SA2->A2_EST,,)
				PrintOut(li,112,SA2->A2_RISCO,,)
				PrintOut(li,116,SubStr(A5_CODPRF,1,15),,)
				li++
				dbSkip()
			End
		EndIf
		dbSelectArea("SA5")
		dbSetOrder(1)
	Else
		dbSelectArea("SAD")
		If EOF()
			PrintOut(li,002,If(cPaisLoc$"ANG|PTG","Não existem fornecedores registados para este item.","Nao existem fornecedores cadastrados para este item."),,)
			li++
		Else

			nPosLoja := 07
			nTamNome := 30
			nPosNome := 10
			If aTamSXG[1] <> aTamSXG[3]
				nPosLoja += aTamSXG[4] - aTamSXG[3]
				nPosNome += ((aTamSXG[4] - aTamSXG[3]) + (aTamSXG2[4] - aTamSXG2[3]))
				nTamNome -= (aTamSXG[4] - aTamSXG[3])
			Endif


			If aTamSXG[1] <> aTamSXG[3]

				PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Código Lj Nome       Loja Razão Social   Telefone        Contacto    Fax             úl.compr Município       Distrito Ris Cód. No Fornec.","Codigo Lj Nome       Loja Razao Social   Telefone        Contato    Fax             Ul.Compr Municipio       UF Ris Cod. no Fornec."),,)





				PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Código Lj Nome                         Telefone        Contacto    Fax             úl.compr   Município       Distrito Ris  Cód. No Fornec.","Codigo Lj Nome                         Telefone        Contato    Fax             Ul.Compr   Municipio       UF Ris  Cod. no Fornec."),,)



			Endif
			li++
			nContador := 0
			While !EOF() .And.  SAD->AD_FILIAL+SAD->AD_GRUPO == xFilial()+cGrupo
				dbSelectArea("SA2")
				dbSeek(xFilial()+SAD->AD_FORNECE+SAD->AD_LOJA)
				If EOF()
					dbSelectArea("SAD")
					dbSkip()
					Loop
				EndIf
				dbSelectArea("SAD")
				nContador++
				If nContador > mv_par12
					Exit
				EndIf
				If li > 55
					cabec(titulo,cabec1,cabec2,nomeprog,Tamanho,IIF(aReturn[4]==1,15,18))

					A140Solic(cDescri,cAliasSC1)

				EndIf
				PrintOut(li,000,AD_FORNECE,,)
				PrintOut(li,nPosLoja,AD_LOJA,,)
				PrintOut(li,nPosNome,SubStr(SA2->A2_NOME,1,nTamNome),,)
				PrintOut(li,041,Substr(SA2->A2_TEL,1,15),,)
				PrintOut(li,057,Substr(SA2->A2_CONTATO,1,10),,)
				PrintOut(li,068,SA2->A2_FAX,,)
				PrintOut(li,084,SA2->A2_ULTCOM,,)
				PrintOut(li,095,Left(SA2->A2_MUN,15),,)
				PrintOut(li,111,SA2->A2_EST,,)
				PrintOut(li,114,SA2->A2_RISCO,,)
				li++
				dbSkip()
			End
		EndIf
		dbSelectArea("SAD")
		dbSetOrder(2)
	EndIf

	If li > 55
		cabec(titulo,cabec1,cabec2,nomeprog,tamanho,IIF(aReturn[4]==1,15,18))
		A140Solic(cDescri,cAliasSC1)
	EndIf




	li++
	PrintOut(li,000,__PrtThinLine(),,)
	li++

	PrintOut(li,002,If(cPaisLoc$"ANG|PTG","Código alternativo : ","Codigo Alternativo : "),,)
	If !Empty(SB1->B1_ALTER)
		PrintOut(li,023,SB1->B1_ALTER,,)
		PrintOut(li,060,If(cPaisLoc$"ANG|PTG","Saldo do alternativo :","Saldo do Alternativo :"),,)
		dbSelectArea("SB2")
		dbSeek(xFilial()+SB1->B1_ALTER+(cAliasSC1)->C1_LOCAL)
		PrintOut(li,083,B2_QATU,PesqPict("SB2","B2_QATU",12),)
		PrintOut(li,096,SC1->C1_UM,,)
	Else
		PrintOut(li,023,If(cPaisLoc$"ANG|PTG","Não há","Nao ha'"),,)
	EndIf

	li++
	PrintOut(li,000,__PrtThinLine(),,)
	li++

	If li > 40
		cabec(titulo,cabec1,cabec2,nomeprog,tamanho,IIF(aReturn[4]==1,15,18))
		A140Solic(cDescri,cAliasSC1)
	EndIf




	li++
	PrintOut(li,000,__PrtThinLine(),,)
	li++

	PrintOut(li,00,If(cPaisLoc$"ANG|PTG","| c o n c o r r ê n c i a s                   | entrega         | observações                        | cond.pgt        | contacto          | quantidade     | preço unitário              | iva     | valor                |","| C O N C O R R E N C I A S                   | ENTREGA         | OBSERVACOES                        | COND.PGTO        | CONTATO          | QUANTIDADE     | PRECO UNITARIO              | IPI     | VALOR                |"),,)
	li++
	PrintOut(li,000,"|---------------------------------------------|-----------------|------------------------------------|------------------|------------------|----------------|-----------------------------|---------|----------------------|",,)
	For j :=1 To 4
		li++
		PrintOut(li,000,"|                                             |                 |                                    |                  |                  |                |                             |         |                      |",,)
		li++
		PrintOut(li,000,"|---------------------------------------------|-----------------|------------------------------------|------------------|------------------|----------------|-----------------------------|---------|----------------------|",,)
	next
	dbSelectArea(cAliasSC1)
	li++
	PrintOut(++li,000,"---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",,)
	PrintOut(++li,000,If(cPaisLoc$"ANG|PTG","|                 requisitante                                                                               |                    autorizante                                                                              |","|                 REQUISITANTE                                                                               |                    AUTORIZANTE                                                                              |"),,)
	PrintOut(++li,000,"|                                                                                                            |                                                                                                             |",,)
	PrintOut(++li,000,"|   ------------------------------------------------------------------------------------------------------   |   -------------------------------------------------------------------------------------------------------   |",,)
	PrintOut(++li,000,"|                "+PADC(ALLTRIM(C1_SOLICIT),15)+"                                                                             |                    "+IIF(SC1->(FieldPos("C1_NOMAPRO"))>0,PADC(ALLTRIM(C1_NOMAPRO),15),SPACE(15))+"                                                                          |",,)
	PrintOut(++li,000,"|                                                                                                            |                                                                                                             |",,)
	PrintOut(++li,000,"---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",,)
	li:=80




	If (cAliasSC1)->(FieldPos("C1_QTDREEM")) > 0
		If Ascan(aSavRec,IIf(lQuery,(cAliasSC1)->R_E_C_N_O_,Recno())) == 0
			AADD(aSavRec,IIf(lQuery,(cAliasSC1)->R_E_C_N_O_,Recno()))
		Endif
	EndIf

	dbSkip()

EndDo




dbSelectArea("SC1")
If Len(aSavRec) > 0 .And.  (cAliasSC1)->(FieldPos("C1_QTDREEM")) > 0
	For nX:=1 to Len(aSavRec)
		dbGoto(aSavRec[nX])
		If C1_QTDREEM < nVlrMax
			RecLock("SC1", .F. )
			_FIELD->C1_QTDREEM := (C1_QTDREEM+1)
			MsUnLock()
		Else
			cLmtSol += SC1->C1_NUM + ","
		EndIf
	next
EndIf

RetIndex("SC1")
If File(cArqInd+ OrdBagExt())
	FErase(cArqInd+ OrdBagExt() )
EndIf


	If !lAuto
		If Select("QRYSC1")<>0
			dbSelectArea("QRYSC1")
			dbCloseArea()
		EndIf
	EndIf


If !Empty(cLmtSol)
	Aviso(If( cPaisLoc $ "ANG|PTG", "Aviso reemissao", "Aviso Reemissão" ),If( cPaisLoc $ "ANG|PTG", "O campo 'reemissao' (c1_qtdreem) atingiu o valor ", "O campo 'Reemissao' (C1_QTDREEM) atingiu o valor " ) + "'" + Alltrim(str(nVlrMax)) + "'" + If( cPaisLoc $ "ANG|PTG", " para os pedidos: ", " para as solicitações: " ) + SubStr(cLmtSol,1,len(cLmtSol)-1) + If( cPaisLoc $ "ANG|PTG", "Pedir ao administrador a alteração  no tamanho do campo.", ". Solicite ao administrador a alteração no tamanho do campo." ),{"OK"})
EndIf

If aReturn[5] = 1
	Set( 24, "" )
	dbCommitAll()
	OurSpool(wnrel)
EndIf

MS_FLUSH()

Return .T. 


Function A140Solic(cDescri,cAliasSC1)









Local j







IF !(FindFunction("SIGACUS_V") .and.  SIGACUS_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar sigacus.prw !!!", "Atualizar SIGACUS.PRW !!!" ))
Endif
IF !(FindFunction("SIGACUSA_V") .and.  SIGACUSA_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar sigacusa.prx !!!", "Atualizar SIGACUSA.PRX !!!" ))
Endif
IF !(FindFunction("SIGACUSB_V") .and.  SIGACUSB_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar sigacusb.prx !!!", "Atualizar SIGACUSB.PRX !!!" ))
Endif

PrintOut(li,000,(cAliasSC1)->C1_ITEM,PesqPict("SC1","C1_ITEM"),)
PrintOut(li,005,(cAliasSC1)->C1_PRODUTO,,)
PrintOut(li,037,SubStr(cDescri,1,30),,)
PrintOut(li,071,SB2->B2_QATU,PesqPict("SB2","B2_QATU",12),)
PrintOut(li,086,RetFldProd(SB1->B1_COD,"B1_EMIN"),PesqPict("SB1","B1_EMIN",12),)
PrintOut(li,101,(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,PesqPict("SC1","C1_QUANT",12),)
PrintOut(li,121,(cAliasSC1)->C1_UM,PesqPict("SC1","C1_UM"),)
PrintOut(li,131,(cAliasSC1)->C1_LOCAL,PesqPict("SC1","C1_LOCAL"),)
PrintOut(li,140,RetFldProd(SB1->B1_COD,"B1_QE"),PesqPict("SB1","B1_QE",09),)
PrintOut(li,162,RetFldProd(SB1->B1_COD,"B1_UPRC"),PesqPict("SB1","B1_UPRC",12),)
PrintOut(li,183,CalcPrazo((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_QUANT),"999",)
PrintOut(li,194,If(Empty((cAliasSC1)->C1_DATPRF),(cAliasSC1)->C1_EMISSAO,(cAliasSC1)->C1_DATPRF),,)
PrintOut(li,210,SomaPrazo(If(Empty((cAliasSC1)->C1_DATPRF),(cAliasSC1)->C1_EMISSAO,(cAliasSC1)->C1_DATPRF),-CalcPrazo((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_QUANT)),,)
li++



For j:=31 TO Len(Trim(cDescri)) Step 30
	PrintOut(li,21,SubStr(cDescri,j,30),,)
	li++
next

Return .T. 