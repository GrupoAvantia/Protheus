#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\MATR290.CH"
#line 2 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr290.prx"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Dialog.ch"
#line 28 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Font.ch"
#line 29 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PTMenu.ch"
#line 31 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Print.ch"
#line 33 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Colors.ch"
#line 35 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Folder.ch"
#line 37 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\msobject.ch"
#line 38 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\VKey.ch"
#line 42 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\WinApi.ch"
#line 44 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCommand.ch"
#line 47 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCSS.CH"
#line 50 "PROTHEUS.CH"
#line 17 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr290.prx"
Function MATR290()

Local oReport
Private cAliasSB1 := "SB1"
Private cAliasSB2 := "SB2"

If FindFunction("TRepInUse") .And.  TRepInUse()






	IF !(FindFunction("SIGACUS_V") .and.  SIGACUS_V() >= 20050512)
	    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar ", "Atualizar " )+"SIGACUS.PRW !!!")
	Endif
	IF !(FindFunction("SIGACUSA_V") .and.  SIGACUSA_V() >= 20050512)
	    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar ", "Atualizar " )+"SIGACUSA.PRX !!!")
	Endif
	IF !(FindFunction("SIGACUSB_V") .and.  SIGACUSB_V() >= 20050512)
	    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar ", "Atualizar " )+"SIGACUSB.PRX !!!")
	Endif



	oReport := ReportDef()
	oReport:PrintDialog()
Else
	MATR290R3()
EndIf

Return Nil





















Static Function ReportDef()

Local lVEIC		:= UPPER(GETMV("MV_VEICULO"))=="S"
Local aOrdem	:= {If( cPaisLoc $ "ANG|PTG", " por código         ", " Por Codigo         " ),If( cPaisLoc $ "ANG|PTG", " por tipo           ", " Por Tipo           " ),If( cPaisLoc $ "ANG|PTG", " por descrição     ", " Por Descricao     " ),If( cPaisLoc $ "ANG|PTG", " por grupo        ", " Por Grupo        " )}
Local cAliasTOP := "SB1"
Local cAliasSB3 := "SB3"
Local cPerg		:= "MTR290"
Local oReport
Local oCell
Local oSection1
Local aSB1Cod	:= TAMSX3("B1_COD")
Local aSB1Ite	:= TAMSX3("B1_CODITE")
Local lQuery	:= .f. 
Local nSaldoPro := 0




AjustaSX1(cPerg,lVeic,aSB1Cod,aSB1Ite)












If !lVeic
	Aadd(aOrdem,If( cPaisLoc $ "ANG|PTG", " por consumo       ", " Por Consumo       " ))
EndIf

oReport := TReport():New("MATR290",If( cPaisLoc $ "ANG|PTG", "Relação Para Analise Dos Stocks", "Relacao para Analise dos Estoques" ),cPerg, {|oReport| ReportPrint(oReport,lVeic,@lQuery,@cAliasTOP,@cAliasSB3,@nSaldoPro)},If( cPaisLoc $ "ANG|PTG", "Este relatório demonstra a situação de cada item em relação ao", "Este relatorio demonstra a situacao de cada item em relacao ao" )+" "+If( cPaisLoc $ "ANG|PTG", "Seu saldo , seu alocação , suas entradas previstas e sua classe", "seu saldo , seu empenho , suas entradas previstas e sua classe" )+" "+If( cPaisLoc $ "ANG|PTG", "Abc.", "ABC." ))
oReport:SetLandScape()
oReport:SetTotalInLine( .F. )
oReport:SetTotalText(If( cPaisLoc $ "ANG|PTG", "T o t a l   g e r a l :", "T o t a l   G e r a l :" ))




Pergunte(cPerg, .F. )





































oSection1 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Artigos", "Produtos" ),{"SB1","SB3"},aOrdem,,)
oSection1:SetHeaderPage()

TRCell():New(oSection1,"B1_COD","SB1",,,,,,,,,,,,,)
TRCell():New(oSection1,"B1_CODITE","SB1")
TRCell():New(oSection1,"B1_DESC","SB1")
TRCell():New(oSection1,"B1_TIPO","SB1","Tp")
TRCell():New(oSection1,"B1_GRUPO","SB1")
TRCell():New(oSection1,"B1_UM","SB1","UM")
TRCell():New(oSection1,"B2_QATU" 	,"SB2")
TRCell():New(oSection1,"B2_QEMP" 	,"SB2")
TRCell():New(oSection1,"C1_QUANT" 	,"SC1","SCs"+Chr(13)+Chr(10)+"Colocadas")
TRCell():New(oSection1,"C7_QUANT" 	,"SC7","PCs"+Chr(13)+Chr(10)+"Colocados")
TRCell():New(oSection1,"C2_QUANT" 	,"SC2","OPs"+Chr(13)+Chr(10)+"Colocadas")
TRCell():New(oSection1,"C6_QTDVEN" 	,"SC6","PVs"+Chr(13)+Chr(10)+"Colocados")
TRCell():New(oSection1,"B1_EMIN" 	,"SB1",,,,,{|| RetFldProd((cAliasTop)->B1_COD,"B1_EMIN",If(lQuery,cAliasTop,)) })
TRCell():New(oSection1,"B1_LE" 	    ,"SB1",,,,,{|| RetFldProd((cAliasTop)->B1_COD,"B1_LE",If(lQuery,cAliasTop,))   })
TRCell():New(oSection1,"B1_PE" 	    ,"SB1",,,,,{|| CalcPrazo((cAliasTop)->B1_COD,RetFldProd((cAliasTop)->B1_COD,"B1_LE",If(lQuery,cAliasTop,))) })
TRCell():New(oSection1,"B1_TIPE"	,"SB1"," ",,,,{|| RetFldProd((cAliasTop)->B1_COD,"B1_TIPE",If(lQuery,cAliasTop,)) })
TRCell():New(oSection1,"ESTMES"		,"   ",If( cPaisLoc $ "ANG|PTG", "Stock", "Estoque" )+Chr(13)+Chr(10)+If( cPaisLoc $ "ANG|PTG", "Em Meses", "em Meses" ),,,,{|| If((cAliasSB3)->B3_MEDIA <> 0,Transform(nSaldoPro/(cAliasSB3)->B3_MEDIA,"99999"),If( cPaisLoc $ "ANG|PTG", "  N/d", "  N/D" )) })
TRCell():New(oSection1,"B3_MEDIA" 	,"SB3")
TRCell():New(oSection1,"B2_USAI" 	,"SB2")

TRCell():New(oSection1,"CLASSE" 	,"SB3",If( cPaisLoc $ "ANG|PTG", "Cl", "CL" ),,,,{||(cAliasSB3)->B3_CLASSE })

Return(oReport)


























Static Function ReportPrint(oReport,lVeic,lQuery,cAliasTOP,cAliasSB3,nSaldoPro)

Local XSB1, XSB2, XSB3, XSC1, XSC2, XSC6, XSC7, XSC9, XSF4
Local oSection1	:= oReport:Section(1)
Local cOrdem
Local nOrdem    := oReport:Section(1):GetOrder()
Local oBreak
Local nEmpPro,nSCPro,nPCPro,nOPPro,nPVPro
Local dUsai,nSaldo,nEmin,lT
Local cLocProc := GETMV("MV_LOCPROC")
Local cFiltro,cCondicao
Local cArqTmp	:= ""
Local cChave	:= ""



  	Local cOrderBy
	Local cWhere
	lQuery		:= .T. 

Private cVar ,cCondSec

If nOrdem == 1
	cOrdem := If( cPaisLoc $ "ANG|PTG", " por código         ", " Por Codigo         " )
ElseIf nOrdem == 2
	cOrdem := If( cPaisLoc $ "ANG|PTG", " por tipo           ", " Por Tipo           " )
ElseIf nOrdem == 3
	cOrdem := If( cPaisLoc $ "ANG|PTG", " por descrição     ", " Por Descricao     " )
ElseIf nOrdem == 4
	cOrdem := If( cPaisLoc $ "ANG|PTG", " por grupo        ", " Por Grupo        " )
ElseIf nOrdem == 5
	cOrdem := If( cPaisLoc $ "ANG|PTG", " por consumo       ", " Por Consumo       " )
EndIf



oReport:SetTitle(oReport:Title()+" ("+AllTrim(cOrdem)+")" )




dbSelectArea("SF4")
dbSetOrder(1)
XSF4	:= XFILIAL("SF4")

dbSelectArea("SC9")
dbSetOrder(1)
XSC9	:= XFILIAL("SC9")

dbSelectArea("SC7")
dbSetOrder(1)
XSC7	:= XFILIAL("SC7")

dbSelectArea("SC6")
dbSetOrder(1)
XSC6	:= XFILIAL("SC6")

dbSelectArea("SC2")
dbSetOrder(1)
XSC2	:= XFILIAL("SC2")

dbSelectArea("SC1")
dbSetOrder(1)
XSC1	:= XFILIAL("SC1")

dbSelectArea("SB3")
dbSetOrder(1)
XSB3	:= XFILIAL("SB3")

dbSelectArea("SB2")
dbSetOrder(1)
XSB2	:= XFILIAL("SB2")

dbSelectArea("SB1")
dbSetOrder(1)
XSB1	:= XFILIAL("SB1")




If lVeic
	oSection1:Cell("B1_COD"):Disable()
	oSection1:Cell("C2_QUANT"):Disable()
Else
	oSection1:Cell("B1_CODITE"):Disable()
EndIf




If lQuery



	MakeSqlExpr(oReport:GetParam())




	cCondicao := "!Eof()"
	cWhere := "%"
	If lVeic
		cWhere += " AND SB1.B1_CODITE >= '" + mv_par01 + "' AND SB1.B1_CODITE <='" + mv_par02 + "' "
	Else
		cWhere += " AND SB1.B1_COD    >= '" + mv_par01 + "' AND SB1.B1_COD    <='" + mv_par02 + "' "
	EndIf
	cWhere += "%"

	cOrderBy := "%"
	If ! lVEIC
		If nOrdem == 5
			cOrderBy += " B3_MEDIA"
		ElseIf nOrdem == 4
			cOrderBy += " B1_GRUPO, B1_COD"
		ElseIf nOrdem == 3
			cOrderBy += " B1_DESC, B1_COD"
		ElseIf nOrdem == 2
			cOrderBy += " B1_TIPO, B1_COD"
		Else
			cOrderBy += " B1_COD"
		EndIf
	Else
		If nOrdem == 4
			cOrderBy += " B1_GRUPO, B1_CODITE"
		ElseIf nOrdem == 3
			cOrderBy += " B1_DESC, B1_CODITE"
		ElseIf nOrdem == 2
			cOrderBy += " B1_TIPO, B1_CODITE"
		Else
			cOrderBy += " B1_CODITE"
		Endif
	EndIf
	cOrderBy += "%"

	oReport:Section(1):BeginQuery()

	cAliasTOP := GetNextAlias()
	cAliasSB3 := cAliasTOP

	If nOrdem <> 5
























__execSql(cAliasTOP," SELECT B1_FILIAL,B1_COD,B1_CODITE,B1_DESC,B1_TIPO,B1_GRUPO,B1_UM,B1_EMIN,B1_LE,B1_TIPE, B3_FILIAL,B3_COD,B3_MEDIA,B3_CLASSE FROM  "+RetSqlName('SB1')+" SB1 LEFT JOIN  "+RetSqlName('SB3')+" SB3 ON B3_FILIAL =  '" +xFilial('SB3')+"'  AND B3_COD = B1_COD AND SB3.D_E_L_E_T_= ' ' WHERE B1_FILIAL =  '" +xFilial('SB1')+"'  AND B1_TIPO >=  "+___SQLGetValue(MV_PAR03)+" AND B1_TIPO <=  "+___SQLGetValue(MV_PAR04)+" AND B1_GRUPO >=  "+___SQLGetValue(MV_PAR05)+" AND B1_GRUPO <=  "+___SQLGetValue(MV_PAR06)+" AND B1_DESC >=  "+___SQLGetValue(MV_PAR07)+" AND B1_DESC <=  "+___SQLGetValue(MV_PAR08)+" AND SB1.D_E_L_E_T_= ' '  "+___SQLGetValue(CWHERE)+" ORDER BY  "+___SQLGetValue(CORDERBY),{},.F.)

	Else























__execSql(cAliasTOP," SELECT B1_FILIAL,B1_COD,B1_CODITE,B1_DESC,B1_TIPO,B1_GRUPO,B1_UM,B1_EMIN,B1_LE,B1_TIPE, B3_FILIAL,B3_COD,B3_MEDIA,B3_CLASSE FROM  "+RetSqlName('SB1')+" SB1 RIGHT JOIN  "+RetSqlName('SB3')+" SB3 ON B3_FILIAL =  '" +xFilial('SB3')+"'  AND B3_COD = B1_COD AND SB3.D_E_L_E_T_= ' ' WHERE B1_FILIAL =  '" +xFilial('SB1')+"'  AND B1_TIPO >=  "+___SQLGetValue(MV_PAR03)+" AND B1_TIPO <=  "+___SQLGetValue(MV_PAR04)+" AND B1_GRUPO >=  "+___SQLGetValue(MV_PAR05)+" AND B1_GRUPO <=  "+___SQLGetValue(MV_PAR06)+" AND B1_DESC >=  "+___SQLGetValue(MV_PAR07)+" AND B1_DESC <=  "+___SQLGetValue(MV_PAR08)+" AND SB1.D_E_L_E_T_= ' '  "+___SQLGetValue(CWHERE)+" ORDER BY  "+___SQLGetValue(CORDERBY),{},.F.)

	EndIf








	oReport:Section(1):EndQuery()

Else

	dbSelectArea("SB1")
	Set( 9,"ON" )
	If nOrdem == 5
		dbSetOrder(1)
	Else
		dbSetOrder(nOrdem)
	EndIf
	cIndex := Indexkey()

	If lVeic
		cCondSB1 := "B1_CODITE >= mv_par01 .And. B1_CODITE <= mv_par02"
	Else
		cCondSB1 := "B1_COD    >= mv_par01 .And. B1_COD    <= mv_par02"
	EndIf
	cCondSB1 += ".And. B1_TIPO  >= mv_par03 .And. B1_TIPO  <= mv_par04"
	cCondSB1 += ".And. B1_GRUPO >= mv_par05 .And. B1_GRUPO <= mv_par06"
	cCondSB1 += ".And. B1_DESC  >= mv_par07 .And. B1_DESC  <= mv_par08"




	MakeAdvplExpr(oReport:GetParam())



	oSection1:SetFilter(cCondSB1,cIndex)

	if ! lVEIC
		If nOrdem == 4
			dbSeek( xSB1+mv_par05, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
			cCondicao := "!Eof() .And. B1_GRUPO <= mv_par06"
		ElseIf nOrdem == 3
			dbSeek( xSB1+mv_par07, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
			cCondicao := "!Eof() .And. B1_DESC <= mv_par08"
		ElseIf nOrdem == 2
			dbSeek( xSB1+mv_par03, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
			cCondicao := "!Eof() .And. B1_TIPO <= mv_par04"
		Else
			dbSeek( xSB1+mv_par01, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
			cCondicao := "!Eof() .And. B1_COD <= mv_par02"
		Endif
	else
		If nOrdem == 4
			dbSetOrder( 7 )
			dbSeek( xSB1+mv_par05, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
			cCondicao := "!Eof() .And. B1_GRUPO <= mv_par06"
		ElseIf nOrdem == 3
			dbSeek( xSB1+mv_par07, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
			cCondicao := "!Eof() .And. B1_DESC <= mv_par08"
		ElseIf nOrdem == 2
			cFiltro   :=      "B1_TIPO>='" + mv_par03 + "'"
			cFiltro   += ".And.B1_TIPO<='" + mv_par04 + "'"
			cFiltro   += ".and.B1_FILIAL=='" + xSB1 + "'"
			cArqTmp   := CriaTrab("", .F. )
			IndRegua("SB1",cArqTmp,"B1_FILIAL+B1_TIPO+B1_CODITE",,cFiltro,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
			nIndr	:=	RetIndex("SB1")
			dbSetIndex(cArqTmp+OrdBagExt())
			dbSetOrder(nIndr + 1)
			dbSeek(xSB1 + mv_par03, .T. )
			cCondicao := "!Eof() .And. B1_TIPO <= mv_par04"
		Else
			cFiltro   :=      "B1_CODITE>='" + mv_par01 + "'"
			cFiltro   += ".And.B1_CODITE<='" + mv_par02 + "'"
			cFiltro   += ".and.B1_FILIAL=='" + xSB1 + "'"
			cArqTmp   := CriaTrab("", .F. )
			IndRegua("SB1",cArqTmp,"B1_FILIAL+B1_CODITE",,cFiltro,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
			nIndr	:=	RetIndex("SB1")
			dbSetIndex(cArqTmp+OrdBagExt())
			dbSetOrder(nIndr + 1)
			dbSeek(xSB1 + mv_par01, .T. )
			cCondicao := "!Eof() .And. B1_CODITE <= mv_par02"
		Endif
	endif
	Set( 9,"OFF" )

EndIf




If nOrdem == 2
	oBreak := TRBreak():New(oSection1,oSection1:Cell("B1_TIPO"),If( cPaisLoc $ "ANG|PTG", "T o t a l  d o   t i p o : ", "T o t a l  d o   T i p o : " ), .F. )
ElseIf nOrdem == 4
	oBreak := TRBreak():New(oSection1,oSection1:Cell("B1_GRUPO"),If( cPaisLoc $ "ANG|PTG", "T o t a l   d o   g r u p o : ", "T o t a l   d o   G r u p o : " ), .F. )
EndIf



TRFunction():New(oSection1:Cell("B2_QATU"  ),NIL,"SUM",oBreak,NIL,,, .F. , .T. )
TRFunction():New(oSection1:Cell("B2_QEMP"  ),NIL,"SUM",oBreak,NIL,,, .F. , .T. )
TRFunction():New(oSection1:Cell("C1_QUANT" ),NIL,"SUM",oBreak,NIL,,, .F. , .T. )
TRFunction():New(oSection1:Cell("C7_QUANT" ),NIL,"SUM",oBreak,NIL,,, .F. , .T. )
TRFunction():New(oSection1:Cell("C2_QUANT" ),NIL,"SUM",oBreak,NIL,,, .F. , .T. )
TRFunction():New(oSection1:Cell("C6_QTDVEN"),NIL,"SUM",oBreak,NIL,,, .F. , .T. )




dbSelectArea("SC1")
dbSetOrder(2)

dbSelectArea("SC2")
dbSetOrder(2)

dbSelectArea("SC6")
dbSetOrder(2)

dbSelectArea("SC7")
dbSetOrder(2)




oReport:SetMeter( SB1->(LastRec()) )

If nOrdem == 5 .And.  !lQuery
	dbSelectArea("SB3")
	cCondicao := " SB3->(!Eof())"
	cFiltro   :=      "B3_COD>='" + mv_par01 + "'"
	cFiltro   += ".And.B3_COD<='" + mv_par02 + "'"
	cFiltro   += ".and.B3_FILIAL=='" + xSB3 + "'"
	cArqTmp   := CriaTrab("", .F. )
	IndRegua("SB3",cArqTmp,"STR(B3_MEDIA)",,cFiltro,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
	nIndSb3:=RetIndex("SB3")
	dbSetIndex(cArqTmp+OrdBagExt())
	dbSetOrder(nIndSb3 + 1)
	dbGotop()
Else
	dbSelectArea(cAliasTOP)
	cCondicao += ".and.B1_FILIAL=='" + xSB1 + "'"
Endif

oSection1:Init()
While !oReport:Cancel() .And.  &(cCondicao)
	cCondSec := "B1_FILIAL=='" + xSB1 + "' .And. "
	if ! lVEIC
		If nOrdem == 5 .And.  !lQuery
	  		dbSelectArea("SB1")
	  		dbSetOrder(1)
			dbSeek(xSB1 + SB3->B3_COD)
			cCondSec += "B1_COD == SB3->B3_COD"
		ElseIf nOrdem == 4
			cVar     := B1_GRUPO
			cCondSec += "B1_GRUPO == cVar"
		ElseIf nOrdem == 3
			cVar     := B1_DESC
			cCondSec += "B1_DESC == cVar"
		ElseIf nOrdem == 2
			cVar     := B1_TIPO
			cCondSec += "B1_TIPO == cVar"
		Else
			cVar     := B1_COD
			cCondSec += "B1_COD == cVar"
		Endif
	ELSE
		If nOrdem == 4
			cVar     := B1_GRUPO
			cCondSec += "B1_GRUPO == cVar"
		ElseIf nOrdem == 3
			cVar     := B1_DESC
			cCondSec += "B1_DESC == cVar"
		ElseIf nOrdem == 2
			cVar     := B1_TIPO
			cCondSec += "B1_TIPO == cVar"
		Else
			cVar     := B1_CODITE
			cCondSec += "B1_CODITE == cVar"
		Endif
	ENDIF

	while !oReport:Cancel() .And. &(cCondicao) .And. &(cCondSec)

		oReport:IncMeter()

		lT := .F. 
		If ! lVEIC
			If B1_COD < mv_par01 .Or.  B1_COD > mv_par02
	   			lT := .T. 
	        endif
		Else
			if B1_CODITE < mv_par01 .Or.  B1_CODITE > mv_par02
	   			lT := .T. 
			endif
		EndIf


		If lT .Or.  B1_TIPO < mv_par03 .Or.  B1_TIPO > mv_par04 .Or.  B1_GRUPO < mv_par05 .Or.  B1_GRUPO > mv_par06 .Or.  B1_DESC < mv_par07 .Or.  B1_DESC > mv_par08
			dbSkip()
			Loop
		EndIf

		nSaldoPro := nEmpPro := nSCPro := nPCPro := nOPPro := nPVPro := 0




		dbSelectArea("SB2")
		dbSeek( xSB2+(cAliasTop)->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		dUsai := B2_USAI
		while !oReport:Cancel() .And. !Eof() .And. B2_FILIAL+B2_COD==xSB2+(cAliasTop)->B1_COD

			IF B2_LOCAL == cLocProc .and.  mv_par13 == 2
				dbSkip()
				Loop
			Endif

			If B2_LOCAL < mv_par17 .Or.  B2_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			nSaldoPro += B2_QATU
			nEmpPro   += If(mv_par16==1,B2_QEMP,If(mv_par16==2,B2_QEMPPRE,B2_QEMP+B2_QEMPPRE))
			nEmpPro   += If(mv_par20==1,B2_QEMPPRJ,0)
			nEmpPro   += B2_RESERVA+B2_QEMPSA
			If dUsai < B2_USAI
				dUsai := B2_USAI
			EndIf
			dbSkip()

		EndDo



		If oReport:Cancel()
			Exit
		EndIf




		If mv_par10 == 1
			nSaldoPro -= nEmpPro
		EndIf




		If mv_par11 == 1 .And.  (Empty(dUsai) .Or.  dUsai > mv_par12)
			dbSelectArea(cAliasTop)
			dbSkip()
			Loop
		EndIf




		If nOrdem <> 5 .And.  !lQuery
			dbSelectArea("SB3")
			dbSeek(xSB3 + (cAliasTop)->B1_COD)
		EndIf




		dbSelectArea("SC1")
		dbSeek( xSC1+(cAliasTop)->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		while !oReport:Cancel() .And. !Eof() .And. C1_FILIAL+C1_PRODUTO==xSC1+(cAliasTop)->B1_COD

			If C1_LOCAL < mv_par17 .Or.  C1_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			If C1_QUJE < C1_QUANT .And.  MtrAvalOp(mv_par16,"SC1")
				nSCPro += (C1_QUANT - C1_QUJE)
			EndIf
			dbSkip()

		EndDo



		If oReport:Cancel()
			Exit
		EndIf

		if ! lVEIC



			dbSelectArea("SC2")
			dbSeek(xSC2 + (cAliasTop)->B1_COD)

			while !oReport:Cancel() .And. !Eof() .And. C2_FILIAL+C2_PRODUTO==xSC2+(cAliasTop)->B1_COD

				If C2_LOCAL < mv_par17 .Or.  C2_LOCAL > mv_par18
					dbSkip()
					Loop
				EndIf

				If Empty(C2_DATRF) .And.  (aSC2Sld()) > 0 .And.  MtrAvalOp(mv_par16)
					nOPPro += (aSC2Sld())
				EndIf
				dbSkip()

			EndDo
		endif



		If oReport:Cancel()
			Exit
		EndIf




		dbSelectArea("SC6")
		dbSeek( xSC6+(cAliasTop)->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )

		while !oReport:Cancel() .And. !Eof() .And. C6_FILIAL+C6_PRODUTO==xSC6+(cAliasTop)->B1_COD

			If C6_LOCAL < mv_par17 .Or.  C6_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			If mv_par14 == 1
				dbSelectArea("SF4")
				dbSetOrder(1)
				dbSeek(xSF4 + SC6->C6_TES)
				dbSelectArea("SC6")
				If SF4->F4_ESTOQUE <> "S"
					dbSkip()
					Loop
				End
			End




			If mv_par19 == 2 .And.  AllTrim(C6_BLQ) == "R"
				dbSkip()
				Loop
			EndIf

			nPVPro += SC6->C6_QTDVEN
			dbSelectArea("SC9")
			dbSetOrder(1)
			cChave := xSC9 + SC6->C6_NUM + SC6->C6_ITEM
			If dbSeek(cChave)
				While !oReport:Cancel() .And.  ! SC9->(EOF()) .And.  cChave = SC9->C9_FILIAL + SC9->C9_PEDIDO + SC9->C9_ITEM
					If C9_LOCAL < mv_par17 .Or.  C9_LOCAL > mv_par18
						dbSkip()
						Loop
					EndIf

					If (Empty(SC9->C9_BLEST) .And.  Empty(SC9->C9_BLCRED)) .And. + SC9->C9_PRODUTO == SC6->C6_PRODUTO
						nPvPro -= SC9->C9_QTDLIB
					ElseIf SC9->C9_BLEST == "10" .AND.  SC9->C9_PRODUTO == SC6->C6_PRODUTO
						nPvPro -= SC9->C9_QTDLIB
					EndIF
					dbskip()
				End
			Endif
			nPVPro := Max(0,nPVPro)
			dbSelectArea("SC6")
			dbSkip()

		EndDo



		If oReport:Cancel()
			Exit
		EndIf



		dbSelectArea("SC7")
		dbSeek( xSC7+(cAliasTop)->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )

		While !oReport:Cancel() .And.  !Eof() .And.  C7_FILIAL + C7_PRODUTO == xSC7 + (cAliasTop)->B1_COD

			If C7_LOCAL < mv_par17 .Or.  C7_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			If (C7_QUANT-C7_QUJE) > 0 .And.  Empty(C7_RESIDUO) .And.  MtrAvalOp(mv_par16,"SC7")
				nPCPro += (C7_QUANT-C7_QUJE)
			EndIf
			dbSkip()

		EndDo



		If oReport:Cancel()
			Exit
		EndIf



		If mv_par09 == 2
			nSaldo	:= nSaldoPro+nSCPro+nPCPro+nOPPro
			nEmin	:= RetFldProd((cAliasTop)->B1_COD,"B1_EMIN",If(lQuery,cAliasTop,))
			If nSaldo > nEmin .Or.  (nEmin == 0 .And.  nSaldo == 0)
				dbSelectArea(cAliasTop)
				dbSkip()
				Loop
			EndIf
		EndIf




		If mv_par15 == 2 .And.  nSaldoPro == 0
			dbSelectArea(cAliasTop)
			dbSkip()
			Loop
		Endif

		dbSelectArea(cAliasTop)
		oSection1:Cell("B2_QATU"   ):SetValue( nSaldoPro )
		oSection1:Cell("B2_QEMP"   ):SetValue( nEmpPro )
		oSection1:Cell("C1_QUANT"  ):SetValue( nSCPro )
		oSection1:Cell("C7_QUANT"  ):SetValue( nPCPro )
		If !lVeic
			oSection1:Cell("C2_QUANT"  ):SetValue( nOPPro )
		EndIf
		oSection1:Cell("C6_QTDVEN" ):SetValue( nPVPro )
		oSection1:Cell("B2_USAI" ):SetValue( dUsai )

		oSection1:PrintLine()

		dbSelectArea(cAliasTop)
		dbSkip()

	EndDo

	If nOrdem == 5 .And.  !lQuery
		dbSelectArea("SB3")
		dbSkip()
	Else
		dbSelectArea(cAliasTop)
	EndIf

EndDo

oSection1:Finish()




dbSelectArea("SC1")
dbSetOrder(1)
dbSelectArea("SC2")
dbSetOrder(1)
dbSelectArea("SC6")
dbSetOrder(1)
dbSelectArea("SC7")
dbSetOrder(1)




If nOrdem == 5 .And.  !lQuery
	dbSelectArea("SB3")
	Ferase(cArqTmp+OrdBagExt())
	dbSetOrder(1)
EndIf

Return Nil



































Function Matr290R3()



LOCAL Tamanho  := "G"
LOCAL titulo   := If( cPaisLoc $ "ANG|PTG", "Relação Para Analise Dos Stocks", "Relacao para Analise dos Estoques" )
LOCAL cDesc1   := If( cPaisLoc $ "ANG|PTG", "Este relatório demonstra a situação de cada item em relação ao", "Este relatorio demonstra a situacao de cada item em relacao ao" )
LOCAL cDesc2   := If( cPaisLoc $ "ANG|PTG", "Seu saldo , seu alocação , suas entradas previstas e sua classe", "seu saldo , seu empenho , suas entradas previstas e sua classe" )
LOCAL cDesc3   := If( cPaisLoc $ "ANG|PTG", "Abc.", "ABC." )
LOCAL cString  := "SB1"
LOCAL nTipo    := 0
LOCAL aOrd     := {OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por código         ", " Por Codigo         " )),OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por tipo           ", " Por Tipo           " )),OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por descrição     ", " Por Descricao     " )),OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por grupo        ", " Por Grupo        " )),OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por consumo       ", " Por Consumo       " ))}
LOCAL wnrel := "MATR290"




Private lVEIC		:= UPPER(GETMV("MV_VEICULO"))=="S"
Private aSB1Cod	:= {}
Private aSB1Ite	:= {}
Private nCOL1		:= 0
Private nCOL2		:= 0
Private XSB1, XSB2, XSB3, XSC1, XSC2, XSC6, XSC7, XSC9, XSF4




PRIVATE aReturn:= {OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Código de barras", "Zebrado" )), 1,OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Administração", "Administracao" )), 1, 2, 1, "",1 }
PRIVATE nLastKey:= 0 ,cPerg := "MTR290"







IF !(FindFunction("SIGACUS_V") .and.  SIGACUS_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar ", "Atualizar " )+"SIGACUS.PRW !!!")
Endif
IF !(FindFunction("SIGACUSA_V") .and.  SIGACUSA_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar ", "Atualizar " )+"SIGACUSA.PRX !!!")
Endif
IF !(FindFunction("SIGACUSB_V") .and.  SIGACUSB_V() >= 20050512)
    Final(If( cPaisLoc $ "ANG|PTG", "Actualizar ", "Atualizar " )+"SIGACUSB.PRX !!!")
Endif

dbSelectArea("SF4")
dbSetOrder(1)
XSF4	:= XFILIAL("SF4")

dbSelectArea("SC9")
dbSetOrder(1)
XSC9	:= XFILIAL("SC9")

dbSelectArea("SC7")
dbSetOrder(1)
XSC7	:= XFILIAL("SC7")

dbSelectArea("SC6")
dbSetOrder(1)
XSC6	:= XFILIAL("SC6")

dbSelectArea("SC2")
dbSetOrder(1)
XSC2	:= XFILIAL("SC2")

dbSelectArea("SC1")
dbSetOrder(1)
XSC1	:= XFILIAL("SC1")

dbSelectArea("SB3")
dbSetOrder(1)
XSB3	:= XFILIAL("SB3")


dbSelectArea("SB2")
dbSetOrder(1)
XSB2	:= XFILIAL("SB2")

dbSelectArea("SB1")
dbSetOrder(1)
XSB1	:= XFILIAL("SB1")




aSB1Cod	:= TAMSX3("B1_COD")
aSB1Ite	:= TAMSX3("B1_CODITE")

if lVEIC

	aOrd     := {OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por código         ", " Por Codigo         " )),OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por tipo           ", " Por Tipo           " )),OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por descrição     ", " Por Descricao     " )),OemToAnsi(If( cPaisLoc $ "ANG|PTG", " por grupo        ", " Por Grupo        " ))}
	nCOL1		:= ABS(aSB1Cod[1] - aSB1Ite[1])
	nCOL2		:= -15
endif




AjustaSX1(cPerg,lVeic,aSB1Cod,aSB1Ite)




Pergunte(cPerg, .F. )


























wnrel:=SetPrint(cString,wnrel,cPerg,@titulo,cDesc1,cDesc2,cDesc3, .F. ,aOrd, .F. ,Tamanho)

If nLastKey = 27
	dbClearFilter()
	Return
Endif

SetDefault(aReturn,cString)

If nLastKey = 27
	dbClearFilter()
	Return
Endif
RptStatus({|lEnd| C290Imp(aOrd,@lEnd,wnRel,cString,tamanho,titulo)},titulo)
Return NIL














Static Function C290Imp(aOrd,lEnd,WnRel,cString,tamanho,titulo)




LOCAL cRodaTxt := If( cPaisLoc $ "ANG|PTG", "Artigo(s)", "PRODUTO(S)" )
LOCAL nCntImpr := 0
LOCAL nSaldoPro,nEmpPro,nSCPro,nPCPro,nOPPro,nPVPro
LOCAL nSaldoSub,nEmpSub,nSCSub,nPCSub,nOPSub,nPVSub
LOCAL nSaldoTot,nEmpTot,nSCTot,nPCTot,nOPTot,nPVTot
LOCAL lPAssou1,lPassou2,nFirst := 0,dUsai,nSaldo, cLocProc := GETMV("MV_LOCPROC")
LOCAL cArqTmp,cFiltro
Local cChave := ""




LOCAL nAux1
LOCAL nI
LOCAL nLenc
Local nIndr
Local lT
LOCAL nEstouro




PRIVATE li := 80 ,m_pag := 1




PRIVATE cCondicao ,lContinua ,cVar ,cCondSec




nTipo  := IIF(aReturn[4]==1,GetMV("MV_COMP"),GetMV("MV_NORM"))




If Type("NewHead")#"U"
	NewHead += " ("+AllTrim(aOrd[aReturn[8]])+")"
Else
	Titulo += " ("+AllTrim(aOrd[aReturn[8]])+")"
EndIf




cabec1 := "CODIGO          DESCRICAO                       TP GRUP UM       SALDO EM   EMPENHO PARA           SC's PC's/CONTRATOS           OP's           PV's       PONTO DE         LOTE   PRAZO  ESTOQUE   CONSUMO     ULTIMA   CL  "
cabec2 := If( cPaisLoc $ "ANG|PTG", "                                                                  stock req/pv/reserva      colocadas      colocados      colocadas      colocados         pedido    económico entrega em meses     médio      saída       ", "                                                                  ESTOQUE REQ/PV/RESERVA      COLOCADAS      COLOCADOS      COLOCADAS      COLOCADOS         PEDIDO    ECONOMICO ENTREGA EM MESES     MEDIO      SAIDA       " )











cArqTmp	:= ""
if lVEIC
	cabec1:= substr(cabec1 ,1,aSB1Cod[1]) + SPACE(nCOL1) + substr(cabec1 ,aSB1Cod[1]+1)
	cabec2:= substr(cabec2 ,1,aSB1Cod[1]) + SPACE(nCOL1) + substr(cabec2 ,aSB1Cod[1]+1)


	nAux1	:= AT("CONTRA",UPPER(cabec1))
	nLenc	:= LEN(cabec1)
	IF nAux1 > 0
	   FOR nI := nAux1 TO nLenc
	      IF SUBStr(cabec1,nI, 1 ) == " "
	         exit
	      endif
	   next
		cabec1:= substr(cabec1 ,1, nI-1 ) + substr(cabec1 ,nI + 15)
		cabec2:= substr(cabec2 ,1, nI-1 ) + substr(cabec2 ,nI + 15)
	ENDIF
endif

dbSelectArea("SB1")
SetRegua(LastRec())

Set( 9,"ON" )

if ! lVEIC
	ordSetFocus( aReturn[8] )
	If aReturn[8] == 4
		dbSeek( xSB1+mv_par05, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		cCondicao := "lContinua .And. !Eof() .And. B1_GRUPO <= mv_par06"
	ElseIf aReturn[8] == 3
		dbSeek( xSB1+mv_par07, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		cCondicao := "lContinua .And. !Eof() .And. B1_DESC <= mv_par08"
	ElseIf aReturn[8] == 2
		dbSeek( xSB1+mv_par03, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		cCondicao := "lContinua .And. !Eof() .And. B1_TIPO <= mv_par04"
	Else
		dbSeek( xSB1+mv_par01, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		cCondicao := "lContinua .And. !Eof() .And. B1_COD <= mv_par02"
	Endif
else
	ordSetFocus( aReturn[8] )
	If aReturn[8] == 4
		dbSetOrder( 7 )
		dbSeek( xSB1+mv_par05, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		cCondicao := "lContinua .And. !Eof() .And. B1_GRUPO <= mv_par06"
	ElseIf aReturn[8] == 3
		dbSeek( xSB1+mv_par07, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		cCondicao := "lContinua .And. !Eof() .And. B1_DESC <= mv_par08"
	ElseIf aReturn[8] == 2
		cFiltro   :=      "B1_TIPO>='" + mv_par03 + "'"
		cFiltro   += ".And.B1_TIPO<='" + mv_par04 + "'"
		cFiltro   += ".and.B1_FILIAL=='" + xSB1 + "'"
		cArqTmp   := CriaTrab("", .F. )
		IndRegua("SB1",cArqTmp,"B1_FILIAL+B1_TIPO+B1_CODITE",,cFiltro,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
		nIndr	:=	RetIndex("SB1")



		dbSetOrder(nIndr + 1)
		dbSeek(xSB1 + mv_par03, .T. )
		cCondicao := "lContinua .And. !Eof() .And. B1_TIPO <= mv_par04"
	Else
		cFiltro   :=      "B1_CODITE>='" + mv_par01 + "'"
		cFiltro   += ".And.B1_CODITE<='" + mv_par02 + "'"
		cFiltro   += ".and.B1_FILIAL=='" + xSB1 + "'"
		cArqTmp   := CriaTrab("", .F. )
		IndRegua("SB1",cArqTmp,"B1_FILIAL+B1_CODITE",,cFiltro,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
		nIndr	:=	RetIndex("SB1")



		dbSetOrder(nIndr + 1)
		dbSeek(xSB1 + mv_par01, .T. )
		cCondicao := "lContinua .And. !Eof() .And. B1_CODITE <= mv_par02"
	Endif
endif
Set( 9,"OFF" )




dbSelectArea("SC1")
dbSetOrder(2)

dbSelectArea("SC2")
dbSetOrder(2)

dbSelectArea("SC6")
dbSetOrder(2)

dbSelectArea("SC7")
dbSetOrder(2)

nSaldoTot := nEmpTot := nSCTot := nPCTot := nOPTot := nPVTot := 0
lPassou1  := .F. 
lContinua := .T. 

If aReturn[8] == 5
	dbSelectArea("SB3")
	cCondicao := "lContinua .And. SB3->(!Eof())"
	cFiltro   :=      "B3_COD>='" + mv_par01 + "'"
	cFiltro   += ".And.B3_COD<='" + mv_par02 + "'"
	cFiltro   += ".and.B3_FILIAL=='" + xSB3 + "'"
	cArqTmp   := CriaTrab("", .F. )
	IndRegua("SB3",cArqTmp,"STR(B3_MEDIA)",,cFiltro,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
	nIndSb3:=RetIndex("SB3")



	dbSetOrder(nIndSb3 + 1)
	dbGotop()
Else
	dbSelectArea("SB1")
	cCondicao += ".and.B1_FILIAL=='" + xSB1 + "'"
Endif
while&cCondicao
   cCondSec := "B1_FILIAL=='" + xSB1 + "' .And. "
	if ! lVEIC
		If aReturn[8] == 5
	  		dbSelectArea("SB1")
	  		dbSetOrder(1)
			dbSeek(xSB1 + SB3->B3_COD)
			cCondSec += "B1_COD == SB3->B3_COD"
		ElseIf aReturn[8] == 4
			cVar     := B1_GRUPO
			cCondSec += "B1_GRUPO == cVar"
		ElseIf aReturn[8] == 3
			cVar     := B1_DESC
			cCondSec += "B1_DESC == cVar"
		ElseIf aReturn[8] == 2
			cVar     := B1_TIPO
			cCondSec += "B1_TIPO == cVar"
		Else
			cVar     := B1_COD
			cCondSec += "B1_COD == cVar"
		Endif
	ELSE
		If aReturn[8] == 4
			cVar     := B1_GRUPO
			cCondSec += "B1_GRUPO == cVar"
		ElseIf aReturn[8] == 3
			cVar     := B1_DESC
			cCondSec += "B1_DESC == cVar"
		ElseIf aReturn[8] == 2
			cVar     := B1_TIPO
			cCondSec += "B1_TIPO == cVar"
		Else
			cVar     := B1_CODITE
			cCondSec += "B1_CODITE == cVar"
		Endif
	ENDIF
	nSaldoSub := nEmpSub := nSCSub := nPCSub := nOPSub := nPVSub := 0
	lPassou2 := .F. 
	while&cCondicao .And. &(cCondSec)

		If lEnd
			PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
			lContinua := .F. 
			Exit
		EndIf

		IncRegua()

		lT := .F. 
		if ! lVEIC
			If B1_COD < mv_par01 .Or.  B1_COD > mv_par02
	   		lT := .T. 
         endif
      else
			if B1_CODITE < mv_par01 .Or.  B1_CODITE > mv_par02
	   		lT := .T. 
			endif
		EndIf
		if lT
			dbSkip()
			Loop
		EndIf

		If B1_TIPO < mv_par03 .Or.  B1_TIPO > mv_par04
			dbSkip()
			Loop
		EndIf

		If B1_GRUPO < mv_par05 .Or.  B1_GRUPO > mv_par06
			dbSkip()
			Loop
		EndIf

		If B1_DESC < mv_par07 .Or.  B1_DESC > mv_par08
			dbSkip()
			Loop
		EndIf

		nSaldoPro := nEmpPro := nSCPro := nPCPro := nOPPro := nPVPro := 0




		dbSelectArea("SB2")
		dbSeek( xSB2+SB1->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		dUsai := B2_USAI
		while !Eof() .And. B2_FILIAL+B2_COD==xSB2+SB1->B1_COD

			If lEnd
				PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
				lContinua := .F. 
				Exit
			EndIf

			IF B2_LOCAL == cLocProc .and.  mv_par13 == 2
				dbSkip()
				Loop
			Endif

			If B2_LOCAL < mv_par17 .Or.  B2_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			nSaldoPro += B2_QATU
			nEmpPro   += If(mv_par16==1,B2_QEMP,If(mv_par16==2,B2_QEMPPRE,B2_QEMP+B2_QEMPPRE))
			nEmpPro   += If(mv_par20==1,B2_QEMPPRJ,0)
			nEmpPro   += B2_RESERVA+B2_QEMPSA
			If dUsai < B2_USAI
				dUsai := B2_USAI
			EndIf
			dbSkip()

		EndDo




		If mv_par10 == 1
			nSaldoPro -= nEmpPro
		EndIf




		If mv_par11 == 1 .And.  (Empty(dUsai) .Or.  dUsai > mv_par12)
			dbSelectArea("SB1")
			dbSkip()
			Loop
		EndIf




		If !lContinua
			Exit
		EndIf




		If aReturn[8] # 5
			dbSelectArea("SB3")
			dbSeek(xSB3 + SB1->B1_COD)
		EndIf




		dbSelectArea("SC1")
		dbSeek( xSC1+SB1->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )
		while !Eof() .And. C1_FILIAL+C1_PRODUTO==xSC1+SB1->B1_COD

			If lEnd
				PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
				lContinua := .F. 
				Exit
			EndIf

			If C1_LOCAL < mv_par17 .Or.  C1_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			If C1_QUJE < C1_QUANT .And.  MtrAvalOp(mv_par16,"SC1")
				nSCPro += (C1_QUANT - C1_QUJE)
			EndIf
			dbSkip()

		EndDo




		If !lContinua
			Exit
		EndIf
		if ! lVEIC




			dbSelectArea("SC2")
			dbSeek(xSC2 + SB1->B1_COD)

			while !Eof() .And. C2_FILIAL+C2_PRODUTO==xSC2+SB1->B1_COD

				If lEnd
					PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
					lContinua := .F. 
					Exit
				EndIf

				If C2_LOCAL < mv_par17 .Or.  C2_LOCAL > mv_par18
					dbSkip()
					Loop
				EndIf

				If Empty(C2_DATRF) .And.  (aSC2Sld()) > 0 .And.  MtrAvalOp(mv_par16)
					nOPPro += (aSC2Sld())
				EndIf
				dbSkip()

			EndDo
		endif




		If !lContinua
			Exit
		EndIf




		dbSelectArea("SC6")
		dbSeek( xSC6+SB1->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )

		while !Eof() .And. C6_FILIAL+C6_PRODUTO==xSC6+SB1->B1_COD

			If lEnd
				PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
				lContinua := .F. 
				Exit
			EndIf

			If C6_LOCAL < mv_par17 .Or.  C6_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			If mv_par14 == 1
				dbSelectArea("SF4")
				dbSetOrder(1)
				dbSeek(xSF4 + SC6->C6_TES)
				dbSelectArea("SC6")
				If SF4->F4_ESTOQUE <> "S"
					dbSkip()
					Loop
				End
			End




			If mv_par19 == 2 .And.  AllTrim(C6_BLQ) == "R"
				dbSkip()
				Loop
			EndIf

			nPVPro += SC6->C6_QTDVEN
			dbSelectArea("SC9")
			dbSetOrder(1)
			cChave := xSC9 + SC6->C6_NUM + SC6->C6_ITEM
			If dbSeek(cChave)
				While ! SC9->(EOF()) .And.  cChave = SC9->C9_FILIAL + SC9->C9_PEDIDO + SC9->C9_ITEM
					If C9_LOCAL < mv_par17 .Or.  C9_LOCAL > mv_par18
						dbSkip()
						Loop
					EndIf

					If (Empty(SC9->C9_BLEST) .And.  Empty(SC9->C9_BLCRED)) .And. + SC9->C9_PRODUTO == SC6->C6_PRODUTO
						nPvPro -= SC9->C9_QTDLIB
					ElseIf SC9->C9_BLEST == "10" .AND.  SC9->C9_PRODUTO == SC6->C6_PRODUTO
						nPvPro -= SC9->C9_QTDLIB
					EndIF
					dbskip()
				End
			Endif
			nPVPro := Max(0,nPVPro)
			dbSelectArea("SC6")
			dbSkip()

		EndDo




		If !lContinua
			Exit
		EndIf




		dbSelectArea("SC7")
		dbSeek( xSC7+SB1->B1_COD, if(.F., .T. , NIL ), if(.F., .T. , NIL ) )

		While !Eof() .And.  C7_FILIAL + C7_PRODUTO == xSC7 + SB1->B1_COD

			If lEnd
				PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
				lContinua := .F. 
				Exit
			EndIf

			If C7_LOCAL < mv_par17 .Or.  C7_LOCAL > mv_par18
				dbSkip()
				Loop
			EndIf

			If (C7_QUANT-C7_QUJE) > 0 .And.  Empty(C7_RESIDUO) .And.  MtrAvalOp(mv_par16,"SC7")
				nPCPro += (C7_QUANT-C7_QUJE)
			EndIf
			dbSkip()

		EndDo




		If !lContinua
			Exit
		EndIf




		If mv_par09 == 2
			nSaldo := nSaldoPro+nSCPro+nPCPro+nOPPro
			If nSaldo > RetFldProd(SB1->B1_COD,"B1_EMIN") .Or.  (RetFldProd(SB1->B1_COD,"B1_EMIN") == 0 .And.  nSaldo == 0)
				dbSelectArea("SB1")
				dbSkip()
				Loop
			EndIf
		EndIf




		If mv_par15 == 2
			If nSaldoPro == 0
				dbSelectArea("SB1")
				dbSkip()
				Loop
			Endif
		Endif

		lPassou1 := .T. 
		lPassou2 := .T. 

		If li > 58
			Cabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)
		EndIf




		nCntImpr++

		dbSelectArea("SB1")

		nEstouro := .F. 

		nLen := LEN(RTRIM(SB1->B1_COD))

		if nLen > 15
			nEstouro := .T. 
  		endif

		if ! lVEIC
			PrintOut(li,000,B1_COD,,)
		else
			PrintOut(li,000,B1_CODITE,,)
		endif

		if nEstouro
			li++
		endif

		if nEstouro
			PrintOut(li,016+nCOL1,Substr(B1_DESC,1,30),,)
		else
			PrintOut(li,017+nCOL1,Substr(B1_DESC,1,30),,)
		endif

		if nEstouro
			PrintOut(li,047+nCOL1,B1_TIPO,,)
		else
			PrintOut(li,048+nCOL1,B1_TIPO,,)
		endif

		if nEstouro
			PrintOut(li,050+nCOL1,B1_GRUPO,,)
		else
			PrintOut(li,051+nCOL1,B1_GRUPO,,)
		endif

		if nEstouro
			PrintOut(li,055+nCOL1,B1_UM,,)
		else
			PrintOut(li,056+nCOL1,B1_UM,,)
		endif

		if nEstouro
		    PrintOut(li,058+nCOL1,nSaldoPro,PesqPictQt("B2_QATU",14),)
		else
		    PrintOut(li,059+nCOL1,nSaldoPro,PesqPictQt("B2_QATU",14),)
		endif

		if nEstouro
    		PrintOut(li,073+nCOL1,nEmpPro,PesqPictQt("B2_QEMP",14),)
  		else
			PrintOut(li,074+nCOL1,nEmpPro,PesqPictQt("B2_QEMP",14),)
  		endif

		if nEstouro
			PrintOut(li,090+nCOL1,nSCPro,PesqPictQt("C1_QUANT",14),)
		else
			PrintOut(li,091+nCOL1,nSCPro,PesqPictQt("C1_QUANT",14),)
		endif

		if nEstouro
			PrintOut(li,105+nCOL1,nPCPro,PesqPictQt("C7_QUANT",14),)
		else
			PrintOut(li,106+nCOL1,nPCPro,PesqPictQt("C7_QUANT",14),)
		endif

		if !lVEIC
			if nEstouro
				PrintOut(li,120+nCOL1,nOPPro,PesqPictQt("C2_QUANT",14),)
			else
				PrintOut(li,121+nCOL1,nOPPro,PesqPictQt("C2_QUANT",14),)
			endif
		endif

		if nEstouro
			PrintOut(li,135+nCOL1+nCOL2,nPVPro,PesqPictQt("C6_QTDVEN",14),)
		else
			PrintOut(li,136+nCOL1+nCOL2,nPVPro,PesqPictQt("C6_QTDVEN",14),)
		endif

		if nEstouro
			PrintOut(li,150+nCOL1+nCOL2,RetFldProd(SB1->B1_COD,"B1_EMIN"),PesqPictQt("B1_EMIN",12),)
		else
			PrintOut(li,151+nCOL1+nCOL2,RetFldProd(SB1->B1_COD,"B1_EMIN"),PesqPictQt("B1_EMIN",12),)
		endif

		if nEstouro
			PrintOut(li,163+nCOL1+nCOL2,RetFldProd(SB1->B1_COD,"B1_LE"),PesqPictQt("B1_LE",12),)
		else
			PrintOut(li,164+nCOL1+nCOL2,RetFldProd(SB1->B1_COD,"B1_LE"),PesqPictQt("B1_LE",12),)
		endif

		if nEstouro
			PrintOut(li,176+nCOL1+nCOL2,CalcPrazo(B1_COD,RetFldProd(SB1->B1_COD,"B1_LE")),"99999",)
		else
			PrintOut(li,177+nCOL1+nCOL2,CalcPrazo(B1_COD,RetFldProd(SB1->B1_COD,"B1_LE")),"99999",)
		endif

		if nEstouro
			PrintOut(li,183+nCOL1+nCOL2,RetFldProd(SB1->B1_COD,"B1_TIPE"),,)
		else
			PrintOut(li,184+nCOL1+nCOL2,RetFldProd(SB1->B1_COD,"B1_TIPE"),,)
		endif

		if nEstouro
			If SB3->B3_MEDIA <> 0
				PrintOut(li,185+nCOL1+nCOL2,nSaldoPro/SB3->B3_MEDIA,"99999",)
			Else
				PrintOut(li,185+nCOL1+nCOL2,If(cPaisLoc$"ANG|PTG","  N/d","  N/D"),,)
			EndIf
		else
			If SB3->B3_MEDIA <> 0
				PrintOut(li,186+nCOL1+nCOL2,nSaldoPro/SB3->B3_MEDIA,"99999",)
			Else
				PrintOut(li,186+nCOL1+nCOL2,If(cPaisLoc$"ANG|PTG","  N/d","  N/D"),,)
			EndIf
		endif

		if nEstouro
			PrintOut(li,191+nCOL1+nCOL2,SB3->B3_MEDIA,PesqPictQt("B3_MEDIA",13),)
		else
			PrintOut(li,192+nCOL1+nCOL2,SB3->B3_MEDIA,PesqPictQt("B3_MEDIA",13),)
		endif

		if nEstouro
			PrintOut(li,205+nCOL1+nCOL2,dUsai,,)
		else
			PrintOut(li,206+nCOL1+nCOL2,dUsai,,)
		endif

		if nEstouro
			PrintOut(li,215+nCOL1+nCOL2,SB3->B3_CLASSE,,)
		else
			PrintOut(li,216+nCOL1+nCOL2,SB3->B3_CLASSE,,)
		endif




		nSaldoSub += nSaldoPro
		nEmpSub   += nEmpPro
		nSCSub    += nSCPro
		nPCSub    += nPCPro
		nOPSub    += nOPPro
		nPVSub    += nPVPro

		dbSelectArea("SB1")
		dbSkip(1)
		li++

	EndDo

	If (aReturn[8] == 2 .Or.  aReturn[8] == 4) .And.  lPassou2

		If aReturn[8] == 2
			if nEstouro
				PrintOut(li,023+nCOL1,If(cPaisLoc$"ANG|PTG","T o t a l  d o   t i p o : ","T o t a l  d o   T i p o : ")+cVar,,)
			else
				PrintOut(li,024+nCOL1,If(cPaisLoc$"ANG|PTG","T o t a l  d o   t i p o : ","T o t a l  d o   T i p o : ")+cVar,,)
			endif
		Else
			If aReturn[8] == 4
				if nEstouro
					PrintOut(li,022+nCOL1,If(cPaisLoc$"ANG|PTG","T o t a l   d o   g r u p o : ","T o t a l   d o   G r u p o : ")+cVar,,)
				else
					PrintOut(li,023+nCOL1,If(cPaisLoc$"ANG|PTG","T o t a l   d o   g r u p o : ","T o t a l   d o   G r u p o : ")+cVar,,)
				endif
			endif
		EndIf

		if nEstouro
			PrintOut(li,058+nCOL1,nSaldoSub,PesqPictQt("B2_QATU",14),)
		else
			PrintOut(li,059+nCOL1,nSaldoSub,PesqPictQt("B2_QATU",14),)
		endif

		if nEstouro
			PrintOut(li,073+nCOL1,nEmpSub,PesqPictQt("B2_QEMP",14),)
		else
			PrintOut(li,074+nCOL1,nEmpSub,PesqPictQt("B2_QEMP",14),)
		endif

		if nEstouro
			PrintOut(li,090+nCOL1,nSCSub,PesqPictQt("C1_QUANT",14),)
		else
			PrintOut(li,091+nCOL1,nSCSub,PesqPictQt("C1_QUANT",14),)
		endif

		if nEstouro
			PrintOut(li,105+nCOL1,nPCSub,PesqPictQt("C7_QUANT",14),)
		else
			PrintOut(li,106+nCOL1,nPCSub,PesqPictQt("C7_QUANT",14),)
		endif

		if ! lVEIC
			if nEstouro
				PrintOut(li,120+nCOL1,nOPSub,PesqPictQt("C2_QUANT",14),)
			else
				PrintOut(li,121+nCOL1,nOPSub,PesqPictQt("C2_QUANT",14),)
			endif
		ENDIF

		if nEstouro
			PrintOut(li,135+nCOL1+nCOL2,nPVSub,PesqPictQt("C6_QTDVEN",14),)
		else
			PrintOut(li,136+nCOL1+nCOL2,nPVSub,PesqPictQt("C6_QTDVEN",14),)
		endif

		li++

		PrintOut(li,0,__PrtThinLine(),,)

		li++
	EndIf




	nSaldoTot += nSaldoSub
	nEmpTot   += nEmpSub
	nSCTot    += nSCSub
	nPCTot    += nPCSub
	nOPTot    += nOPSub
	nPVTot    += nPVSub

	If aReturn[8] == 5
		dbSelectArea("SB3")
		dbSkip()
	Else
		dbSelectArea("SB1")
	EndIf

EndDo

If lPassou1
	If 	li > 56
		Cabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)
	EndIf

	li++

	if nEstouro
		PrintOut(li,023+nCOL1,If(cPaisLoc$"ANG|PTG","T o t a l   g e r a l :","T o t a l   G e r a l :"),,)
	else
		PrintOut(li,024+nCOL1,If(cPaisLoc$"ANG|PTG","T o t a l   g e r a l :","T o t a l   G e r a l :"),,)
	endif

	if nEstouro
		PrintOut(li,058+nCOL1,nSaldoTot,PesqPictQt("B2_QATU",14),)
	else
		PrintOut(li,059+nCOL1,nSaldoTot,PesqPictQt("B2_QATU",14),)
	endif

	if nEstouro
		PrintOut(li,073+nCOL1,nEmpTot,PesqPictQt("B2_QEMP",14),)
	else
		PrintOut(li,074+nCOL1,nEmpTot,PesqPictQt("B2_QEMP",14),)
	endif

	if nEstouro
		PrintOut(li,090+nCOL1,nSCTot,PesqPictQt("C1_QUANT",14),)
	else
		PrintOut(li,091+nCOL1,nSCTot,PesqPictQt("C1_QUANT",14),)
	endif

	if nEstouro
		PrintOut(li,105+nCOL1,nPCTot,PesqPictQt("C7_QUANT",14),)
	else
		PrintOut(li,106+nCOL1,nPCTot,PesqPictQt("C7_QUANT",14),)
	endif

	if ! lVEIC
		if nEstouro
			PrintOut(li,120+nCOL1,nOPTot,PesqPictQt("C2_QUANT",14),)
		else
			PrintOut(li,121+nCOL1,nOPTot,PesqPictQt("C2_QUANT",14),)
		endif
	endif

	if nEstouro
		PrintOut(li,135+nCOL1+nCOL2,nPVTot,PesqPictQt("C6_QTDVEN",14),)
	else
		PrintOut(li,136+nCOL1+nCOL2,nPVTot,PesqPictQt("C6_QTDVEN",14),)
	endif
EndIf

dbSelectArea("SC1")
dbSetOrder(1)
dbSelectArea("SC2")
dbSetOrder(1)
dbSelectArea("SC6")
dbSetOrder(1)
dbSelectArea("SC7")
dbSetOrder(1)

If li <> 80
	Roda(nCntImpr,cRodaTxt,Tamanho)
EndIf





dbSelectArea(cString)
dbClearFilter()




if lVEIC
	if !empty(cArqTmp)
		RetIndex("SB1")
		dbsetorder(1)
		IF File( cArqTmp + OrdBagExt() )
			fErase( cArqTmp + OrdBagExt())
		EndIF
		cArqTmp := ""
	endif
endif
ordSetFocus( 1 )

If aReturn[5] = 1
	Set( 24, "" )
	dbCommitAll()
	OurSpool(wnrel)
Endif



If aReturn[8] == 5
	dbSelectArea("SB3")
	Ferase(cArqTmp+OrdBagExt())
	dbSetOrder(1)
EndIf

MS_FLUSH()
return
























Static Function AjustaSX1(cPerg,lVeic,aSB1Cod,aSB1Ite)

Local aArea1	:= Getarea()
Local nTamSX1   := Len(SX1->X1_GRUPO)

DBSELECTAREA("SX1")
DBSETORDER(1)
DBSEEK(PADR(cPerg,nTamSX1))
if lVEIC
   DBSEEK(cPerg)
   while SX1->X1_GRUPO==PADR(cPerg,nTamSX1) .AND. !SX1->(EOF())

      IF "PRODU" $ UPPER(SX1->X1_PERGUNT) .AND.  UPPER(SX1->X1_TIPO) == "C" .AND.  (SX1->X1_TAMANHO <> aSB1Ite[1] .OR.  UPPER(SX1->X1_F3) <> "VR4")

         RECLOCK("SX1", .F. )
         SX1->X1_TAMANHO := aSB1Ite[1]
         SX1->X1_F3 := "VR4"
         DBCOMMIT()
         MSUNLOCK()

      ENDIF
      DBSKIP()
   ENDDO
else
   while SX1->X1_GRUPO==PADR(cPerg,nTamSX1) .AND. !SX1->(EOF())

      IF "PRODU" $ UPPER(SX1->X1_PERGUNT) .AND.  UPPER(SX1->X1_TIPO) == "C" .AND.  (SX1->X1_TAMANHO <> aSB1Cod[1] .OR.  UPPER(SX1->X1_F3) <> "SB1")

         RECLOCK("SX1", .F. )
         SX1->X1_TAMANHO := aSB1Cod[1]
         SX1->X1_F3 := "SB1"
         DBCOMMIT()
         MSUNLOCK()

      ENDIF
      DBSKIP()
   ENDDO
endif
RESTAREA(aArea1)
Return Nil