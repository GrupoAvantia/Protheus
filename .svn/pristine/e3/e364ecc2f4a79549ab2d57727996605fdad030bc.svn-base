#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\MATR310.CH"
#line 2 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr310.prx"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Dialog.ch"
#line 28 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Font.ch"
#line 29 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PTMenu.ch"
#line 31 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Print.ch"
#line 33 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Colors.ch"
#line 35 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Folder.ch"
#line 37 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\msobject.ch"
#line 38 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\VKey.ch"
#line 42 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\WinApi.ch"
#line 44 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCommand.ch"
#line 47 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCSS.CH"
#line 50 "PROTHEUS.CH"
#line 16 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr310.prx"
Function MATR310
Local oReport

If FindFunction("TRepInUse") .And.  TRepInUse()



	oReport:= ReportDef()
	oReport:PrintDialog()
Else
	MATR310R3()
EndIf

Return






















Static Function ReportDef()

Local oReport
Local oSection1
Local oCell
Local oBreak
Local cTamVlr := TamSX3("D2_CUSTO1")[1]
Local cPictVl := X3Picture("D2_CUSTO1")
Local nTamCOD := TamSX3("B1_COD")[1]+15






If !(FindFunction("SIGACUS_V") .And.  SIGACUS_V() >= 20050512)
	Aviso("Atencao","Atualizar patch do programa SIGACUS.PRW !!!",{"Ok"})
	Return
EndIf
If !(FindFunction("SIGACUSA_V") .And.  SIGACUSA_V() >= 20050512)
	Aviso("Atencao","Atualizar patch do programa SIGACUSA.PRX !!!",{"Ok"})
	Return
EndIf
If !(FindFunction("SIGACUSB_V") .And.  SIGACUSB_V() >= 20060915)
	Aviso("Atencao","Atualizar patch do programa SIGACUSB.PRX !!!",{"Ok"})
	Return
EndIf




AjustaSX1()












oReport:= TReport():New("MATR310",If( cPaisLoc $ "ANG|PTG", "Relação Dos Produtos Vendidos", "Relacao dos Produtos Vendidos" ),"MTR310", {|oReport| ReportPrint(oReport)},If( cPaisLoc $ "ANG|PTG", "Este relatório apresenta o valor total das vendas de cada produto,", "Este relatorio apresenta o valor total das vendas de cada produto," )+" "+If( cPaisLoc $ "ANG|PTG", "Calculando a sua participação dentro do total das vendas.mostra tam-", "calculando sua participacao dentro do total das vendas.Mostra tam-" )+" "+If( cPaisLoc $ "ANG|PTG", "Bem o custo de cada venda e o custo de reposição do produto.", "bem o custo de cada venda e o custo de reposicao do produto." ))
oReport:SetLandscape()
oReport:SetTotalInLine( .F. )
























Pergunte("MTR310", .F. )

oSection1 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Artigos", "Produtos" ),{"SD2","SB1","SD1"})
oSection1:SetTotalInLine( .F. )
oSection1 :SetReadOnly()
oSection1:SetHeaderPage( .F. )

TRCell():New(oSection1,"cTipant"	,"   ",If( cPaisLoc $ "ANG|PTG", "Tp.", "TP" )					,"@!"						,2			,,)
TRCell():New(oSection1,"cCodAnt"	,"   ",If( cPaisLoc $ "ANG|PTG", "Código", "Codigo" )					,"@!"						,nTamCOD	,,)
TRCell():New(oSection1,"B1_DESC"	,"SB1",				,				,40			,,)
TRCell():New(oSection1,"nAp1"		,"   ","Quantidade"					,PesqPictQt("D2_QUANT",16)	,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"B1_UM"		,"SB1",				,				,,,,"RIGHT",,"RIGHT")
TRCell():New(oSection1,"nAp2"		,"   ",If( cPaisLoc $ "ANG|PTG", "(a)custo", "(A)Custo" )+Chr(13)+Chr(10)+"Total"		,				,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nCusto"		,"   ","Custo por"+Chr(13)+Chr(10)+"Unidade"		,				,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nAp5"		,"   ",If( cPaisLoc $ "ANG|PTG", "Val Facturado", "Val Faturado" )+Chr(13)+Chr(10)+"Bruto"		,				,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nAp3"		,"   ",If( cPaisLoc $ "ANG|PTG", "(b)valor", "(B)Valor" )+Chr(13)+Chr(10)+If( cPaisLoc $ "ANG|PTG", "Facturado", "Faturado" )		,				,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nImpnFat"	,"   ",If( cPaisLoc $ "ANG|PTG", "Impostos não", "Impostos nao" )+Chr(13)+Chr(10)+If( cPaisLoc $ "ANG|PTG", "Facturados", "Faturados" )		,				,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nValFat"	,"   ",If( cPaisLoc $ "ANG|PTG", "Val Facturado", "Val Faturado" )+"-"+Chr(13)+Chr(10)+If( cPaisLoc $ "ANG|PTG", "Imp. Não Fact.", "Imp. Nao Fat." ),					,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nMargem"	,"   ","Margem"					,"9999999.9"				,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nMixMar"	,"   ","Mix"+Chr(13)+Chr(10)+If( cPaisLoc $ "ANG|PTG", "*mar", "*Mar" )		,"999999.9"					,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"cSinal"		,"   ",""						,"@X"						,6			,,,"RIGHT",,"RIGHT")
TRCell():New(oSection1,"nMix"		,"   ","Mix"					,"999999.9"					,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nAp4"		,"   ","Custo de"+Chr(13)+Chr(10)+If( cPaisLoc $ "ANG|PTG", "Reposição", "Reposicao" )		,				,cTamVlr	,,,,,"RIGHT")
TRCell():New(oSection1,"nVar"		,"   ",If( cPaisLoc $ "ANG|PTG", "Variação", "Variacao" )					,"999999.9"					,cTamVlr	,,,,,"RIGHT")

oBreak := TRBreak():New(oSection1,oSection1:Cell("cTipant"),If( cPaisLoc $ "ANG|PTG", "Sub total : ", "Sub Total : " ), .F. )

TRFunction():New(oSection1:Cell("nAp1"),"CALC_AP1","SUM",oBreak,"",PesqPictQt("D2_QUANT",16),, .F. , .T. )
TRFunction():New(oSection1:Cell("nAp2"),"CALC_AP2","SUM",oBreak,"",cPictVl,, .F. , .T. )
TRFunction():New(oSection1:Cell("nCusto"),NIL,"ONPRINT",oBreak,"",cPictVl,{|| oSection1:GetFunction("CALC_AP2"):GetLastValue()/oSection1:GetFunction("CALC_AP1"):GetLastValue()}, .F. , .T. )
TRFunction():New(oSection1:Cell("nAp5"),NIL,"SUM",oBreak,"",cPictVl,, .F. , .T. )
TRFunction():New(oSection1:Cell("nAp3"),"CALC_AP3","SUM",oBreak,"",cPictVl,, .F. , .T. )
TRFunction():New(oSection1:Cell("nImpnFat"),NIL,"SUM",oBreak,"",cPictVl,, .F. , .T. )
TRFunction():New(oSection1:Cell("nValFat"),NIL,"SUM",oBreak,"",cPictVl,, .F. , .T. )
TRFunction():New(oSection1:Cell("nMargem"),NIL,"ONPRINT",oBreak,"","9999999.9",{|| 100*((oSection1:GetFunction("CALC_AP3"):GetLastValue()-oSection1:GetFunction("CALC_AP2"):GetLastValue())/oSection1:GetFunction("CALC_AP3"):GetLastValue())}, .F. , .T. )
TRFunction():New(oSection1:Cell("nMixMar"),NIL,"SUM",oBreak,"","999999.9",, .F. , .T. )
TRFunction():New(oSection1:Cell("nMix"),NIL,"SUM",oBreak,"","999999.9",, .F. , .T. )
TRFunction():New(oSection1:Cell("nAp4"),"CALC_AP4","SUM",oBreak,"",cPictVl,, .F. , .T. )
TRFunction():New(oSection1:Cell("nVar"),NIL,"ONPRINT",oBreak,"","999999.9",{|| (100*oSection1:GetFunction("CALC_AP4"):GetLastValue()/oSection1:GetFunction("CALC_AP2"):GetLastValue())-100}, .F. , .T. )

Return(oReport)























Static Function ReportPrint(oReport)

Local oSection1:= oReport:Section(1)
Local lDevolucao := .F. 
Local nAp1,nAp1Cus,nAp2,nAp3,nAp4,nAp5
Local cCodAnt := "",cTipant := "",nTotFat:=0,nTotLuc:=0
Local nMoeda
Local cArqSD1:=cArqSD2:=cArqTrab:=cArqTrb2:=cKeySD2:=sKeySD1:=cFilSD1:=cFilSD2:=""
Local cEstoq := If( (mv_par12 == 1),"S",If( (mv_par12 == 2),"N","SN" ) )
Local cDupli := If( (mv_par13 == 1),"S",If( (mv_par13 == 2),"N","SN" ) )
Local nValCus := 0
Local aTam:={}
Local aStruct := {}
Local nIndSd1:= 0
Local nCpo
Local aImpVar := {}
Local cFormula := ""
Local cAliasTop := "SD2"
Local cEspecieLoja := "CF"




Private lVEIC	:= UPPER(GETMV("MV_VEICULO"))=="S"
Private aCampos := {}
Private cCampImp




If LjAnalisaLeg(18)[1]
	cEspecieLoja := "ECF"
EndIf

nMoeda := mv_par09
oReport:SetTitle( oReport:Title()+" - "+GetMv("MV_SIMB"+Alltrim(Str(nMoeda))))

If mv_par15 == 1
	cFormula := "Formula da Margem" +" => (( B - A ) / B ) * 100"
Else
	cFormula := "Formula da Margem" + " =>  C = B - "+Str(mv_par16,5,2)+"%  => (( C - A ) / C ) * 100"
EndIf

dbSelectArea("SF4")
dbSetOrder(1)

dbSelectArea("SF2")
dbSetOrder(1)

dbSelectArea("SF1")
dbSetOrder(1)

dbSelectArea("SD2")
dbSetOrder(1)

dbSelectArea("SD1")
dbSetOrder(1)

dbSelectArea("SB1")
dbSetOrder(1)




aTam := TamSx3("D2_FILIAL")
Aadd(aCampos,{"D2_FILIAL","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_COD")
Aadd(aCampos,{"D2_COD","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_LOCAL")
Aadd(aCampos,{"D2_LOCAL","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_SERIE")
Aadd(aCampos,{"D2_SERIE","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_TES")
Aadd(aCampos,{"D2_TES","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_TP")
Aadd(aCampos,{"D2_TP","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_EMISSAO")
Aadd(aCampos,{"D2_EMISSAO","D",aTam[1],aTam[2]})
aTam := TamSx3("D2_TIPO")
Aadd(aCampos,{"D2_TIPO","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_DOC")
Aadd(aCampos,{"D2_DOC","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_QUANT")
Aadd(aCampos,{"D2_QUANT","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_TOTAL")
Aadd(aCampos,{"D2_TOTAL","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_CUSTO"+Str(mv_par09,1))
Aadd(aCampos,{"D2_CUSTO","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_VALIPI")
Aadd(aCampos,{"D2_VALIPI","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_VALICM")
Aadd(aCampos,{"D2_VALICM","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_ITEM")
Aadd(aCampos,{"D2_ITEM","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_ORIGLAN")
Aadd(aCampos,{"D2_ORIGLAN","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_CLIENTE")
Aadd(aCampos,{"D2_CLIENTE","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_LOJA")
Aadd(aCampos,{"D2_LOJA","C",aTam[1],aTam[2]})

If cPaisLoc<>"BRA"
	aStruct:=SD2->(dbStruct())
	For nCpo := 1 to Len(aStruct)
		If Substr(aStruct[nCpo][1],1,9)=="D2_VALIMP" .or.  Substr(aStruct[nCpo][1],1,9)=="D2_BASIMP"
			aTam := TamSx3(aStruct[nCpo][1])
			Aadd(aCampos,{aStruct[nCpo][1],"N",aTam[1],aTam[2]})
			Aadd(aImpVar,aStruct[nCpo][1])
		EndIf
	Next
EndIf

cArqTrab := CriaTrab(aCampos)
dbUseArea(.T.,,cArqTrab ,"TRB" , if(.F. .or. .T., !.T., NIL),.F. )
cArqTrb2 := CriaTrab( NIL, .F.  )
IndRegua("TRB",cArqTrb2,"D2_FILIAL+D2_TP+D2_COD+D2_DOC+D2_SERIE",,cFilSD2,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))

If (mv_par11 # 3)

	dbSelectArea( "SD1" )
	cArqSD1 := CriaTrab( NIL, .F.  )
	cKeySD1 := "D1_FILIAL+D1_COD+D1_SERIORI+D1_NFORI+D1_ITEMORI"

	cFilSD1 := "D1_FILIAL = '" + xFilial("SD1") + "'"
	cFilSD1 += " .And. D1_TIPO = 'D'"
	cFilSD1 += " .And. D1_COD >= '" + MV_PAR07 + "'"
	cFilSD1 += " .And. D1_COD <= '" + MV_PAR08 + "'"
	cFilSD1 += " .And. D1_LOCAL >= '" + MV_PAR01 + "'"
	cFilSD1 += " .And. D1_LOCAL <= '" + MV_PAR02 + "'"
	cFilSD1 += " .And. DTOS(D1_DTDIGIT) >= '" + DTOS(MV_PAR03) + "'"
	cFilSD1 += " .And. DTOS(D1_DTDIGIT) <= '" + DTOS(MV_PAR04) + "'"
	cFilSD1 += " .And. D1_TP >= '" + MV_PAR05 + "'"
	cFilSD1 += " .And. D1_TP <= '" + MV_PAR06 + "'"

	IndRegua("SD1",cArqSD1,cKeySD1,,cFilSD1,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))

	nIndSd1:=RetIndex("SD1")



	dbSetOrder(nIndSd1 + 1)
	dbGoTop()

EndIf

dbSelectArea("SD2")
dbSetOrder(2)







	MakeSqlExpr(oReport:uParam)

	cAliasTop := GetNextAlias()




	oReport:Section(1):BeginQuery()

	cSelect := "%"
	cSelect += "D2_CUSTO"+Str(mv_par09,1)

	If cPaisLoc<>"BRA"
		For nCpo := 1 to Len(aImpVar)
			cSelect += ","+aImpVar[nCpo]
		Next
	Endif
	cSelect += "%"

	cWhere := "%"
	IF ! lVeic
		cWhere += " AND D2_COD >= '" + MV_PAR07 + "'"
		cWhere += " AND D2_COD <= '" + MV_PAR08 + "'"
	Endif
	If mv_par17 == 2
		cWhere += " And D2_TIPO <> 'D'"
	Endif


	If cPaisLoc<>"BRA"
		cWhere += " AND NOT ("+IsRemito(2,"D2_TIPODOC")+")"
	Endif

	cWhere += "%"


























__execSql(cAliasTop," SELECT D2_FILIAL,D2_TP,D2_COD,D2_DOC,D2_SERIE,D2_LOCAL,D2_TES,D2_EMISSAO,D2_TIPO,D2_QUANT, D2_TOTAL,D2_VALIPI,D2_VALICM,D2_ORIGLAN,D2_CLIENTE,D2_ITEM,D2_LOJA, "+___SQLGetValue(CSELECT)+" FROM  "+RetSqlName('SD2')+" SD2, "+RetSqlName('SF2')+" SF2 WHERE SD2.D2_FILIAL =  '" +xFilial('SD2')+"'  AND SD2.D2_TP >=  "+___SQLGetValue(MV_PAR05)+" AND SD2.D2_TP <=  "+___SQLGetValue(MV_PAR06)+" AND SD2.D2_LOCAL >=  "+___SQLGetValue(MV_PAR01)+" AND SD2.D2_LOCAL <=  "+___SQLGetValue(MV_PAR02)+" AND SD2.D2_EMISSAO >=  "+___SQLGetValue(DTOS(MV_PAR03))+" AND SD2.D2_EMISSAO <=  "+___SQLGetValue(DTOS(MV_PAR04))+" AND SF2.F2_FILIAL =  '" +xFilial('SF2')+"'  AND SF2.F2_DOC = SD2.D2_DOC AND SF2.F2_SERIE = SD2.D2_SERIE AND SF2.F2_LOJA = SD2.D2_LOJA AND (NOT (SF2.F2_ESPECIE <>  "+___SQLGetValue(CESPECIELOJA)+" AND SF2.F2_NFCUPOM <> ' ')) AND SF2.D_E_L_E_T_= ' ' AND SD2.D_E_L_E_T_= ' '  "+___SQLGetValue(CWHERE)+" ORDER BY 1,2,3",{},.F.)








	oReport:Section(1):EndQuery()






























dbSelectArea(cAliasTop)
oReport:SetMeter(SD2->(LastRec()))

GeraTrab("SD2",cAliasTop, .T. )

SB1->(dbSetOrder(1))

If mv_par11 <> 3
	dbSelectArea("SD1")
	dbGoTop()







		MakeSqlExpr(oReport:uParam)

		cAliasTop := GetNextAlias()




		oReport:Section(1):BeginQuery()

		cWhere := "%"
		IF ! lVeic
			cWhere += " AND D1_COD >= '" + MV_PAR07 + "'"
			cWhere += " AND D1_COD <= '" + MV_PAR08 + "'"
		Endif

		cWhere += " AND D1_TIPO = 'D'"


		If cPaisLoc<>"BRA"
			cWhere += " AND NOT ("+IsRemito(2,"D1_TIPODOC")+")"
		Endif

		cWhere += "%"

	    cMoeda := "%"+"D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1))+"%"



















__execSql(cAliasTop," SELECT D1_FILIAL,D1_TP,D1_COD,D1_DOC,D1_SERIE,D1_LOCAL,D1_TES,D1_EMISSAO,D1_TIPO,D1_QUANT, D1_TOTAL,D1_VALIPI,D1_VALICM,D1_ORIGLAN,D1_ITEM,D1_LOJA,D1_SERIORI,D1_SERIORI,D1_NFORI, "+___SQLGetValue(CMOEDA)+",D1_VALDESC FROM  "+RetSqlName('SD1')+" SD1 WHERE D1_FILIAL =  '" +xFilial('SD1')+"'  AND D1_TP >=  "+___SQLGetValue(MV_PAR05)+" AND D1_TP <=  "+___SQLGetValue(MV_PAR06)+"AND D1_LOCAL >=  "+___SQLGetValue(MV_PAR01)+" AND D1_LOCAL <=  "+___SQLGetValue(MV_PAR02)+"AND D1_EMISSAO >=  "+___SQLGetValue(DTOS(MV_PAR03))+" AND D1_EMISSAO <=  "+___SQLGetValue(DTOS(MV_PAR04))+" AND SD1.D_E_L_E_T_= ' '  "+___SQLGetValue(CWHERE),{},.F.)








		oReport:Section(1):EndQuery()






























dbSelectArea(cAliasTop)
oReport:SetMeter(SD1->(LastRec()))
	GeraTrab("SD1",cAliasTop, .T. )
EndIf

dbSelectArea("TRB")
dbGoTop()

While !oReport:Cancel() .And.  !TRB->(Eof())

	If oReport:Cancel()
		Exit
	EndIf

	oReport:IncMeter()

	If !(cCodAnt == TRB->D2_COD)
		cCodAnt    := TRB->D2_COD
		oSection1:Cell("cCodAnt"):SetValue(cCodAnt)
		lDevolucao := .T. 
	EndIf





	If !(TRB->D2_ORIGLAN == "LF") .And.  AvalTes(TRB->D2_TES,cEstoq,cDupli)

		If !(SB1->(DbSeek( xFilial("SB1") + TRB->D2_COD, .F.  )))
			dbSkip()
			Loop
		EndIf

		If TRB->D2_TIPO <> "D"
			If (mv_par09 > 1)
				nValCus := TRB->D2_CUSTO
				If nValCus > 0
					nTotLuc += nValCus
				Else
					nTotLuc += xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				EndIf
			Else
				nTotLuc += TRB->D2_CUSTO
			EndIf
			If cPaisLoc<>"BRA"
				nTotFat +=  ValSD2()
			Else
				If (mv_par09 > 1)
					nTotFat += xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				Else
					nTotFat += ValSD2()
				EndIf
			EndIf
		Else
			If (mv_par09 > 1)
				nValCus := TRB->D2_CUSTO
				If nValCus > 0
					nTotLuc -= nValCus
				Else
					nTotLuc -= xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				EndIf
			Else
				nTotLuc -= TRB->D2_CUSTO
			EndIf
			If cPaisLoc<>"BRA"
				nTotFat -=  ValSD2()
			Else
				If (mv_par09 > 1)
					nTotFat -= xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				Else
					nTotFat -= ValSD2()
				EndIf
			EndIf
		Endif
		Do Case
		Case (mv_par11 == 1)
			DbSelectArea( "SD1" )
			If DbSeek( xFilial("SD1") + TRB->D2_COD + TRB->D2_SERIE + TRB->D2_DOC + TRB->D2_ITEM, .F.  )
				While !SD1->(Eof()) .And.  (SD1->D1_COD == TRB->D2_COD) .And.  (TRB->D2_SERIE+TRB->D2_DOC+TRB->D2_ITEM == SD1->D1_SERIORI+SD1->D1_NFORI+AllTrim(SD1->D1_ITEMORI))




					If !(D1_ORIGLAN == "LF") .And.  AvalTes(D1_TES,cEstoq,cDupli)

						If (mv_par09 > 1)
							nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
							if nValCus > 0
								nTotLuc -= nValCus
							else
								nTotLuc -= xMoeda( D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
							endif
						Else
							nTotLuc -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
						EndIf

						If (mv_par09 > 1)
							nTotFat -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
						Else
							nTotFat -= ValSD1()
						EndIf
					EndIf
					dbSelectArea("SD1")
					DbSkip( 1 )
				EndDo
			EndIf
		Case (mv_par11 == 2) .And.  lDevolucao
			DbSelectArea( "SD1" )
			If DbSeek( xFilial("SD1") + TRB->D2_COD + TRB->D2_SERIE + TRB->D2_DOC, .F.  )
				While !SD1->(Eof()) .And.  (SD1->D1_COD == TRB->D2_COD) .And.  (TRB->D2_SERIE+TRB->D2_DOC == SD1->D1_SERIORI+SD1->D1_NFORI)




					If !(D1_ORIGLAN == "LF") .And.  AvalTes(D1_TES,cEstoq,cDupli)

						If (mv_par09 > 1)
							nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
							if nValCus > 0
								nTotLuc -= nValCus
							else
								nTotLuc -= xMoeda( D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
							endif
						Else
							nTotLuc -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
						EndIf

						If (mv_par09 > 1)
							nTotFat -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
						Else
							nTotFat -= ValSD1()
						EndIf
					EndIf
					dbSelectArea("SD1")
					DbSkip( 1 )
				EndDo
			EndIf
		EndCase
	EndIf

	DbSelectArea( "TRB" )
	DbSkip( 1 )
	lDevolucao := !(TRB->D2_TIPO == "D")
EndDo

nTotLuc := c310AbaVal(nTotFat)-nTotLuc

TRB->(DbGoTop())

cCodAnt := ""

oSection1:Init()
dbSelectArea("TRB")
While !oReport:Cancel() .And.  !TRB->(Eof())

	If oReport:Cancel()
		Exit
	EndIf

	cTipant := TRB->D2_TP
	oSection1:Cell("cTipant"):SetValue(cTipant)

	While !oReport:Cancel() .And.  !TRB->(Eof()) .And.  (TRB->D2_TP == cTipant)

		If oReport:Cancel()
			Exit
		EndIf

		If !(SB1->(DbSeek( xFilial("SB1") + TRB->D2_COD, .F.  )))
			dbSkip()
			Loop
		EndIf

		nAp1 	:= 0
		nAp1Cus	:= 0
		nAp2	:= 0
		nAp3	:= 0
		nAp4	:= 0
		nAp5	:= 0

		If !(cCodAnt == TRB->D2_COD)
			cCodAnt    := TRB->D2_COD
			oSection1:Cell("cCodAnt"):SetValue(cCodAnt)
			lDevolucao := !(TRB->D2_TIPO == "D")
		EndIf

		While !oReport:Cancel() .And.  !TRB->(Eof()) .And.   TRB->D2_TP+TRB->D2_COD == cTipant+cCodAnt

			If oReport:Cancel()
				Exit
			EndIf

			oReport:IncMeter()





			If !(TRB->D2_ORIGLAN == "LF") .And.  AvalTes(TRB->D2_TES,cEstoq,cDupli)
				If !(TRB->D2_TIPO == "D")
					If AvalTes(TRB->D2_TES,"S")
						nAp1Cus+=TRB->D2_QUANT
					Endif
					nAp1 += TRB->D2_QUANT
					If (mv_par09 > 1)
						nValCus := TRB->D2_CUSTO
						if nValCus > 0
							nAp2 += nValCus
						else
							nAp2 += xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						endif
					Else
						nAp2 += TRB->D2_CUSTO
					EndIf

					If (mv_par09 > 1)
						nAp3 += Iif(cPaisLoc<>"BRA",ValSD2(),xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO ))
						If cPaisLoc=="BRA"
							nAp5 += xMoeda( TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						Else
							nAp5 += SumTaxSD2( .F. )
						EndIf
					Else
						nAp3 += ValSD2()
						If cPaisLoc=="BRA"
							nAp5 += TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0)
						Else
							nAp5 += SumTaxSD2( .F. )
						EndIf
					EndIF

					If mv_par09 > 1
						nAp4 += (TRB->D2_QUANT*xMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
					Else
						If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
							nAp4 += (TRB->D2_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
						Else
							nAp4 += (TRB->D2_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
						EndIf
					EndIF
				Else
					If AvalTes(TRB->D2_TES,"S")
						nAp1Cus-=TRB->D2_QUANT
					Endif
					nAp1 -= TRB->D2_QUANT
					If (mv_par09 > 1)
						nValCus := TRB->D2_CUSTO
						if nValCus > 0
							nAp2 -= nValCus
						else
							nAp2 -= xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						endif
					Else
						nAp2 -= TRB->D2_CUSTO
					EndIf

					If (mv_par09 > 1)
						nAp3 -= xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						If cPaisLoc=="BRA"
							nAp5 -= xMoeda( TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						Else
							nAp5 -=  SumTaxSD2( .F. )
						EndIf
					Else
						nAp3 -= ValSD2()
						If cPaisLoc=="BRA"
							nAp5 -= TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0)
						Else
							nAp5 -= SumTaxSD2( .F. )
						EndIf
					EndIF

					If mv_par09 > 1
						nAp4 -= (TRB->D2_QUANT*xMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
					Else
						If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
							nAp4 -= (TRB->D2_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
						Else
							nAp4 -= (TRB->D2_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
						EndIf
					EndIF
				Endif
				Do Case
				Case (mv_par11 == 1)
					DbSelectArea( "SD1" )
					If DbSeek( xFilial("SD1") + TRB->D2_COD+TRB->D2_SERIE+TRB->D2_DOC+TRB->D2_ITEM, .F.  )
						While !SD1->(Eof()) .And.  (D1_COD == cCodAnt) .And.  (TRB->D2_SERIE+TRB->D2_DOC+TRB->D2_ITEM == SD1->D1_SERIORI+SD1->D1_NFORI+AllTrim(SD1->D1_ITEMORI))




							If !(SD1->D1_ORIGLAN == "LF") .And.  AvalTes(SD1->D1_TES,cEstoq,cDupli)
								If AvalTes(D1_TES,"S")
									nAp1Cus -= D1_QUANT
								Endif
								nAp1 -= SD1->D1_QUANT
								If (mv_par09 > 1)
									nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
									if nValCus > 0
										nAP2 -= nValCus
									else
										nAp2 -= xMoeda(SD1->D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),nMoeda, SD1->D1_DTDIGIT )
									endif
								Else
									nAp2 -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
								EndIf

								If (mv_par09 > 1)
									nAp3 -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, SD1->D1_DTDIGIT )
									If cPaisLoc = "BRA"
										nAp5 -= xMoeda( SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, SD1->D1_DTDIGIT )
									Else
										nAp5 -= SumTaxSD1( .F. )
									EndIf
								Else
									nAp3 -= ValSD1()
									If cPaisLoc="BRA"
										nAp5 -= SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0)
									Else
										nAp5 -= SumTaxSD1( .F. )
									EndIf
								EndIF

								If mv_par09 > 1
									nAp4 -= (SD1->D1_QUANT*xMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
								Else
									If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
										nAp4 -= (SD1->D1_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
									Else
										nAp4 -= (SD1->D1_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
									EndIf
								EndIF
							EndIf
							dbSelectArea("SD1")
							DbSkip( 1 )
						EndDo
					EndIf
				Case (mv_par11 == 2) .And.  lDevolucao
			 		DbSelectArea( "SD1" )
					If DbSeek( xFilial("SD1") +TRB->D2_COD+TRB->D2_SERIE+TRB->D2_DOC, .F.  )
						While !SD1->(Eof()) .And.  (D1_COD == cCodAnt) .And.  (TRB->D2_SERIE+TRB->D2_DOC == SD1->D1_SERIORI+SD1->D1_NFORI)




							If !(D1_ORIGLAN == "LF") .And.  AvalTes(D1_TES,cEstoq,cDupli)
								If AvalTes(D1_TES,"S")
									nAp1Cus -= D1_QUANT
								Endif
								nAp1 -= D1_QUANT
								If (mv_par09 > 1)
									nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
									if nValCus > 0
										nAp2 -= nValCus
									else
										nAp2 -= xMoeda( D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
									endif
								Else
									nAp2 -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
								EndIf

								If (mv_par09 > 1)
									nAp3 -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
									If cPaisLoc = "BRA"
										nAp5 -= xMoeda( SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),nMoeda,D1_DTDIGIT )
									Else
										nAp5 -=  SumTaxSD1( .F. )
									EndIf
								Else
									nAp3 -= ValSD1()
									If cPaisLoc = "BRA"
										nAp5 -= SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0)
									Else
										nAp5 -= SumTaxSD1( .F. )
									EndIf
								EndIF

								If mv_par09 > 1
									nAp4 -= (D1_QUANT*xMoeda( RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
								Else
									If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
										nAp4 -= (D1_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
									Else
										nAp4 -= (D1_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
									EndIf
								EndIF
							EndIf
							dbSelectArea("SD1")
							DbSkip( 1 )
						EndDo
					EndIf
				EndCase

			EndIf
			DbSelectArea( "TRB" )
			dbSkip()
			lDevolucao := !(TRB->D2_TIPO == "D")
		EndDo

		If nAp1 <> 0 .Or.  nAp2 <> 0 .Or.  nAp3 <> 0 .Or.  nAp4 <> 0 .And.  lDevolucao

			oSection1:Cell("nAp2"):SetPicture(TM(nAp2,14))
			oSection1:Cell("nCusto"):SetPicture(TM(nAp2,14))
			oSection1:Cell("nAp5"):SetPicture(TM(nAp5,14))
			oSection1:Cell("nAp3"):SetPicture(TM(nAp3,14))
			oSection1:Cell("nImpnFat"):SetPicture(TM(nAp5,12))
			oSection1:Cell("nValFat"):SetPicture(TM(nAp3,14))
			oSection1:Cell("nAp4"):SetPicture(TM(nAp4,14))

			oSection1:Cell("nAp1"):SetValue(nAp1)
			oSection1:Cell("nAp2"):SetValue(nAp2)
			oSection1:Cell("nCusto"):SetValue (Iif(nAp1Cus<>0,nAp2/nAp1Cus,0))
			oSection1:Cell("nAp5"):SetValue(nAp5)
			oSection1:Cell("nAp3"):SetValue(nAp3)
			If nAp3 <> 0
				oSection1:Cell("nImpnFat"):SetValue(nAp5-(c310AbaVal(nAp5)))
				oSection1:Cell("nValFat"):SetValue(nAp3-(nAp5-(c310AbaVal(nAp5))))
				oSection1:Cell("nMargem"):SetValue(100*(c310AbaVal(nAp3)-nAp2)/c310AbaVal(nAp3))
			Else
				oSection1:Cell("nImpnFat"):SetValue(0)
				oSection1:Cell("nValFat"):SetValue(0)
				oSection1:Cell("nMargem"):SetValue(0)
			Endif
			If nTotFat <> 0
				oSection1:Cell("nMixMar"):SetValue(100*c310AbaVal(nAp3)/c310AbaVal(nTotFat))
			Else
				oSection1:Cell("nMixMar"):SetValue(0)
			Endif
			If nTotLuc <> 0
				oSection1:Cell("nMix"):SetValue(100*(c310AbaVal(nAp3)-nAp2)/nTotLuc)
			Else
				oSection1:Cell("nMix"):SetValue(0)
			EndIf
			oSection1:Cell("nAp4"):SetValue(nAp4)
			If nAp2 <> 0
				oSection1:Cell("nVar"):Show()
				oSection1:Cell("nVar"):SetValue((100*nAp4/nAp2)-100)
			Else
				oSection1:Cell("nVar"):SetValue(0)
				oSection1:Cell("nVar"):Hide()
			EndIf

	      	If lVeic .And.  !Empty(SB1->B1_CODITE)
				oReport:PrintText("[ " + SB1->B1_CODITE + " ] GRUPO : [ " + SB1->B1_GRUPO + " ]")
			EndIf

			oSection1:Cell("cSinal"):SetValue(IIF(nAp3-nAp2>0,"+","-"))
			oSection1:PrintLine()

		Endif
		DbSelectArea( "TRB" )
	EndDo
	DbSelectArea( "TRB" )
EndDo

oSection1:Finish()

oReport:PrintText(" " + cFormula, oReport:Row()+ ( 4 * oReport:LineHeight()) ,oSection1:Cell("cTipant"):ColPos(),,,, .F. )

IF "" <> ALLTRIM(cArqSD1)
   IF File(cArqSD1+OrdBagExt())
		Ferase(cArqSD1+OrdBagExt())
	ENDIF
Endif

IF "" <> ALLTRIM(cArqSD2)
	IF File(cArqSD2+OrdBagExt())
		FErase(cArqSD2+OrdBagExt())
	ENDIF
Endif

dbSelectArea("TRB")
dbCloseArea()
If File(cArqTrab+GetDBExtension())
	FErase(cArqTrab+GetDBExtension())
Endif
If File(cArqTrb2+OrdBagExt())
	FErase(cArqTrb2+OrdBagExt())
Endif

Return NIL




















































Function MATR310R3



LOCAL Tamanho  := "G"
LOCAL titulo   := If( cPaisLoc $ "ANG|PTG", "Relação Dos Produtos Vendidos", "Relacao dos Produtos Vendidos" )
LOCAL cDesc1   := If( cPaisLoc $ "ANG|PTG", "Este relatório apresenta o valor total das vendas de cada produto,", "Este relatorio apresenta o valor total das vendas de cada produto," )
LOCAL cDesc2   := If( cPaisLoc $ "ANG|PTG", "Calculando a sua participação dentro do total das vendas.mostra tam-", "calculando sua participacao dentro do total das vendas.Mostra tam-" )
LOCAL cDesc3   := If( cPaisLoc $ "ANG|PTG", "Bem o custo de cada venda e o custo de reposição do produto.", "bem o custo de cada venda e o custo de reposicao do produto." )
LOCAL cString  := "SD2"
LOCAL nTipo    := 0
LOCAL wnrel    := "MATR310"
LOCAL nTamSX1  := Len(SX1->X1_GRUPO)




Local aArea1	:= Getarea()



Private lVEIC		:= UPPER(GETMV("MV_VEICULO"))=="S"
Private aSB1Cod	:= {}
Private aSB1Ite	:= {}
Private lT			:= .T. 




PRIVATE aReturn:= {OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Código de barras", "Zebrado" )), 1,OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Administração", "Administracao" )), 2, 2, 1, "",1 }
PRIVATE nLastKey := 0 ,cPerg := "MTR310"







IF !(FindFunction("SIGACUS_V") .and.  SIGACUS_V() >= 20050512)
	Aviso("Atencao","Atualizar patch do programa SIGACUS.PRW !!!",{"Ok"})
	Return
EndIf
IF !(FindFunction("SIGACUSA_V") .and.  SIGACUSA_V() >= 20050512)
	Aviso("Atencao","Atualizar patch do programa SIGACUSA.PRX !!!",{"Ok"})
	Return
EndIf
IF !(FindFunction("SIGACUSB_V") .and.  SIGACUSB_V() >= 20050512)
	Aviso("Atencao","Atualizar patch do programa SIGACUSB.PRX !!!",{"Ok"})
	Return
EndIf

DBSELECTAREA("SF4")
DBSETORDER(1)

DBSELECTAREA("SF2")
DBSETORDER(1)

DBSELECTAREA("SF1")
DBSETORDER(1)

DBSELECTAREA("SD2")
DBSETORDER(1)

DBSELECTAREA("SD1")
DBSETORDER(1)

DBSELECTAREA("SB1")
DBSETORDER(1)





PutSx1("MTR310","18","Considera Vlr PIS/COFINS ?","Considera Vlr PIS/COFINS ?","Consider PIS/COFINS Value ?", "mv_chi", "N", 1, 0, 0,"C", "", "", "", "","MV_PAR18","Sim","Si","Yes", "","Nao","No","No", "", "", "", "", "", "", "", "", "", "", "", "", "")
























aSB1Cod	:= TAMSX3("B1_COD")
aSB1Ite	:= TAMSX3("B1_CODITE")

if lVEIC

	nCOL1		:= ABS(aSB1Cod[1] - aSB1Ite[1]) + 1 +  aSB1Cod[1]

   DBSELECTAREA("SX1")
   DBSETORDER(1)
   DBSEEK(PADR(cPerg,nTamSX1))
   while SX1->X1_GRUPO==PADR(cPerg,nTamSX1) .AND. !SX1->(EOF())

      IF "PRODU" $ UPPER(SX1->X1_PERGUNT) .AND.  UPPER(SX1->X1_TIPO) == "C" .AND.  (SX1->X1_TAMANHO <> aSB1Ite[1] .OR.  UPPER(SX1->X1_F3) <> "VR4")

         RECLOCK("SX1", .F. )
         SX1->X1_TAMANHO := aSB1Ite[1]
         SX1->X1_F3 := "VR4"
         DBCOMMIT()
         MSUNLOCK()

      ENDIF
      DBSKIP()
   ENDDO
   DBCOMMITALL()
   RESTAREA(aArea1)
else
   DBSELECTAREA("SX1")
   DBSETORDER(1)
   DBSEEK(PADR(cPerg,nTamSX1))
   while SX1->X1_GRUPO==PADR(cPerg,nTamSX1) .AND. !SX1->(EOF())

      IF "PRODU" $ UPPER(SX1->X1_PERGUNT) .AND.  UPPER(SX1->X1_TIPO) == "C" .AND.  (SX1->X1_TAMANHO <> aSB1Cod[1] .OR.  UPPER(SX1->X1_F3) <> "SB1")

         RECLOCK("SX1", .F. )
         SX1->X1_TAMANHO := aSB1Cod[1]
         SX1->X1_F3 := "SB1"
         DBCOMMIT()
         MSUNLOCK()

      ENDIF
	  If cPaisLoc <> "BRA" .And.  SX1->X1_ORDEM $ "10#14#18"
	     RecLock("SX1", .F. )
		 SX1->X1_GSC := IIF(SX1->X1_ORDEM=="18","S","C")
		 MsUnLock()

		 aHelpSpa := {}

     	 Aadd( aHelpSpa, "Sera considerado el valor de los        " )
		 Aadd( aHelpSpa, "impuestos en el saldo del archivo de    " )
 		 Aadd( aHelpSpa, "Itens del Pedido de Venta (SD2).        " )

         PutSX1Help("P.MTR31010.",,,aHelpSpa)

  		 aHelpSpa := {}

     	 Aadd( aHelpSpa, "Sera considerado el valor de los        " )
		 Aadd( aHelpSpa, "impuestos del valor en el archivo de    " )
 		 Aadd( aHelpSpa, "Items de la Factura de Entrada (SD1)    " )

         PutSX1Help("P.MTR31014.",,,aHelpSpa)
	  Endif
      DBSKIP()
   ENDDO
   DBCOMMITALL()
   RESTAREA(aArea1)
endif


Pergunte(cPerg, .F. )




wnrel:=SetPrint(cString,wnrel,cPerg,@titulo,cDesc1,cDesc2,cDesc3, .F. ,"",,Tamanho)

dbSelectArea( "SD2" )
If nLastKey = 27
	dbClearFilter()
	Return
Endif

SetDefault(aReturn,cString)

dbSelectArea( "SD2" )
If nLastKey = 27
	dbClearFilter()
	Return
Endif

RptStatus({|lEnd| C310Imp(@lEnd,wnRel,cString,titulo,Tamanho)},titulo)

Return NIL














Static Function C310Imp(lEnd,WnRel,cString,titulo,Tamanho)




Local cRodaTxt := If( cPaisLoc $ "ANG|PTG", "Registo(s)     fórmula da margem ", "REGISTRO(S)     Formula da Margem " )
Local nCntImpr := 0
Local lDevolucao := .F. 
Local nAp1,nAp1Cus,nAp2,nAp3,nAp4,nAp5
Local nAt1,nAt1Cus,nAt2,nAt3,nAt4,nAt5
Local nAg1,nAg1Cus,nAg2,nAg3,nAg4,nAg5
Local cCodAnt := "",cTipant := "",nTotFat:=0,nTotLuc:=0
Local nMoeda ,lPassou
Local cArqSD1:=cArqSD2:=cArqTrab:=cArqTrb2:=cKeySD2:=sKeySD1:=cFilSD1:=cFilSD2:=""
Local cEstoq := If( (mv_par12 == 1),"S",If( (mv_par12 == 2),"N","SN" ) )
Local cDupli := If( (mv_par13 == 1),"S",If( (mv_par13 == 2),"N","SN" ) )
Local nValCus := 0
Local aTam:={}
Local nIndSd1:= 0
Local aStruct := {}
Local nCpo
Local cAliasTop
Local cQuery	:= ""
Local lQuery	:= .F. 
Local cFilOrder	:= ""
Local cCpo  := ""
Local cNCpo := ""
Local aImpVar := {}
Local cFormula := ""
Local cEspecieLoja := "CF"

Private aCampos := {}
Private cCampImp



Private li := 80 ,m_pag := 1




Private lContinua := .T. 




If LjAnalisaLeg(18)[1]
	cEspecieLoja := "ECF"
EndIf




nTipo  := IIF(aReturn[4]==1,15,18)




nMoeda := mv_par09
titulo := AllTrim(Titulo) +  " - "+GetMv("MV_SIMB"+Alltrim(Str(nMoeda)))

cRodaTxt := alltrim(substr(cRodaTxt, at("(S)", upper(cRodaTxt)) + 3 ))

If mv_par15 == 1
	cFormula := cRodaTxt +" => (( B - A ) / B ) * 100"
Else
	cFormula := cRodaTxt + " =>  C = B - "+Str(mv_par16,5,2)+"%  => (( C - A ) / C ) * 100"
EndIf

cabec1 := If( cPaisLoc $ "ANG|PTG", "TP CÓDIGO                                                  QUANTIDADE      UM      (A) CUSTO        CUSTO POR   VAL FACTURADO      (B) VALOR  IMPOSTOS NÃO    VLR FACTURADO -     MAR      MIX     MIX        CUSTO DE  VARIA", "TP CODIGO                                                  QUANTIDADE      UM      (A) CUSTO        CUSTO POR   VAL FATURADO      (B) VALOR  IMPOSTOS NAO    VAL FATURADO -     MAR      MIX     MIX        CUSTO DE  VARIA" )
cabec2 := If( cPaisLoc $ "ANG|PTG", "   Total          Unidade          Bruto       Facturado     Facturados     Imp. Não Fact.     Origem     *mar               Reposição      C.conc.", "                                                                                       TOTAL          UNIDADE          BRUTO       FATURADO     FATURADOS     IMP. NAO FAT.     GEM     *MAR               REPOSICAO    CAO" )




If (mv_par11 # 3)

	dbSelectArea( "SD1" )
	cArqSD1 := CriaTrab( NIL, .F.  )
	cKeySD1 := "D1_FILIAL+D1_COD+D1_SERIORI+D1_NFORI+D1_ITEMORI"

	cFilSD1 := "D1_FILIAL = '" + xFilial("SD1") + "'"
	cFilSD1 += " .And. D1_TIPO = 'D'"
	cFilSD1 += " .And. D1_COD >= '" + MV_PAR07 + "'"
	cFilSD1 += " .And. D1_COD <= '" + MV_PAR08 + "'"
	cFilSD1 += " .And. D1_LOCAL >= '" + MV_PAR01 + "'"
	cFilSD1 += " .And. D1_LOCAL <= '" + MV_PAR02 + "'"
	cFilSD1 += " .And. DTOS(D1_DTDIGIT) >= '" + DTOS(MV_PAR03) + "'"
	cFilSD1 += " .And. DTOS(D1_DTDIGIT) <= '" + DTOS(MV_PAR04) + "'"
	cFilSD1 += " .And. D1_TP >= '" + MV_PAR05 + "'"
	cFilSD1 += " .And. D1_TP <= '" + MV_PAR06 + "'"

	IndRegua("SD1",cArqSD1,cKeySD1,,cFilSD1,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))

	nIndSd1:=RetIndex("SD1")



	dbSetOrder(nIndSd1 + 1)
	dbGoTop()

EndIf

dbSelectArea( "SD2" )
dbSetOrder( 2 )

cKeySD2 := IndexKey()

If !Empty(aReturn[7])
	dbClearFilter()
    cKeySD2 += "+D2_DOC+D2_SERIE"
EndIf

aTam := TamSx3("D2_FILIAL")
Aadd(aCampos,{"D2_FILIAL","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_COD")
Aadd(aCampos,{"D2_COD","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_LOCAL")
Aadd(aCampos,{"D2_LOCAL","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_SERIE")
Aadd(aCampos,{"D2_SERIE","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_TES")
Aadd(aCampos,{"D2_TES","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_TP")
Aadd(aCampos,{"D2_TP","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_EMISSAO")
Aadd(aCampos,{"D2_EMISSAO","D",aTam[1],aTam[2]})
aTam := TamSx3("D2_TIPO")
Aadd(aCampos,{"D2_TIPO","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_DOC")
Aadd(aCampos,{"D2_DOC","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_QUANT")
Aadd(aCampos,{"D2_QUANT","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_TOTAL")
Aadd(aCampos,{"D2_TOTAL","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_CUSTO"+Str(mv_par09,1))
Aadd(aCampos,{"D2_CUSTO","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_VALIPI")
Aadd(aCampos,{"D2_VALIPI","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_VALICM")
Aadd(aCampos,{"D2_VALICM","N",aTam[1],aTam[2]})
aTam := TamSx3("D2_ITEM")
Aadd(aCampos,{"D2_ITEM","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_ORIGLAN")
Aadd(aCampos,{"D2_ORIGLAN","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_CLIENTE")
Aadd(aCampos,{"D2_CLIENTE","C",aTam[1],aTam[2]})
aTam := TamSx3("D2_LOJA")
Aadd(aCampos,{"D2_LOJA","C",aTam[1],aTam[2]})

If cPaisLoc<>"BRA"
	aStruct:=SD2->(dbStruct())
	For nCpo := 1 to Len(aStruct)
		If Substr(aStruct[nCpo][1],1,9)=="D2_VALIMP" .or.  Substr(aStruct[nCpo][1],1,9)=="D2_BASIMP"
			aTam := TamSx3(aStruct[nCpo][1])
			Aadd(aCampos,{aStruct[nCpo][1],"N",aTam[1],aTam[2]})
			Aadd(aImpVar,aStruct[nCpo][1])
		EndIf
	Next
EndIf

cArqTrab := CriaTrab(aCampos)
dbUseArea(.T.,,cArqTrab ,"TRB" , if(.F. .or. .T., !.T., NIL),.F. )
cArqTrb2 := CriaTrab( NIL, .F.  )
IndRegua("TRB",cArqTrb2,"D2_FILIAL+D2_TP+D2_COD+D2_DOC+D2_SERIE",,cFilSD2,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))


	If !(TcSrvType()=="AS/400") .And.  !("POSTGRES" $ TCGetDB())
		cAliasTop	:= CriaTrab("", .F. )
		lQuery		:= .T. 
		cQuery := " SELECT SD2.D2_FILIAL,SD2.D2_TP,SD2.D2_COD,SD2.D2_DOC,SD2.D2_SERIE,"
		cQuery += " SD2.D2_LOCAL,SD2.D2_TES,SD2.D2_EMISSAO,SD2.D2_TIPO,SD2.D2_QUANT,"
		cQuery += " SD2.D2_TOTAL,SD2.D2_CUSTO"+Str(mv_par09,1)+",SD2.D2_VALIPI,"
		cQuery += " SD2.D2_VALICM,SD2.D2_ORIGLAN,SD2.D2_CLIENTE,"
		cQuery += IIf(!Empty(aReturn[7]),A285QryFil("SD2",cQuery,aReturn[7]),"")
		cQuery += "	SD2.D2_ITEM,SD2.D2_LOJA"


		If cPaisLoc<>"BRA"
			For nCpo := 1 to Len(aImpVar)
				cQuery += ",SD2."+aImpVar[nCpo]
			Next
		Endif

		cQuery += " FROM " + RetSqlName("SD2") + " SD2 " + "," + RetSqlName("SF2") + " SF2 "
		cQuery += " WHERE SD2.D2_FILIAL = '" + xFilial("SD2") + "'"
		cQuery += " And SD2.D2_TP >= '" + MV_PAR05 + "'"
		cQuery += " And SD2.D2_TP <= '" + MV_PAR06 + "'"
		IF ! lVeic
			cQuery += " And SD2.D2_COD >= '" + MV_PAR07 + "'"
			cQuery += " And SD2.D2_COD <= '" + MV_PAR08 + "'"
		Endif

		cQuery += " And SD2.D2_LOCAL   >= '" + MV_PAR01       + "'"
		cQuery += " And SD2.D2_LOCAL   <= '" + MV_PAR02       + "'"
		cQuery += " And SD2.D2_EMISSAO >= '" + DTOS(MV_PAR03) + "'"
		cQuery += " And SD2.D2_EMISSAO <= '" + DTOS(MV_PAR04) + "'"
		cQuery += " And SF2.F2_FILIAL   = '" + xFilial("SF2") + "'"
		cQuery += " And SF2.F2_DOC      =   SD2.D2_DOC   "
		cQuery += " And SF2.F2_SERIE    =   SD2.D2_SERIE "
		cQuery += " And SF2.F2_LOJA     =   SD2.D2_LOJA  "
		cQuery += " And (NOT (SF2.F2_ESPECIE <> '"+ cEspecieLoja +"' AND SF2.F2_NFCUPOM <> ' ')) "

		If mv_par17 == 2
			cQuery += " And D2_TIPO <> 'D'"
		Endif


		If cPaisLoc<>"BRA"
			cQuery += " AND NOT ("+IsRemito(2,"D2_TIPODOC")+")"
		Endif

		cQuery += "	   And SF2.D_E_L_E_T_ = ' ' And SD2.D_E_L_E_T_ = ' ' "

		If !Empty(aReturn[7])
			cFilOrder := ", 4 , 5 "
		Endif

	 	cQuery += " ORDER BY  1 , 2 , 3 " + cFilOrder
		cQuery:=ChangeQuery(cQuery)
		MsAguarde({|| dbUseArea( .T. ,"TOPCONN",TCGenQry(,,cQuery),cAliasTop, .F. , .T. )},If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
		aEval(SD2->(dbStruct()), {|x| If(x[2] <> "C" .And.  FieldPos(x[1]) > 0, TcSetField(cAliasTop,x[1],x[2],x[3],x[4]),Nil)})
		SetRegua(LastRec())
		dbSelectArea(cAliasTop)

    Else


		cFilSD2 := "D2_FILIAL == '" + xFilial("SD2") + "'"
		cFilSD2 += " .And. D2_TP >= '" + MV_PAR05 + "'"
		cFilSD2 += " .And. D2_TP <= '" + MV_PAR06 + "'"
		IF ! lVeic
			cFilSD2 += " .And. D2_COD >= '" + MV_PAR07 + "'"
			cFilSD2 += " .And. D2_COD <= '" + MV_PAR08 + "'"
		Endif
		cFilSD2 += " .And. D2_LOCAL >= '" + MV_PAR01 + "'"
		cFilSD2 += " .And. D2_LOCAL <= '" + MV_PAR02 + "'"
		cFilSD2 += " .And. DTOS(D2_EMISSAO) >= '" + DTOS(MV_PAR03) + "'"
		cFilSD2 += " .And. DTOS(D2_EMISSAO) <= '" + DTOS(MV_PAR04) + "'"

		If mv_par17 == 2
			cFilSD2 += ' .And. D2_TIPO # "D"'
		Endif


		If cPaisLoc<>"BRA"
			cFilSD2	+= " .And. .Not. ("+IsRemito(2,"D2_TIPODOC")+")"
		Endif

		cArqSD2 := CriaTrab( NIL, .F.  )
		IndRegua("SD2",cArqSD2,cKeySD2,,cFilSD2,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))


	EndIf


GeraTrab("SD2",cAliasTop)

SB1->(dbSetOrder(1))

If mv_par11 <> 3
	dbSelectArea("SD1")
	dbGoTop()

		If !(TcSrvType()=="AS/400") .And.  !("POSTGRES" $ TCGetDB())
			cAliasTop	:= CriaTrab("", .F. )
			lQuery		:= .T. 
			cQuery := " SELECT SD1.D1_FILIAL,SD1.D1_TP,SD1.D1_COD,SD1.D1_DOC,SD1.D1_SERIE,"
			cQuery += " SD1.D1_LOCAL,SD1.D1_TES,SD1.D1_EMISSAO,SD1.D1_TIPO,SD1.D1_QUANT,"
			cQuery += " SD1.D1_TOTAL,SD1.D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1))+" ,SD1.D1_VALIPI,"
			cQuery += " SD1.D1_VALICM,SD1.D1_ORIGLAN,"
			cQuery += IIf(!Empty(aReturn[7]),A285QryFil("SD1",cQuery,aReturn[7]),"")
			cQuery += "	SD1.D1_ITEM,SD1.D1_LOJA"


			If cPaisLoc<>"BRA"
				For nCpo := 1 to Len(aImpVar)
					cQuery += ",SD1."+aImpVar[nCpo]
				Next
			Endif

			cQuery += " FROM " + RetSqlName("SD1") + " SD1 "
			cQuery += " WHERE SD1.D1_FILIAL = '" + xFilial("SD1") + "'"
			cQuery += " And SD1.D1_TP >= '" + MV_PAR05 + "'"
			cQuery += " And SD1.D1_TP <= '" + MV_PAR06 + "'"
			IF ! lVeic
				cQuery += " And SD1.D1_COD >= '" + MV_PAR07 + "'"
				cQuery += " And SD1.D1_COD <= '" + MV_PAR08 + "'"
			Endif

			cQuery += " And SD1.D1_LOCAL >= '" + MV_PAR01 + "'"
			cQuery += " And SD1.D1_LOCAL <= '" + MV_PAR02 + "'"
			cQuery += " And SD1.D1_EMISSAO >= '" + DTOS(MV_PAR03) + "'"
			cQuery += " And SD1.D1_EMISSAO <= '" + DTOS(MV_PAR04) + "'"

			If mv_par17 == 2
				cQuery += " And D1_TIPO = 'D'"
			Endif


			If cPaisLoc<>"BRA"
				cQuery += " AND NOT ("+IsRemito(2,"D1_TIPODOC")+")"
			Endif

			cQuery += "	   And D_E_L_E_T_ = ' ' "

			If !Empty(aReturn[7])
				cFilOrder := ", 4 , 5 "
			Endif

		 	cQuery += " ORDER BY  1 , 2 , 3 " + cFilOrder
			cQuery:=ChangeQuery(cQuery)
			MsAguarde({|| dbUseArea( .T. ,"TOPCONN",TCGenQry(,,cQuery),cAliasTop, .F. , .T. )},If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
			aEval(SD2->(dbStruct()), {|x| If(x[2] <> "C" .And.  FieldPos(x[1]) > 0, TcSetField(cAliasTop,x[1],x[2],x[3],x[4]),Nil)})
			SetRegua(LastRec())
			dbSelectArea(cAliasTop)

	    Else


			cFilSD2 := "D1_FILIAL == '" + xFilial("SD1") + "'"
			cFilSD2 += " .And. D1_TP >= '" + MV_PAR05 + "'"
			cFilSD2 += " .And. D1_TP <= '" + MV_PAR06 + "'"
			IF ! lVeic
				cFilSD2 += " .And. D1_COD >= '" + MV_PAR07 + "'"
				cFilSD2 += " .And. D1_COD <= '" + MV_PAR08 + "'"
			Endif
			cFilSD2 += " .And. D1_LOCAL >= '" + MV_PAR01 + "'"
			cFilSD2 += " .And. D1_LOCAL <= '" + MV_PAR02 + "'"
			cFilSD2 += " .And. DTOS(D1_EMISSAO) >= '" + DTOS(MV_PAR03) + "'"
			cFilSD2 += " .And. DTOS(D1_EMISSAO) <= '" + DTOS(MV_PAR04) + "'"

			If mv_par17 == 2
				cFilSD2 += ' .And. D1_TIPO = "D"'
			Endif


			If cPaisLoc<>"BRA"
				cFilSD2	+= " .And. .Not. ("+IsRemito(2,"D2_TIPODOC")+")"
			Endif
   			cKeySD1:=IndexKey()

			cArqSD2 := CriaTrab( NIL, .F.  )
			IndRegua("SD1",cArqSD2,cKeySD1,,cFilSD2,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))


		EndIf

	GeraTrab("SD1")
EndIf

dbSelectArea("TRB")
dbGoTop()

SetRegua(RecCount())

While lContinua .And.  !TRB->(Eof())

	If lEnd
		PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
		lContinua := .F. 
		Exit
	Endif

	IncRegua()

	If !(cCodAnt == TRB->D2_COD)
		cCodAnt    := TRB->D2_COD
		lDevolucao := .T. 
	EndIf

	SB1->(dbSeek(xFilial("SB1") + TRB->D2_COD))





	If !(TRB->D2_ORIGLAN == "LF") .And.  AvalTes(TRB->D2_TES,cEstoq,cDupli)
		If TRB->D2_TIPO <> "D"
			If (mv_par09 > 1)
				nValCus := TRB->D2_CUSTO
				If nValCus > 0
					nTotLuc += nValCus
				Else
					nTotLuc += xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				EndIf
			Else
				nTotLuc += TRB->D2_CUSTO
			EndIf
			If cPaisLoc<>"BRA"
				nTotFat +=  ValSD2()
			Else
				If (mv_par09 > 1)
					nTotFat += xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				Else
					nTotFat += ValSD2()
				EndIf
			EndIf
		Else
			If (mv_par09 > 1)
				nValCus := TRB->D2_CUSTO
				If nValCus > 0
					nTotLuc -= nValCus
				Else
					nTotLuc -= xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				EndIf
			Else
				nTotLuc -= TRB->D2_CUSTO
			EndIf
			If cPaisLoc<>"BRA"
				nTotFat -=  ValSD2()
			Else
				If (mv_par09 > 1)
					nTotFat -= xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
				Else
					nTotFat -= ValSD2()
				EndIf
			EndIf
		Endif
		Do Case
		Case (mv_par11 == 1)
			DbSelectArea( "SD1" )
			If DbSeek( xFilial("SD1") + TRB->D2_COD + TRB->D2_SERIE + TRB->D2_DOC + TRB->D2_ITEM, .F.  )
				While !SD1->(Eof()) .And.  (SD1->D1_COD == TRB->D2_COD) .And.  (TRB->D2_SERIE+TRB->D2_DOC+TRB->D2_ITEM == SD1->D1_SERIORI+SD1->D1_NFORI+AllTrim(SD1->D1_ITEMORI))




					If !(D1_ORIGLAN == "LF") .And.  AvalTes(D1_TES,cEstoq,cDupli)

						If (mv_par09 > 1)
							nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
							if nValCus > 0
								nTotLuc -= nValCus
							else
								nTotLuc -= xMoeda( D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
							endif
						Else
							nTotLuc -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
						EndIf

						If (mv_par09 > 1)
							nTotFat -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
						Else
							nTotFat -= ValSD1()
						EndIf
					EndIf
					dbSelectArea("SD1")
					DbSkip( 1 )
				EndDo
			EndIf
		Case (mv_par11 == 2) .And.  lDevolucao
			DbSelectArea( "SD1" )
			If DbSeek( xFilial("SD1") + TRB->D2_COD + TRB->D2_SERIE + TRB->D2_DOC, .F.  )
				While !SD1->(Eof()) .And.  (SD1->D1_COD == TRB->D2_COD) .And.  (TRB->D2_SERIE+TRB->D2_DOC == SD1->D1_SERIORI+SD1->D1_NFORI)




					If !(D1_ORIGLAN == "LF") .And.  AvalTes(D1_TES,cEstoq,cDupli)

						If (mv_par09 > 1)
							nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
							if nValCus > 0
								nTotLuc -= nValCus
							else
								nTotLuc -= xMoeda( D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
							endif
						Else
							nTotLuc -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
						EndIf

						If (mv_par09 > 1)
							nTotFat -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
						Else
							nTotFat -= ValSD1()
						EndIf
					EndIf
					dbSelectArea("SD1")
					DbSkip( 1 )
				EndDo
			EndIf
		EndCase
	EndIf

	DbSelectArea( "TRB" )
	DbSkip( 1 )
	lDevolucao := !(TRB->D2_TIPO == "D")
EndDo

nTotLuc := c310AbaVal(nTotFat)-nTotLuc

TRB->(DbGoTop())

nAg1	:= 0
nAg1Cus	:= 0
nAg2	:= 0
nAg3	:= 0
nAg4	:= 0
nAg5	:= 0
cCodAnt := ""

dbSelectArea("TRB")
While lContinua .And.  !TRB->(Eof())

	If lEnd
		PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
		Exit
	Endif

	nAt1	:= 0
	nAt1Cus	:= 0
	nAt2	:= 0
	nAt3	:= 0
	nAt4	:= 0
	nAt5	:= 0

	lPassou := .F. 
	cTipant := TRB->D2_TP

	While lContinua .And.  !TRB->(Eof()) .And.  (TRB->D2_TP == cTipant)

		IF lEnd
			PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
			lContinua := .F. 
			Exit
		Endif

		SB1->(DbSeek( xFilial("SB1") + TRB->D2_COD, .F.  ))

		nAp1 	:= 0
		nAp1Cus	:= 0
		nAp2	:= 0
		nAp3	:= 0
		nAp4	:= 0
		nAp5	:= 0

		If !(cCodAnt == TRB->D2_COD)
			cCodAnt    := TRB->D2_COD
			lDevolucao := !(TRB->D2_TIPO == "D")
		EndIf

		While lContinua .And.  !TRB->(Eof()) .And.   TRB->D2_TP+TRB->D2_COD == cTipant+cCodAnt

			IF lEnd
				PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
				lContinua := .F. 
				Exit
			Endif

			IncRegua()





			If !(TRB->D2_ORIGLAN == "LF") .And.  AvalTes(TRB->D2_TES,cEstoq,cDupli)
				If !(TRB->D2_TIPO == "D")
					If AvalTes(TRB->D2_TES,"S")
						nAp1Cus+=TRB->D2_QUANT
					Endif
					nAp1 += TRB->D2_QUANT
					If (mv_par09 > 1)
						nValCus := TRB->D2_CUSTO
						if nValCus > 0
							nAp2 += nValCus
						else
							nAp2 += xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						endif
					Else
						nAp2 += TRB->D2_CUSTO
					EndIf

					If (mv_par09 > 1)
						nAp3 += Iif(cPaisLoc<>"BRA",ValSD2(),xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO ))
						If cPaisLoc=="BRA"
							nAp5 += xMoeda( TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						Else
							nAp5 += SumTaxSD2( .F. )
						EndIf
					Else
						nAp3 += ValSD2()
						If cPaisLoc=="BRA"
							nAp5 += TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0)
						Else
							nAp5 += SumTaxSD2( .F. )
						EndIf
					EndIF

					If mv_par09 > 1
						nAp4 += (TRB->D2_QUANT*xMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
					Else
						If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
							nAp4 += (TRB->D2_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
						Else
							nAp4 += (TRB->D2_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
						EndIf
					EndIF
				Else
					If AvalTes(TRB->D2_TES,"S")
						nAp1Cus-=TRB->D2_QUANT
					Endif
					nAp1 -= TRB->D2_QUANT
					If (mv_par09 > 1)
						nValCus := TRB->D2_CUSTO
						if nValCus > 0
							nAp2 -= nValCus
						else
							nAp2 -= xMoeda( TRB->D2_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						endif
					Else
						nAp2 -= TRB->D2_CUSTO
					EndIf

					If (mv_par09 > 1)
						nAp3 -= xMoeda( ValSD2(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						If cPaisLoc=="BRA"
							nAp5 -= xMoeda( TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, TRB->D2_EMISSAO )
						Else
							nAp5 -=  SumTaxSD2( .F. )
						EndIf
					Else
						nAp3 -= ValSD2()
						If cPaisLoc=="BRA"
							nAp5 -= TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0)
						Else
							nAp5 -= SumTaxSD2( .F. )
						EndIf
					EndIF

					If mv_par09 > 1
						nAp4 -= (TRB->D2_QUANT*xMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
					Else
						If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
							nAp4 -= (TRB->D2_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
						Else
							nAp4 -= (TRB->D2_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
						EndIf
					EndIF
				Endif
				Do Case
				Case (mv_par11 == 1)
					DbSelectArea( "SD1" )
					If DbSeek( xFilial("SD1") + TRB->D2_COD+TRB->D2_SERIE+TRB->D2_DOC+TRB->D2_ITEM, .F.  )
						While !SD1->(Eof()) .And.  (D1_COD == cCodAnt) .And.  (TRB->D2_SERIE+TRB->D2_DOC+TRB->D2_ITEM == SD1->D1_SERIORI+SD1->D1_NFORI+AllTrim(SD1->D1_ITEMORI))




							If !(SD1->D1_ORIGLAN == "LF") .And.  AvalTes(SD1->D1_TES,cEstoq,cDupli)
								If AvalTes(D1_TES,"S")
									nAp1Cus -= D1_QUANT
								Endif
								nAp1 -= SD1->D1_QUANT
								If (mv_par09 > 1)
									nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
									if nValCus > 0
										nAP2 -= nValCus
									else
										nAp2 -= xMoeda(SD1->D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),nMoeda, SD1->D1_DTDIGIT )
									endif
								Else
									nAp2 -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
								EndIf

								If (mv_par09 > 1)
									nAp3 -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, SD1->D1_DTDIGIT )
									If cPaisLoc = "BRA"
										nAp5 -= xMoeda( SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, SD1->D1_DTDIGIT )
									Else
										nAp5 -= SumTaxSD1( .F. )
									EndIf
								Else
									nAp3 -= ValSD1()
									If cPaisLoc="BRA"
										nAp5 -= SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0)
									Else
										nAp5 -= SumTaxSD1( .F. )
									EndIf
								EndIF

								If mv_par09 > 1
									nAp4 -= (SD1->D1_QUANT*xMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
								Else
									If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
										nAp4 -= (SD1->D1_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
									Else
										nAp4 -= (SD1->D1_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
									EndIf
								EndIF
							EndIf
							dbSelectArea("SD1")
							DbSkip( 1 )
						EndDo
					EndIf
				Case (mv_par11 == 2) .And.  lDevolucao
			 		DbSelectArea( "SD1" )
					If DbSeek( xFilial("SD1") +TRB->D2_COD+TRB->D2_SERIE+TRB->D2_DOC, .F.  )
						While !SD1->(Eof()) .And.  (D1_COD == cCodAnt) .And.  (TRB->D2_SERIE+TRB->D2_DOC == SD1->D1_SERIORI+SD1->D1_NFORI)




							If !(D1_ORIGLAN == "LF") .And.  AvalTes(D1_TES,cEstoq,cDupli)
								If AvalTes(D1_TES,"S")
									nAp1Cus -= D1_QUANT
								Endif
								nAp1 -= D1_QUANT
								If (mv_par09 > 1)
									nValCus :=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
									if nValCus > 0
										nAp2 -= nValCus
									else
										nAp2 -= xMoeda( D1_CUSTO, Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
									endif
								Else
									nAp2 -=  &("D1_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)) )
								EndIf

								If (mv_par09 > 1)
									nAp3 -= xMoeda( ValSD1(), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, D1_DTDIGIT )
									If cPaisLoc = "BRA"
										nAp5 -= xMoeda( SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),nMoeda,D1_DTDIGIT )
									Else
										nAp5 -=  SumTaxSD1( .F. )
									EndIf
								Else
									nAp3 -= ValSD1()
									If cPaisLoc = "BRA"
										nAp5 -= SD1->D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,SD1->D1_VALIPI,0)
									Else
										nAp5 -= SumTaxSD1( .F. )
									EndIf
								EndIF

								If mv_par09 > 1
									nAp4 -= (D1_QUANT*xMoeda( RetFldProd(SB1->B1_COD,"B1_CUSTD"), Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")), nMoeda, RetFldProd(SB1->B1_COD,"B1_DATREF") ))
								Else
									If RetFldProd(SB1->B1_COD,"B1_MCUSTD") > "1" .and.  !Empty(RetFldProd(SB1->B1_COD,"B1_MCUSTD"))
										nAp4 -= (D1_QUANT*(XMoeda(RetFldProd(SB1->B1_COD,"B1_CUSTD"),Val(RetFldProd(SB1->B1_COD,"B1_MCUSTD")),1,dDataBase)))
									Else
										nAp4 -= (D1_QUANT*RetFldProd(SB1->B1_COD,"B1_CUSTD"))
									EndIf
								EndIF
							EndIf
							dbSelectArea("SD1")
							DbSkip( 1 )
						EndDo
					EndIf
				EndCase

			EndIf
			DbSelectArea( "TRB" )
			dbSkip()
			lDevolucao := !(TRB->D2_TIPO == "D")
		EndDo

		IF lEND
			EXIT
		ENDIF

		If nAp1 <> 0 .Or.  nAp2 <> 0 .Or.  nAp3 <> 0 .Or.  nAp4 <> 0 .And.  lDevolucao

			If li > 55
				Cabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)
			EndIf

			lPassou := .T. 
			nCntImpr++
			if lVeic
			   IF sb1->(dbseek( xFilial("SB1") + cCodAnt ))
			      IF !EMPTY(SB1->B1_CODITE)
						PrintOut(li,003,"[ "+SB1->B1_CODITE+" ] GRUPO : [ "+SB1->B1_GRUPO+" ]",,)
						li++
					ENDIF
				ENDIF
			endif

			PrintOut(li,000,cTipant,,)
			PrintOut(li,003,cCodAnt,,)
			PrintOut(li,057,nAp1,PesqPictQt("D2_QUANT",16),)
			PrintOut(li,075,SB1->B1_UM,,)
			PrintOut(li,078,nAp2,TM(nAp2,14),)

			PrintOut(li,094,(Iif(nAp1Cus<>0,nAp2/nAp1Cus,0)),TM(nAp2,14),)
			PrintOut(li,110,nAp5,TM(nAp5,14),)
			PrintOut(li,125,nAp3,TM(nAp3,14),)

			If nAp3 <> 0
				PrintOut(li,141,nAp5-(c310AbaVal(nAp5)),TM(nAp5,12),)
				PrintOut(li,157,nAp3-(nAp5-(c310AbaVal(nAp5))),TM(nAp3,14),)
				PrintOut(li,173,100*(c310AbaVal(nAp3)-nAp2)/c310AbaVal(nAp3),"9999999.9",)
			EndIf
			If nTotFat <> 0
				PrintOut(li,183,100*c310AbaVal(nAp3)/c310AbaVal(nTotFat),"9999.9",)
			EndIf
			If nTotLuc <> 0
				PrintOut(li,190,IIF(nAp3-nAp2>0,"+","-"),,)
				PrintOut(li,191,100*(c310AbaVal(nAp3)-nAp2)/nTotLuc,"9999.9",)
			EndIf
			PrintOut(li,199,nAp4,TM(nAp4,14),)
			If nAp2 <> 0
				PrintOut(li,214,(100*nAp4/nAp2)-100,"9999.9",)
			EndIf

			li++
			nAt1	+= nAp1
			nAt1Cus	+= nAp1Cus
			nAt2	+= nAp2
			nAt3	+= nAp3
			nAt4	+= nAp4
			nAt5	+= nAp5
		Endif
		DbSelectArea( "TRB" )
	EndDo
	IF lEND
	   EXIT
	ENDIF
	If lPassou
		If li > 59
			Cabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)
		EndIf

		PrintOut(li,000,If(cPaisLoc$"ANG|PTG","Sub total : ","Sub Total : ")+cTipant,,)
		PrintOut(li,057,nAt1,PesqPictQt("D2_QUANT",16),)
		PrintOut(li,078,nAt2,TM(nAt2,14),)
		PrintOut(li,094,(nAt2/nAt1Cus),TM(nAt2,14),)
		PrintOut(li,110,nAt5,TM(nAt5,14),)
		PrintOut(li,125,nAt3,TM(nAt3,14),)
		If nAt3#0
			PrintOut(li,141,nAt5-(c310AbaVal(nAt5)),TM(nAp3,12),)
			PrintOut(li,157,nAt3-(nAt5-(c310AbaVal(nAt5))),TM(nAp3,14),)
			PrintOut(li,173,100*(c310AbaVal(nAt3)-nAt2)/c310AbaVal(nAt3),"9999999.9",)
		EndIf
		PrintOut(li,183,100*(c310AbaVal(nAt3))/c310AbaVal(nTotfat),"9999.9",)
		If nTotLuc <> 0
			PrintOut(li,190,IIF(nAt3-nAt2>0,"+","-"),,)
			PrintOut(li,191,100*(c310AbaVal(nAt3)-nAt2)/nTotLuc,"9999.9",)
		EndIF
		PrintOut(li,199,nAt4,tm(nAt4,14),)
		If nAt2 <> 0
			PrintOut(li,214,(100*nAt4/nAt2)-100,"9999.9",)
		EndIF

		li += 2
		nAg1	+= nAt1
		nAg1Cus	+= nAt1Cus
		nAg2	+= nAt2
		nAg3	+= nAt3
		nAg4	+= nAt4
		nAg5	+= nAt5
	EndIf
	DbSelectArea( "TRB" )
EndDo

IF ! lEND
	If li > 59
		Cabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)
	EndIf
	PrintOut(li,000,If(cPaisLoc$"ANG|PTG","T o t a l ---> ","T O T A L ---> "),,)
	PrintOut(li,057,nAg1,PesqPictQt("D2_QUANT",16),)
	PrintOut(li,078,nAg2,TM(nAg2,14),)
	PrintOut(li,094,(nAg2/nAg1Cus),TM(nAg2,14),)
	PrintOut(li,110,nAg5,TM(nAg5,14),)
	PrintOut(li,125,nAg3,TM(nAg3,14),)
	If nAg3 <> 0
		PrintOut(li,141,nAg5-(c310AbaVal(nAg5)),TM(nAp3,12),)
		PrintOut(li,157,nAg3-(nAg5-(c310AbaVal(nAg5))),TM(nAp3,14),)
		PrintOut(li,173,100*(c310AbaVal(nAg3)-nAg2)/c310AbaVal(nAg3),"9999999.9",)
	EndIF
	If nTotFat <> 0
		PrintOut(li,183,100*c310AbaVal(nAg3)/c310AbaVal(nTotFat),"9999.9",)
	EndIF
	If nTotluc <> 0
		PrintOut(li,190,IIF(nAg3-nAg2>0,"+","-"),,)
		PrintOut(li,191,100*(c310AbaVal(nAg3)-nAg2)/nTotLuc,"9999.9",)
	EndIF
	PrintOut(li,199,nAg4,tm(nAg4,14),)
	If nAg2#0
		PrintOut(li,214,(100*nAg4/nAg2)-100,"9999.9",)
	EndIF
	LI++
	LI++
	PrintOut(li,00,OemToAnsi(cFormula),,)
	LI++
	Roda(nCntImpr,cRodaTxt,Tamanho)
ENDIF




dbSelectArea(cString)
dbClearFilter()
ordSetFocus( 1 )

If aReturn[5] = 1
	Set( 24, "" )
	dbCommitAll()
	OurSpool(wnrel)
Endif

MS_FLUSH()

DbSelectArea( "SD1" )
RetIndex( "SD1" )
dbSetOrder(1)

DbSelectArea( "SD2" )
RetIndex( "SD2" )
dbSetOrder(1)

IF "" <> ALLTRIM(cArqSD1)
   IF File(cArqSD1+OrdBagExt())
		Ferase(cArqSD1+OrdBagExt())
	ENDIF
Endif

IF "" <> ALLTRIM(cArqSD2)
	IF File(cArqSD2+OrdBagExt())
		FErase(cArqSD2+OrdBagExt())
	ENDIF
Endif

dbSelectArea("TRB")
dbCloseArea()
If File(cArqTrab+GetDBExtension())
	FErase(cArqTrab+GetDBExtension())
Endif
If File(cArqTrb2+OrdBagExt())
	FErase(cArqTrb2+OrdBagExt())
Endif

RETURN













Static Function ValSD1()
Local nValRet	:=0, nImpInc:=0,nImpNoInc:=0
Local aImpostos:={}
Local nY := 0

If ( cPaisLoc=="BRA" )
	nValRet:=D1_TOTAL-SD1->D1_VALDESC+IF(mv_par10 == 1,D1_VALIPI,0)-IF(mv_par14 == 1,0,D1_VALICM)-IF(mv_par18 == 1,0,PisCofins("SD1",1,2,1) + PisCofins("SD1",2,2,1))
ElseIf (mv_par10==1.Or.mv_par14<>1)
	aImpostos:=TesImpInf(SD1->D1_TES)
	For nY:=1 to Len(aImpostos)
		cCampImp:="SD1->D1_"+(Substr(aImpostos[nY][2],4))
		If ( aImpostos[nY][3]=="1" )
			nImpInc  += &cCampImp
		Else
			nImpNoInc+= &cCampImp
		EndIf
	Next
	nValRet:=D1_TOTAL-D1_VALDESC+IF(mv_par10 == 1,nImpInc,0)-IF(mv_par14 == 1,0,nImpNoInc)-IF(mv_par18 == 1,0,PisCofins("SD1",1,2,1) + PisCofins("SD1",2,2,1))
Else
	nValRet:=D1_TOTAL-D1_VALDESC
EndIf

If cPaisLoc<>"BRA"

	nValRet := CalcMoed("SF1",nValRet)

EndIf
RETURN nValRet














Static Function ValSD2()
Local nValRet	:=0, nImpInc:=0,nImpNoInc:=0
Local aImpostos:={}
Local nY := 0

If ( cPaisLoc=="BRA" )
	nValRet:=TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0)-IF(mv_par14 == 1,0,TRB->D2_VALICM)- IF(mv_par18 == 1,0,PisCofins("TRB",1,2,2) + PisCofins("TRB",2,2,2))
ElseIf (mv_par10==1.Or.mv_par14<>1)
	aImpostos:=TesImpInf(TRB->D2_TES)
	For nY:=1 to Len(aImpostos)
		cCampImp:="TRB->D2_"+(Substr(aImpostos[nY][2],4))
		If ( aImpostos[nY][3]=="1" )
			nImpInc  += &cCampImp
		Else
			nImpNoInc+= &cCampImp
		EndIf
	Next
	nValRet:=TRB->D2_TOTAL+IF(mv_par10 == 1,nImpInc,0)-IF(mv_par14 == 1,0,nImpNoInc) - IF(mv_par18 == 1,0,PisCofins("TRB",1,2,2) + PisCofins("TRB",2,2,2))
Else
	nValRet:=TRB->D2_TOTAL
EndIf

If cPaisLoc<>"BRA"

	nValRet := CalcMoed("SF2",nValRet)

EndIf
RETURN nValRet
















Static Function c310AbaVal(nValor)
LOCAL perc := mv_par16
If mv_par15 == 2
	nValor := nValor - (nValor * perc /100)
EndIf
Return(nValor)












Static Function GeraTrab(cAlias,cAliasTrb,lGrafico)
Local nPosFirst, nCpos, lSeek
Local nCpo      := 0
Local lRetPE    := .T. 
Local lMR110FIL := ExistBlock("MR110FIL")
lGrafico := If( lGrafico == nil, .F. , lGrafico ) ;

cAliasTrb := IIF(cAliasTrb==Nil,cAlias,cAliasTrb)

dbSelectArea(cAliasTrb)
dbGoTop()
While !Eof() .And.  &(Subs(cAlias,2,2)+"_FILIAL") == xFilial(cAlias)

	dbSelectArea(cAliasTrb)



	IF LVEIC
	   lT := .T. 
	   DBSELECTAREA("SB1")
	   DBSEEK( xFilial("SB1") + &(cAliasTrb+"->"+Subs(cAlias,2,2)+"_COD"))
		IF !EOF()
		   IF (SB1->B1_CODITE >= mv_par07 .and.  SB1->B1_CODITE <= mv_par08)
			   lT := .F. 
			ENDIF
		ENDIF
		dbSelectArea(cAliasTrb)
		if lT
		   DBSKIP()
		   LOOP
	   endif
	ENDIF

   If cAlias == "SD2"



		If !lGrafico
			If !Empty(aReturn[7]) .And.  !&(aReturn[7])
				dbSkip()
				Loop
			EndIf
		Endif










	EndIf

	If cAlias == "SD1" .And.  TRB->(lSeek:=(dbSeek((cAliasTrb)->D1_FILIAL+(cAliasTrb)->D1_TP+(cAliasTrb)->D1_COD+(cAliasTrb)->D1_NFORI+(cAliasTrb)->D1_SERIORI))) .And.  TRB->D2_TIPO == "N"
		dbSkip()
		loop
	EndIf
	If cAlias == "SD1" .And.  MV_PAR11 == 3 .And.  (cAliasTrb)->D1_TIPO == "D"
		dbSkip()
		Loop
	EndIf




	If cAlias == "SD1" .And.  lMR110FIL .And.  !lGrafico
        lRetPe := ExecBlock("MR110FIL", .F. , .F. , {aReturn[7]} )
        If ValType(lRetPE)=="L" .And.  lRetPe== .F. 
			dbSkip()
			Loop
        EndIf
	EndIf

	dbSelectArea("TRB")
	Reclock("TRB", .T. )
	_FIELD->TRB->D2_FILIAL :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_FILIAL")
	_FIELD->TRB->D2_COD :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_COD")
	_FIELD->TRB->D2_LOCAL :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_LOCAL")
	If cAlias == "SD2"
		_FIELD->TRB->D2_SERIE :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_SERIE")
	Else
		_FIELD->TRB->D2_SERIE :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_SERIORI")
	Endif
	_FIELD->TRB->D2_TES :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_TES")
	_FIELD->TRB->D2_TP :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_TP")
	_FIELD->TRB->D2_EMISSAO :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_EMISSAO")
	_FIELD->TRB->D2_TIPO :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_TIPO")
	If cALIAS == "SD2"
		_FIELD->TRB->D2_DOC :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_DOC")
	Else
		_FIELD->TRB->D2_DOC :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_NFORI")
	Endif
	_FIELD->TRB->D2_QUANT :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_QUANT")
	_FIELD->TRB->D2_TOTAL :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_TOTAL")
	If cAlias == "SD1" .And.  MV_PAR11 == 2 .And.  (cAliasTrb)->D1_TIPO == "D"
		_FIELD->TRB->D2_TOTAL := TRB->D2_TOTAL-&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_VALDESC")
    EndIf
	_FIELD->TRB->D2_VALIPI :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_VALIPI")
	_FIELD->TRB->D2_VALICM :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_VALICM")
	_FIELD->TRB->D2_ITEM :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_ITEM")
	_FIELD->TRB->D2_ORIGLAN :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_ORIGLAN")
	_FIELD->TRB->D2_LOJA :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_LOJA")

	If cAlias == "SD2"
		_FIELD->TRB->D2_CUSTO :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_CUSTO"+Str(mv_par09,1))
		_FIELD->TRB->D2_CLIENTE :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_CLIENTE")
	Else
		_FIELD->TRB->D2_CUSTO :=&(cAliasTrb+"->"+Subs(cAlias,2,2)+"_CUSTO"+If((mv_par09==1),"",Str(mv_par09,1)))
	EndIf

	If cPaisLoc<>"BRA" .And.  cAlias == "SD2"
		nPosFirst := AScan(aCampos,{|x| "D2_VALIMP"$Alltrim(x[1]) .or.  "D2_BASIMP"$AllTrim(x[1])})
		For nCpo := nPosFirst to Len(aCampos)
			If "D2_VALIMP"$aCampos[nCpo][1] .or.  "D2_BASIMP"$aCampos[nCpo][1]
				_FIELD->TRB->&(aCampos[nCpo][1]) :=&(cAliasTrb+"->"+Substr(cAlias,2,2)+Substr(aCampos[nCpo][1],3,8))
			EndIf
		Next
	EndIf
	MsUnlock()
	dbSelectArea(cAliasTrb)
	dbSkip()
EndDo
TRB->(dbGoTop())
Return














Static Function SumTaxSD2(lNoInc)
Local nValRet	:=0, nImpInc:=0,nImpNoInc:=0
Local aImpostos:={}
Local nY := 0

If ( cPaisLoc=="BRA" )
	If lNoInc
		nValRet:=TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0)-IF(mv_par14 == 1,0,TRB->D2_VALICM)
	Else
		nValRet:=TRB->D2_TOTAL+IF(mv_par10 == 1,TRB->D2_VALIPI,0)
	EndIf
Else
	aImpostos:=TesImpInf(TRB->D2_TES)
	For nY:=1 to Len(aImpostos)
		cCampImp:="TRB->D2_"+(Substr(aImpostos[nY][2],4))
		If ( aImpostos[nY][3]=="1" )
			nImpInc  += &cCampImp
		Else
			nImpNoInc+= &cCampImp
		EndIf
	Next
	If lNoInc
		nValRet:=TRB->D2_TOTAL+IF(mv_par10 == 1,nImpInc,0)-IF(mv_par14 == 1,0,nImpNoInc)
	Else
		nValRet:=TRB->D2_TOTAL+IF(mv_par10 == 1,nImpInc,0)
	EndIf
EndIf
If cPaisLoc<>"BRA"

	nValRet := CalcMoed("SF2",nValRet)

EndIf
RETURN nValRet














Static Function SumTaxSD1(lNoInc)
Local nValRet	:=0, nImpInc:=0,nImpNoInc:=0
Local aImpostos:={}
Local nY :=0

If ( cPaisLoc=="BRA" )
	If lNoInc
		nValRet:=D1_TOTAL+IF(mv_par10 == 1,D1_VALIPI,0)-IF(mv_par14 == 1,0,D1_VALICM)
	Else
		nValRet:=D1_TOTAL+IF(mv_par10 == 1,D1_VALIPI,0)
	EndIf
Else
	aImpostos:=TesImpInf(SD1->D1_TES)
	For nY:=1 to Len(aImpostos)
		cCampImp:="SD1->D1_"+(Substr(aImpostos[nY][2],4))
		If ( aImpostos[nY][3]=="1" )
			nImpInc  += &cCampImp
		Else
			nImpNoInc+= &cCampImp
		EndIf
	Next
	If lNoInc
		nValRet:=D1_TOTAL+IF(mv_par10 == 1,nImpInc,0)-IF(mv_par14 == 1,0,nImpNoInc)
	Else
		nValRet:=D1_TOTAL+IF(mv_par10 == 1,nImpInc,0)
	EndIf
EndIf

If cPaisLoc<>"BRA"

	nValRet := CalcMoed("SF1",nValRet)

EndIf
RETURN nValRet




















Static Function PisCofins(cAliasNew,nPisCof,nBasVal,nEntrSai)

Local cAliasSB1  := "SB1"
Local cAliasSF4  := "SF4"
Local cAliasSF2  := "SF2"
Local cAliasSF1  := "SF1"
Local cCpVlPisEn := ""
Local cCpBsPisEn := ""
Local cCpVlPisSa := ""
Local cCpBsPisSa := ""
Local cCpVlCofEn :=  ""
Local cCpBsCofEn :=  ""
Local cCpVlCofSa :=  ""
Local cCpBsCofSa :=  ""
Local aRelImp	 := MaFisRelImp("MT100",{ "SD1" })
Local aRelImp2	 := MaFisRelImp("MT100",{ "SD2" })
Local nRedPis	 := 1
Local nRedCOF	 := 1
Local nPsVlPisEn := 0
Local nPsBsPisEn := 0
Local nPsVlPisSa := 0
Local nPsBsPisSa := 0
Local nBasCofins := 0
Local nPsVlCofEn := 0
Local nPsBsCofEn := 0
Local nPsVlCofSa := 0
Local nPsBsCofSa := 0
Local nScanPis   := 0
Local nScanCof   := 0
Local nTxPis     := 0
Local nTxCof     := 0
Local nRetorno   := 0





If nEntrSai == 1




	If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_BASEPS2"} ) )
		cCpBsPisEn := aRelImp[nScanPis,2]
		nPsBsPisEn := SD1->(FieldPos(cCpBsPisEn))
	EndIf
	If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_VALPS2"} ) )
		cCpVlPisEn := aRelImp[nScanPis,2]
		nPsVlPisEn := SD1->(FieldPos(cCpVlPisEn))
	EndIf




	If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_BASECF2"} ) )
		cCpBsCofEn := aRelImp[nScanCof,2]
		nPsBsCofEn := SD1->(FieldPos(cCpBsCofEn))
	EndIf
	If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_VALCF2"} ) )
		cCpVlCofEn := aRelImp[nScanCof,2]
		nPsVlCofEn := SD1->(FieldPos(cCpVlCofEn))
	EndIf

	dbSelectArea(cAliasNew)


	SF4->(dbSetOrder(1))
	SF4->(MsSeek(xFilial("SF4") + (cAliasNew)->D1_TES))
	SB1->(dbSetOrder(1))
	SB1->(MsSeek(xFilial("SB1") + (cAliasNew)->D1_COD))
	SF1->(dbSetOrder(1))
	SF1->(MsSeek(xFilial("SF1") +(cAliasNew)->D1_DOC+(cAliasNew)->D1_SERIE+(cAliasNew)->D1_FORNECE+(cAliasNew)->D1_LOJA+(cAliasNew)->D1_TIPO))

	If (cAliasSF4)->F4_AGREG <> "N"
		If SB1->(FieldPos("B1_PPIS")) >0
			nTxPIS	:= 	if((cAliasSB1)->B1_PPIS <> 0,(cAliasSB1)->B1_PPIS , GetMv("MV_TXPIS"))
		Endif
		If SB1->(FieldPos("B1_REDPIS")) > 0
			nRedPIS	:= 	Iif((cAliasSB1)->B1_REDPIS > 0,1-((cAliasSB1)->B1_REDPIS / 100 ), 1 )
		Endif
		If SF4->(FieldPos("F4_BASEPIS")) > 0
			nRedPIS	*= 	Iif((cAliasSF4)->F4_BASEPIS > 0,1-((cAliasSF4)->F4_BASEPIS / 100 ), 1 )
		Endif
		If SB1->(FieldPos("B1_REDCOF")) > 0
			nRedCOF	:= 	Iif((cAliasSB1)->B1_REDCOF > 0,1-((cAliasSB1)->B1_REDCOF / 100 ), 1 )
		Endif
		If SF4->(FieldPos("F4_BASECOF")) > 0
			nRedCOF	*= 	Iif((cAliasSF4)->F4_BASECOF > 0,1-((cAliasSF4)->F4_BASECOF / 100 ), 1 )
		EndIf
		If SB1->(FieldPos("B1_PCOFINS")) > 0
			nTxCOF	:=	if((cAliasSB1)->B1_PCOFINS <> 0,(cAliasSB1)->B1_PCOFINS , GetMv("MV_TXCOFIN"))
		Endif

		If SF4->(FieldPos("F4_PISCOF")) >0

			If (cAliasSF4)->F4_PISCOF $ "13" .And.  nPisCof == 1

				If SF4->(FieldPos("F4_PISCRED")) >0
					nRetorno := 0



					If !Empty( nPsVlPisEn ) .And.  !Empty( nPsBsPisEn )
						If nBasVal == 2
							nRetorno := ( cAliasNew )->( FieldGet( nPsVlPisEn ) )
						Else
							nRetorno := ( cAliasNew )->( FieldGet( nPsBsPisEn ) )
						Endif
					EndIf




					If !Empty( nRetorno )
						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetorno := ( cAliasNew )->( FieldGet( nPsVlPisEn ) )
							Else
								nRetorno := ( cAliasNew )->( FieldGet( nPsBsPisEn ) )
							Endif
						ElseIf (cAliasSF4)->F4_PISCRED =="2"
							If nBasVal == 2
								nRetorno := ( cAliasNew )->( FieldGet( nPsVlPisEn ) )
							Else
								nRetorno := ( cAliasNew )->( FieldGet( nPsBsPisEn ) )
							Endif
						Endif

					Else

						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetorno  := ( ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC) * nRedPis) * (nTxPIS/100)
							Else
								nRetorno := ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC )  * nRedPis
							Endif
						ElseIf (cAliasSF4)->F4_PISCRED =="2"
							If nBasVal == 2
								nRetorno := ( ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC) * nRedPis) * (nTxPIS/100)
							Else
								nRetorno := ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC  ) * nRedPis
							Endif
						Endif

					EndIf

				EndIf

			ElseIf (cAliasSF4)->F4_PISCOF $ "23" .And.  nPisCof == 2

				If SF4->(FieldPos("F4_PISCRED")) >0

					nRetorno := 0




					If !Empty( nPsVlCofEn ) .And.  !Empty( nPsBsCofEn )
						If nBasVal == 2
							nRetorno := ( cAliasNew )->( FieldGet( nPsVlCofEn ) )
						Else
							nRetorno := ( cAliasNew )->( FieldGet( nPsBsCofEn ) )
						Endif
					EndIf




					If !Empty( nRetorno )

						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetorno := ( cAliasNew )->( FieldGet( nPsVlCofEn ) )
							Else
								nRetorno := ( cAliasNew )->( FieldGet( nPsBsCofEn ) )
							Endif
						ElseIf (cAliasSF4)->F4_PISCRED =="2"
							If nBasVal == 2
								nRetorno := ( cAliasNew )->( FieldGet( nPsVlCofEn ) )
							Else
								nRetorno := ( cAliasNew )->( FieldGet( nPsBsCofEn ) )
							Endif
						Endif

					Else

						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetorno := ( ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC )  * nRedCOF) * (nTxCOF/100)
							Else
								nRetorno := ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC  ) * nRedCOF
							Endif

						ElseIf	(cAliasSF4)->F4_PISCRED =="2"

							If nBasVal == 2
								nRetorno := ( ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC )  * nRedCOF) * (nTxCOF/100)
							Else
								nRetorno := ( (cAliasNew)->D1_TOTAL+((cAliasNew)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasNew)->D1_VALDESC  ) * nRedCOF
							Endif

						Endif

					Endif

				Endif

			Endif

		EndIf

	EndIf

EndIf





If nEntrSai == 2




	If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_BASEPS2"} ) )
		cCpBsPisSa := aRelImp2[nScanPis,2]
		nPsBsPisSa := SD2->(FieldPos(cCpBsPisSa))
	EndIf
	If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_VALPS2"} ) )
		cCpVlPisSa := aRelImp2[nScanPis,2]
		nPsVlPisSa := SD2->(FieldPos(cCpVlPisSa))
	EndIf




	If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_BASECF2"} ) )
		cCpBsCofSa := aRelImp2[nScanCof,2]
		nPsBsCofSa := SD2->(FieldPos(cCpBsCofSa))
	EndIf
	If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_VALCF2"} ) )
		cCpVlCofSa := aRelImp2[nScanCof,2]
		nPsVlCofSa := SD2->(FieldPos(cCpVlCofSa))
	EndIf





	dbSelectArea(cAliasNew)


	SF4->(dbSetOrder(1))
	SF4->(MsSeek(xFilial("SF4") + (cAliasNew)->D2_TES))
	SB1->(dbSetOrder(1))
	SB1->(MsSeek(xFilial("SB1") + (cAliasNew)->D2_COD))
	SF2->(dbSetOrder(1))
	SF2->(MsSeek(xFilial("SF2") + (cAliasNew)->D2_DOC+(cAliasNew)->D2_SERIE+(cAliasNew)->D2_CLIENTE+(cAliasNew)->D2_LOJA))

	If (cAliasSF4)->F4_AGREG <> "N"

		If SB1->(FieldPos("B1_PPIS")) >0
			nTxPIS	:= 	if((cAliasSB1)->B1_PPIS <> 0,(cAliasSB1)->B1_PPIS , GetMv("MV_TXPIS"))
		Endif
		If SB1->(FieldPos("B1_REDPIS")) > 0
			nRedPIS	:= 	Iif((cAliasSB1)->B1_REDPIS > 0,1-((cAliasSB1)->B1_REDPIS / 100 ), 1 )
		Endif
		If SF4->(FieldPos("F4_BASEPIS")) > 0
			nRedPIS	*= 	Iif((cAliasSF4)->F4_BASEPIS > 0,1-((cAliasSF4)->F4_BASEPIS / 100 ), 1 )
		Endif
		If SB1->(FieldPos("B1_REDCOF")) > 0
			nRedCOF	:= 	Iif((cAliasSB1)->B1_REDCOF > 0,1-((cAliasSB1)->B1_REDCOF / 100 ), 1 )
		EndIf
		If SF4->(FieldPos("F4_BASECOF")) > 0
			nRedCOF	*= 	Iif((cAliasSF4)->F4_BASECOF > 0,1-((cAliasSF4)->F4_BASECOF / 100 ), 1 )
		EndIf
		If SB1->(FieldPos("B1_PCOFINS")) > 0
			nTxCOF	:=	if((cAliasSB1)->B1_PCOFINS <> 0,(cAliasSB1)->B1_PCOFINS , GetMv("MV_TXCOFIN"))
		Endif

		If SF4->(FieldPos("F4_PISCOF")) > 0

			If (cAliasSF4)->F4_PISCOF $ "13" .And.  nPisCof == 1
				nRetorno := 0




				If !Empty( nPsVlPisSa ) .And.  !Empty( nPsBsPisSa )
					If nBasVal == 2
						nRetorno := ( cAliasNew )->( FieldGet( nPsVlPisSa ) )
					Else
						nRetorno := ( cAliasNew )->( FieldGet( nPsBsPisSa ) )
					Endif
				EndIf




				If !Empty( nRetorno )




					If nBasVal == 2
						nRetorno := ( cAliasNew )->( FieldGet( nPsVlPisSa ) )
					Else
						nRetorno := ( cAliasNew )->( FieldGet( nPsBsPisSa ) )
					Endif

					If SF4->(FieldPos("F4_PISCRED")) >0
						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetorno := ( cAliasNew )->( FieldGet( nPsVlPisSa ) )
							Else
								nRetorno := ( cAliasNew )->( FieldGet( nPsBsPisSa ) )
							Endif
						Endif
					Endif

				Else




					If nBasVal == 2
						nRetorno := ( ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedPis ) * (nTxPIS/100)
					Else
						nRetorno := ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
					Endif

					If SF4->(FieldPos("F4_PISCRED")) >0
						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetorno  := ( ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedPis) * (nTxPIS/100)
							Else
								nRetorno  := ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
							Endif
						Endif
					Endif

				EndIf

			ElseIf (cAliasSF4)->F4_PISCOF $ "23" .And.  nPisCof == 2

				nRetorno := 0




				If !Empty( nPsVlCofSa ) .And.  !Empty( nPsBsCofSa )
					If nBasVal == 2
						nRetorno :=( cAliasNew )->( FieldGet( nPsVlCofSa ) )
					Else
						nRetorno :=( cAliasNew )->( FieldGet( nPsBsCofSa ) )
					Endif
				EndIf




				If !Empty( nRetorno )
					If nBasVal == 2
						nRetono := ( cAliasNew )->( FieldGet( nPsVlCofSa ) )
					Else
						nRetorno:= ( cAliasNew )->( FieldGet( nPsBsCofSa ) )
					Endif

					If SF4->(FieldPos("F4_PISCRED")) >0
						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetono := ( cAliasNew )->( FieldGet( nPsVlCofSa ) )
							Else
								nRetorno:= ( cAliasNew )->( FieldGet( nPsBsCofSa ) )
							Endif
						Endif
					Endif

				Else
					If nBasVal == 2
						nRetorno := ( ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedCOF) * (nTxCOF/100)
					Else
						nRetorno := ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
					Endif

					If SF4->(FieldPos("F4_PISCRED")) >0
						If (cAliasSF4)->F4_PISCRED =="1"
							If nBasVal == 2
								nRetorno := ( ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedCOF) * (nTxCOF/100)
							Else
								nRetorno := ( (cAliasNew)->D2_TOTAL+((cAliasNew)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
							Endif
						Endif
					Endif

				Endif

			EndIf

		EndIf

	Endif
Endif

RETURN(nRetorno)

















Static Function CalcMoed(cTab,nVal)
Local nValor :=0
Local aArea:={}
Local aAreaSF2:={}
Local aAreaSF1:={}
Local nMoedaOri:= 0

If cTab == "SF2"
	aArea:=GetArea()
	aAreaSF2:=SF2->(GetArea())
	SF2->(dbSetOrder(1))
	SF2->(MsSeek(xFilial("SF2") + TRB->D2_DOC+TRB->D2_SERIE+TRB->D2_CLIENTE+TRB->D2_LOJA))
	nMoedaOri:=SF2->F2_MOEDA
	RestArea(aArea)
	SF2->(RestArea(aAreaSF2))
	nValor := xMoeda( nVal, nMoedaOri, mv_par09, TRB->D2_EMISSAO )
ElseIf cTab == "SF1"
	aArea:=GetArea()
	aAreaSF1:=SF1->(GetArea())
	SF1->(dbSetOrder(1))
	SF1->(MsSeek(xFilial("SF1")+TRB->D2_COD+TRB->D2_SERIE+TRB->D2_DOC+TRB->D2_ITEM, .F. ))
	nMoedaOri:=SF1->F1_MOEDA
	RestArea(aArea)
	SF1->(RestArea(aAreaSF1))
	nValor := xMoeda( nVal, nMoedaOri, mv_par09, TRB->D2_EMISSAO )
EndIf

Return nValor















Static Function MTR310CF(cDoc,cSerie,cCliente,cLoja)
Local lRet := .F. 
Local aAreaCF := GetArea()
Local lSeek := .F. 

dbSelectArea("SF2")
dbSetOrder(1)
Seek:= (MsSeek(xFilial("SF2")+cDoc+cSerie+cCliente+cLoja))
If lSeek .And.  allTrim(F2_ESPECIE) == "NF" .And.  !Empty(allTrim(F2_NFCUPOM))
   lRet := .T. 
Endif
RestArea(aAreaCF)
Return lRet















Static Function AjustaSX1()

Local aSB1Cod	:= TAMSX3("B1_COD")
Local aSB1Ite	:= TAMSX3("B1_CODITE")
Local lVEIC		:= UPPER(GETMV("MV_VEICULO"))=="S"
Local cPerg     := "MTR310"

PutSx1("MTR310","18","Considera Vlr PIS/COFINS ?","Considera Vlr PIS/COFINS ?","Consider PIS/COFINS Value ?", "mv_chi", "N", 1, 0, 0,"C", "", "", "", "","MV_PAR18","Sim","Si","Yes", "","Nao","No","No", "", "", "", "", "", "", "", "", "", "", "", "", "")

if lVEIC

	nCOL1		:= ABS(aSB1Cod[1] - aSB1Ite[1]) + 1 +  aSB1Cod[1]

   DBSELECTAREA("SX1")
   DBSETORDER(1)
   DBSEEK(cPerg)
   while SX1->X1_GRUPO==cPerg .AND. !SX1->(EOF())

      IF "PRODU" $ UPPER(SX1->X1_PERGUNT) .AND.  UPPER(SX1->X1_TIPO) == "C" .AND.  (SX1->X1_TAMANHO <> aSB1Ite[1] .OR.  UPPER(SX1->X1_F3) <> "VR4")

         RECLOCK("SX1", .F. )
         SX1->X1_TAMANHO := aSB1Ite[1]
         SX1->X1_F3 := "VR4"
         DBCOMMIT()
         MSUNLOCK()

      ENDIF
      DBSKIP()
   ENDDO
   DBCOMMITALL()
else
   DBSELECTAREA("SX1")
   DBSETORDER(1)
   DBSEEK(cPerg)
   while SX1->X1_GRUPO==cPerg .AND. !SX1->(EOF())

      IF "PRODU" $ UPPER(SX1->X1_PERGUNT) .AND.  UPPER(SX1->X1_TIPO) == "C" .AND.  (SX1->X1_TAMANHO <> aSB1Cod[1] .OR.  UPPER(SX1->X1_F3) <> "SB1")

         RECLOCK("SX1", .F. )
         SX1->X1_TAMANHO := aSB1Cod[1]
         SX1->X1_F3 := "SB1"
         DBCOMMIT()
         MSUNLOCK()

      ENDIF
	  If cPaisLoc <> "BRA" .And.  SX1->X1_ORDEM $ "10#14#18"
	     RecLock("SX1", .F. )
		 SX1->X1_GSC := IIF(SX1->X1_ORDEM=="18","S","C")
		 MsUnLock()

		 aHelpSpa := {}

     	 Aadd( aHelpSpa, "Sera considerado el valor de los        " )
		 Aadd( aHelpSpa, "impuestos en el saldo del archivo de    " )
 		 Aadd( aHelpSpa, "Itens del Pedido de Venta (SD2).        " )

         PutSX1Help("P.MTR31010.",,,aHelpSpa)

  		 aHelpSpa := {}

     	 Aadd( aHelpSpa, "Sera considerado el valor de los        " )
		 Aadd( aHelpSpa, "impuestos del valor en el archivo de    " )
 		 Aadd( aHelpSpa, "Items de la Factura de Entrada (SD1)    " )

         PutSX1Help("P.MTR31014.",,,aHelpSpa)
	  Endif
      DBSKIP()
   ENDDO
   DBCOMMITALL()
endif

Return Nil