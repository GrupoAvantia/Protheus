#INCLUDE "Matr931.ch"
#INCLUDE "Protheus.ch"        
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддддддддд©╠╠
╠╠ЁFun┤┘o    ЁMatr931      ЁAutorЁ Juan Jose Pereira    Ё Data Ё 18.12.96 		Ё╠╠
╠╠цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁImprime Registro de Entradas P1 e Saidas P2                  		Ё╠╠
╠╠цддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё ATUALIZACOES SOFRIDAS DESDE A CONSTRUCAO INICIAL.                     		Ё╠╠
╠╠цддддддддддддддбддддддддбддддддбдддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё PROGRAMADOR  Ё DATA   Ё BOPS Ё  MOTIVO DA ALTERACAO                   		Ё╠╠
╠╠цддддддддддддддеддддддддеддддддедддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Marcos SimiduЁ26/11/97ЁXXXXXXЁImpressao de itens com Tes do livro ='Z'		Ё╠╠
╠╠Ё Marcos SimiduЁ23/12/97Ё13597AЁAcertos nas quebras de pagina.          		Ё╠╠
╠╠Ё Marcos SimiduЁ23/12/97Ё13855AЁCorrecao nas totalizacoes mes/periodos. 		Ё╠╠
╠╠Ё Marcos SimiduЁ24/03/98Ё14621AЁInclusao parametro Totaliza por dia.    		Ё╠╠
╠╠Ё Rodrigo Sart.Ё25/03/98Ё10385AЁAlteracao do parametro mv_par04  Lista: 		Ё╠╠
╠╠Ё              Ё        Ё      Ё(1)Livros (2)Termos (3)Livros e Termos  		Ё╠╠
╠╠Ё Rodrigo Sart.Ё27/03/98Ё14810AЁ Tratamento do estado origem no Resumo varia-	Ё╠╠
╠╠Ё              Ё        Ё14810AЁvel (lLisEstOri).                 			Ё╠╠
╠╠Ё Marcos SimiduЁ02/04/98Ё15022AЁImpr. de Termo Encerr. quando o periodo inoforЁ╠╠
╠╠Ё              Ё        Ё15022AЁmado nao possuir movimento. 	    			Ё╠╠
╠╠Ё Marcos SimiduЁ06/05/98ЁXXXXXXЁAcertos na impressao do termo de encerramento	Ё╠╠
╠╠Ё              Ё        Ё      Ёno livro de saidas.             				Ё╠╠
╠╠Ё Eduardo      Ё02/06/98ЁxxxxxxЁDesenvolvimento do CIAP                 		Ё╠╠
╠╠Ё Marcos SimiduЁ02/07/98ЁXXXXXXЁAcertos de dbSelectArea(0) - CIAP.      		Ё╠╠
╠╠Ё Marcos SimiduЁ11/08/98ЁXXXXXXЁZera array acumulador dos resumos.      		Ё╠╠
╠╠Ё Marcos SimiduЁ22/10/98Ё18419AЁAcertos no param.consid.UF no demonstrativo 	Ё╠╠
╠╠Ё              Ё22/10/98Ё18419AЁvo por estado de origem.                 		Ё╠╠
╠╠Ё Marcos SimiduЁ03/11/98ЁXXXXXXЁAcertos no ano com 4 bytes.             		Ё╠╠
╠╠Ё Marcos SimiduЁ24/11/98Ё10986AЁAcertos na totalizacao do vlr.contabil. 		Ё╠╠
╠╠Ё Andreia      Ё29/01/99ЁxxxxxxЁAlteracao do lay-out devido ao aumento do cam-Ё╠╠
╠╠Ё              Ё        Ё      Ёpo conta contabil.                			Ё╠╠
╠╠Ё Andreia      Ё11/03/99ЁxxxxxxЁTratamento da especie das notas fiscais cance-Ё╠╠
╠╠Ё              Ё        Ё      Ёladas atraves do parametro MV_ESPECIE			Ё╠╠
╠╠Ё Andreia      Ё10/08/99Ё22553AЁTratamento do parametro MV_PAR21 que define emЁ╠╠
╠╠Ё              Ё        Ё      Ёqual coluna sera impresso o imposto retido 	Ё╠╠
╠╠Ё Andreia      Ё14/12/99Ё19277AЁNo resumo por CFOP,trocar TOTAL por SUB-TOTAL	Ё╠╠ 
╠╠Ё              Ё        Ё      Ёe TOTAL GERAL por TOTAL(Portaria CAT 08/90).	Ё╠╠
╠╠Ё Guilherme    Ё06/07/07Ё125854ЁInclusao do numero da Reducao Z para os       Ё╠╠
╠╠Ё Santos       Ё        Ё      Ёmovimentos gerados para ECF's.                Ё╠╠
╠╠юддддддддддддддаддддддддаддддддадддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
FUNCTION Matr931

Local cArqCiap := ""
Private cIndxSF3  :=""
Private nCredAtivo :=0
//зддддддддддддддддддддддддддддддддд©
//Ё Flag de Movimentacao            Ё
//юддддддддддддддддддддддддддддддддды
lHouveMov:=.F.
//зддддддддддддддддддддддддддддддддд©
//Ё Largura do campo de observacoes Ё
//юддддддддддддддддддддддддддддддддды
nLargObs:=If(nTipoMov=1,17,41)
//зддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Pictures de campos numericos - Colunas Valores    Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддды
cPictVl:=If(nTipoMov==1,"@E 999,999,999,999.99","@E 999,999,999,999.99")
//зддддддддддддддддддддддддддддддддддд©
//Ё Recebe layout do modelo escolhido Ё
//юддддддддддддддддддддддддддддддддддды
aL:=NIL
R931LayOut()
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Cria Arquivo a ser Impresso com um indice de mesmo nome            Ё
	//Ё Ordem (1) = F3_FILIAL+DTOS(F3_ENTRADA)+F3_SERIE+F3_NFISCAL+F3_CFO  Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	cArqTemp:=EmiteLivro(If(nTipoMov==1,"E","S"),dDtIni,dDtFim,lLacuna,lServico,lDesconto,cNrLivro,cFilterUser,@cArqCiap,MV_PAR27,MV_PAR09,MV_PAR31,MV_PAR32,MV_PAR33,MV_PAR36,"MATR930")
	//здддддддддддддддддддддддддддд©
	//Ё Salva periodos de Apuracao Ё
	//юдддддддддддддддддддддддддддды
	nSvApurICM:=DefPeriodo(F3_ENTRADA,nApurICM)
	nSvApurIPI:=DefPeriodo(F3_ENTRADA,nApurIPI)
EndIf
If !lAbortPrint
	If nTipoMov==1
		R931RegEntradas()
	Else
		R931RegSaidas()
	Endif
Endif
//зддддддддддддддд©
//Ё Restaura area Ё
//юддддддддддддддды
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dbCloseArea()
    Ferase(cArqTemp+GetDbExtension())
	Ferase(cArqTemp+OrdBagExt())
EndIf
If ( Select("CIAP")!=0 )
	dbSelectArea("CIAP")
	dbCloseArea()
        Ferase(cArqCiap+GetDbExtension())
	Ferase(cArqCiap+OrdBagExt())
EndIf
If ( Select(cArqSF3)!=0 )
	dbSelectArea(cArqSF3)
	dbCloseArea()
	Ferase(cArqSF3+GetDbExtension())
	Ferase(cIndxSF3+OrdBagExt())
EndIf
dbSelectArea(aSvArea[1])
dbSetOrder(aSvArea[2])
dbGoto(aSvArea[3])
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддддддбдддддбддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931RegEntradasЁAutorЁ Juan Jose Pereira  Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддддддадддддаддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁImprime Registro de Entradas                                Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931RegEntradas()
Local lApur := .F.          
Local aAreaSM0	 	:= SM0->(GetArea())
Local aArea			:= {}                    
Local lCredST		:= SF3->(FieldPos("F3_CREDST")) > 0
Local lP1IcmST		:= GetNewPar("MV_P1ICMST",.F.)
Local lProcST		:= .T.
Local lAliqstn      := GetNewPar ("MV_ALIQSTN", .T.) // parametro tem como objetivo nao imprimir aliquota de ICMS ST no relatorio
Local lMod55		:= GetNewPar ("MV_SPED55",.F.)
Local lUnicaNf		:= .T.
Local EntAmbulante  := .F.
Local lImprZero		:= GetNewPar ("MV_IMPZNFC",.F.)
aGrade:=NIL             

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dDiaAnt:=F3_ENTRADA
	dDia:=dDiaAnt
	SetRegua(LastRec())
	While !Eof()
		lTotGrade:=.F.
		lUnicaNf := .T.
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif
		//зддддддддддд©
		//Ё Cabecalho Ё
		//юддддддддддды
		If nLin>nLimPag .And. !(cArqTemp)->SEMMOV
			R931Cabec(dDia)
		Endif
		//зддддддддддддддддддддддддддддд©
		//Ё Contador de Tamanho de nota Ё
		//юддддддддддддддддддддддддддддды
		nTamNota:=nLin             
		
        //здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o valor do ICMS Retido de acordo com a configuracao da TES     Ё
		//ЁQuando o campo F3_CREST existir e estiver configurado como "4",         Ё
		//Ёo valor do ICMS retido nao deve ser apresentado na coluna de observacoesЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
        lProcST := .T.
		If lCredST
		    If (cArqTemp)->F3_CREDST == "4" .And. lP1IcmST
                lProcST := .T.
			Elseif (cArqTemp)->F3_CREDST == "4" .And. !lP1IcmST
                lProcST := .F.
            Endif
        Endif
		
        //verifica se faz tratamento - Remessa de Venda para Fora do Estabelecimento
        If GetMv("MV_ESTADO")=="SP" .And. Alltrim((cArqTemp)->F3_CFO)$"1904/2904"   
		    lEntAmbulante := .T.
		Else
		    lEntAmbulante := .F.
		EndIf                        
		
		//зддддддддддддддддддддддддддддддддд©
		//ЁImprime os periodos sem movimentoЁ
		//юддддддддддддддддддддддддддддддддды
		If (cArqTemp)->SEMMOV
			dDia:=(cArqTemp)->F3_ENTRADA
			R931Cabec(dDia)
			cLinha:=FmtLin(Array(18),aL[17],,,nLin,.F.)
			R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
			FmtLin(,aL[1],,,@nLin)
			(cArqTemp)->(dbSkip())     
			dDia:=(cArqTemp)->F3_ENTRADA          
			lHouveMov := .T.
			Loop
		Endif

		//здддддддддддддддддддддддддддд©
		//Ё Salva periodos de Apuracao Ё
		//юдддддддддддддддддддддддддддды
		If !lApur
			lApur := .T.
			nSvApurICM:=DefPeriodo(F3_ENTRADA,nApurICM)
			nSvApurIPI:=DefPeriodo(F3_ENTRADA,nApurIPI)
		Endif            
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPosiciona na filial em que foi processado o registro	Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁConta contabil devera ser buscada no parametro MV_CTALFE de cada filialЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cContaContab := Alltrim(GetMV("MV_CTALFE"))
		cContaContab :=	StrTran(cContaContab,"SF3->",)
		//зддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Posiciona nos cadastros de Clientes/FornecedoresЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддды
		cClieFor:=F3_CLIEFOR+F3_LOJA
		If(F3_TIPO$"DB",dbSelectArea("SA1"),dbSelectArea("SA2"))
		dbSeek(xFilial()+cClieFor)
		dbSelectArea(cArqTemp)
		//здддддддддддддддддддддддддддддддддд©
		//ЁRestaura a filial e area corrente Ё
		//юдддддддддддддддддддддддддддддддддды
		Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		//
		dbSelectArea(cArqTemp)
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de Observacao Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,,lListaNFO)
		R931IniGrade()
		
	    If lEntAmbulante
		    aGrade[1,1]:=""
		Else
		    If lImpZer.or.F3_BASEICM+F3_VALICM>0  
			    aGrade[1,1]:="1"
			    aGrade[1,2]:=F3_BASEICM
			    aGrade[1,3]:=F3_VALICM
			Else
				aGrade[1,1]:=""
			Endif
        EndIf
		If lImpZer.or.F3_ISENICM>0
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
			    aGrade[nx,1]:="2"
			    aGrade[nx,2]:=F3_ISENICM
		    EndIf
		Endif
		If lImpZer.or.F3_OUTRICM>0
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
    			aGrade[nx,1]:="3"				
				If F3_OUTRICM>0
		    		aGrade[nx,2]:=F3_OUTRICM
	            Else
					If SF3->(FieldPos("F3_VL43080"))>0
					    If F3_VL43080 > 0
					    	aGrade[nx,2]:=F3_VL43080
					    EndIf
					Endif                                               					   				    
   				    If SF3->(FieldPos("F3_VLINCMG"))>0
				        If F3_VLINCMG > 0
				    	    aGrade[nx,2]:=F3_VLINCMG
				       EndIf
				    EndIf
				Endif                                            		
		    EndIf
		Endif                                               		
	    If lEntAmbulante
		    aGrade[1,4]:=""
		Else
			If lImpZer.or.F3_BASEIPI+F3_VALIPI>0
			    aGrade[1,4]:="1"
			    aGrade[1,5]:=F3_BASEIPI
    	        aGrade[1,6]:=F3_VALIPI
 	     	Else
				aGrade[1,4]:=""
			Endif
        EndIf
		If lImpZer.or.F3_ISENIPI>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
				aGrade[nx,4]:="2"
				aGrade[nx,5]:=F3_ISENIPI
		    EndIf
		Endif
		If lImpZer.or.F3_OUTRIPI>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			If lEntAmbulante
		    	aGrade[nx,1]:=""
		    Else
				aGrade[nx,4]:="3"
				aGrade[nx,5]:=F3_OUTRIPI
		    EndIf
		Endif
		aDados:=Array(18)
		aDados[1]:= DTOC(F3_ENTRADA)
		aDados[2]:= IIf(Empty(F3_ESPECIE),R930CFOTra(F3_CFO,F3_SERIE),Iif(lMod55 .And. Alltrim(F3_ESPECIE) == "SPED","55",F3_ESPECIE))
		aDados[3]:=F3_SERIE
		aDados[4]:=F3_NFISCAL
		aDados[5]:= DTOC(F3_EMISSAO)
		aDados[6]:=(F3_CLIEFOR+"-"+F3_LOJA)
		aDados[7]:=F3_ESTADO
		
		If Empty(F3_DTCANC) .Or. lImprZero
			aDados[8]:=Iif(lEntAmbulante,0,F3_VALCONT)
			aDados[9]:=Substr(EvalMacro(cContaContabil),1,14)					
	        aDados[10]:=If(substr(F3_CFO,1,3)$"999#000",,Transform(F3_CFO,PESQPICT("SF3","F3_CFO")))
			If nModelo != 5
				If lEntAmbulante
				    aDados[13]:=""
				Else 
				    aDados[13]:=Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@ZE 99.99"),"")
			    EndIf
			EndIf
		Endif
	
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R931ImpGrade(lUnicaNf)
		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[17],cPictVl,,@nLin)
			Endif
		End
   		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GO Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. F3_ICMSRET-F3_OBSSOL>0 .And. lProcST
			aDados[11]:="ST"
			aDados[12]:=F3_BASERET
			If nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:=F3_ICMSRET-F3_OBSSOL
			ElseIf nColuna == 3	
	            If F3_TIPO == "D"
				   aDados[14]:=F3_ICMSRET-F3_OBSSOL
				Else
				   aDados[18]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. F3_ICMSRET-F3_OBSSOL>0 .And. lProcST
			aDados[11]:="ST"
			aDados[12]:=F3_BASERET
			If nModelo != 5
            	aDados[13]:= Iif(lAliqstn,"",Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@E 99.99"),""))
			EndIf
			aDados[14]:=F3_ICMSRET-F3_OBSSOL
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		Endif
		//зддддддддддддддддд©
		//Ё Acumula valores Ё
		//юддддддддддддддддды
		nLinNec:=nLin-nTamNota+If(lImpZer,1,0)
		aTamNotas[1]:=Max(aTamNotas[1],nLinNec)
		LivrAcumula(cArqTemp,@aTotDia,@aTotPerICM,@aTotPerIPI,@aTotMes,@aTransp,@aResumo,@aResCFO,cArqSF3)
		dDiaAnt:=F3_ENTRADA
		********************* CIAP **********************
		//зддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Atualiza a Manutencao do CIAP                   Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддды
        If lEmiteCiap
		   If Select("CIAP") > 0
			  dbSelectArea("CIAP")
			  If ( dbSeek(&(cArqTemp)->(Recno())) )
				 While ( !Eof() .And. CIAP->SF3==&(cArqTemp)->(Recno()) )
					   dbSelectArea("SF9")
					   dbGoto(CIAP->SF9)
					   Begin Transaction
						     RecLock("SF9",.F.)
						     SF9->F9_NLRE := Val(cLivro)
						     SF9->F9_FLRE := nPagina
						     MsUnlock()
					   End Transaction
					   dbSelectArea("CIAP")
					   dbSkip()
				 EndDo
			  Endif
		   EndIf
		Endif   
		********************* CIAP **********************
		dbSelectArea(cArqTemp)
		dbSkip()
		If !Eof()
			dDia:=F3_ENTRADA
		Else
			dDia:=UltimoDia(dDia)+1
		EndIf
		//зддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Totais e finaliza relatorio Ё
		//юддддддддддддддддддддддддддддддддддддды
		lTotGrade:=.T.
		lHouveMov:=.T.
		R931Totais()
		If lUnicaNf
			lUnicaNf := .F.
		EndIf
	End
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Quando nao ha movimento                                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !lHouveMov
		dDia:=dDtIni
		R931Cabec(dDia)
		cLinha:=FmtLin(Array(18),aL[17],,,nLin,.F.)
		R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
		FmtLin(,aL[1],,,@nLin)
		R931TermEnc()
	Endif
Else
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de Abertura    Ё
	//юдддддддддддддддддддддддддддддды
	R931TermIni()
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de EncerramentoЁ
	//юдддддддддддддддддддддддддддддды
	R931TermEnc()
EndIf
Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддддбдддддбддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931RegSaidasЁAutorЁJuan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддддадддддаддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁImprime Registro de Saidas                                  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931RegSaidas
Local lMV_ESTCLI 	:= GetNewPar ("MV_ESTCLI", .F.)	//Parametro para mudar a pesquisa do estado do cliente. F3_ESTADO pelo A1_EST ou A2_EST.
Local lApur			:= .F.  
Local lEcfNotas 	:= GetNewPar ("MV_ECFNOTA", .F.)	//Parametro tem como objetivo imprimir o documento final mesmo sem a utilizacao de Aglutinar Notas Fiscais de Saida
Local lAliqstn      := GetNewPar ("MV_ALIQSTN", .T.) // parametro tem como objetivo nao imprimir aliquota de ICMS ST no relatorio
Local aAreaSM0 		:= SM0->(GetArea())
Local aArea			:= {}                                                          
Local lCredST		:= SF3->(FieldPos("F3_CREDST")) > 0
Local lProcST		:= .T.
Local lSaiAmbulante := .F.
Local lImprZero		:= GetNewPar ("MV_IMPZNFC",.F.)
Local lP1IcmST		:= GetNewPar("MV_P1ICMST",.F.)

PRIVATE aGrade := {}
//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё So trata arquivo quando for imprimir Livros ou Livros e TermosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nImpTerm == 1 .Or. nImpTerm == 3
	dbSelectArea(cArqTemp)
	dDiaAnt:=F3_ENTRADA
	dDia:=dDiaAnt
	SetRegua(LastRec())
	While !Eof()
		IncRegua()
		If Interrupcao(@lAbortPrint)
			Exit
		Endif
        //здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o valor do ICMS Retido de acordo com a configuracao da TES     Ё
		//ЁQuando o campo F3_CREST existir e estiver configurado como "4",         Ё
		//Ёo valor do ICMS retido nao deve ser apresentado na coluna de observacoesЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
        lProcST := .T.
		If lCredST
		    If (cArqTemp)->F3_CREDST == "4" .And. (cArqTemp)->F3_OBSSOL>0
                lProcST := .F.
            Elseif (cArqTemp)->F3_CREDST == "4" .And. !lP1IcmST 
	   			lProcST := .F.
            Endif
        Endif

        If (!lLacuna .AND. !Empty(F3_DTCANC))
     	   dbSelectArea(cArqTemp)
		   dbSkip()
		   If Eof() .And. lHouveMov
				dDia:=F3_ENTRADA
				R931Totais()
		   EndIf
         loop
        Endif

        //verifica se faz tratamento - Remessa de Venda para Fora do Estabelecimento
        If GetMv("MV_ESTADO")=="SP" .And. Alltrim((cArqTemp)->F3_CFO)$"/5904/6904/"   
		    lSaiAmbulante := .T.
		Else
		    lSaiAmbulante := .F.
		EndIf                        

		//зддддддддддд©
		//Ё Cabecalho Ё
		//юддддддддддды
		If nLin>nLimPag  .And. !(cArqTemp)->SEMMOV
			R931Cabec(dDia)
		Endif
		//зддддддддддддддддддддддддддддддддд©
		//ЁImprime os periodos sem movimentoЁ
		//юддддддддддддддддддддддддддддддддды
		If (cArqTemp)->SEMMOV
			dDia:=(cArqTemp)->F3_ENTRADA
			R931Cabec(dDia)
			cLinha:=FmtLin(Array(15),aL[19],,,nLin,.F.)
			R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
			FmtLin(,aL[1],,,@nLin)
			(cArqTemp)->(dbSkip())     
			dDia:=(cArqTemp)->F3_ENTRADA          
			lHouveMov := .T.
			Loop
		Endif

		//здддддддддддддддддддддддддддд©
		//Ё Salva periodos de Apuracao Ё
		//юдддддддддддддддддддддддддддды
		If !lApur
			lApur := .T.
			nSvApurICM:=DefPeriodo(F3_ENTRADA,nApurICM)
			nSvApurIPI:=DefPeriodo(F3_ENTRADA,nApurIPI)
		Endif
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPosiciona na filial em que foi processado o registro	Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁConta contabil devera ser buscada no parametro MV_CTALFS de cada filialЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cContaContab := Alltrim(GetMV("MV_CTALFS"))
		cContaContab :=	StrTran(cContaContab,"SF3->",)
		//здддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁVerifica o parametro para cada filial processadaЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддды
        lMV_ESTCLI 	:= GetNewPar ("MV_ESTCLI", .F.)	
		//здддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Posiciona nos cadastros de Clientes/Fornecedores Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддды
		cClieFor:=F3_CLIEFOR+F3_LOJA
		If(F3_TIPO$"DB",dbSelectArea("SA2"),dbSelectArea("SA1"))
		dbSeek(xFilial()+cClieFor)
		dbSelectArea(cArqTemp)
		//здддддддддддддддддддддддддддддддддд©
		//ЁRestaura a filial e area corrente Ё
		//юдддддддддддддддддддддддддддддддддды
		Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		//
		dbSelectArea(cArqTemp)
		//зддддддддддддддддддддддддддддд©
		//Ё Contador de Tamanho de nota Ё
		//юддддддддддддддддддддддддддддды
		nTamNota:=nLin
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,,lListaNFO)
		//здддддддддддддддддд©
		//Ё Linhas de DetalheЁ
		//юдддддддддддддддддды
		aDados:=Array(15)

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁPreenche a especie de acordo com a regra e Artigo utilizado utilizada  Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aDados[1] := R931GetEcf(cArqTemp,1)  
		aDados[2] := R931GetEcf(cArqTemp,2)
		
		IF lAglutina        
		   aDados[3]:=F3_NFISCAL+" A "+IF(!EMPTY(F3_DTCANC),F3_NFISCAL,F3_DOCOR)
		ELSE   
		   aDados[3]:=F3_NFISCAL+" A "+IF(F3_TIPO$"L" .And. !lEcfNotas ,F3_DOCOR,F3_NFISCAL)
		ENDIF 
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//ЁLayout de acordo com a lei 9.513 (lista o intervalo de cupons fiscais - ECF)Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If lLeiECF .AND. (SF3->(FieldPos("F3_NUMINI")) > 0 .AND. SF3->(FieldPos("F3_NUMFIM")) > 0) .AND. !Empty(F3_PDV)
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁPosiciona na filial em que foi processado o registro	Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддды
	        Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,1)
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁRecupera a partir do SFI, o numero do ultimo documento emitido no ECF.Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			aDados[3] := R931GetEcf(cArqTemp,3)
	
			dbSelectArea(cArqTemp)
			//здддддддддддддддддддддддддддддддддд©
			//ЁRestaura a filial e area corrente Ё
			//юдддддддддддддддддддддддддддддддддды
			Mtr930Fil(aAreaSM0,(cArqTemp)->FILCORR,2)
		Endif
		aDados[4]:=StrZero(Day(F3_ENTRADA),2)
		//
		aDados[5]:=F3_ESTADO
		If (lMV_ESTCLI)
			aDados[5]:=Iif (F3_TIPO$"DB", SA2->A2_EST, SA1->A1_EST)
		EndIf
		//
		If Empty(F3_DTCANC) .Or. lImprZero		
		
			aDados[6]:=Iif(lSaiAmbulante==.T.,0,F3_VALCONT)
			aDados[7]:=Substr(EvalMacro(cContaContabil),1,20)
	      	aDados[8]:=If(substr(F3_CFO,1,3)$"999#000",,Transform(F3_CFO,PESQPICT("SF3","F3_CFO")))
			If lSaiAmbulante
	    		aDados[9]:=""
	  		Else
	    		aDados[9]:=If(F3_TIPO=="S".OR.F3_FORMUL=="S",,"ICMS")
			    aDados[10]:=F3_BASEICM       
			    If nModelo != 5
				    aDados[11]:=Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@E 99.99"),"")
			    EndIf
			    aDados[12]:=F3_VALICM
			    aDados[13]:=F3_ISENICM
			    aDados[14]:=F3_OUTRICM
			    If SF3->(FieldPos("F3_VL43080")) > 0
			        If !Empty(F3_VL43080)
			            aDados[14]:=F3_VL43080
			        EndIf
			    EndIf
			    If SF3->(FieldPos("F3_VLINCMG")) > 0
			        If !Empty(F3_VLINCMG)
			            aDados[14]:=F3_VLINCMG
			        EndIf
			    EndIf
			EndIf
		Endif
		
		R931LoadObs()
		FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		//
		nPosObs:=Ascan(aObs,{|x|x[2]})
		
		If Empty(F3_DTCANC)
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0               
				    //Verifica se havera salto de pagina p/impressao das OBS
				    If nLin>nLimPag  .And. !(cArqTemp)->SEMMOV
						aDados[3]:=STR0023 //"A TRANSPORTAR"
						aDados[6]:=aTransp[ColF3("F3_VALCONT")]
						aDados[9]:="ICMS"
						aDados[10]:=aTransp[ColF3("F3_BASEICM")]
						aDados[12]:=aTransp[ColF3("F3_VALICM")]
						aDados[13]:=aTransp[ColF3("F3_ISENICM")]
						aDados[14]:=aTransp[ColF3("F3_OUTRICM")]
						If SF3->(FieldPos("F3_VL43080")) > 0
			    			If !Empty(aTransp[ColF3("F3_VL43080")])
				    		    aDados[14]:=aTransp[ColF3("F3_VL43080")]
					    	EndIf
						EndIf
						If SF3->(FieldPos("F3_VLINCMG")) > 0
			    			If !Empty(aTransp[ColF3("F3_VLINCMG")])
				    		    aDados[14]:=aTransp[ColF3("F3_VLINCMG")]
					    	EndIf
						EndIf
						FmtLin(@aDados,aL[20],cPictVl,,@nLin)
						aDados[9]:="IPI"
						aDados[10]:=aTransp[ColF3("F3_BASEIPI")]
						aDados[12]:=aTransp[ColF3("F3_VALIPI")]
						aDados[13]:=aTransp[ColF3("F3_ISENIPI")]
						aDados[14]:=aTransp[ColF3("F3_OUTRIPI")]
						FmtLin(@aDados,aL[20],cPictVl,,@nLin)				
						R931Filler()
						R931Cabec()  
	                Else
	                	FmtLin(@aDados,aL[19],cPictVl,,@nLin)
	                Endif                
				Endif
			End
			
			If !(F3_TIPO=="S".OR.F3_FORMUL=="S")
				If lSaiAmbulante
				    aDados[9]:=""
				Else			
	   			    aDados[9]:="IPI"
				    aDados[10]:=F3_BASEIPI
				    aDados[12]:=F3_VALIPI
				    aDados[13]:=F3_ISENIPI
				    aDados[14]:=F3_OUTRIPI
				EndIf
				R931LoadObs()
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			Endif
			nPosObs:=Ascan(aObs,{|x|x[2]})
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0             
					FmtLin(@aDados,aL[19],cPictVl,,@nLin)
				Endif
			End
		Endif
	 	//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. F3_ICMSRET-F3_OBSSOL>0 .And. lProcST
			aDados[9]:="ST"
			aDados[10]:=F3_BASERET
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:= F3_ICMSRET-F3_OBSSOL
			ElseIf nColuna == 3	
                If F3_TIPO <> "D"
				   aDados[12]:= F3_ICMSRET-F3_OBSSOL
                Else
				   aDados[15]:=STR0001+Alltrim(Transform(F3_ICMSRET-F3_OBSSOL,PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. F3_ICMSRET-F3_OBSSOL>0 .And. lProcST
			aDados[09]:="ST"
			aDados[10]:=F3_BASERET       
			If nModelo != 5
				aDados[11]:= Iif(lAliqstn,"",Iif(F3_ALIQICM > 0,Transform(F3_ALIQICM,"@E 99.99"),""))
			EndIf
			aDados[12]:= F3_ICMSRET-F3_OBSSOL
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
		Endif
		//зддддддддддддддддд©
		//Ё Acumula valores Ё
		//юддддддддддддддддды
		nLinNec:=nLin-nTamNota+If(lImpZer,1,0)
		aTamNotas[1]:=Max(aTamNotas[1],nLinNec)
		LivrAcumula(cArqTemp,@aTotDia,@aTotPerICM,@aTotPerIPI,@aTotMes,@aTransp,@aResumo,@aResCFO,cArqSF3)
		dDiaAnt:=F3_ENTRADA
		dbSelectArea(cArqTemp)
		dbSkip()
		If !Eof()
			dDia:=F3_ENTRADA
		Else
			dDia:=UltimoDia(dDia)+1
		EndIf
		//зддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Totais e finaliza relatorio Ё
		//юддддддддддддддддддддддддддддддддддддды
		lHouveMov:=.T.
		R931Totais()
	End
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//Ё Quando nao ha movimento                                      Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If !lHouveMov
		dDia:=dDtIni
		R931Cabec(dDia)
		cLinha:=FmtLin(Array(15),aL[19],,,nLin,.F.)
		R93xFillPage(cLinha,STR0002,@nLin,nLimPag) //"*** NAO HOUVE MOVIMENTO ***"
		FmtLin(,aL[1],,,@nLin)
		R931TermEnc()
	Endif
Else
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de Abertura    Ё
	//юдддддддддддддддддддддддддддддды
	R931TermIni()
	//здддддддддддддддддддддддддддддд©
	//Ё Imprime Termo de EncerramentoЁ
	//юдддддддддддддддддддддддддддддды
	R931TermEnc()
EndIf
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931Cabec ЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Impressao de Cabecalho                                     Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
FUNCTION R931Cabec(dData)
Local lLFisOrd := GetNewPar("MV_LFISORD",.F.)
Local cTermoSAb := GetMv("MV_LSAIAB")
Local cTermoEAb	:= GetMv("MV_LENTAB")
dData:=IIf(dData==NIL,dDiaAnt,dData)
If MV_PAR41 == 1 .And. !Empty(SuperGetMV("MV_P2ABER", ,"")) .And. !Empty(SuperGetMv("MV_P1ABER",,""))
	cTermoSAb := SuperGetMv("MV_P2ABER",,"")
	cTermoEAb := SuperGetMv("MV_P1ABER",,"")
EndIf
          
cPeriodo:=aMeses[Month(dData)]+" / "+Str(Year(dData),4)
//здддддддддддддддддддддддддддддддддддддддд©
//Ё Imprime Termos de Abertura/EncerramentoЁ
//юдддддддддддддддддддддддддддддддддддддддды
aPagTerm:=CtrlPg(@nPagina,nQtFeixe,lReiniPg)
cPagina :=Transform(StrZero(nPagina,6),"@R 999.999")
If (nImpTerm == 2 .Or. nImpTerm == 3).and.aPagTerm[1]+aPagTerm[2]>0
	If nTipoMov==1
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,GetMv("MV_LENTEN"),nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoEAb,nLargMax,cPerg)
	Else
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,GetMv("MV_LSAIEN"),nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoSAb,nLargMax,cPerg)
	Endif
Endif
//здддддддддддддддддддд©
//Ё Imprime Cabecalho  Ё
//юдддддддддддддддддддды
nLin:=3
FmtLin(,AvalImp(nLargMax),,,@nLin)
FmtLin(,aL[1],,,@nLin)
FmtLin({cTitLivro},aL[2],,,@nLin)
FmtLin(,aL[3],,,@nLin)
FmtLin({cNome},aL[4],,,@nLin)
FmtLin(,aL[5],,,@nLin)
FmtLin({cInscr,cCGC},aL[6],,,@nLin)
FmtLin(,aL[7],,,@nLin)
If lLFisOrd
	FmtLin({cLivro,cPagina,cPeriodo},aL[8],,,@nLin)
Else
	FmtLin({cPagina,cPeriodo},aL[8],,,@nLin)
Endif
FmtLin(,{aL[9],aL[10],aL[11],aL[12],aL[13],aL[14],aL[15],aL[16]},,,@nLin)
If nTipoMov==2
	FmtLin(,{aL[17],aL[18]},,,@nLin)
Endif

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931LayOutЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Layout dos modelos P1 e P2                                 Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931LayOut

Local nSubDiv	:= mv_par36
Local lLFisOrd	:= GetNewPar("MV_LFISORD",.F.)
Local lImp  	:= GetNewPar("MV_IMPCABE",.F.)
Local lImpPag  	:= GetNewPar("MV_IMPPAGI",.F.)
If nTipoMov==1
	aL:=Array(18)  
	aL[01]:="+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPara atender a Legislacao de Pernambuco                        Ё
	//ЁO valor do ICMS ST nas entradas deve ser apresentado em coluna Ё
	//Ёespecifica - Contribuinte Substituido - ICMS na Fonte          Ё
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	If cMV_ESTADO == "PE"
		aL[02]:=STR0050 //"|                                                                  REGISTRO DE ENTRADAS #                                                                     |                  (*) CODIGO DE VALORES FISCAIS             |"
		aL[03]:="|                                                                                                                                                               |------------------------------------------------------------|"
		aL[04]:=STR0051 //"| FIRMA: #############################                                                                                                                        |1-OPERACOES COM CREDITO DO IMPOSTO                          |"
		aL[05]:=STR0052 //"|                                                                                                                                                             |                                                            |"
		aL[06]:=STR0053 //"| INSC.EST: ###########           C.N.P.J.: ##############                                                                                                    |2-OPERACOES SEM CREDITO DO IMPOSTO-ISENTAS OU NAO TRIBUTADAS|"
		aL[07]:=STR0054 //"|                                                                                                                                                             |                                                            |"
		aL[08]:=STR0055 //"| FOLHA: #######                   MES OU PERIODO/ANO: #######                                                                                                |3-OPERACOES SEM CREDITO DO IMPOSTO - OUTRAS                 |"
		aL[09]:=STR0056 //"|                                                                                                                                                             |                                                            |"		
		aL[10]:=STR0057 //"|                                                                                                                                                             |ST-CONTRIBUINTE-SUBSTITUIDO - ICMS NA FONTE                 |"
    Else
    	If nSubDiv == 1 
    		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
    		If cMV_ESTADO == "SE"   
    			aL[02]:=STR0071 //"|                                                                REGISTRO DE ENTRADAS MODELO P1                                                               |                  (*) CODIGO DE VALORES FISCAIS             |"	
    		Else
	    		If lImp
	    	    	aL[02]:=STR0064 //"|                                                                  REGISTRO DE ENTRADAS # - P1                                                                |                  (*) CODIGO DE VALORES FISCAIS             |"
	    	    Else
			   		aL[02]:=STR0003 //"|                                                                  REGISTRO DE ENTRADAS #                                                                     |                  (*) CODIGO DE VALORES FISCAIS             |"
				Endif 
	    	EndIf 
    	ElseIf nSubDiv == 2
    		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
    		If cMV_ESTADO == "SE"   
    			aL[02]:=STR0073//"|                                                        LIVRO REGISTRO DE ENTRADAS ESTADUAIS MODELO - P1                                                     |                  (*) CODIGO DE VALORES FISCAIS             |"
    		Else
	   			If lImp
	   				aL[02]:=STR0065//"|                                                            LIVRO REGISTRO DE ENTRADAS ESTADUAIS # - P1                                                      |                  (*) CODIGO DE VALORES FISCAIS             |"
	   			Else
			   		aL[02]:=STR0058 //"|                                                            LIVRO REGISTRO DE ENTRADAS ESTADUAIS #                                                           |                  (*) CODIGO DE VALORES FISCAIS             |"
	            Endif
	  		EndIf 
    	ElseIf nSubDiv == 3    
    		
    		If cMV_ESTADO == "SE"
    		  		aL[02]:=STR0074 //"|                                                     LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS - MODELO P1                                                   |                  (*) CODIGO DE VALORES FISCAIS             |"        
    		Else 
	    		If lImp
	    			aL[02]:=STR0066 //"|                                                         LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS # - P1                                                    |                  (*) CODIGO DE VALORES FISCAIS             |"        
	            Else
			   		aL[02]:=STR0059 //"|                                                         LIVRO REGISTRO DE ENTRADAS INTERESTADUAIS #                                                         |                  (*) CODIGO DE VALORES FISCAIS             |"
	            Endif 
	    	EndIf 
	    	
		Endif
		aL[03]:="|                                                                                                                                                               |------------------------------------------------------------|"
		aL[04]:=STR0004 //"| FIRMA: #############################                                                                                                                        |                                                            |"
		aL[05]:=STR0005 //"|                                                                                                                                                             |1-OPERACOES COM CREDITO DO IMPOSTO                          |" 
		aL[06]:=STR0006 //"| INSC.EST: ###########           C.N.P.J.: ##############                                                                                                    |                                                            |" 
		aL[07]:=STR0007 //"|                                                                                                                                                             |2-OPERACOES SEM CREDITO DO IMPOSTO-ISENTAS OU NAO TRIBUTADAS|" 
		If lLFisOrd
				aL[08]:=STR0060 //"| ORDEM/FOLHA: ###-E / #######     MES OU PERIODO/ANO: #######  
			ElseIf lImpPag
				aL[08]:=STR0070 //"| PаGINA: #######                    MES OU PERIODO/ANO: #######                                                                                                                                                           |"
   			Else
				aL[08]:=STR0008 //"| FOLHA: #######                   MES OU PERIODO/ANO: #######	                                                                                                                                                           |"
	 	Endif
		aL[09]:=STR0009 //"|                                                                                                                                                             |3-OPERACOES SEM CREDITO DO IMPOSTO - OUTRAS                 |" 
		aL[10]:="|                                                                                                                                                               |                                                            |"
	Endif
	aL[11]:="|============================================================================================================================================================================================================================|"
	aL[12]:=STR0010//"|        |                    DOCUMENTOS FISCAIS                      |                  |    CODIFICACAO      |        ICMS - VALORES FISCAIS                 |       IPI - VALORES FISCAIS             |                 |"
	aL[13]:="|          |------------------------------------------------------------|                  |---------------------|-----------------------------------------------|-----------------------------------------|                 |"
	aL[14]:=STR0011//"|DATA DE |ESPE |  SERIE  |         |DATA     |                   | UF |                  |              |      |COD|BASE DE CALCULO   |     |    IMPOSTO       |COD|BASE DE CALCULO   |    IMPOSTO       |                 |"
	aL[15]:=STR0012//"|ENTRADA |CIE  |SUB-SERIE| NUMERO  |DOCUMENTO| CODIGO DO EMITENTE|ORIG| VALOR CONTABIL   |   CONTABIL   |FISCAL|(*)|VL. DA OPERACAO   |ALIQ.|   CREDITADO      |(*)|VL. DA OPERACAO   |   CREDITADO      | OBSERVACOES     |"
	aL[16]:="|==========|=====+=========+=========+==========+==================+====|==================|==============+======|===+==================+=====+==================|===+==================+==================|=================|"
    aL[17]:="|##########|#####|   ###   |#########|##########|##################| ## |##################|##############|######| # |##################|#####|##################| # |##################|##################|#################|"
    aL[18]:="|# # # #   |# #####################################################| ## |##################|##############|######| # |##################|#####|##################| # |##################|##################|#################|"
Else                                                                                                                                                                                                
	aL:=Array(20)
	aL[01]:="+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+"
	If nSubDiv == 1 
	
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды 
  		If cMV_ESTADO == "SE"                                                                                                                                                                                                  
    		aL[02]:=STR0072 //"|                                                                                             REGISTRO DE SAIDAS MODELO - P2                                                                                               |"
    	Else
			If lImp
	    	    aL[02]:=STR0067 //"|                                                                                                     REGISTRO DE SAIDAS # - P2                                                                                            |"
	  		Else
		  		aL[02]:=STR0013 //"|                                                                                                     REGISTRO DE SAIDAS #                                                                                                 |"		
			Endif 
		EndIf
			
	ElseIf nSubDiv == 2           
	
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If cMV_ESTADO == "SE"                                                                                                                                                                                                  
    		aL[02]:=STR0075 //"|                                                                                        LIVRO REGISTRO DE SAIDAS ESTADUAIS - MODELO P2                                                                                    |"
    	Else
			If lImp
				aL[02]:=STR0068 //"|                                                                                             LIVRO REGISTRO DE SAIDAS ESTADUAIS # - P2                                                                                    |"
	        Else
		  		aL[02]:=STR0061 //"|                                                                                             LIVRO REGISTRO DE SAIDAS ESTADUAIS #                                                                                         |"		
		    Endif 
		EndIf 
		
	ElseIf nSubDiv == 3       
	    
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//| TRATA PARA ATENDER LEGISLACAO DE SERGIPE                      Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If cMV_ESTADO == "SE"                                                                                                                                                                                                  
    		aL[02]:=STR0076 //"|                                                                                       LIVRO REGISTRO DE SAIDAS INTERESTADUAIS - MODELO P2                                                                                |"
    	Else
			If lImp
				aL[02]:=STR0069 //"|                                                                                           LIVRO REGISTRO DE SAIDAS INTERESTADUAIS # - P2                                                                                 |"
			Else
		  		aL[02]:=STR0062 //"|                                                                                           LIVRO REGISTRO DE SAIDAS INTERESTADUAIS #                                                                                      |"				
		    Endif   
		EndIf    
		
	Endif
	aL[03]:="|                                                                                                                                                                                                                          |"
	aL[04]:=STR0014 //"| FIRMA: #########################                                                                                                                                                                                         |"
	aL[05]:="|                                                                                                                                                                                                                          |"
	aL[06]:=STR0015 //"| INSC.EST: #########             C.N.P.J.: ##############                                                                                                                                                                 |"
	aL[07]:="|                                                                                                                                                                                                                          |"
	If lLFisOrd
			aL[08]:=STR0063 //"| ORDEM/FOLHA: ###-E / #######     MES OU PERIODO/ANO: #######  
		ElseIf lImpPag
			aL[08]:=STR0070 //"| PаGINA: #######                    MES OU PERIODO/ANO: #######                                                                                                                                                           |"
   		Else
		  	aL[08]:=STR0016 //"| FOLHA: #######                   MES OU PERIODO/ANO: #######	                                                                                                                                                           |"
 	Endif
	aL[09]:="|                                                                                                                                                                                                                          |"
	aL[10]:="|                                                                                                                                                                                                                          |"
	aL[11]:="|==========================================================================================================================================================================================================================|"
	aL[12]:=STR0017 //"|         DOCUMENTOS FISCAIS               |                  |      CODIFICACAO          |                                      VALORES FISCAIS                                 |                                         |"
	aL[13]:=STR0018 //"|------------------------------------------|                  |---------------------------|--------------------------------------------------------------------------------------|                                         |"
	aL[14]:=STR0019 //"|     |     |                     |   |    |                  |                    |      |    |      OPERACOES COM DEBITO DO IMPOSTO      |   OPERACOES SEM DEBITO DO IMPOSTO   |                                         |"
	aL[15]:=STR0020 //"|     |SERIE|                     |   |    |                  |                    |      |ICMS|-------------------------------------------|-------------------------------------|                                         |"
	aL[16]:=STR0021 //"|ESPE | SUB-|                     |   | UF |      VALOR       |                    |      |    |     BASE DE      |     |     IMPOSTO      |    ISENTAS OU    |                  |                                         |"
	aL[17]:=STR0022 //"|CIE  |SERIE|       NUMERO        |DIA|DEST|     CONTABIL     |   CONTABIL         |FISCAL|IPI |     CALCULO      |ALIQ |     DEBITADO     |  NAO TRIBUTADAS  |      OUTRAS      |            OBSERVACOES                  |"
	aL[18]:="|=====+=====+=====================+===+====|==================|====================+======|====+==================+=====+==================|==================+==================|=========================================|"
	aL[19]:="|#####| ### |#####################| ##| ## |##################|####################| #### |####|##################|#####|##################|##################|##################|#########################################|"
	aL[20]:="|# #  |     |#####################| ##| ## |##################|####################| #### |####|##################|#####|##################|##################|##################|#########################################|"
Endif

Return

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931TranspЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime linhas de transporte                               Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931Transp(lTotal)
Local nTamTransp := Len(LivrArrayObs(nLargObs,aTransp))+7+If(lImpZer,3,0)
//Pego o tamanho da ObservaГЦo do aTransportar + 2 linhas que serЦo impressas nessa funГЦo caso seja Entrada ou 4 linhas caso seja Saida + 3 linhas se imprimir Linhas sem valor
Default lTotal	:=	.F.

nMaior:=0
AEval(aTamNotas,{|x|nMaior:=Max(nMaior,x)})
aTamNotas[2]:=nMaior
nLinNec:=aTamNotas[2]

//Se o tamanho da pagina for igual a linha + o tamanho do aTransportar devo imprimir o Transportar
lTransp:=(nLimPag <= (nLin+nTamTransp))//Tamanho da pag. = numero da linha + tamanho a transpotar Ex: 58 = 40 + 18	

//Se estou chamando a funГЦo R931Transp atravИs de algum Totalizador posso imprimir pois a validaГЦo de tamanho jА foi feita na funГЦo do Totalizador
If lTotal
	lTransp:= .T.
EndIf


If lTransp
	nTamTransp:=nLin
	If nTipoMov==1

		aObs:=LivrArrayObs(nLargObs,aTransp)

		R931IniGrade()

		aGrade[1,1]:="1"
		aGrade[1,2]:=aTransp[ColF3("F3_BASEICM")]
		aGrade[1,3]:=aTransp[ColF3("F3_VALICM")]
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
		aGrade[nx,1]:="2"
		aGrade[nx,2]:=aTransp[ColF3("F3_ISENICM")]
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
		aGrade[nx,1]:="3"
		If aTransp[ColF3("F3_OUTRICM")]>0		
	    	aGrade[nx,2]:=aTransp[ColF3("F3_OUTRICM")]
		Endif
		If SF3->(FieldPos("F3_VL43080")) > 0
		    If !Empty(aTransp[ColF3("F3_VL43080")])
		        aGrade[nx,2]:=aTransp[ColF3("F3_VL43080")]
		    EndIf
		EndIf	  	
		If SF3->(FieldPos("F3_VLINCMG")) > 0
		    If !Empty(aTransp[ColF3("F3_VLINCMG")])
		        aGrade[nx,2]:=aTransp[ColF3("F3_VLINCMG")]
		    EndIf
		EndIf
		aGrade[1,4]:="1"
		aGrade[1,5]:=aTransp[ColF3("F3_BASEIPI")]
		aGrade[1,6]:=aTransp[ColF3("F3_VALIPI")]
		nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
		aGrade[nx,4]:="2"
		aGrade[nx,5]:=aTransp[ColF3("F3_ISENIPI")]
		nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
		aGrade[nx,4]:="3"
		aGrade[nx,5]:=aTransp[ColF3("F3_OUTRIPI")]

		aDados:=Array(18)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0023 //"A TRANSPORTAR"
		aDados[8]:=aTransp[ColF3("F3_VALCONT")]

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
            If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GO Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTransp[ColF3("F3_BASERET")]
			If nColuna == 1 
				aDados[18]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[14]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
                Else
				   aDados[18]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTransp[ColF3("F3_BASERET")]
			aDados[14]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		Endif
		nLinNec:=nLin-nTamTransp+If(lImpZer,1,0)
		aTamNotas[2]:=Max(aTamNotas[2],nLinNec)

		R931Filler()
	   R931Cabec()
	Else
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,aTransp)
		aDados:=Array(15)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0023 //"A TRANSPORTAR"
		aDados[6]:=aTransp[ColF3("F3_VALCONT")]
		aDados[9]:="ICMS"
		aDados[10]:=aTransp[ColF3("F3_BASEICM")]
		aDados[12]:=aTransp[ColF3("F3_VALICM")]
		aDados[13]:=aTransp[ColF3("F3_ISENICM")]
		aDados[14]:=aTransp[ColF3("F3_OUTRICM")]
		If SF3->(FieldPos("F3_VL43080")) > 0
		    If !Empty(aTransp[ColF3("F3_VL43080")]) 
		        aDados[14]:=aTransp[ColF3("F3_VL43080")]                           
		    EndIf           
		EndIf
   	    If SF3->(FieldPos("F3_VLINCMG"))>0
		    If !Empty(aTransp[ColF3("F3_VLINCMG")]) 
	            aDados[14]:=aTransp[ColF3("F3_VLINCMG")]
	        EndIf
	    EndIf
		
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		aDados[9]:="IPI"
		aDados[10]:=aTransp[ColF3("F3_BASEIPI")]
		aDados[12]:=aTransp[ColF3("F3_VALIPI")]
		aDados[13]:=aTransp[ColF3("F3_ISENIPI")]
		aDados[14]:=aTransp[ColF3("F3_OUTRIPI")]
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
 		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTransp[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO <> "D"
				   aDados[12]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
                Else
				   aDados[15]:=STR0001+Alltrim(Transform(aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTransp[ColF3("F3_BASERET")]
			aDados[12]:=aTransp[ColF3("F3_ICMSRET")]-aTransp[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif

		nLinNec:=nLin-nTamTransp+If(lImpZer,1,0)
		aTamNotas[2]:=Max(aTamNotas[2],nLinNec)

		R931Filler()
	    R931Cabec()
	Endif
Endif

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931TotdiaЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime total do dia                                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931TotDia
Local nX := 0
Local nLinDia   := Len(LivrArrayObs(nLargObs,aTotDia))+If(nTipoMov==1,3,5)+If(lImpZer,3,0)
Local nLinTrans := Len(LivrArrayObs(nLargObs,aTransp))+If(nTipoMov==1,2,4)+If(lImpZer,3,0)//ObservaГУes + Tam. Max. das linhas impressas a transportar И 2 ou 4 dependendo do tipo de movimento + 3 linhas caso imprima linhas sem valor
lTotDia:=(dDiaAnt!=dDia)

If (lTotDia .And. !Empty(dDia)) .Or. Eof()
	aTamNotas[3]:=Max(aTamNotas[3],If(nLin>=nLimPag,nLinNec+(nLin-nLimPag),nLinNec))
	nLinNec:=aTamNotas[3]
    
    //Se o tamanho da pagina for menor que as linhas do Totalizador do dia + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador do dia.
    If nLimPag<nLin+nLinDia+nLinTrans
		R931Transp(.T.)
	Endif

	nTamTotDia:=nLin
	If nTipoMov==1

		aObs:=LivrArrayObs(nLargObs,aTotDia)

		R931IniGrade()

		If lImpZer.Or.(aTotDia[ColF3("F3_BASEICM")]>0.Or.aTotDia[ColF3("F3_VALICM")]>0)
		    If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_BASEICM")] ==0
			    aGrade[1,1]:=""
		    Else 
			    aGrade[1,1]:="1"
		    	aGrade[1,2]:=aTotDia[ColF3("F3_BASEICM")]
		    	aGrade[1,3]:=aTotDia[ColF3("F3_VALICM")]
		    EndIf
		Else                                                                      
			aGrade[1,1]:=""
		Endif
		If lImpZer.Or.(aTotDia[ColF3("F3_ISENICM")]>0)
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
		    If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENICM")]==0
			    aGrade[nx,1]:=""
		    Else 
				aGrade[nx,1]:="2"
				aGrade[nx,2]:=aTotDia[ColF3("F3_ISENICM")]
            EndIf
		Endif
		If lImpZer.Or.aTotDia[ColF3("F3_OUTRICM")]>0
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
		    If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_OUTRICM")]==0
			    aGrade[nx,1]:=""
		    Else 
				aGrade[nx,1]:="3"
			    If aTotDia[ColF3("F3_OUTRICM")]>0
				    aGrade[nx,2]:=aTotDia[ColF3("F3_OUTRICM")]
	            Else
			        If SF3->(FieldPos("F3_VLINCMG")) > 0
				        If aTotDia[ColF3("F3_VLINCMG")]>0
					        aGrade[nx,2]:=aTotDia[ColF3("F3_VLINCMG")]
		                EndIf
		            EndIf
					If SF3->(FieldPos("F3_VL43080")) > 0
					    If aTotDia[ColF3("F3_VL43080")]>0
						    aGrade[nx,2]:=aTotDia[ColF3("F3_VL43080")]
					    Endif
					EndIf			
	            EndIf
		    Endif
		Endif
		If lImpZer.Or.(aTotDia[ColF3("F3_BASEIPI")]>0.Or.aTotDia[ColF3("F3_VALIPI")]>0)
			If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_BASEIPI")]==0
			    aGrade[1,4]:=""
			Else
				aGrade[1,4]:="1"
				aGrade[1,5]:=aTotDia[ColF3("F3_BASEIPI")]
				aGrade[1,6]:=aTotDia[ColF3("F3_VALIPI")]
            EndIf
		Else
			aGrade[1,4]:=""
		Endif
		If lImpZer.Or.aTotDia[ColF3("F3_ISENIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
			If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENIPI")]==0
			    aGrade[nx,4]:=""
			Else
				aGrade[nx,4]:="2"
				aGrade[nx,5]:=aTotDia[ColF3("F3_ISENIPI")]
            EndIf
		Endif
		If lImpZer.Or.aTotDia[ColF3("F3_OUTRIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_OUTRIPI")]==0
			    aGrade[nx,4]:=""
			Else
    			aGrade[nx,4]:="3"
	    		aGrade[nx,5]:=aTotDia[ColF3("F3_OUTRIPI")]
		    EndIf
		Endif

		aDados:=Array(18)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0024+StrZero(Day(dDiaAnt),2) //"TOTAL DO DIA "
		aDados[8]:=aTotDia[ColF3("F3_VALCONT")]

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTotDia[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14] := aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[14] := aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
				Else
				   aDados[18]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTotDia[ColF3("F3_BASERET")]
			aDados[14]:= aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
		nLinNec:=nLin-nTamTotDia+If(lImpZer,1,0)
		aTamNotas[3]:=Max(aTamNotas[3],nLinNec)
	Else
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,aTotDia)
		aDados:=Array(15)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0024+StrZero(Day(dDiaAnt),2) //"TOTAL DO DIA "
		
		If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENICM")]==0 .And. aTotDia[ColF3("F3_OUTRICM")]==0
		    aDados[9]:=""
		Else
			aDados[6]:=aTotDia[ColF3("F3_VALCONT")]
			aDados[9]:="ICMS"
			aDados[10]:=aTotDia[ColF3("F3_BASEICM")]
			aDados[12]:=aTotDia[ColF3("F3_VALICM")]
			aDados[13]:=aTotDia[ColF3("F3_ISENICM")]
			aDados[14]:=aTotDia[ColF3("F3_OUTRICM")] 
			If SF3->(FieldPos("F3_VL43080")) > 0
			    If !Empty(aTotDia[ColF3("F3_VL43080")])
			        aDados[14]:=aTotDia[ColF3("F3_VL43080")]		
			    EndIf
			EndIf
			If SF3->(FieldPos("F3_VLINCMG")) > 0
			    If !Empty(aTotDia[ColF3("F3_VLINCMG")])
			        aDados[14]:=aTotDia[ColF3("F3_VLINCMG")]		
			    EndIf
			EndIf
        EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		If aTotDia[ColF3("F3_ALIQICM")]==0 .And. aTotDia[ColF3("F3_ISENIPI")]==0 .And. aTotDia[ColF3("F3_OUTRIPI")]==0
    		aDados[9]:=""
		Else
			aDados[9]:="IPI"
			aDados[10]:=aTotDia[ColF3("F3_BASEIPI")]
			aDados[12]:=aTotDia[ColF3("F3_VALIPI")]
			aDados[13]:=aTotDia[ColF3("F3_ISENIPI")]
			aDados[14]:=aTotDia[ColF3("F3_OUTRIPI")]
        EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
 		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTotDia[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO <> "D"
				   aDados[12]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
                Else
				   aDados[15]:=STR0001+Alltrim(Transform(aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTotDia[ColF3("F3_BASERET")]
			aDados[12]:=aTotDia[ColF3("F3_ICMSRET")]-aTotDia[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[20],,,@nLin)
		nLinNec:=nLin-nTamTotDia+If(lImpZer,1,0)
		aTamNotas[3]:=Max(aTamNotas[3],nLinNec)
	Endif
Endif
If lTotDia
	For nX := 1 to Len(aTotDia)
	Do Case
		Case ValType(aTotDia[nX]) == "C"
			aTotDia[nX] := ""
		Case ValType(aTotDia[nX]) == "N"
			aTotDia[nX] := 0
		OtherWise
			aTotDia[nX] := Nil				
		End Case
	Next nX		
Endif

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931TotMesЁAutor Ё Juan Jose Pereira     Ё Data Ё 18.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime total do Mes                                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931TotMes
Local xx 		:= 1
Local nPosicao 	:= 0                                                                            
Local nProcFil	:= mv_par31
Local nRecBrutA	:= 0
Local nRecBrutM	:= 0
Local nPercent	:= GetNewPar("MV_PERCRJ",0) // Percentual Aliquota Simples RJ
Local nTaxa		:= mv_par35
Local cFilDe	:= mv_par32
Local cFilAte	:= mv_par33        
Local aArea		:= GetArea()
Local aAreaSm0 	:= SM0->(GetArea())
Local aICMSDev	:= {}
Local nLinMes   := Len(LivrArrayObs(nLargObs,aTotMes))+3+If(lImpZer,3,0)//ObservaГУes + Tam. Max. da totalizacao do mes 3 + 3 linhas caso imprima linhas sem valor
Local nLinTrans := Len(LivrArrayObs(nLargObs,aTransp))+If(nTipoMov==1,2,4)+If(lImpZer,3,0)//ObservaГУes + Tam. Max. das linhas impressas a transportar И 2 ou 4 dependendo do tipo de movimento + 3 linhas caso imprima linhas sem valor

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁVerifica se o processamento e centralizado, imprimindo mais de uma filialЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If nProcFil <> 1
	cFilDe 	:= cFilAnt
	cFilAte	:= cFilAnt
Endif      

SM0->(dbSeek(cEmpAnt+cFilDe,.T.))

********************* CIAP **********************
If lEmiteCiap
   nPosicao :=Ascan((cArqTemp)->(dbstruct()),{ |x| ( "F3_VALICM" $ x[1] ) })
   if nTipoMov==1 .and. lTotMes
      If nLin>=nLimPag.and.lImpMes
		 R931Transp()
	  Endif
	
	  dData := LastDay(MV_PAR01)
	  SFA->(dbSetOrder(2))
	  
      //зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
      //ЁImprime atraves das filiais selecionadas para o processamentoЁ
      //юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
      Do While !SM0->(Eof()) .And. SM0->M0_CODIGO+SM0->M0_CODFIL <= cEmpAnt+cFilAte

  	     cFilAnt	:= SM0->M0_CODFIL

	     If SFA->(dbSeek(xFilial("SFA")+dTos( dData )))
		    While SFA->(!EOF()) .and. SFA->FA_FILIAL == xFilial("SFA") .and. Dtos(SFA->FA_DATA)== dTos(ddata)
			   If ( SFA->FA_TIPO == "1" ) .and. (SFA->FA_CREDIT =="1")  			      
				  cMensagem:=Trim("Credito ICMS Ativo")+If(lColCiap,PADL(Transform(SFA->FA_VALOR,"@E 9,999,999.99"),21),"")
				  For xx:=1 to MlCount(cMensagem,nLargObs)
					  AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
				  Next xx
						
				  SF9->(dbSeek(xFilial()+SFA->FA_CODIGO))
				  R931IniGrade()
				  aGrade[1,1]:="1"
                  If !lColCiap
				     aGrade[1,3]:=SFA->FA_VALOR
				  Endif
				  nCredAtivo  +=SFA->FA_VALOR
				  
				  aDados:=Array(18)				

    		      If nLin>=nLimPag
			         R931Filler()
			         R931Cabec()
		          Endif
				  
				  FmtLin(@aDados,aL[18],,,@nLin)
                  aDados[10]	:= SF9->F9_CFOENT
				  R931ImpGrade()
				  nPosObs:=Ascan(aObs,{|x|x[2]})
				  While nPosObs>0
					    R931LoadObs()
					    If nPosObs>0
						   FmtLin(@aDados,aL[17],cPictVl,,@nLin)
					    Endif
				  Enddo
			   EndIf				
			   SFA->(dBSkip())
		    EndDo
		Endif
		SM0->(dbSkip())	     
      Enddo
	  aTotMes[nPosicao] +=nCredAtivo
   EndIf
Endif   
******************* CIAP FIM *********************
If lTotMes .and. lImpMes

	//Se o tamanho da pagina for menor que as linhas do Totalizador Mensal + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador Mensal.
    If nLimPag<nLin+nLinMes+nLinTrans
		R931Transp(.T.)
	Endif

	If nTipoMov==1

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Tam. Max. da totalizacao do mes - 3    Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		If (nLin+3)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif

		aObs:=LivrArrayObs(nLargObs,aTotMes)

		R931IniGrade()
        If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_BASEICM")]==0
			aGrade[1,1]:=""
        Else 
			aGrade[1,1]:="1"
 			aGrade[1,2]:=aTotMes[ColF3("F3_BASEICM")]
			aGrade[1,3]:=aTotMes[ColF3("F3_VALICM")]
        EndIf	
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
        
        If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_ISENICM")]==0
			aGrade[nx,1]:=""
        Else
			aGrade[nx,1]:="2"
			aGrade[nx,2]:=aTotMes[ColF3("F3_ISENICM")]
		EndIf	
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
        
        If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_OUTRICM")]==0
			aGrade[nx,1]:=""
        Else
			aGrade[nx,1]:="3"
            If aTotMes[ColF3("F3_OUTRICM")]>0
			    aGrade[nx,2]:=aTotMes[ColF3("F3_OUTRICM")]
            Else
	            If SF3->(FieldPos("F3_VLINCMG")) > 0        
                    If aTotMes[ColF3("F3_VLINCMG")]>0
			            aGrade[nx,2]:=aTotMes[ColF3("F3_VLINCMG")]
                    EndIf
                Endif 
			    If SF3->(FieldPos("F3_VL43080")) > 0
			        If !Empty(aTotMes[ColF3("F3_VL43080")])
			    	    aGrade[nx,2]:=aTotMes[ColF3("F3_VL43080")]		 
				    EndIf
				Endif		                
            Endif 
		EndIf
        
		If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_BASEIPI")]==0
			aGrade[1,4]:=""
   		Else
			aGrade[1,4]:="1"
			aGrade[1,5]:=aTotMes[ColF3("F3_BASEIPI")]
			aGrade[1,6]:=aTotMes[ColF3("F3_VALIPI")]
        EndIf	
		nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
        
       	If aTotMes[ColF3("F3_ALIQICM")]==0 .And. aTotMes[ColF3("F3_ISENIPI")]==0
			aGrade[nx,4]:=""
		Else	
			aGrade[nx,4]:="2"
			aGrade[nx,5]:=aTotMes[ColF3("F3_ISENIPI")]
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			aGrade[nx,4]:="3"
			aGrade[nx,5]:=aTotMes[ColF3("F3_OUTRIPI")]
	    EndIf
		aDados:=Array(18)
		FmtLin(@aDados,aL[18],,,@nLin)
		aDados[6]:=STR0025 //"TOTAL DO MES"
		aDados[8]:=aTotMes[ColF3("F3_VALCONT")]
   
		If nTipoMov==5
			If Alltrim(cMV_ESTADO) == "SP"
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁQuando optante pelo Simples Paulista, o registro de entradas deve mostrar as operacoes de saidaЁ
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	 	 		cMensagem := "Valor Total Operacoes SaМdas " + Transform(CalcRecBru(FirstDay(dDiaAnt),LastDay(dDiaAnt)),"@E 9,999,999.99")
		  		For xx:=1 to MlCount(cMensagem,nLargObs)
			    	AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
		 		Next xx
			Endif
        Endif
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTotMes[ColF3("F3_BASERET")]
			if nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:= aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[14]:= aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
                Else
				   aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			EndIf
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aTotMes[ColF3("F3_BASERET")]
			aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
	Else
		If (nLin+3)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aObs:=LivrArrayObs(nLargObs,aTotMes)
		aDados:=Array(15)
		FmtLin(@aDados,aL[20],,,@nLin)
		aDados[3]:=STR0025 //"TOTAL DO MES"
		If aTotMes[ColF3("F3_ALIQICM")]+aTotMes[ColF3("F3_BASEICM")]+aTotMes[ColF3("F3_VALICM")]+aTotMes[ColF3("F3_ISENICM")]+aTotMes[ColF3("F3_OUTRICM")] ==0
		    aDados[9]:=""
		Else
			aDados[6]:=aTotMes[ColF3("F3_VALCONT")]
			aDados[9]:="ICMS"
			aDados[10]:=aTotMes[ColF3("F3_BASEICM")]
			aDados[12]:=aTotMes[ColF3("F3_VALICM")]
			aDados[13]:=aTotMes[ColF3("F3_ISENICM")]
			aDados[14]:=aTotMes[ColF3("F3_OUTRICM")]
			If SF3->(FieldPos("F3_VL43080")) > 0
			    If !Empty(aTotMes[ColF3("F3_VL43080")])
			       aDados[14]:=aTotMes[ColF3("F3_VL43080")]
			    EndIf
			EndIf
			If aTotMes[ColF3("F3_ALIQICM")]+aTotMes[ColF3("F3_BASEIPI")]+aTotMes[ColF3("F3_VALIPI")]+aTotMes[ColF3("F3_ISENIPI")]+aTotMes[ColF3("F3_OUTRIPI")]==0
			    If !Empty(aTotMes[ColF3("F3_VLINCMG")])
			       aDados[14]:=aTotMes[ColF3("F3_VLINCMG")]
			    EndIf
			EndIf
        EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		If aTotMes[ColF3("F3_ALIQICM")]==0 
		    aDados[9]:=""
		Else
			aDados[9]:="IPI"
			aDados[10]:=aTotMes[ColF3("F3_BASEIPI")]
			aDados[12]:=aTotMes[ColF3("F3_VALIPI")]
			aDados[13]:=aTotMes[ColF3("F3_ISENIPI")]
			aDados[14]:=aTotMes[ColF3("F3_OUTRIPI")]
        EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

 		If nModelo == 5
 			If Alltrim(cMV_ESTADO) == "RJ"				
				//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
				//ЁQuando optante pelo Simples RJ, o registro de saМdas deve mostrar a Receita Bruta e o ICMS Dev.Ё
				//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	 	 		dDtRecIni	:= Ctod("01/01/"+ Str(Year(dDtIni)-1,4))
				dDtRecFim	:= Ctod("31/12/"+ Str(Year(dDtIni)-1,4))
	
	 	 		nRecBrutA 	:= CalcRBruta(dDtRecIni, dDtRecFim)     
				nRecBrutM	:= CalcRBruta(dDtIni, dDtFim)       
				aICMSDev	:= CalcImpost(nRecBrutA, nRecBrutM, nTaxa)
	
	 	 		cMensagem := STR0046 + Transform((nRecBrutM),"@E 9,999,999.99") //"Receita Bruta do perМodo .... R$ "
		  		For xx:=1 to MlCount(cMensagem,nLargObs)
			    	AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
		 		Next xx        
				
				If (aICMSDev[1][3])$("Regime Simplificado Especial")
					cMensagem := STR0047 + Alltrim(Str(nPercent))+ STR0048 + Transform((aICMSDev[1][1]),"@E 9,999,999.99") //"ICMS devido (" # "%)............. R$ "
				Else	
					cMensagem := STR0049 + Transform((aICMSDev[1][1]),"@E 9,999,999.99") //"ICMS devido ................. R$ "      
		  		Endif
		  		
		  		For xx:=1 to MlCount(cMensagem,nLargObs)
			    	AADD(aObs,{MemoLine(cMensagem,nLargObs,xx),.T.})
		 		Next xx  
			Endif
        Endif
 		
		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R931ImpGrade()
		
 		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
 		
 		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End
		
 		//зддддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GO Ё
		//юддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro).and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTotMes[ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
			    If F3_TIPO <> "D"
				   aDados[12]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			    Else
				   aDados[15]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aTotMes[ColF3("F3_BASERET")]
			aDados[12]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		FmtLin(@aDados,aL[20],,,@nLin)
	Endif
Else
	If lTotMes
		R931Filler()
	Endif
Endif
If lTotMes
   R931Filler()
	For xx := 1 to Len(aTransp)
		If ValType(aTransp[xx]) == "N"
			aTransp[xx] := 0
		Else
			aTransp[xx] := "NULL"
		Endif
	Next

	For xx := 1 to Len(aTotMes)
		If ValType(aTotMes[xx]) == "N"
			aTotMes[xx] := 0
		Else
			aTotMes[xx] := "NULL"
		Endif
	Next

	For xx := 1 to Len(aTamNotas)
		If ValType(aTamNotas[xx]) == "N"
			aTamNotas[xx] := 0
		Else
			aTamNotas[xx] := "NULL"
		Endif
	Next
Endif

//здддддддддддддддддддддддддддддддддд©
//ЁRestaura a filial e area corrente Ё
//юдддддддддддддддддддддддддддддддддды
RestArea(aAreaSm0)
cFilAnt	:= SM0->M0_CODFIL
RestArea(aArea)

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931TotPerЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime total do periodo de apuracao                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931TotPer
Local nCntFor :=1
Local nLinICM   := Len(LivrArrayObs(nLargObs,aTotPerIcm))+If(nTipoMov==1,3,3)+If(lImpZer,3,0)
Local nLinIPI   := Len(LivrArrayObs(nLargObs,aTotPerIPI))+If(nTipoMov==1,2,2)+If(lImpZer,3,0)
Local nLinTrans := Len(LivrArrayObs(nLargObs,aTransp))+If(nTipoMov==1,2,4)+If(lImpZer,3,0)//ObservaГУes + Tam. Max. das linhas impressas a transportar И 2 ou 4 dependendo do tipo de movimento + 3 linhas caso imprima linhas sem valor
nLinNec2:=0


If lTotPerICM
	aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
	nLinNec2:=nLinNec2+aTamNotas[4]
Endif
If lTotPerIPI
	aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
	nLinNec2:=nLinNec2+aTamNotas[5]
Endif

If lTotPerICM.or.lTotPerIPI
	nLinNec:=nLinNec2
	
	
	//Se o tamanho da pagina for menor que as linhas do Totalizador do ICM + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador do ICM.
    If lTotPerICM
	    If nLimPag<nLin+nLinICM+nLinTrans
			R931Transp(.T.)
		Endif
	EndIf
	//Se o tamanho da pagina for menor que as linhas do Totalizador do IPI + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir o Totalizador do IPI.
	If lTotPerIPI
	    If nLimPag<nLin+nLinIPI+nLinTrans
			R931Transp(.T.)
		Endif
	EndIf

	If nTipoMov==1
		aObs:={}

		R931IniGrade()

		If lTotPerIcm
			aObs := LivrArrayObs(nLargObs,aTotPerIcm)
			If (aTotPerIcm[ColF3("F3_BASEICM")]>0.Or.aTotPerIcm[ColF3("F3_VALICM")]>0)
				aGrade[1,1]:="1"
				aGrade[1,2]:=aTotPerIcm[ColF3("F3_BASEICM")]
				aGrade[1,3]:=aTotPerIcm[ColF3("F3_VALICM")]
			Else
				aGrade[1,1]:=If(!lImpZer,"","1")
			Endif

			If aTotPerIcm[ColF3("F3_ISENICM")]>0
				nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
				aGrade[nx,1]:="2"
				aGrade[nx,2]:=aTotPerIcm[ColF3("F3_ISENICM")]
			Endif

			If aTotPerIcm[ColF3("F3_OUTRICM")]>0
				nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})
				aGrade[nx,1]:="3"
				aGrade[nx,2]:=aTotPerIcm[ColF3("F3_OUTRICM")]
			Else
	            If SF3->(FieldPos("F3_VL43080")) > 0
				    If aTotPerIcm[ColF3("F3_VL43080")]>0
					    aGrade[nx,2]:=aTotPerIcm[ColF3("F3_VL43080")]
				    EndIf
				Endif
  		   	    If SF3->(FieldPos("F3_VLINCMG")) > 0
				   If aTotPerIcm[ColF3("F3_VLINCMG")]>0
					   aGrade[nx,2]:=aTotPerIcm[ColF3("F3_VLINCMG")]
				   Endif
	           EndIf
			Endif
		Endif

		If lTotPerIPI
			If (aTotPerIPI[ColF3("F3_BASEIPI")]>0 .Or.aTotPerIPI[ColF3("F3_VALIPI")]>0)
				aGrade[1,4]:="1"
				aGrade[1,5]:=aTotPerIPI[ColF3("F3_BASEIPI")]
				aGrade[1,6]:=aTotPerIPI[ColF3("F3_VALIPI")]
			Else
				aGrade[1,4]:=If(!lImpZer,"","1")
			Endif

			If aTotPerIPI[ColF3("F3_ISENIPI")]>0
				nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
				aGrade[nx,4]:="2"
				aGrade[nx,5]:=aTotPerIPI[ColF3("F3_ISENIPI")]
			Endif

			If aTotPerIPI[ColF3("F3_OUTRIPI")]>0
				nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
				aGrade[nx,4]:="3"
				aGrade[nx,5]:=aTotPerIPI[ColF3("F3_OUTRIPI")]
			Endif

		Endif

		aDados:=Array(18)

		If lTotPerICM .Or. lTotPerIPI
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=STR0026 //"TOTAL DO PERIODO "
			If lTotPerIcm
				aDados[8]:=aTotPerICM[ColF3("F3_VALCONT")]
			Endif
			If lTotPerIPI
				aDados[8]:=aTotPerIPI[ColF3("F3_VALCONT")]
			Endif
			//здддддддддддддддддддддддддддддддддддддддд©
			//Ё Imprime Linhas de detalhe              Ё
			//юдддддддддддддддддддддддддддддддддддддддды
			R931ImpGrade()

			nPosObs:=Ascan(aObs,{|x|x[2]})
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0
					FmtLin(@aDados,aL[18],cPictVl,,@nLin)
				Endif
			End
		Endif

		aDados:=Array(18)

		nTamTotPer:=nLin
		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If lTotPerICM
			If !Empty(cTitLivro).and. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
				aDados[11]:="ST"
				aDados[12]:=aTotMes[ColF3("F3_BASERET")]
				if nColuna == 1
					aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				ElseIf nColuna == 2
					aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				ElseIf nColuna == 3
					If F3_TIPO == "D"
					   aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
					Else
					   aDados[18]:=STR0001+Alltrim(Transform(aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
					Endif   
				endif
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]>0
				aDados[11]:="ST"
				aDados[12]:=aTotMes[ColF3("F3_BASERET")]
				aDados[14]:=aTotMes[ColF3("F3_ICMSRET")]-aTotMes[ColF3("F3_OBSSOL")]
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		Endif
		If lTotPerICM
			nLinNec:=nLin-nTamTotPer
			aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
		Endif
		If lTotPerIPI
			nLinNec:=nLin-nTamTotPer
			aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
		Endif
		FmtLin(@aDados,aL[18],,,@nLin)
	Else
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		nTamTotPer:=nLin
		aObs:={}
		aDados:=Array(15)
		aDados[3]:=STR0027 //"TOTAL DO PERIODO"
		If lTotPerICM
			aObs:=LivrArrayObs(nLargObs,aTotPerICM)
			aDados[6]:=aTotPerICM[ColF3("F3_VALCONT")]
			aDados[9]:="ICMS"
			aDados[10]:=aTotPerICM[ColF3("F3_BASEICM")]
			aDados[12]:=aTotPerICM[ColF3("F3_VALICM")]
			aDados[13]:=aTotPerICM[ColF3("F3_ISENICM")]
			aDados[14]:=aTotPerICM[ColF3("F3_OUTRICM")]
			If SF3->(FieldPos("F3_VL43080")) > 0
			    If !Empty(aTotPerICM[ColF3("F3_VL43080")])
			        aDados[14]:=aTotPerICM[ColF3("F3_VL43080")]
			    EndIf           
			EndIf
			If SF3->(FieldPos("F3_VLINCMG")) > 0
			    If !Empty(aTotPerICM[ColF3("F3_VLINCMG")])
			        aDados[14]:=aTotPerICM[ColF3("F3_VLINCMG")]
			    EndIf           
			EndIf
			R931LoadObs()
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		If lTotPerIPI
			aDados[6]:=aTotPerIPI[ColF3("F3_VALCONT")]
			aDados[9]:="IPI"
			aDados[10]:=aTotPerIPI[ColF3("F3_BASEIPI")]
			aDados[12]:=aTotPerIPI[ColF3("F3_VALIPI")]
			aDados[13]:=aTotPerIPI[ColF3("F3_ISENIPI")]
			aDados[14]:=aTotPerIPI[ColF3("F3_OUTRIPI")]
			R931LoadObs()
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
		If lTotPerICM
			nPosObs:=Ascan(aObs,{|x|x[2]})
			While nPosObs>0
				R931LoadObs()
				If nPosObs>0
					FmtLin(@aDados,aL[20],cPictVl,,@nLin)
				Endif
			End
		Endif
 		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If lTotPerICM
			If !Empty(cTitLivro) .And. aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]>0
				aDados[9]:="ST"
				aDados[10]:=aTotPerICM[ColF3("F3_BASERET")]
				if nColuna == 1
					aDados[15]:=STR0001+Alltrim(Transform(aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				ElseIf nColuna == 2
					aDados[12]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
				ElseIf nColuna == 3
                    If F3_TIPO <> "D"
				  	   aDados[12]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
                    Else
					   aDados[15]:=STR0001+Alltrim(Transform(aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
					Endif   
				Endif
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]>0
				aDados[9]:="ST"
				aDados[10]:=aTotPerICM[ColF3("F3_BASERET")]
				aDados[12]:=aTotPerICM[ColF3("F3_ICMSRET")]-aTotPerICM[ColF3("F3_OBSSOL")]
				FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		EndIf
		FmtLin(@aDados,aL[20],,,@nLin)
		If lTotPerICM
			nLinNec:=nLin-nTamTotPer
			aTamNotas[4]:=Max(aTamNotas[4],nLinNec)
		Endif
		If lTotPerIPI
			nLinNec:=nLin-nTamTotPer
			aTamNotas[5]:=Max(aTamNotas[5],nLinNec)
		Endif
	Endif
	If lTotPerICM.Or.!(Month(dDia)==Month(dDiaAnt))
		For nCntFor := 1 to Len(aTotPerICM)
			If ValType(aTransp[nCntFor]) == "N"
				aTotPerICM[nCntFor] := 0
			Else
				aTotPerICM[nCntFor] := "NULL"
			Endif
		Next
		nSvApurICM:=DefPeriodo(dDia,nApurICM)
	Endif
	If lTotPerIPI.Or.!(Month(dDia)==Month(dDiaAnt))
		For nCntFor := 1 to Len(aTotPerIPI)
			If ValType(aTotPerIPI[nCntFor]) == "N"
				aTotPerIPI[nCntFor] := 0
			Else
				aTotPerIPI[nCntFor] := "NULL"
			Endif
		Next
		nSvApurIPI:=DefPeriodo(dDia,nApurIPI)
	Endif
Endif
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931ResCfoЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Resumo por CFO                                             Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931ResCfo

Local i :=0
Local cChave3	:= ""

//здддддддддддд©
//Ё Ordena CFOsЁ
//юдддддддддддды
aResCFO := Asort(aResCFO,,,{|x,y|x[ColF3("F3_CFO")]<y[ColF3("F3_CFO")]})

If Len(aResCFO)==0 .Or. !(lTotPerIcm .Or. lTotPerIPI)
	Return
Endif

aCFOS:={STR0028,; //"1.00 ENTRADAS DO ESTADO"
		STR0029,; //"2.00 ENTRADAS DE FORA DO ESTADO"
		STR0030,; //"3.00 ENTRADAS DO EXTERIOR"
		"",;
		STR0031,; //"5.00 SAIDAS PARA O ESTADO"
		STR0032,; //"6.00 SAIDAS PARA FORA DO ESTADO"
		STR0033} //"7.00 SAIDAS PARA O EXTERIOR"

cSvCFO:="X"

If nLin<nLimPag
   R931Filler()
Endif   

nLin:=80
For i:=1 to Len(aResCFO)
	If nLin>=nLimPag
        R931Filler()
		R931Cabec()
	EndIf
	aObs:=LivrArrayObs(nLargObs,aResCFO[i])
	cCFO:=Trim(aResCFO[i,ColF3("F3_CFO")])
	If nTipoMov==1

		If i==1
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=STR0034 //"RESUMO DAS OPERACOES E PRESTACOES POR CODIGO FISCAL DE OPERACAO"
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:="==============================================================="
			FmtLin(@aDados,aL[18],,,@nLin)
		EndIf

		If lImpZer .And. (nLin+4)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif

		R931IniGrade()

		If (aResCFO[i,ColF3("F3_BASEICM")]>0 .Or. aResCFO[i,ColF3("F3_VALICM")]>0 .Or. aResCFO[i,ColF3("F3_VALCONT")]>0)
			aGrade[1,1]:="1"
			aGrade[1,2]:=aResCFO[i,ColF3("F3_BASEICM")]
			aGrade[1,3]:=aResCFO[i,ColF3("F3_VALICM")]
			// Tratamento do campo F3_VALCONT, deverА ser somado apenas se o campo F4_LFICM for ICM Zerado
			cChave3 := SF3->F3_NFISCAL+SF3->F3_SERIE+SF3->F3_CLIEFOR+SF3->F3_LOJA 
			SD1->(dbSetOrder(1))
			SF4->(dbSetOrder(1))
			If SD1->(dbSeek(xFilial("SD1")+cChave3))
				If SF4->(dbSeek(xFilial("SF4")+SD1->D1_TES))
					If SF4->F4_LFICM == "Z" .Or. SF4->F4_LFIPI == "Z"
						aGrade[1,4]:=aResCFO[i,ColF3("F3_VALCONT")]
					Endif
				Endif
			Endif
			//
		Else
			aGrade[1,1]:=If(!lImpZer,"","1")
		Endif
		If aResCFO[i,ColF3("F3_ISENICM")]>0
			nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","2")})
			aGrade[nx,1]:="2"
			aGrade[nx,2]:=aResCFO[i,ColF3("F3_ISENICM")]
		Endif
		nx:=Ascan(aGrade,{|x|x[1]==If(!lImpZer,"","3")})  
    	aGrade[nx,1]:="3"
		If aResCFO[i,ColF3("F3_OUTRICM")]>0
		    aGrade[nx,2]:=aResCFO[i,ColF3("F3_OUTRICM")]
        Endif
  		If SF3->(FieldPos("F3_VL43080")) > 0
		    If aResCFO[i,ColF3("F3_VL43080")]>0
   		        aGrade[nx,2]:=aResCFO[i,ColF3("F3_VL43080")]		        
		    Endif
        EndIf        
		If SF3->(FieldPos("F3_VLINCMG")) > 0
		    If aResCFO[i,ColF3("F3_VLINCMG")]>0
			    aGrade[nx,2]:=aResCFO[i,ColF3("F3_VLINCMG")]
		    Endif
		Endif

		If (aResCFO[i,ColF3("F3_BASEIPI")]>0.Or.aResCFO[i,ColF3("F3_VALIPI")]>0)
			aGrade[1,4]:="1"
			aGrade[1,5]:=aResCFO[i,ColF3("F3_BASEIPI")]
			aGrade[1,6]:=aResCFO[i,ColF3("F3_VALIPI")]
		Else
			aGrade[1,4]:=If(!lImpZer,"","1")
		Endif
		If aResCFO[i,ColF3("F3_ISENIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","2")})
			aGrade[nx,4]:="2"
			aGrade[nx,5]:=aResCFO[i,ColF3("F3_ISENIPI")]
		Endif
		If aResCFO[i,ColF3("F3_OUTRIPI")]>0
			nx:=Ascan(aGrade,{|x|x[4]==If(!lImpZer,"","3")})
			aGrade[nx,4]:="3"
			aGrade[nx,5]:=aResCFO[i,ColF3("F3_OUTRIPI")]
		Endif

		aDados:=Array(18)
        If !(Substr(cCFO,1,1)==cSvCFO).and.!(ALLTRIM(cCFO)$"TTT") .And. !Empty (cCfo)
			FmtLin(@aDados,aL[18],,,@nLin)
			cSvCFO:=Substr(cCFO,1,1)
			aDados[6]:=If(cSvCFO="0",,aCFOS[Val(cSvCFO)])
			FmtLin(@aDados,aL[18],,,@nLin)
			aDados[6]:=Replic("=",If(cSvCFO="0",3,Len(aCFOS[Val(cSvCFO)])))
			FmtLin(@aDados,aL[18],,,@nLin)
		Endif

		If (nLin+4)>=nLimPag
			R931Filler()
			R931Cabec()
		Endif

		If ("TT"$cCFO)
			FmtLin(@aDados,aL[18],,,@nLin)
            aDados[6]:=If(ALLTRIM(cCFO)=="TTT",STR0035,STR0036) //"TOTAL"###"SUB-TOTAL"
		Else
            aDados[10]:=TransForm(cCFO,PESQPICT("SF3","F3_CFO"))
		Endif
		aDados[8]:=aResCFO[i,ColF3("F3_VALCONT")]

		//здддддддддддддддддддддддддддддддддддддддд©
		//Ё Imprime Linhas de detalhe              Ё
		//юдддддддддддддддддддддддддддддддддддддддды
		R931ImpGrade()

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
				FmtLin(@aDados,aL[18],cPictVl,,@nLin)
			Endif
		End
		//зддддддддддддддддддддддддддддддддддддддд©
		//Ё Para atender legislacao Fomentar de GOЁ
		//юддддддддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aResCFO[i,ColF3("F3_BASERET")]
			if nColuna == 1
				aDados[18]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[14]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
			    If F3_TIPO == "D"
				   aDados[14]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			    Else
				   aDados[18]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		ElseIf (nColuna == 2 .Or. nColuna == 3) .And. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[11]:="ST"
			aDados[12]:=aResCFO[i,ColF3("F3_BASERET")]
			aDados[14]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[18],cPictVl,,@nLin)
		Endif
	Else
       //зддддддддддддддддддддддддддддддддддддддд©
       //ЁControla a impressao de CFO's de Saida.Ё
       //юддддддддддддддддддддддддддддддддддддддды
	    If Val(Substr(cCFO,1,1))<5 .AND. !(ALLTRIM(cCFO)=="TTT")
	       Loop
	    Endif                      
		If i==1
			If mv_par27 == 1 .And. nTotIcmDeb > 0
				FmtLin(@aDados,aL[20],,,@nLin)
				aDados[15]:= STR0042+Transform(nTotIcmDeb,PESQPICT("SF3","F3_ICMSRET")) //"ICMS A SER DEBITADO: "
				FmtLin(@aDados,aL[20],,,@nLin)
			Endif

			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:=STR0034 //"RESUMO DAS OPERACOES E PRESTACOES POR CODIGO FISCAL DE OPERACAO"
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:="==============================================================="
			FmtLin(@aDados,aL[20],,,@nLin)
		EndIf
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Cria Array com mensagens a serem impressas na coluna de ObservacaoЁ
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		aDados:=Array(15)

        If !(Substr(cCFO,1,1)==cSvCFO).and.!(ALLTRIM(cCFO)=="TTT")
			If (nLin+3)>=nLimPag
			   R931Filler()
			   R931Cabec()
			Endif
			FmtLin(@aDados,aL[20],,,@nLin)
			cSvCFO:=Substr(cCFO,1,1)
			aDados[3]:=If(cSvCFO="0",,aCFOS[Val(cSvCFO)])
			FmtLin(@aDados,aL[20],,,@nLin)
			aDados[3]:=Replic("=",If(cSvCFO="0",3,Len(aCFOS[Val(cSvCFO)])))
			FmtLin(@aDados,aL[20],,,@nLin)
		Endif
		If ("TT"$cCFO)
			FmtLin(@aDados,aL[20],,,@nLin)
            aDados[3]:=If(ALLTRIM(cCFO)=="TTT",STR0035,STR0036) //"TOTAL"###"SUB-TOTAL"
		Else
            aDados[8]:=TransForm(cCFO,PESQPICT("SF3","F3_CFO"))
		Endif
		aDados[6]:=aResCFO[i,ColF3("F3_VALCONT")]
		aDados[9]:="ICMS"
		aDados[10]:=aResCFO[i,ColF3("F3_BASEICM")]
		aDados[12]:=aResCFO[i,ColF3("F3_VALICM")]
		aDados[13]:=aResCFO[i,ColF3("F3_ISENICM")]
		aDados[14]:=aResCFO[i,ColF3("F3_OUTRICM")]
		If SF3->(FieldPos("F3_VL43080")) > 0
		    If !Empty(aResCFO[i,ColF3("F3_VL43080")])
		        aDados[14]:=aResCFO[i,ColF3("F3_VL43080")]
		    EndIf                               
		EndIf
		If SF3->(FieldPos("F3_VLINCMG")) > 0
		    If !Empty(aResCFO[i,ColF3("F3_VLINCMG")])
		        aDados[14]:=aResCFO[i,ColF3("F3_VLINCMG")]
		    EndIf                               
		EndIf
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		aDados[9]:="IPI"
		aDados[10]:=aResCFO[i,ColF3("F3_BASEIPI")]
		aDados[12]:=aResCFO[i,ColF3("F3_VALIPI")]
		aDados[13]:=aResCFO[i,ColF3("F3_ISENIPI")]
		aDados[14]:=aResCFO[i,ColF3("F3_OUTRIPI")]
		R931LoadObs()
		FmtLin(@aDados,aL[20],cPictVl,,@nLin)

		nPosObs:=Ascan(aObs,{|x|x[2]})
		While nPosObs>0
			R931LoadObs()
			If nPosObs>0
     		   FmtLin(@aDados,aL[20],cPictVl,,@nLin)
			Endif
		End

 		//здддддддддддддддддддддддддддддддддд©
		//Ё Atender legislacao Fomentar de GOЁ
		//юдддддддддддддддддддддддддддддддддды
		If !Empty(cTitLivro) .and. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aResCFO[i,ColF3("F3_BASERET")]
			If nColuna == 1
				aDados[15]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
			ElseIf nColuna == 2
				aDados[12]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			ElseIf nColuna == 3
                If F3_TIPO == "D"
				   aDados[12]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
                Else
				   aDados[15]:=STR0001+Alltrim(Transform(aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")],PESQPICT("SF3","F3_ICMSRET"))) //"ICMS RETIDO: "
				Endif   
			Endif
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Elseif (nColuna == 2 .Or. nColuna == 3) .And. aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]>0
			aDados[9]:="ST"
			aDados[10]:=aResCFO[i,ColF3("F3_BASERET")]
			aDados[12]:=aResCFO[i,ColF3("F3_ICMSRET")]-aResCFO[i,ColF3("F3_OBSSOL")]
			FmtLin(@aDados,aL[20],cPictVl,,@nLin)
		Endif
	Endif
	//зддддддддддддддддддддддддддддддддд©
	//Ё Completa preenchimento da folha Ё
	//юддддддддддддддддддддддддддддддддды
	If i==Len(aResCFO)
		If nTipoMov==1
			FmtLin(@aDados,aL[18],,,@nLin)
		Else
			FmtLin(@aDados,aL[20],,,@nLin)
		Endif
		aResCFO	:= {}
		R931Filler()
	Endif    
Next i

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931ResEstЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Resumo por Estado                                          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931ResEst
Local xx:=0
Local i:=1
Local j:=1
Local lFirstCO:=.T.
Local lFirstNC:=.T.
Local nTotvlrctb:=0
Local nTotvlrbsc:=0
Local nTotimpdeb	:=0
Local nTotisenta	:=0
Local nTotoutras	:=0
Local nTotIcmCre	:=0
Local nTotIPICre	:=0
Local nTotBasIPI	:=0
Local lAntiICM		:= (SF3->(FieldPos("F3_VALANTI")) > 0 .And. SuperGetMv("MV_ESTADO")=="SP")

If Len(aResumo)==0 .Or. !(lTotPerIcm .Or. lTotPerIPI)
	Return
Endif

nLin:=80
//здддддддддддддддддддддддддддддддддддддддддд©
//Ё Arranja o resumo em ordem de CFO e EstadoЁ
//юдддддддддддддддддддддддддддддддддддддддддды
aResumo:=ASort(aResumo,,,{|x,y|x[1]+x[2]<y[1]+y[2]})
lFirstCO:=.T.
lFirstNC:=.T.
For i:=1 to Len(aResumo)
   If nLin>nLimPag
   		If nLin<>80
   			FmtLin({},aL[01],,,@nLin)
   		EndIf
		R931Cabec()
	Endif
	If nTipoMov==1
		aDados:=Array(18)
		If (lLisEstOri.Or.(!lLisEstOri.And.aResumo[i,16]!=aResumo[i,2]))
			If i==1
				FmtLin(@aDados,aL[17],,,@nLin)
				aDados[8]:=STR0037 //"DEMONSTRATIVO POR ESTADO DE ORIGEM DA MERCADORIA OU DE INICIO DA PRESTACAO DE SERVICO"
				FmtLin(@aDados,aL[17],,,@nLin)
				aDados[8]:="====================================================================================="
				FmtLin(@aDados,aL[17],,,@nLin)
				FmtLin(@aDados,aL[17],,,@nLin)
			Endif
         
		    aGrade:={}


			If mv_par26 == 1
	           aDados[07]:=aResumo[i,2] 		// Estado
			   aDados[08]:=aResumo[i,3] 		//Valor Contabil

			   If aResumo[i,4]>0 //Base de Calculo
				  AADD(aGrade,{"1",aResumo[i,4]})
			   Endif
               If aResumo[i,7]>0 .And. lLisIsenta //ICMS Isentas
                  AADD(aGrade,{"2",aResumo[i,7]})
               EndIf
               If aResumo[i,5]>0 //ICMS Outras
				  AADD(aGrade,{"3",aResumo[i,5]})
               Else
	               If aResumo[i,19]>0 //Incentivo a prod.leite-MG
					  AADD(aGrade,{"3",aResumo[i,19]})
				   Endif			   
			   Endif

               If aResumo[i,8]>0          		//Valor Icms
				  aDados[14] :=aResumo[i,8]
               EndIf
               If aResumo[i,9]>0 				// Base de Calculo IPI
				  aDados[16] :=aResumo[i,9]
			   Endif
               If aResumo[i,10]>0          		//Valor IPI
				  aDados[17] :=aResumo[i,10]
               EndIf
			Else
	           aDados[7]:=aResumo[i,2] // Estado
			   aDados[8]:=aResumo[i,3] //Valor Contabil
			   If aResumo[i,4]>0 //Base de Calculo
				  AADD(aGrade,{"1",aResumo[i,4]})
			   Endif
               If aResumo[i,7]>0 .And. lLisIsenta //ICMS Isentas
                  AADD(aGrade,{"2",aResumo[i,7]})
               EndIf
               If aResumo[i,5]>0 //ICMS Outras
				  AADD(aGrade,{"3",aResumo[i,5]})
               Else
	               If aResumo[i,19]>0 //Incentivo a prod.leite-MG
					  AADD(aGrade,{"3",aResumo[i,19]})
				   Endif	
			   Endif
            Endif			
			If aResumo[i,6]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS Retido
				aObs := {}
				cMensagem:=STR0038+Alltrim(Transform(aResumo[i,6],PESQPICT("SF3","F3_ICMSRET")))
			    For xx:=1 to MlCount(cMensagem,17)
				   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
			    Next xx				
				//aDados[18]:=STR0038+Alltrim(Transform(aResumo[i,6],PESQPICT("SF3","F3_ICMSRET")))
			Endif 

			 //зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддX©
             //Ёcriar totalizador de resumo por estado. quando o parametro  mv_par24 for sim Ё
             //юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддXы

			IF MV_PAR25 == 1                
     		   nTotvlrctb +=aResumo[i,3] //Valor Contabil

			   If aResumo[i,4]>0 //Base de Calculo
				  nTotvlrbsc +=	aResumo[i,4]
			   Endif
               If aResumo[i,7]>0 .And. lLisIsenta //ICMS Isentas
                  nTotvlrbsc +=	aResumo[i,7]
               EndIf
               If aResumo[i,5]>0 //ICMS Outras
				  nTotvlrbsc +=	aResumo[i,5]
	           Else
	               If aResumo[i,19]>0 //Incentivo a prod.leite-MG
					  nTotvlrbsc += aResumo[i,19]
			       Endif
			   Endif

	    	   If mv_par26 == 1
				  nTotIcmCre	+=aResumo[i,08] //Total Icm Creditado
				  nTotIPICre	+=aResumo[i,10] //Total Ipi Creditado
				  nTotBasIPI	+=aResumo[i,09] //Base de Calculo IPI
	    	   Endif
			endif 

			if len(aGrade) > 0
				For j:=1 to Len(aGrade)
					aDados[11]:=aGrade[j,1]
					aDados[12]:=aGrade[j,2]
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
					If Len(aObs) <= 0
						FmtLin(@aDados,aL[17],cPictVl,,@nLin)
					Else
						nPosObs:=Ascan(aObs,{|x|x[2]})
						While nPosObs>0
							R931LoadObs()
							If nPosObs>0
								FmtLin(@aDados,aL[17],cPictVl,,@nLin)
							Endif                      
							nPosObs:=Ascan(aObs,{|x|x[2]})							
						End					
					EndIf
				Next j
			Else
				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf			
			Endif	
			If aResumo[i,13]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS NORMAL
				aObs := {}
				cMensagem:=STR0043+Alltrim(Transform(aResumo[i,13],PESQPICT("SF3","F3_OBSICM")))
			    For xx:=1 to MlCount(cMensagem,17)
				   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
			    Next xx				

				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf			    				
			Endif			
			If aResumo[i,14]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS ST. INT.
				If lAntiICM
					aObs := {}
					cMensagem:=STR0044+Alltrim(Transform(aResumo[i,14]-aResumo[i,17],PESQPICT("SF3","F3_OBSSOL")))
				    For xx:=1 to MlCount(cMensagem,17)
					   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
				    Next xx									
				Else       
					aObs := {}
					cMensagem:=STR0044+Alltrim(Transform(aResumo[i,14],PESQPICT("SF3","F3_OBSSOL")))
				    For xx:=1 to MlCount(cMensagem,17)
					   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
				    Next xx					
				Endif  

				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf				
			Endif	
			If aResumo[i,15]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //CRED. PRES. ST
				aObs := {}
				cMensagem:=STR0045+Alltrim (Transform (aResumo[i,15], PESQPICT("SF3","F3_CRPRST")))
			    For xx:=1 to MlCount(cMensagem,17)
				   AADD(aObs,{MemoLine(cMensagem,17,xx),.T.})
			    Next xx
	
				If Len(aObs) <= 0
					FmtLin(@aDados,aL[17],cPictVl,,@nLin)
				Else
					nPosObs:=Ascan(aObs,{|x|x[2]})
					While nPosObs>0
						R931LoadObs()
						If nPosObs>0
							FmtLin(@aDados,aL[17],cPictVl,,@nLin)
						Endif                      
						nPosObs:=Ascan(aObs,{|x|x[2]})							
					End					
				EndIf			    
			Endif 
		Endif
	Else
		aDados:=Array(15)
		If (lLisEstOri.Or.(!lLisEstOri.And.aResumo[i,16]!=aResumo[i,2]))
			If i==1
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[7]:=STR0039 //"DEMONSTRATIVO POR ESTADO DE DESTINO DA MERCADORIA OU DA PRESTACAO DE SERVICO"
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[7]:="============================================================================"
				FmtLin(@aDados,aL[19],,,@nLin)
				FmtLin(@aDados,aL[19],,,@nLin)
			Endif
			If lFirstCO.and.aResumo[i,1]=="CO"
				lFirstCO:=.F.
				aDados[9]:=STR0040 //"OPERACOES REALIZADAS COM CONTRIBUINTES"
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[9]:="======================================"
				FmtLin(@aDados,aL[19],,,@nLin)
			Endif
			If lFirstNC.and.aResumo[i,1]=="NC"
				lFirstNC:=.F.
				aDados[9]:=STR0041 //"OPERACOES REALIZADAS COM NAO CONTRIBUINTES"
				FmtLin(@aDados,aL[19],,,@nLin)
				aDados[9]:="=========================================="
				FmtLin(@aDados,aL[19],,,@nLin)
			Endif

			If mv_par26 == 1
			   aDados[05]:=aResumo[i,2]
			   aDados[06]:=aResumo[i,3]
			   aDados[09]:="ICMS"
			   aDados[10]:=aResumo[i,4]
			   aDados[12]:=aResumo[i,8]
			   aDados[13]:=aResumo[i,7]            
			   aDados[14]:=aResumo[i,5]            
			   If aResumo[i,19]>0
			       aDados[14]:=aResumo[i,19]
			   EndIf           
			Else
			   aDados[5]:=aResumo[i,2]
			   aDados[6]:=aResumo[i,3]
			   aDados[9]:="ICMS"
			   aDados[10]:=aResumo[i,4]
			Endif   

            IF mv_par25 == 1                
     		   nTotvlrctb +=aResumo[i,3] //Valor Contabil
	    	   nTotvlrbsc +=aResumo[i,4] //Base de Calculo
	    	   If mv_par26 == 1
				  nTotimpdeb	+=aResumo[i,8]
				  nTotisenta	+=aResumo[i,7]
				  nTotoutras	+=aResumo[i,5]
				  If aResumo[i,19]>0
				      nTotoutras	+=aResumo[i,19]
				  EndIf
	    	   Endif
     		endif 

			If aResumo[i,6]>0 .and. (nColuna == 1 .Or. nColuna == 3)
				aDados[15]:=STR0038+Alltrim(Transform(aResumo[i,6],PESQPICT("SF3","F3_ICMSRET"))	) //"ICMS RETIDO...: "
			Endif
			FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			If aResumo[i,13]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS NORMAL
				aDados[15]:=STR0043+Alltrim(Transform(aResumo[i,13],PESQPICT("SF3","F3_OBSICM")))
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			Endif			
			If aResumo[i,14]>0 .and. (nColuna == 1 .Or. nColuna == 3)   //ICMS ST. INT.
				If lAntiICM
					aDados[15]:=STR0044+Alltrim(Transform(aResumo[i,14]-aResumo[i,17],PESQPICT("SF3","F3_OBSSOL")))
				Else
					aDados[15]:=STR0044+Alltrim(Transform(aResumo[i,14],PESQPICT("SF3","F3_OBSSOL")))
				Endif			
				FmtLin(@aDados,aL[19],cPictVl,,@nLin)
			EndIf
		Endif
	Endif
	//зддддддддддддддддддддддддддддддддд©
	//Ё Completa preenchimento da folha Ё
	//юддддддддддддддддддддддддддддддддды
	If i==Len(aResumo)

	   IF nTipoMov==1 .AND. MV_PAR25 == 1
          aDados[5]		:= STR0035
          aDados[8]		:= nTotvlrctb //TOTAL Valor Contabil
          aDados[12]	:= nTotvlrbsc //TOTAL Base de Calculo    
          If mv_par26 == 1
	   	     aDados[14]	:= nTotIcmCre
		     aDados[17]	:= nTotIPICre
		     aDados[16]	:= nTotBasIPI
		  Endif   

			FmtLin(@aDados,aL[17],cPictVl,,@nLin)
		ELSE
          IF  nTipoMov == 2  .AND. MV_PAR25 == 1
              aDados[03]	:=	STR0035
              aDados[06]	:=	nTotvlrctb //TOTAL Valor Contabil
              aDados[10]	:=	nTotvlrbsc //TOTAL Base de Calculo
              If mv_par26 == 1
		         aDados[12]	:=	nTotimpdeb
			     aDados[13]	:=	nTotisenta
			     aDados[14]	:=	nTotoutras
			  Endif   
              FmtLin(@aDados,aL[19],cPictVl,,@nLin)
          ENDIF
       ENDIF
	   
	   R931Filler()
	Endif
Next i
aResumo:={}
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931LoadObsЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Carrega observacao para ser impressa                       Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931LoadObs(nReserv)
                                  
Default nReserv := 0
// nPosOBS indica a linha da OBSERVACAO que sera impressa
if nReserv <> 0
	nPosObs:= nReserv
else
	nPosObs:=Ascan(aObs,{|x|x[2]})
endif

If nPosObs>0
	aDados[If(nTipoMov==1,18,15)]:=aObs[nPosObs,1]
	aObs[nPosObs,2]:=.F.
Endif

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931Totais ЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Aciona funcoes de totalizacao                              Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931Totais
Local nLinTrans := Len(LivrArrayObs(nLargObs,aTransp))+If(nTipoMov==1,2,4)+If(lImpZer,3,0)

If !lImpZer
	R931Transp()
Else
    //FaГo essa validaГЦo pois quando imprimimos linhas sem valor (ImpZer) conto de 3 em 3 linhas e nЦo de 1 em 1
    //Se o tamanho da pagina for menor que as 3 prСximas linhas + as linhas do valor a Transportar 
    //devo imprimir as linhas do valor a Transportar primeiro e depois continuo a imprimir as Notas.
    If nLimPag<=nLin+3+nLinTrans
		R931Transp(.T.)
	Endif
EndIf	

If lTotalDia
	R931TotDia()
	R931Transp()
Endif

lTotPerICM:=(nSvApurICM!=DefPeriodo(dDia,nApurICM)) .Or. IIf(nApurIcm==3,Month(dDia)!=Month(dDiaAnt),.F.)
lTotPerIPI:=(nSvApurIPI!=DefPeriodo(dDia,nApurIPI)) .Or. IIf(nApurIpi==3,Month(dDia)!=Month(dDiaAnt),.F.)
lTotMes:=(Month(dDiaAnt)!=Month(dDia))


R931TotPer()
R931TotMes()
//зддддддддддддддддддддд©
//Ё Termino do RelatorioЁ
//юддддддддддддддддддддды
If lTotMes
	//здддддддддддддддддддддддд©
	//Ё Imprime Resumo por CFO Ё
	//юдддддддддддддддддддддддды
	R931ResCfo()
	//зддддддддддддддддддддддддддд©
	//Ё Imprime Resumo por Estado Ё
	//юддддддддддддддддддддддддддды
    R931ResEst()
Endif
//здддддддддддддддддддддддддддддд©
//Ё Imprime Termo de EncerramentoЁ
//юдддддддддддддддддддддддддддддды
R931TermEnc()
If nLin<=nLimPag .And. (cArqTemp)->(EOF())
   R931Filler()
Endif   
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931TermIniЁAutor Ё Rodrigo de A. SartorioЁ Data Ё 25.03.98 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime termo de abertura no caso de so listar termos      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931TermIni()
Local cTermoSAb := GetMv("MV_LSAIAB")
Local cTermoEAb	:= GetMv("MV_LENTAB")
If MV_PAR41 == 1 .And. !Empty(SuperGetMv("MV_P2ABER",,"")) .And. !Empty(SuperGetMv("MV_P1ABER",,""))
	cTermoSAb := SuperGetMv("MV_P2ABER",,"")
	cTermoEAb := SuperGetMv("MV_P1ABER",,"")
EndIf

nPagina:=1
//здддддддддддддддддддддддддддддддддддддддд©
//Ё Imprime Termos de Abertura/EncerramentoЁ
//юдддддддддддддддддддддддддддддддддддддддды
aPagTerm:=CtrlPg(@nPagina,nQtFeixe,lReiniPg)
cPagina :=Transform(StrZero(nPagina,6),"@R 999.999")
If (nImpTerm == 2 .Or. nImpTerm == 3).and.aPagTerm[1]+aPagTerm[2]>0
	If nTipoMov==1
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,GetMv("MV_LENTEN"),nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoEAb,nLargMax,cPerg)
	Else
		ImprimeTermo(aPagTerm[1],nPagIni,nQtFeixe,GetMv("MV_LSAIEN"),nLargMax,cPerg)
		nPagIni:=ImprimeTermo(aPagTerm[2],nPagIni,nQtFeixe,cTermoSAb,nLargMax,cPerg)
	Endif
Endif
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931TermEncЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime termo de encerramento no fim do relatorio          Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931TermEnc()
If ((Eof().Or.!lHouveMov).and. nImpTerm == 3) .Or. (nImpTerm == 2)
	If nTipoMov==1
		ImprimeTermo(nPagina,nPagIni,nQtFeixe,GetMv("MV_LENTEN"),nLargMax,cPerg)
	Else
		ImprimeTermo(nPagina,nPagIni,nQtFeixe,GetMv("MV_LSAIEN"),nLargMax,cPerg)
	Endif
Endif
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбдддддддддддбддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931FillerЁAutor Ё Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддедддддддддддаддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Preenche folha com linha vazias                            Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931Filler

IF nLin < 67        

   While nLin<nLimPag
     	FmtLin(@aDados,If(nTipoMov==1,aL[17],aL[19]),,,@nLin) 
   End                       
   If nLin>=nLimPag
      FmtLin(@aDados,aL[1],,,@nLin)
   ENdif   

ENDIF
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931IniGradeЁAutorЁ Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Inicializa array aGrade do registro de entradas            Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931IniGrade
//зддддддддддддддддддддддддддддддддддддд©
//Ё Monta grade de impressao            Ё
//Ё [1]=Codigo de Operacao de ICMS      Ё
//Ё [2]=Base de ICMS / Isentas / Outras Ё
//Ё [3]=Valor do ICMS                   Ё
//Ё [4]=Codigo de Operacao de IPI       Ё
//Ё [5]=Base de IPI / Isentas / Outras  Ё
//Ё [6]=Valor do IPI                    Ё
//юддддддддддддддддддддддддддддддддддддды
If !lImpZer
	aGrade:={{"",0,0,"",0,0,0},{"",0,0,"",0,0,0},{"",0,0,"",0,0,0}}
Else
	aGrade:={{"1",0,0,"1",0,0,0},{"2",0,0,"2",0,0,0},{"3",0,0,"3",0,0,0}}
Endif
Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    ЁR931ImpGradeЁAutorЁ Juan Jose Pereira     Ё Data Ё 23.12.96 Ё╠╠
╠╠цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Imprime aGrade do registro de entradas                     Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
STATIC FUNCTION R931ImpGrade(lUnicaNf)

Local lImprimiu :=.F.
Local nX		:= 1
Local nY		:= 1
Local aQuebra	:= {}
Local nPosObsQ  := 0
Local cChave4   := ""

DEFAULT lUnicaNf := .F.

For nx:=1 to Len(aGrade)
	If !lImpZer.and.(aGrade[nx,2]+aGrade[nx,3]+aGrade[nx,5]+aGrade[nx,6]+aGrade[nx,7])==0
		Loop
	Endif
	lImprimiu:=.T.
	//зддддддддддддддддд©
	//Ё Colunas de ICMS Ё
	//юддддддддддддддддды
	aDados[11]:=aGrade[nx,1]
	aDados[12]:=aGrade[nx,2]
	aDados[14]:=aGrade[nx,3]  

	//зддддддддддддддддд©
	//Ё Colunas de IPI  Ё
	//юддддддддддддддддды
	If aGrade[nx,5]+aGrade[nx,6]>0
        nLinha :=6
		aDados[15]:=aGrade[nx,4]
		aDados[16]:=aGrade[nx,5]		  
		aDados[17]:=aGrade[nx,6]	
	Endif     	

	R931LoadObs(nPosObsQ) 

	If Len(aDados) > 0 .And. aDados[1] <> Nil   
		aQuebra := AClone(aDados)
	Endif
	FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)  
	//
	nPosObs:=Ascan(aObs,{|x|x[2]})
        
	While nPosObs>0         
 	    R931LoadObs(nPosObsQ)
		If nPosObs>0   
			
			//зддддддддддд©
			//Ё Cabecalho Ё
			//юддддддддддды
			If nLin>nLimPag  .And. !(cArqTemp)->SEMMOV
				// Guardo a proxima observacao para imprimir na primeira linha apos a quebra de pagina
			If Len(aDados) > 0
				aQuebra := AClone(aDados)
				endif
				R931Filler()
				R931Cabec()  			
				// Imprimo os dados na nota fiscal novamente pois mudou de pagina e ainda existe observacoes a 
				// serem impressas para esta nota fiscal
				FmtLin(@aQuebra,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)				
			Else
				FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
				nPosObsQ:=0
			Endif		
		Endif
	End
	nPosObsQ  := 0
Next nx

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Imprime itens com lancamento no livro fiscal zerado   Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If !lImprimiu .And. !Empty(aDados[1]) .And. F3_VALCONT>0
	cChave4 := F3_NFISCAL+F3_SERIE+F3_CLIEFOR+F3_LOJA 
	SD1->(dbSetOrder(1))
	SF4->(dbSetOrder(1))
	If SD1->(dbSeek(xFilial("SD1")+cChave4))								
		If SF4->(dbSeek(xFilial("SF4")+SD1->D1_TES))
			If SF4->F4_LFICM == "T"
				aDados[11]:="1"
			ElseIf SF4->F4_LFICM == "I"				
				aDados[11]:="2"
			ElseIf SF4->F4_LFICM == "O"				
				aDados[11]:="3"	
			Endif			
			If SF4->F4_LFIPI == "T"
				aDados[15]:="1"
			ElseIf SF4->F4_LFIPI == "I"				
				aDados[15]:="2"
			ElseIf SF4->F4_LFIPI == "O"				
				aDados[15]:="3"	
			Endif			
		Endif
	Endif	
	//зддддддддддддддддд©
	//Ё Colunas de ICMS Ё
	//юддддддддддддддддды

	aDados[12]:=0
	aDados[14]:=0
	//зддддддддддддддддд©
	//Ё Colunas de IPI  Ё
	//юддддддддддддддддды
   
	aDados[16]:=0
	aDados[17]:=0
	//зддддддддддддддддддддддд©
	//Ё Coluna de Observacoes Ё
	//юддддддддддддддддддддддды
	R931LoadObs()
	If lIcmIpZer
		FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
	Else
		aDados[11]:= NIL
		aDados[15]:= NIL
		aDados[12]:= NIL
		aDados[14]:= NIL
		aDados[16]:= NIL
		aDados[17]:= NIL
		FmtLin(@aDados,If(!lTotGrade,aL[17],aL[18]),cPictVl,,@nLin)
	EndIf
Endif

Return
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддддбдддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤┘o    Ё R931GetEcf ЁAutorЁ Vendas e CRM          Ё Data Ё 18.05.09 Ё╠╠
╠╠цддддддддддеддддддддддддадддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o Ё Retorna alguns dados para o preenchimento das Colunas      Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠ЁParametrosЁ cAliasECF - Alias temporario    							  Ё╠╠
╠╠Ё			 Ё nOpcField - Define campo de retorno 1-Especie 2-Serie   	  Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Function R931GetEcf(cAliasECF,nOpcField)

Local cRet	 := ""			// Sempre retorna caracter
Local lMod55 := GetNewPar("MV_SPED55",.F.)
Local lEspCup:= Alltrim((cAliasECF)->(F3_ESPECIE))== "CF" .OR. (LjAnalisaLeg(18)[1] .AND. "ECF" $ (cAliasECF)->(F3_ESPECIE))
Local cNFiscal 	:= "" 			// Numero do comprovante fiscal

DbSelectArea(cAliasECF)		// Arquivo temporario
//здддддддддддддддддддддддддддддддддддддд©
//ЁCaso 1 - retorna a especie  2- a serieЁ
//юдддддддддддддддддддддддддддддддддддддды
If nOpcField == 1 
	If(Empty( (cAliasECF)->(F3_ESPECIE) ) )
		cRet	:= R930CFOTra((cAliasECF)->(F3_CFO),(cAliasECF)->(F3_SERIE))
	Else
		If lLeiECF .AND. lEspCup 		// Apenas especie cupom
			Do case
				Case(nLegisArt == 3)  	// Artigo 80
					cRet	:= "CMR"
				Case(nLegisArt == 4)  	// Artigo 81
					cRet	:= "MRC"
				OtherWise
					cRet	:= "CF"   	// Para os Artigos 25 e 26 sempre fica "CF"                                 		
			EndCase	
		ElseIf lMod55 .And. Alltrim((cAliasECF)->(F3_ESPECIE)) == "SPED"  // Para modelo Sped codigo 55.
			cRet	:= "55"	
		Else	
			cRet	:= (cAliasECF)->(F3_ESPECIE)
		EndIf	
	EndIf	
ElseIf nOpcField == 2 
	If (!lLeiECF .OR. (Empty((cAliasECF)->(F3_PDV)) .OR. !lEspCup )) .AND. (cAliasECF)->(F3_SERIE) <> "ECF"
		cRet := (cAliasECF)->(F3_SERIE)
	Else
		Do Case
			Case(nLegisArt == 1)  		// Artigo 25
				cRet	:= "ECF"
			Case(nLegisArt == 4)  		// Artigo 81
				cRet	:= "CMR"
			OtherWise
				cRet := Alltrim((cAliasECF)->(F3_PDV))	// Para os Artigos 26 e 80 grava o n do PDV
		EndCase	
	EndIf 
Else	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁLista o intervalo de cupons fiscais , exceto para os artigos 25 e 80 que utilizam o numero do MapaЁ
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	DbSelectArea("SFI")
	DbSetOrder(1)		//FILIAL + DTMOVTO + PDV
	If DbSeek(xFilial("SFI") + DTOS((cAliasECF)->(F3_EMISSAO)) + (cAliasECF)->(F3_PDV))
		If (nLegisArt == 1 .OR. nLegisArt == 4)  	// Artigo 25 e Artigo 81
			cRet := SFI->FI_NUMERO + " A " + SFI->FI_NUMERO		
		Else
			//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
			//ЁVerifica nЗmero, rotina antiga(Loja300) armazenava no campo F3_NUMINI Ё
			//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
			cNFiscal	:= IIF(Empty( (cAliasECF)->(F3_NUMINI) ),(cAliasECF)->(F3_NFISCAL),(cAliasECF)->(F3_NUMINI))
			cRet 		:= cNFiscal + " A " + SFI->FI_COO
		EndIf	
	EndIf
EndIf	

Return(cRet)
   
