#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\MATR265.CH"
#line 2 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr265.prx"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Dialog.ch"
#line 28 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Font.ch"
#line 29 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PTMenu.ch"
#line 31 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Print.ch"
#line 33 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Colors.ch"
#line 35 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Folder.ch"
#line 37 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\msobject.ch"
#line 38 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\VKey.ch"
#line 42 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\WinApi.ch"
#line 44 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCommand.ch"
#line 47 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCSS.CH"
#line 50 "PROTHEUS.CH"
#line 16 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr265.prx"
Function MATR265()
Local oReport

If FindFunction("TRepInUse") .And.  TRepInUse()



	oReport:= ReportDef()
	oReport:PrintDialog()
Else
	MATR265R3()
EndIf

Return NIL

















Static Function ReportDef()
Local oReport
Local oSection1, oSection2, oSection3, oSection4, oSection5, oSection6
Local cTitle    := OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Pick-list Endereçamento", "Pick-List Enderecamento" ))
Local cQryRel   := ""
Private cPerg   :="MTR265"

	cQryRel := GetNextAlias()













oReport:= TReport():New("MATR265",cTitle,cPerg, {|oReport| ReportPrint(oReport,cQryRel)},OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Este relatório tem o objectivo de facilitar a retirada de materiais", "Este relatorio tem o objetivo de facilitar a retirada de materiais" ))+" "+OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Após a facturação de uma factura ou a criação de uma op caso consumam", "apos o Faturamento de uma NF ou a Criacao de uma OP caso consumam" ))+" "+OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Materiais Que Utilizem O Controle De Endereçamento", "materiais que utilizam o controle de Enderecamento" )))
oReport:SetLandscape()




AjustaSX1()




















Pergunte(oReport:GetParam(), .F. )



















oSection1 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Cabeçalhos de Facturas de saída", "Cabecalhos de documentos de saida" ),{"SD2","SF2","SA4"},)
oSection1:SetLineStyle()

TRCell():New(oSection1,"A2_COD"    ,"SA2",,,,,)
TRCell():New(oSection1,"A2_LOJA"   ,"SA2",,,,,)
TRCell():New(oSection1,"A2_NOME"   ,"SA2",,,,,)
TRCell():New(oSection1,"A2_MUN"    ,"SA2",,,,,)
TRCell():New(oSection1,"A2_EST"    ,"SA2",,,,,)
TRCell():New(oSection1,"D2_DOC"    ,"SD2",,,,,)
TRCell():New(oSection1,"D2_SERIE"  ,"SD2",,,,,)
TRCell():New(oSection1,"D2_PEDIDO" ,"SD2",,,,,)
TRCell():New(oSection1,"A4_NOME"   ,"SA4",,,,,)
TRCell():New(oSection1,"F2_VOLUME1","SF2",,,,,)
TRCell():New(oSection1,"F2_ESPECI1","SF2",,,,,)
TRCell():New(oSection1,"F2_PLIQUI" ,"SF2",,,,,)
TRCell():New(oSection1,"F2_PBRUTO" ,"SF2",,,,,)

oSection1:Cell("A2_COD"    ):SetCellBreak()
oSection1:Cell("A2_LOJA"   ):SetCellBreak()
oSection1:Cell("A2_NOME"   ):SetCellBreak()
oSection1:Cell("A2_MUN"    ):SetCellBreak()
oSection1:Cell("A2_EST"    ):SetCellBreak()
oSection1:Cell("D2_DOC"    ):SetCellBreak()
oSection1:Cell("D2_SERIE"  ):SetCellBreak()
oSection1:Cell("D2_PEDIDO" ):SetCellBreak()
oSection1:Cell("A4_NOME"   ):SetCellBreak()
oSection1:Cell("F2_VOLUME1"):SetCellBreak()
oSection1:Cell("F2_ESPECI1"):SetCellBreak()
oSection1:Cell("F2_PLIQUI" ):SetCellBreak()
oSection1:Cell("F2_PBRUTO" ):SetCellBreak()




oSection2 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Ordens de produção", "Ordens de Produção" ),{"SD4","SC2"},)
oSection2:SetLineStyle()

TRCell():New(oSection2,"D4_OP"     ,"SD4",,,,,)
TRCell():New(oSection2,"C2_PRODUTO","SC2",,,,,)
TRCell():New(oSection2,"B1_DESC"   ,"SB1",,,,,)
TRCell():New(oSection2,"C2_DATPRI" ,"SC2",,,,,)
TRCell():New(oSection2,"C2_DATPRF" ,"SC2",,,,,)
TRCell():New(oSection2,"C2_QUANT"  ,"SC2",,,,,)
TRCell():New(oSection2,"C2_OBS"    ,"SC2",,,,,)

oSection2:Cell("D4_OP"     ):SetCellBreak()
oSection2:Cell("C2_PRODUTO"):SetCellBreak()
oSection2:Cell("B1_DESC"   ):SetCellBreak()
oSection2:Cell("C2_DATPRI" ):SetCellBreak()
oSection2:Cell("C2_DATPRF" ):SetCellBreak()
oSection2:Cell("C2_QUANT"  ):SetCellBreak()
oSection2:Cell("C2_OBS"    ):SetCellBreak()




oSection3 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", " Itens de documentos de saída", " Itens de documentos de saida" ),{"SD2"},)
oSection3:SetLineStyle()

TRCell():New(oSection3,"A2_COD"   ,"SA2",,,,,)
TRCell():New(oSection3,"A2_LOJA"  ,"SA2",,,,,)
TRCell():New(oSection3,"A2_NOME"  ,"SA2",,,,,)
TRCell():New(oSection3,"A2_MUN"   ,"SA2",,,,,)
TRCell():New(oSection3,"A2_EST"   ,"SA2",,,,,)
TRCell():New(oSection3,"D2_DOC"   ,"SD2",,,,,)
TRCell():New(oSection3,"D2_SERIE" ,"SD2",,,,,)
TRCell():New(oSection3,"D2_PEDIDO","SD2",,,,,)

oSection3:Cell("A2_COD"   ):SetCellBreak()
oSection3:Cell("A2_LOJA"  ):SetCellBreak()
oSection3:Cell("A2_NOME"  ):SetCellBreak()
oSection3:Cell("A2_MUN"   ):SetCellBreak()
oSection3:Cell("A2_EST"   ):SetCellBreak()
oSection3:Cell("D2_DOC"   ):SetCellBreak()
oSection3:Cell("D2_SERIE" ):SetCellBreak()
oSection3:Cell("D2_PEDIDO"):SetCellBreak()




oSection4 := TRSection():New(oSection1,If( cPaisLoc $ "ANG|PTG", " Itens de documentos de saída", " Itens de documentos de saida" ),{"SD2","SB1","SDB"},)
oSection4:SetHeaderPage()

TRCell():New(oSection4,"D2_COD"    ,"SD2",,,,,)
TRCell():New(oSection4,"B1_DESC"   ,"SB1",,,,,)
TRCell():New(oSection4,"B1_UM"     ,"SB1",,,,,)
TRCell():New(oSection4,"D2_LOTECTL","SD2",,,,,)
TRCell():New(oSection4,"D2_NUMLOTE","SD2",,,,,)
TRCell():New(oSection4,"DB_LOCALIZ","SDB",,,,,)
TRCell():New(oSection4,"DB_NUMSERI","SDB",,,,,)
TRCell():New(oSection4,"DB_QUANT"  ,"SDB",,,,,)
TRCell():New(oSection4,"D2_DTVALID","SD2",,,,,)
TRCell():New(oSection4,"D2_POTENCI","SD2",,,,,)




oSection5 := TRSection():New(oSection2,If( cPaisLoc $ "ANG|PTG", "Alocações", "Empenhos" ),{"SD4","SB1","SDC"},)
oSection5:SetHeaderPage()

TRCell():New(oSection5,"D4_COD"    ,"SD4",,,,,)
TRCell():New(oSection5,"B1_DESC"   ,"SB1",,,,,)
TRCell():New(oSection5,"B1_UM"     ,"SB1",,,,,)
TRCell():New(oSection5,"D4_LOTECTL","SD4",,,,,)
TRCell():New(oSection5,"D4_NUMLOTE","SD4",,,,,)
TRCell():New(oSection5,"DC_LOCALIZ","SDC",,,,,)
TRCell():New(oSection5,"DC_NUMSERI","SDC",,,,,)
TRCell():New(oSection5,"D4_QUANT"  ,"SD4",,,,,)
TRCell():New(oSection5,"D4_DTVALID","SD4",,,,,)
TRCell():New(oSection5,"D4_POTENCI","SD4",,,,,)




oSection6 := TRSection():New(oSection3,"Movimentos por Endereço",{"SD2","SB1","SDB"},)
oSection6:SetHeaderPage()

TRCell():New(oSection6,"D2_COD"    ,"SD2",,,,,)
TRCell():New(oSection6,"B1_DESC"   ,"SB1",,,,,)
TRCell():New(oSection6,"B1_UM"     ,"SB1",,,,,)
TRCell():New(oSection6,"D2_LOTECTL","SD2",,,,,)
TRCell():New(oSection6,"D2_NUMLOTE","SD2",,,,,)
TRCell():New(oSection6,"DB_LOCALIZ","SDB",,,,,)
TRCell():New(oSection6,"DB_NUMSERI","SDB",,,,,)
TRCell():New(oSection6,"DB_QUANT"  ,"SDB",,,,,)

Return(oReport)



















Static Function ReportPrint(oReport, cQryRel)
Local oSection1   := oReport:Section(1)
Local oSection2   := oReport:Section(2)
Local oSection3   := oReport:Section(3)
Local oSection4   := oReport:Section(1):Section(1)
Local oSection5   := oReport:Section(2):Section(1)
Local oSection6   := oReport:Section(3):Section(1)
Local cSerIni     := If(cPaisLoc=="BRA",MV_PAR14,MV_PAR16)
Local cSerFin     := If(cPaisLoc=="BRA",MV_PAR15,MV_PAR17)
Local lExistBlock := ExistBlock("MR265MAIL")
Local lQuery      := .F. 
Local cIndex, cFilter
Local cChaveDB    := cChaveC9 := cChave := cChave2 := cDocAnt := cCompara := cTitulo:= ""
Local nValorNf    := 0
Local aTam        := TamSX3("D2_TOTAL")
Local bBlock
Local cWhere01
Local nSldSD4	  := 0






	lQuery := .T. 



	MakeSqlExpr(oReport:GetParam())





	cWhere01 := "%"
	If	Upper(TcGetDb()) $ "ORACLE,DB2,POSTGRES,INFORMIX"
		cWhere01  += "SC2.C2_NUM = SUBSTR(SD4.D4_OP,1,6) AND "
		cWhere01  += "SC2.C2_ITEM = SUBSTR(SD4.D4_OP,7,2) AND "
		cWhere01  += "SC2.C2_SEQUEN = SUBSTR(SD4.D4_OP,9,3) AND "
		cWhere01  += "SC2.C2_ITEMGRD = SUBSTR(SD4.D4_OP,12,2)"
	Else
		cWhere01  += "SC2.C2_NUM = SUBSTRING(SD4.D4_OP,1,6) AND "
		cWhere01  += "SC2.C2_ITEM = SUBSTRING(SD4.D4_OP,7,2) AND "
		cWhere01  += "SC2.C2_SEQUEN = SUBSTRING(SD4.D4_OP,9,3) AND "
		cWhere01  += "SC2.C2_ITEMGRD = SUBSTRING(SD4.D4_OP,12,2)"
	EndIf
	cWhere01 += "%"





	If MV_PAR01 == 1

		oSection1:BeginQuery()












































__execSql(cQryRel," SELECT D2_FILIAL, D2_DOC, D2_SERIE, D2_ITEM, D2_COD, D2_ITEMPV, D2_LOTECTL, D2_NUMLOTE, D2_PEDIDO, D2_TIPO, D2_DTVALID, D2_POTENCI, D2_TIPODOC, D2_CLIENTE, D2_LOJA, D2_TOTAL, D2_NUMSEQ, D2_LOCAL, D2_QUANT, D2_REMITO, C6_FILIAL, C6_NUM, C6_ITEM, C6_PRODUTO, C6_ENTREG, F2_FILIAL,F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA, F2_TIPO, F2_MOEDA, F2_VOLUME1, F2_ESPECI1, F2_PLIQUI, F2_PBRUTO, F2_TRANSP, F2_EMISSAO, F2_TXMOEDA, B1_FILIAL, B1_COD, B1_DESC, B1_UM, A4_FILIAL, A4_COD, A4_NOME FROM  "+RetSqlName('SD2')+" SD2 JOIN  "+RetSqlName('SC6')+" SC6 ON SC6.C6_FILIAL =  '" +xFilial('SC6')+"'  AND SC6.C6_NUM = D2_PEDIDO AND SC6.C6_ITEM = D2_ITEMPV AND SC6.C6_ENTREG BETWEEN  "+___SQLGetValue(MV_PAR04)+" AND  "+___SQLGetValue(MV_PAR05)+" AND SC6.D_E_L_E_T_= ' ' LEFT JOIN  "+RetSqlName('SF2')+" SF2 ON SF2.F2_FILIAL =  '" +xFilial('SF2')+"'  AND SF2.F2_CLIENTE = D2_CLIENTE AND SF2.F2_LOJA = D2_LOJA AND SF2.F2_DOC = D2_DOC AND SF2.F2_SERIE = D2_SERIE AND SF2.D_E_L_E_T_= ' ' LEFT JOIN  "+RetSqlName('SB1')+" SB1 ON SB1.B1_FILIAL =  '" +xFilial('SB1')+"'  AND SB1.B1_COD = D2_COD AND SB1.D_E_L_E_T_= ' ' LEFT JOIN  "+RetSqlName('SA4')+" SA4 ON SA4.A4_FILIAL =  '" +xFilial('SA4')+"'  AND SA4.A4_COD = F2_TRANSP AND SA4.D_E_L_E_T_= ' ' WHERE D2_FILIAL =  '" +xFilial('SD2')+"'  AND D2_DOC BETWEEN  "+___SQLGetValue(MV_PAR02)+" AND  "+___SQLGetValue(MV_PAR03)+" AND D2_CLIENTE BETWEEN  "+___SQLGetValue(MV_PAR06)+" AND  "+___SQLGetValue(MV_PAR07)+" AND D2_SERIE BETWEEN  "+___SQLGetValue(MV_PAR14)+" AND  "+___SQLGetValue(MV_PAR15)+" AND SD2.D_E_L_E_T_= ' ' ORDER BY D2_FILIAL, D2_DOC, D2_SERIE, D2_ITEM, D2_COD, D2_ITEMPV, D2_LOTECTL, D2_NUMLOTE",{},.F.)
		oSection1:EndQuery(); If oSection1:bCompQuery <> NIL; oSection1:bRealQuery := {|__section| __runcb(__section:bCompQuery, .T. )}; EndIf

		oSection4:SetParentQuery()

	ElseIf MV_PAR01 == 2

		oSection2:BeginQuery()
























__execSql(cQryRel," SELECT SD4.D4_FILIAL, SD4.D4_COD, SD4.D4_OP, SD4.D4_LOTECTL, SD4.D4_NUMLOTE, SD4.D4_DTVALID, SD4.D4_POTENCI, SD4.D4_LOCAL, SD4.D4_TRT, SD4.D4_QUANT, SD4.D4_QTDEORI, SC2.C2_FILIAL, SC2.C2_NUM, SC2.C2_ITEM, SC2.C2_SEQUEN, SC2.C2_ITEMGRD, SC2.C2_DATPRI, SC2.C2_DATPRF, SC2.C2_PRODUTO, SC2.C2_QUANT, SC2.C2_OBS, SC2.C2_TPOP, SB1.B1_FILIAL, SB1.B1_COD, SB1.B1_DESC, SB1.B1_UM FROM  "+RetSqlName('SD4')+" SD4 JOIN  "+RetSqlName('SC2')+" SC2 ON SC2.C2_FILIAL =  '" +xFilial('SC2')+"'  AND SC2.C2_DATPRF BETWEEN  "+___SQLGetValue(MV_PAR04)+" AND  "+___SQLGetValue(MV_PAR05)+" AND SC2.D_E_L_E_T_= ' ' LEFT JOIN  "+RetSqlName('SB1')+" SB1 ON SB1.B1_FILIAL =  '" +xFilial('SB1')+"'  AND SB1.B1_COD = SD4.D4_COD AND SB1.D_E_L_E_T_= ' ' WHERE SD4.D4_FILIAL =  '" +xFilial('SD4')+"'  AND SD4.D4_OP BETWEEN  "+___SQLGetValue(MV_PAR08)+" AND  "+___SQLGetValue(MV_PAR09)+" AND  "+___SQLGetValue(CWHERE01)+" AND SD4.D_E_L_E_T_= ' ' ORDER BY SC2.C2_FILIAL, SC2.C2_NUM, SC2.C2_ITEM, SC2.C2_SEQUEN, SC2.C2_ITEMGRD",{},.F.)
		oSection2:EndQuery(); If oSection2:bCompQuery <> NIL; oSection2:bRealQuery := {|__section| __runcb(__section:bCompQuery, .T. )}; EndIf

		oSection5:SetParentQuery()

	ElseIf MV_PAR01 == 3

		oSection3:BeginQuery()




















__execSql(cQryRel," SELECT D2_FILIAL, D2_DOC, D2_SERIE, D2_ITEM, D2_COD, D2_ITEMPV, D2_LOTECTL, D2_NUMLOTE, D2_PEDIDO, D2_TIPO, D2_DTVALID, D2_POTENCI, D2_TIPODOC, D2_CLIENTE, D2_LOJA, D2_TOTAL, D2_NUMSEQ, D2_LOCAL, D2_QUANT, D2_REMITO, B1_FILIAL, B1_COD, B1_DESC, B1_UM FROM  "+RetSqlName('SD2')+" SD2 LEFT JOIN  "+RetSqlName('SB1')+" SB1 ON SB1.B1_FILIAL =  '" +xFilial('SB1')+"'  AND SB1.B1_COD = D2_COD AND SB1.D_E_L_E_T_= ' ' WHERE D2_FILIAL =  '" +xFilial('SD2')+"'  AND D2_TIPODOC >= '50' AND D2_DOC BETWEEN  "+___SQLGetValue(MV_PAR02)+" AND  "+___SQLGetValue(MV_PAR03)+" AND D2_CLIENTE BETWEEN  "+___SQLGetValue(MV_PAR06)+" AND  "+___SQLGetValue(MV_PAR07)+" AND SD2.D_E_L_E_T_= ' ' ORDER BY D2_FILIAL, D2_DOC, D2_SERIE, D2_ITEM, D2_COD, D2_ITEMPV, D2_LOTECTL, D2_NUMLOTE",{},.F.)
		oSection3:EndQuery(); If oSection3:bCompQuery <> NIL; oSection3:bRealQuery := {|__section| __runcb(__section:bCompQuery, .T. )}; EndIf

		oSection6:SetParentQuery()

	EndIf
































































































dbSelectArea(cQryRel)
If MV_PAR01 == 1




	oReport:SetTitle(oReport:Title()+"    "+If( cPaisLoc $ "ANG|PTG", " (factura De Venda)", " (Nota Fiscal de Venda)" ))




	oSection2:Disable()
	oSection3:Disable()
	oSection5:Disable()
	oSection6:Disable()

	oReport:SetMeter( SD2->(LastRec()) )
	oSection1:Init()
	oSection4:Init()
	While !oReport:Cancel() .And.  !(cQryRel)->(Eof())
		If !lQuery



			dbSelectArea("SC6")
			dbSetOrder( 1 )

			If !dbSeek( xFilial( "SC6" ) + (cQryRel)->(D2_PEDIDO+D2_ITEMPV+D2_COD) ) .Or.  ( C6_ENTREG < mv_par04 .Or.  C6_ENTREG > mv_par05 )
				dbSelectArea(cQryRel)
				oReport:IncMeter()
				dbSkip()
				Loop
			EndIf
			SF2->(dbSeek(xFilial("SF2")+(cQryRel)->D2_DOC+(cQryRel)->D2_SERIE))
			cQrySF2 := "SF2"



			If mv_par13==2
				If If(SF2->F2_MOEDA==0,1,SF2->F2_MOEDA)<>mv_par12
					dbselectarea(cQryRel)
					oReport:IncMeter()
					dbskip()
					loop
				Endif
			Endif
		Else
			cQrySF2 := cQryRel



			If mv_par13==2
			   If If((cQryRel)->F2_MOEDA==0,1,(cQryRel)->F2_MOEDA)<>mv_par12
					dbselectarea(cQryRel)
					oReport:IncMeter()
					dbskip()
					loop
			   endif
			endif
		EndIf
		If (cQrySF2)->F2_TIPO $ "DºB"
			dbSelectArea( "SA2" )
			dbSetOrder( 1 )
			dbSeek( xFilial("SA2") + (cQryRel)->D2_CLIENTE + (cQryRel)->D2_LOJA )
			oSection1:Cell("A2_COD" ):SetValue( SA2->A2_COD  )
			oSection1:Cell("A2_LOJA"):SetValue( SA2->A2_LOJA )
			oSection1:Cell("A2_NOME"):SetValue( SA2->A2_NOME )
			oSection1:Cell("A2_MUN" ):SetValue( SA2->A2_MUN  )
			oSection1:Cell("A2_EST" ):SetValue( SA2->A2_EST  )
		Else
			dbSelectArea( "SA1" )
			dbSetOrder( 1 )
			dbSeek( xFilial("SA1") + (cQryRel)->D2_CLIENTE + (cQryRel)->D2_LOJA)
			oSection1:Cell("A2_COD" ):SetValue( SA1->A1_COD  )
			oSection1:Cell("A2_LOJA"):SetValue( SA1->A1_LOJA )
			oSection1:Cell("A2_NOME"):SetValue( SA1->A1_NOME )
			oSection1:Cell("A2_MUN" ):SetValue( SA1->A1_MUN  )
			oSection1:Cell("A2_EST" ):SetValue( SA1->A1_EST  )
		EndIf
		oSection1:PrintLine()
		oReport:ThinLine()

		nValorNf := 0
		cDocAnt  := xFilial("SD2")+(cQryRel)->(D2_DOC+D2_SERIE)
		While !(cQryRel)->(Eof()) .And.  (cQryRel)->(D2_FILIAL+D2_DOC+D2_SERIE) == cDocAnt
			If Localiza( (cQryRel)->D2_COD )
				dbSelectArea( "SDB" )
				dbSetOrder( 1 )
				cChaveDB :=xFilial("SDB")+(cQryRel)->D2_COD+(cQryRel)->D2_LOCAL+(cQryRel)->D2_NUMSEQ+(cQryRel)->D2_DOC+(cQryRel)->D2_SERIE+(cQryRel)->D2_CLIENTE+(cQryRel)->D2_LOJA
				If dbSeek( cChaveDB )
					While !Eof() .And.  cChaveDB == DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA
						If DB_ESTORNO == "S"
							dbSkip()
							Loop
						EndIf
						oSection4:Cell("DB_LOCALIZ"):SetValue( SDB->DB_LOCALIZ )
						oSection4:Cell("DB_NUMSERI"):SetValue( SDB->DB_NUMSERI )
						oSection4:Cell("DB_QUANT"  ):SetValue( SDB->DB_QUANT   )
						If !lQuery
							SB1->(dbSeek(xFilial("SB1")+(cQryRel)->D2_COD))
						EndIf
						oReport:IncMeter()
						oSection4:PrintLine()
						dbSkip()
					EndDo
				Else
					dbSelectArea( "SC9" )
					dbSetOrder( 2 )

					cChaveC9 := xFilial( "SC9" ) + (cQryRel)->D2_CLIENTE + (cQryRel)->D2_LOJA + (cQryRel)->D2_PEDIDO + (cQryRel)->D2_ITEMPV
					dbSeek( cChaveC9 )
					While !Eof() .And.  cChaveC9 == C9_FILIAL + C9_CLIENTE + C9_LOJA + C9_PEDIDO + C9_ITEM



						If Rastro( (cQryRel)->D2_COD, "S" )


							bBlock  := { || C9_PRODUTO + C9_NUMLOTE + C9_NFISCAL + C9_SERIENF <> (cQryRel)->D2_COD + (cQryRel)->D2_NUMLOTE + (cQryRel)->D2_DOC + (cQryRel)->D2_SERIE }
						ElseIf Rastro( SC9->C9_PRODUTO, "L" )

							bBlock  := { || C9_PRODUTO + C9_LOTECTL + C9_NFISCAL + C9_SERIENF <> (cQryRel)->D2_COD + (cQryRel)->D2_LOTECTL + (cQryRel)->D2_DOC + (cQryRel)->D2_SERIE  }
						Else

							bBlock  := { || C9_PRODUTO + C9_NFISCAL + C9_SERIENF <> (cQryRel)->D2_COD + (cQryRel)->D2_DOC + (cQryRel)->D2_SERIE }
						EndIf

						If C9_BLEST <> "10" .Or.  C9_BLCRED <> "10" .Or.  Eval( bBlock )
							dbSkip()
							Loop
						EndIf
						dbSelectArea("SDC")
						dbSetOrder(1)
						If Rastro((cQryRel)->D2_COD, "S")
							bBlock  := {|| SC9->C9_LOTECTL+SC9->C9_NUMLOTE == DC_LOTECTL+DC_NUMLOTE}
							cChave  := xFilial()+SC9->C9_PRODUTO+(cQryRel)->D2_LOCAL+"SC6"+SC9->C9_PEDIDO+SC9->C9_ITEM+SC9->C9_SEQUEN
							cChave2 := SC9->C9_LOTECTL+SC9->C9_NUMLOTE
						ElseIf Rastro(SC9->C9_PRODUTO, "L")
							bBlock  := {|| SC9->C9_LOTECTL == DC_LOTECTL}
							cChave  := xFilial()+SC9->C9_PRODUTO+(cQryRel)->D2_LOCAL+"SC6"+SC9->C9_PEDIDO+SC9->C9_ITEM+SC9->C9_SEQUEN
							cChave2 := SC9->C9_LOTECTL
						Else
							bBlock  := {|| .T. }
							cChave  := xFilial()+SC9->C9_PRODUTO+(cQryRel)->D2_LOCAL+"SC6"+SC9->C9_PEDIDO+SC9->C9_ITEM+SC9->C9_SEQUEN
							cChave2 := ""
						EndIf



						If dbSeek(cChave+cChave2, .F. )
							while !Eof() .And. cChave==DC_FILIAL+DC_PRODUTO+DC_LOCAL+DC_ORIGEM+DC_PEDIDO+DC_ITEM+DC_SEQ .And. Eval(bBlock)
								oSection4:Cell("DB_LOCALIZ"):SetValue( SDC->DC_LOCALIZ )
								oSection4:Cell("DB_NUMSERI"):SetValue( SDC->DC_NUMSERI )



								SB8->(dbSeek(xFilial("SB8") + SDC->(DC_PRODUTO+DC_LOCAL+DTOS(SC9->C9_DTVALID)+DC_LOTECTL+DC_NUMLOTE)))
								If mv_par10 == 1
									oSection4:Cell("DB_QUANT"  ):SetValue( SDC->DC_QTDORIG )
								Else
									oSection4:Cell("DB_QUANT"  ):SetValue( SDC->DC_QUANT )
								EndIf
								oSection4:Cell("D2_DTVALID"):SetValue( SC9->C9_DTVALID )
								oSection4:Cell("D2_POTENCI"):SetValue( SB8->B8_POTENCI )
								dbSelectArea("SDC")
								dbSkip()
								If !lQuery
									SB1->(dbSeek(xFilial("SB1")+(cQryRel)->D2_COD))
								EndIf
								oReport:IncMeter()
								oSection4:PrintLine()
							EndDo
						EndIf
						dbSelectArea("SC9")
						dbSkip()
					EndDo
				EndIf
			Else
				oSection4:Cell("DB_LOCALIZ"):SetValue( "" )
				oSection4:Cell("DB_NUMSERI"):SetValue( "" )
				oSection4:Cell("DB_QUANT"  ):SetValue( (cQryRel)->D2_QUANT )
				If !lQuery
					SB1->(dbSeek(xFilial("SB1")+(cQryRel)->D2_COD))
				EndIf
				oReport:IncMeter()
				oSection4:PrintLine()
			EndIf



			If lExistBlock
				ExecBlock("MR265MAIL", .F. , .F. )
			EndIf
			nValorNf += xmoeda((cQryRel)->D2_TOTAL,(cQrySF2)->F2_MOEDA,mv_par12,(cQrySF2)->F2_EMISSAO,msdecimais(mv_par12)+1,(cQrySF2)->F2_TXMOEDA)

			(cQryRel)->(dbSkip())
		EndDo
		oReport:SkipLine()
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Valor da factura: ", "VALOR DA NOTA FISCAL: " )+"  "+Str(nValorNf,aTam[1],aTam[2]))
		oReport:SkipLine()
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Observação: ", "OBSERVACAO: " ))
		oReport:EndPage()
	EndDo

	oSection1:Finish()
	oSection4:Finish()
	(cQryRel)->(DbCloseArea())

ElseIf MV_PAR01 == 2




	oReport:SetTitle(oReport:Title()+"    "+If( cPaisLoc $ "ANG|PTG", " (ordem De Produção)", " (Ordem de Producao)" ))




	oSection1:Disable()
	oSection3:Disable()
	oSection4:Disable()
	oSection6:Disable()

	oReport:SetMeter( SD4->(LastRec()) )
	oSection2:Init()
	oSection5:Init()
	While !oReport:Cancel() .And.  !(cQryRel)->(Eof())
		If !lQuery
			SC2->( dbSeek(xFilial("SC2")+(cQryRel)->D4_OP ))
			If !MtrAvalOp(mv_par11)
				oReport:IncMeter()
				(cQryRel)->(dbSkip())
				Loop
			EndIf
			If DTOS(SC2->C2_DATPRF) < DTOS(mv_par04) .Or.  DTOS(SC2->C2_DATPRF) > DTOS(mv_par05)
	  			(cQryRel)->(dbSkip())
				Loop
            EndIf
			SB1->( dbSeek(xFilial("SB1")+SC2->C2_PRODUTO ))
		Else
			If !MtrAvalOp(mv_par11,"SC2",cQryRel)
				oReport:IncMeter()
				(cQryRel)->(dbSkip())
				Loop
			EndIf
			SB1->( dbSeek(xFilial("SB1")+(cQryRel)->C2_PRODUTO ))
		EndIf
		oSection2:Cell("B1_DESC"):SetValue( SB1->B1_DESC )
		oSection2:PrintLine()
		oReport:ThinLine()
		cOpAnt := (cQryRel)->D4_OP
		While !(cQryRel)->(Eof()) .And.  (cQryRel)->(D4_FILIAL+D4_OP) == xFilial("SD4")+cOpAnt
			If Localiza((cQryRel)->D4_COD)
				dbSelectArea("SDC")
				dbSetOrder(2)
				cChave := ""
				If Rastro((cQryRel)->D4_COD)
					cChave:=xFilial("SDC")+(cQryRel)->(D4_COD+D4_LOCAL+D4_OP+D4_TRT+D4_LOTECTL+D4_NUMLOTE)
					cCompara:="DC_FILIAL+DC_PRODUTO+DC_LOCAL+DC_OP+DC_TRT+DC_LOTECTL+DC_NUMLOTE"
				Else
					cChave:=xFilial("SDC")+(cQryRel)->(D4_COD+D4_LOCAL+D4_OP+D4_TRT)
					cCompara:="DC_FILIAL+DC_PRODUTO+DC_LOCAL+DC_OP+DC_TRT"
				EndIf



				If !Empty(cChave) .AND.  dbSeek(cChave)
					nSldSD4 := If(mv_par10==1,(cQryRel)->D4_QTDEORI,(cQryRel)->D4_QUANT)
					while SDC->(!Eof()) .And. cChave==&(cCompara)

						oSection5:Cell("DC_LOCALIZ"):Setvalue( SDC->DC_LOCALIZ )
						oSection5:Cell("DC_NUMSERI"):Setvalue( SDC->DC_NUMSERI )




						If mv_par10 == 1
							oSection5:Cell("D4_QUANT"  ):Setvalue( SDC->DC_QTDORIG )
						Else
							oSection5:Cell("D4_QUANT"  ):Setvalue( SDC->DC_QUANT )
						EndIf

						oReport:IncMeter()
						oSection5:PrintLine()
						nSldSD4 -= If(mv_par10==1,SDC->DC_QTDORIG,SDC->DC_QUANT)
						SDC->(dbSkip())
					EndDo
				Else
					oSection5:Cell("DC_LOCALIZ"):Setvalue( "" )
					oSection5:Cell("DC_NUMSERI"):Setvalue( "" )
					If mv_par10 == 1
						oSection5:Cell("D4_QUANT"  ):Setvalue( (cQryRel)->D4_QTDEORI )
					EndIf
					oReport:IncMeter()
					oSection5:PrintLine()
				EndIf
			Else
				oSection5:Cell("DC_LOCALIZ"):Setvalue( "" )
				oSection5:Cell("DC_NUMSERI"):Setvalue( "" )
				If mv_par10 == 1
					oSection5:Cell("D4_QUANT"  ):Setvalue( (cQryRel)->D4_QTDEORI )
				EndIf
				oReport:IncMeter()
				oSection5:PrintLine()
			EndIf
			If nSldSD4 > 0
				oSection5:Cell("DC_LOCALIZ"):Setvalue( "" )
				oSection5:Cell("DC_NUMSERI"):Setvalue( "" )
				oSection5:Cell("D4_QUANT"  ):Setvalue( nSldSD4 )
				oReport:IncMeter()
				oSection5:PrintLine()
				nSldSD4 := 0
			EndIf
			(cQryRel)->(dbSkip())
		EndDo
		oReport:EndPage()
	EndDo
	oSection2:Finish()
	oSection5:Finish()
	(cQryRel)->(DbCloseArea())

ElseIf MV_PAR01 == 3




	If cPaisloc $ "CHI"
		cTitulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Guia De Despacho", "GUIA DE DESPACHO" ) + ") "
	Elseif cPaisloc $ "COL|MEX|PAR"
		cTitulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Remissão", "REMISION" ) + ") "
	Elseif cPaisloc $ "EUA|POR"
		cTitulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Conduce", "CONDUCE" ) + ") "
	Elseif cPaisloc $ "ARG|URU"
		cTitulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Guia de remessa", "REMITO" ) + ") "
	Endif
	oReport:SetTitle(oReport:Title()+"    "+cTitulo)




	oSection1:Disable()
	oSection2:Disable()
	oSection4:Disable()
	oSection5:Disable()

	oReport:SetMeter( SD2->(LastRec()) )
	oSection3:Init()
	oSection6:Init()
	While !oReport:Cancel() .And.  !(cQryRel)->(Eof())
		If SD2->D2_TIPO $ "D"
			dbSelectArea( "SA2" )
			dbSetOrder( 1 )
			dbSeek( xFilial("SA2") + (cQryRel)->D2_CLIENTE + (cQryRel)->D2_LOJA )
			oSection3:Cell("A2_COD" ):SetValue( SA2->A2_COD  )
			oSection3:Cell("A2_LOJA"):SetValue( SA2->A2_LOJA )
			oSection3:Cell("A2_NOME"):SetValue( SA2->A2_NOME )
			oSection3:Cell("A2_MUN" ):SetValue( SA2->A2_MUN  )
			oSection3:Cell("A2_EST" ):SetValue( SA2->A2_EST  )
		Else
			dbSelectArea( "SA1" )
			dbSetOrder( 1 )
			dbSeek( xFilial("SA1") + (cQryRel)->D2_CLIENTE + (cQryRel)->D2_LOJA)
			oSection3:Cell("A2_COD" ):SetValue( SA1->A1_COD  )
			oSection3:Cell("A2_LOJA"):SetValue( SA1->A1_LOJA )
			oSection3:Cell("A2_NOME"):SetValue( SA1->A1_NOME )
			oSection3:Cell("A2_MUN" ):SetValue( SA1->A1_MUN  )
			oSection3:Cell("A2_EST" ):SetValue( SA1->A1_EST  )
		EndIf
		oSection3:PrintLine()
		oReport:ThinLine()
		cDocAnt := xFilial("SD2")+(cQryRel)->(D2_DOC+D2_SERIE)
		While !(cQryRel)->(Eof()) .And.  (cQryRel)->(D2_FILIAL+D2_DOC+D2_SERIE) == cDocAnt
			If Localiza( (cQryRel)->D2_COD )
				dbSelectArea( "SDB" )
				dbSetOrder(1)
				cChaveDB := xFilial("SDB")+(cQryRel)->(D2_COD+D2_LOCAL+D2_NUMSEQ+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA)
				If dbSeek(cChaveDB)
					While !Eof() .And.  cChaveDB == DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA
			   			If DB_ESTORNO == "S"
							dbSkip()
							Loop
						EndIf
						oSection6:Cell("DB_LOCALIZ"):SetValue( SDB->DB_LOCALIZ )
						oSection6:Cell("DB_NUMSERI"):SetValue( SDB->DB_NUMSERI )
						oSection6:Cell("DB_QUANT"  ):SetValue( SDB->DB_QUANT   )
						If !lQuery
							SB1->(dbSeek(xFilial("SB1")+(cQryRel)->D2_COD))
						EndIf
						oReport:IncMeter()
						oSection6:PrintLine()
						SDB->(dbSkip())
					EndDo
				Else
					oSection6:Cell("DB_LOCALIZ"):SetValue( "" )
					oSection6:Cell("DB_NUMSERI"):SetValue( "" )
					oSection6:Cell("DB_QUANT"  ):SetValue( (cQryRel)->D2_QUANT )
					If !lQuery
						SB1->(dbSeek(xFilial("SB1")+(cQryRel)->D2_COD))
					EndIf
					oReport:IncMeter()
					oSection6:PrintLine()
				EndIf
			Else
				oSection6:Cell("DB_LOCALIZ"):SetValue( "" )
				oSection6:Cell("DB_NUMSERI"):SetValue( "" )
				oSection6:Cell("DB_QUANT"  ):SetValue( (cQryRel)->D2_QUANT )
				If !lQuery
					SB1->(dbSeek(xFilial("SB1")+(cQryRel)->D2_COD))
				EndIf
				oReport:IncMeter()
				oSection6:PrintLine()
			EndIf



			If lExistBlock
				ExecBlock("MR265MAIL", .F. , .F. )
			EndIf
			(cQryRel)->(dbSkip())
		EndDo
		oReport:EndPage()
	EndDo
	oSection3:Finish()
	oSection6:Finish()
	(cQryRel)->(DbCloseArea())

EndIf
Return Nil































Function MATR265R3()



LOCAL tamanho:="G"
LOCAL cDesc1 :=If( cPaisLoc $ "ANG|PTG", "Este relatório tem o objectivo de facilitar a retirada de materiais", "Este relatorio tem o objetivo de facilitar a retirada de materiais" )
LOCAL cDesc2 :=If( cPaisLoc $ "ANG|PTG", "Após a facturação de uma factura ou a criação de uma op caso consumam", "apos o Faturamento de uma NF ou a Criacao de uma OP caso consumam" )
LOCAL cDesc3 :=If( cPaisLoc $ "ANG|PTG", "Materiais Que Utilizem O Controle De Endereçamento", "materiais que utilizam o controle de Enderecamento" )
LOCAL cString:="SD2"
PRIVATE cbCont,cabec1,cabec2,cbtxt
PRIVATE cPerg  :="MTR265"
PRIVATE aReturn := {If( cPaisLoc $ "ANG|PTG", "Código de barras", "Zebrado" ),1,If( cPaisLoc $ "ANG|PTG", "Administração", "Administracao" ), 2, 2, 1, "",0 }
PRIVATE nomeprog:="MATR265",nLastKey := 0
PRIVATE li:=80, limite:=132, lRodape:= .F. 
PRIVATE wnrel  := "MATR265"
PRIVATE titulo :=If( cPaisLoc $ "ANG|PTG", "Pick-list Endereçamento", "Pick-List Enderecamento" )
PRIVATE cSerIni := ""
PRIVATE cSerFin := ""





cbtxt   := SPACE(10)
cbcont  := 0
Li      := 80
m_pag   := 1

cabec1  := If( cPaisLoc $ "ANG|PTG", "ARTIGO                                      DESCRIÇÃO                                  UM LOTE       SUB-LOTE LOCALIZAÇÃO   NÚMERO DE SÉRIE      QUANTIDADE     DT VALIDADE   POTÊNCIA", "PRODUTO                                      DESCRICAO                                  UM LOTE       SUB-LOTE LOCALIZACAO   NUMERO DE SERIE      QUANTIDADE     DT VALIDADE   POTENCIA" )
cabec2  := ""







AjustaSX1()
pergunte( cPerg, .F. )

















wnrel:=SetPrint(cString,wnrel,cPerg,@Titulo,cDesc1,cDesc2,cDesc3, .F. ,, .F. ,Tamanho)

If nLastKey == 27
	Return
Endif

SetDefault(aReturn,cString)

If nLastKey == 27
	Return
Endif




cSerIni := If(cPaisLoc=="BRA",MV_PAR14,MV_PAR16)
cSerFin := If(cPaisLoc=="BRA",MV_PAR15,MV_PAR17)
If mv_par01 == 1
	titulo  += If( cPaisLoc $ "ANG|PTG", " (factura De Venda)", " (Nota Fiscal de Venda)" )
	RptStatus({|lEnd| C265ImpNF(@lEnd,tamanho,titulo,wnRel,cString)},titulo)
ElseIf mv_par01 == 2



	titulo  += If( cPaisLoc $ "ANG|PTG", " (ordem De Produção)", " (Ordem de Producao)" )
	RptStatus({|lEnd| C265ImpOP(@lEnd,tamanho,titulo,wnRel,cString)},titulo)
ElseIf cPaisLoc # "BRA"




    If cPaisloc $ "CHI"
		titulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Guia De Despacho", "GUIA DE DESPACHO" ) + ") "
    Elseif cPaisloc $ "COL|MEX|PAR"
   		titulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Remissão", "REMISION" ) + ") "
    Elseif cPaisloc $ "EUA|POR"
 		titulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Conduce", "CONDUCE" ) + ") "
    Elseif cPaisloc $ "ARG|URU"
		titulo  += " (" + If( cPaisLoc $ "ANG|PTG", "Guia de remessa", "REMITO" ) + ") "
    Endif
	RptStatus({|lEnd| C265ImpRem(@lEnd,tamanho,titulo,wnRel,cString)},titulo)
EndIf

Return














Static Function C265ImpNF( lEnd, tamanho, titulo, wnRel )



LOCAL bBlock, cChaveAnt:="",cChaveDB:=""
LOCAL lExistBlock:=ExistBlock("MR265MAIL")
PRIVATE cNfAnt    := Space(TamSX3("D2_DOC")[1])
PRIVATE cSerieAnt := Space(TamSX3("D2_SERIE")[1])
PRIVATE nValorNf  := 0




dbSelectArea("SB1")
dbSetOrder(1)

dbSelectArea("SD2")
dbSetOrder(1)




cIndex :="D2_FILIAL+D2_DOC+D2_SERIE+D2_ITEM+D2_COD+D2_ITEMPV+D2_LOTECTL+D2_NUMLOTE"

cExpres:='D2_FILIAL=="'+xFilial()+'".And.'
cExpres+='D2_DOC>="'+mv_par02+'".And.D2_DOC<="'+mv_par03+'".And.'
If cPaisLoc<>"BRA"
	cExpres+=" !("+IsRemito(2,"SD2->D2_TIPODOC")+") .And. "
Endif
cExpres+='D2_SERIE>="'+cSerIni+'" .And. '
If !Empty(cSerFin)
	cExpres+='D2_SERIE<="'+cSerFin+'" .And. '
Endif
cExpres+='D2_CLIENTE>="'+mv_par06+'".And.D2_CLIENTE<="'+mv_par07+'"'

cSD2ntx := CriaTrab(, .F. )
IndRegua("SD2", cSD2ntx, cIndex,,cExpres,If( cPaisLoc $ "ANG|PTG", "A selecionar registos ...", "Selecionando Registros ..." ))
nIndex := RetIndex("SD2")



dbSetOrder( nIndex+1 )




dbGoTop()
SetRegua(LastRec())

cChaveAnt := "????????????????"

SB8->(dbSetOrder(1))

While !Eof()



	If lAbortPrint
		PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
		Exit
	Endif




	dbSelectArea("SC6")
	dbSetOrder( 1 )

	If !dbSeek( xFilial( "SC6" ) + SD2->D2_PEDIDO + SD2->D2_ITEMPV + SD2->D2_COD ) .Or.  ( C6_ENTREG < mv_par04 .Or.  C6_ENTREG > mv_par05 )
		dbSelectArea("SD2")
		IncRegua()
		dbSkip()
		Loop
	EndIf

	dbSelectArea( "SF2" )
	dbSetOrder( 1 )
	dbSeek(xFilial("SF2")+SD2->D2_DOC+SD2->D2_SERIE)




	if mv_par13==2
	   if if(F2_MOEDA==0,1,F2_MOEDA)<>mv_par12
	      dbselectarea("SD2")
  		  IncRegua()
	      dbskip()
	      loop
	   endif
	endif

	dbSelectArea( "SB1" )
	dbSeek( xFilial() + SD2->D2_COD )

	If SF2->F2_TIPO $ "DºB"
		dbSelectArea( "SA2" )
		dbSetOrder( 1 )
		dbSeek( xFilial() + SD2->D2_CLIENTE + SD2->D2_LOJA )
	Else
		dbSelectArea( "SA1" )
		dbSetOrder( 1 )
		dbSeek( xFilial() + SD2->D2_CLIENTE + SD2->D2_LOJA)
	EndIf

	dbSelectArea( "SA4" )
	dbSetOrder( 1 )
	dbSeek( xFilial() + SF2->F2_TRANSP )

	dbSelectArea( "SC9" )

	nValorNf += xmoeda(SD2->D2_TOTAL,SF2->F2_MOEDA,mv_par12,SF2->F2_EMISSAO,msdecimais(mv_par12)+1,SF2->F2_TXMOEDA)


	If cChaveAnt == SD2->D2_FILIAL + SD2->D2_DOC + SD2->D2_SERIE + SD2->D2_ITEM + SD2->D2_COD + SD2->D2_ITEMPV + SD2->D2_LOTECTL
		dbSelectArea( "SD2" )
		cChaveAnt := D2_FILIAL + D2_DOC + D2_SERIE + D2_ITEM + D2_COD + D2_ITEMPV + D2_LOTECTL
		dbSkip()
		Loop
	EndIf




	CabecNF(Tamanho)




	DetalheNF(Tamanho)

	If Localiza( SD2->D2_COD )
		dbSelectArea( "SDB" )
		dbSetOrder( 1 )
		cChaveDB :=xFilial("SDB")+SD2->D2_COD+SD2->D2_LOCAL+SD2->D2_NUMSEQ+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA
		If dbSeek( cChaveDB )
			While !Eof() .And.  cChaveDB == DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA
				If DB_ESTORNO == "S"
					dbSkip()
					Loop
				EndIf
				PrintOut(Li,70,DB_LOCALIZ,PesqPict("SDB","DB_LOCALIZ",15),)
				PrintOut(Li,86,DB_NUMSERI,PesqPict("SDB","DB_NUMSERI",20),)
				PrintOut(Li,107,DB_QUANT,PesqPictQt("DB_QUANT",14),)
				PrintOut(li,122,SD2->D2_DTVALID,PesqPict("SD2","D2_DTVALID",10),)
				PrintOut(li,136,SD2->D2_POTENCI,PesqPictQt("D2_POTENCI",14),)
				dbSkip()
				Li := Li + 1
				If Li > 55
					roda(cbcont,cbtxt,tamanho)
					CabecNF(Tamanho)
					DetalheNF(Tamanho)
				EndIf
			EndDo
		Else
			dbSelectArea( "SC9" )
			dbSetOrder( 2 )

			cChaveC9 := xFilial( "SC9" ) + SD2->D2_CLIENTE + SD2->D2_LOJA + SD2->D2_PEDIDO + SD2->D2_ITEMPV
			dbSeek( cChaveC9 )

			While !Eof() .And.  cChaveC9 == C9_FILIAL + C9_CLIENTE + C9_LOJA + C9_PEDIDO + C9_ITEM



				If Rastro( SD2->D2_COD, "S" )


					bBlock  := { || C9_PRODUTO + C9_NUMLOTE + C9_NFISCAL + C9_SERIENF <> SD2->D2_COD + SD2->D2_NUMLOTE + SD2->D2_DOC + SD2->D2_SERIE }
				ElseIf Rastro( SC9->C9_PRODUTO, "L" )


					bBlock  := { || C9_PRODUTO + C9_LOTECTL + C9_NFISCAL + C9_SERIENF <> SD2->D2_COD + SD2->D2_LOTECTL + SD2->D2_DOC + SD2->D2_SERIE  }
				Else

					bBlock  := { || C9_PRODUTO + C9_NFISCAL + C9_SERIENF <> SD2->D2_COD + SD2->D2_DOC + SD2->D2_SERIE }
				EndIf

				If C9_BLEST <> "10" .Or.  C9_BLCRED <> "10" .Or.  Eval( bBlock )
					dbSkip()
					Loop
				EndIf
				dbSelectArea("SDC")
				dbSetOrder(1)
				If Rastro(SD2->D2_COD, "S")
					bBlock  := {|| SC9->C9_LOTECTL+SC9->C9_NUMLOTE == DC_LOTECTL+DC_NUMLOTE}
					cChave  := xFilial()+SC9->C9_PRODUTO+SD2->D2_LOCAL+"SC6"+SC9->C9_PEDIDO+SC9->C9_ITEM+SC9->C9_SEQUEN
					cChave2 := SC9->C9_LOTECTL+SC9->C9_NUMLOTE
				ElseIf Rastro(SC9->C9_PRODUTO, "L")
					bBlock  := {|| SC9->C9_LOTECTL == DC_LOTECTL}
					cChave  := xFilial()+SC9->C9_PRODUTO+SD2->D2_LOCAL+"SC6"+SC9->C9_PEDIDO+SC9->C9_ITEM+SC9->C9_SEQUEN
					cChave2 := SC9->C9_LOTECTL
				Else
					bBlock  := {|| .T. }
					cChave  := xFilial()+SC9->C9_PRODUTO+SD2->D2_LOCAL+"SC6"+SC9->C9_PEDIDO+SC9->C9_ITEM+SC9->C9_SEQUEN
					cChave2 := ""
				EndIf



				If dbSeek(cChave+cChave2, .F. )
					while !Eof() .And. cChave==DC_FILIAL+DC_PRODUTO+DC_LOCAL+DC_ORIGEM+DC_PEDIDO+DC_ITEM+DC_SEQ .And. Eval(bBlock)
						PrintOut(Li,070,DC_LOCALIZ,PesqPict("SDC","DC_LOCALIZ",15),)
						PrintOut(Li,086,DC_NUMSERI,PesqPict("SDC","DC_NUMSERI",20),)



						SB8->(dbSeek(xFilial("SB8") + SDC->(DC_PRODUTO+DC_LOCAL+DTOS(SC9->C9_DTVALID)+DC_LOTECTL+DC_NUMLOTE)))
						If mv_par10 == 1
							PrintOut(Li,107,DC_QTDORIG,PesqPictQt("DC_QTDORIG",14),)
							PrintOut(li,122,SC9->C9_DTVALID,PesqPict("SC9","C9_DTVALID",10),)
							PrintOut(li,136,SB8->B8_POTENCI,PesqPictQt("B8_POTENCI",14),)
						Else
							PrintOut(Li,107,DC_QUANT,PesqPictQt("DC_QUANT",14),)
							PrintOut(li,122,SC9->C9_DTVALID,PesqPict("SC9","C9_DTVALID",10),)
							PrintOut(li,136,SB8->B8_POTENCI,PesqPictQt("B8_POTENCI",14),)
						EndIf
						dbSelectArea("SDC")
						dbSkip()
						Li++
						If Li > 55
							Roda(cbcont,cbtxt,tamanho)
							CabecNF()
							DetalheNF()
						EndIf
					EndDo
				EndIf
				dbSelectArea("SC9")
				dbSkip()
			EndDo
		EndIf
	Else
		PrintOut(Li,86,SD2->D2_QUANT,PesqPictQt("D2_QUANT",14),)
	EndIf
	dbSelectArea("SD2")



	Li++
	cNfAnt := SD2->D2_DOC
	cSerieAnt := SD2->D2_SERIE
	IncRegua()
	dbSelectArea( "SD2" )
	cChaveAnt := D2_FILIAL + D2_DOC + D2_SERIE + D2_ITEM + D2_COD + D2_ITEMPV + D2_LOTECTL



	If lExistBlock
		ExecBlock("MR265MAIL", .F. , .F. )
	EndIf
	dbSkip()
	If SD2->D2_DOC <> cNfAnt .Or.  SD2->D2_SERIE <> cSerieAnt
		Li++
		PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Valor da factura: ","VALOR DA NOTA FISCAL: ")+Transform(nValorNf,PesqPict("SD2","D2_TOTAL",16,SF2->F2_MOEDA)),,)
		Li++
		Li++
		PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Observação: ","OBSERVACAO: "),,)
		nValorNf := 0
	EndIf
EndDo

If Li <> 80
	roda(cbcont,cbtxt,tamanho)
EndIf

dbSelectArea("SD2")
RetIndex("SD2")
Ferase( cSD2ntx + OrdBagExt() )

If aReturn[5] = 1
	Set( 24, "" )
	dbCommitAll()
	OurSpool(wnrel)
Endif

MS_FLUSH()














Static Function CabecNF(Tamanho)
Local cTxt := ""
If Li > 55 .Or.  SD2->D2_DOC <> cNfAnt .Or.  SD2->D2_SERIE <> cSerieAnt
	Cabec(Titulo,Cabec1,Cabec2,NomeProg,Tamanho,18)
	If SF2->F2_TIPO $ "DºB"
		PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Cliente/forn.: ","CLIENTE/FORN.: ")+AllTrim(SA2->A2_COD)+"/"+SA2->A2_LOJA+" - "+SA2->A2_NOME,,)
		Li+=2
		PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","CONCELHO....: ","MUNICIPIO....: ")+AllTrim(SA2->A2_MUN)+" - "+SA2->A2_EST,,)
		Li+=2
	Else
		PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Cliente/forn.: ","CLIENTE/FORN.: ")+AllTrim(SA1->A1_COD)+"/"+SA1->A1_LOJA+" - "+SA1->A1_NOME,,)
		Li+=2
		PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","CONCELHO....: ","MUNICIPIO....: ")+AllTrim(SA1->A1_MUN)+" - "+SA1->A1_EST,,)
		Li+=2
	EndIf
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Factura..: ","NOTA FISCAL..: ")+SD2->D2_DOC,,)
	Li+=2
	cTxt := Padr(Alltrim(Upper(RetTitle("D2_SERIE"))),Len(If( cPaisLoc $ "ANG|PTG", "CONCELHO....: ", "MUNICIPIO....: " ))-1,".")
    PrintOut(Li,00,cTxt+": "+SD2->D2_SERIE,,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Pedido.......: ","PEDIDO.......: ")+SD2->D2_PEDIDO,,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Transporte...: ","TRANSPORTE...: ")+SA4->A4_NOME,,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Volume.......: ","VOLUME.......: ")+AllTrim(Str(SF2->F2_VOLUME1)),,)
	PrintOut(Li,45,If(cPaisLoc$"ANG|PTG","Espécie....: ","ESPECIE....: ")+SF2->F2_ESPECI1,,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Peso líq.....: ","PESO LIQ.....: ")+Transform(SF2->F2_PLIQUI,PesqPict("SF2","F2_PLIQUI")),,)
	PrintOut(Li,45,If(cPaisLoc$"ANG|PTG","Peso bruto.: ","PESO BRUTO.: ")+Transform(SF2->F2_PBRUTO,PesqPict("SF2","F2_PBRUTO")),,)
	Li+=2
	PrintOut(Li,00,__PrtThinLine(),,)
	Li+=2
Endif
Return














Static Function DetalheNF(Tamanho)
PrintOut(Li,00,SD2->D2_COD,PesqPict("SD2","D2_COD",30),)
PrintOut(Li,45,Left(SB1->B1_DESC,30),PesqPict("SB1","B1_DESC",30),)
PrintOut(Li,77,SB1->B1_UM,PesqPict("SB1","B1_UM",2),)
PrintOut(Li,87,SD2->D2_LOTECTL,PesqPict("SD2","D2_LOTECTL",10),)
PrintOut(Li,97,SD2->D2_NUMLOTE,PesqPict("SD2","D2_NUMLOTE",6),)
Return














Static Function C265ImpOP( lEnd, tamanho, titulo, wnRel )



LOCAL cChave,cCompara
LOCAL nSldSD4 := 0
PRIVATE cOpAnt := Space(11)




dbSelectArea("SB1")
dbSetOrder(1)

dbSelectArea("SD4")
dbSetOrder(2)

dbSelectArea("SDC")
dbSetOrder(2)

dbSelectArea("SC2")
dbSetOrder(1)




cIndex:=IndexKey()

cExpres:='C2_FILIAL=="'+xFilial()+'".And.'
cExpres+='C2_NUM+C2_ITEM+C2_SEQUEN+C2_ITEMGRD>="'+mv_par08+'".And.'
cExpres+='C2_NUM+C2_ITEM+C2_SEQUEN+C2_ITEMGRD<="'+mv_par09+'".And.'
cExpres+='DTOS(C2_DATPRF)>="'+DTOS(mv_par04)+'".And.'
cExpres+='DTOS(C2_DATPRF)<="'+DTOS(mv_par05)+'"'

cSC2ntx := CriaTrab(, .F. )
IndRegua("SC2", cSC2ntx, cIndex,,cExpres,If( cPaisLoc $ "ANG|PTG", "A selecionar registos ...", "Selecionando Registros ..." ))
nIndex := RetIndex("SC2")



dbSetOrder( nIndex+1 )




dbGoTop()
SetRegua(LastRec())

cChaveAnt := "????????????????"

While !Eof()




	If lAbortPrint
		PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
		Exit
	Endif

	If !MtrAvalOp(mv_par11)
		dbSkip()
		Loop
	EndIf

	dbSelectArea("SB1")
	dbSeek(xFilial()+SC2->C2_PRODUTO)




	CabecOP(Tamanho)

	dbSelectArea("SD4")
	dbSeek(xFilial()+cOPAnt)
	While !Eof() .And.  D4_FILIAL+D4_OP == xFilial("SD4")+cOpAnt



		CabecOP(Tamanho)
		DetalheOP(Tamanho)
		If Localiza(SD4->D4_COD)
			dbSelectArea("SDC")
			cChave := ""
			If Rastro(SD4->D4_COD)
				cChave:=xFilial()+SD4->D4_COD+SD4->D4_LOCAL+SD4->D4_OP+SD4->D4_TRT+SD4->D4_LOTECTL+SD4->D4_NUMLOTE
				cCompara:="DC_FILIAL+DC_PRODUTO+DC_LOCAL+DC_OP+DC_TRT+DC_LOTECTL+DC_NUMLOTE"
			Else
				cChave:=xFilial()+SD4->D4_COD+SD4->D4_LOCAL+SD4->D4_OP+SD4->D4_TRT
				cCompara:="DC_FILIAL+DC_PRODUTO+DC_LOCAL+DC_OP+DC_TRT"
			EndIf



			If !Empty(cChave) .AND.  dbSeek(cChave)
				nSldSD4 := If(mv_par10==1,SD4->D4_QTDEORI,SD4->D4_QUANT)
				while !Eof() .And. cChave==&(cCompara)
					CabecOP(Tamanho)
					PrintOut(Li,50,DC_LOTECTL,PesqPict("SDC","DC_LOTECTL",10),)
					PrintOut(Li,61,DC_NUMLOTE,PesqPict("SDC","DC_NUMLOTE",6),)
					PrintOut(Li,70,DC_LOCALIZ,PesqPict("SDC","DC_LOCALIZ",15),)
					PrintOut(Li,86,DC_NUMSERI,PesqPict("SDC","DC_NUMSERI",20),)



					If mv_par10 == 1
						PrintOut(Li,107,DC_QTDORIG,PesqPictQt("D4_QUANT",14),)
						PrintOut(li,122,SD4->D4_DTVALID,PesqPict("SD4","D4_DTVALID",10),)
						PrintOut(li,136,SD4->D4_POTENCI,PesqPictQt("D4_POTENCI",14),)
					Else
						PrintOut(Li,107,DC_QUANT,PesqPictQt("D4_QUANT",14),)
						PrintOut(li,122,SD4->D4_DTVALID,PesqPict("SD4","D4_DTVALID",10),)
						PrintOut(li,136,SD4->D4_POTENCI,PesqPictQt("D4_POTENCI",14),)
					EndIf
					Li++
					nSldSD4 -= If(mv_par10==1,DC_QTDORIG,DC_QUANT)
					dbSkip()
				EndDo
				If nSldSD4 > 0
					DetalheOP(Tamanho)
					PrintOut(Li,107,nSldSD4,PesqPictQt("D4_QUANT",14),)
					PrintOut(li,122,SD4->D4_DTVALID,PesqPict("SD4","D4_DTVALID",10),)
					PrintOut(li,136,SD4->D4_POTENCI,PesqPictQt("D4_POTENCI",14),)
					Li++
				EndIf
			Else
				PrintOut(Li,107,If(mv_par10==1,SD4->D4_QTDEORI,SD4->D4_QUANT),PesqPictQt("D4_QUANT",14),)
				PrintOut(li,122,SD4->D4_DTVALID,PesqPict("SD4","D4_DTVALID",10),)
				PrintOut(li,136,SD4->D4_POTENCI,PesqPictQt("D4_POTENCI",14),)
				Li++
			EndIf
		Else
			PrintOut(Li,107,If(mv_par10==1,SD4->D4_QTDEORI,SD4->D4_QUANT),PesqPictQt("D4_QUANT",14),)
			PrintOut(li,122,SD4->D4_DTVALID,PesqPict("SD4","D4_DTVALID",10),)
			PrintOut(li,136,SD4->D4_POTENCI,PesqPictQt("D4_POTENCI",14),)
			Li++
		EndIf
		dbSelectArea("SD4")
		dbSkip()
	EndDo
	dbSelectArea("SC2")
	dbSkip()
EndDo

If Li <> 80
	roda(cbcont,cbtxt,tamanho)
EndIf

dbSelectArea("SC2")
RetIndex("SC2")
Ferase(cSC2ntx+OrdBagExt())

If aReturn[5] = 1
	Set( 24, "" )
	dbCommitAll()
	OurSpool(wnrel)
Endif

MS_FLUSH()














Static Function CabecOP(Tamanho)
Local aArea    := GetArea()
Local aAreaSB1 := SB1->(GetArea())
If Li > 55 .Or.  SC2->C2_NUM+SC2->C2_ITEM+SC2->C2_SEQUEN+SC2->C2_ITEMGRD <> cOpAnt
	Cabec(Titulo,Cabec1,Cabec2,NomeProg,Tamanho,18)
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Ordem de produção: ","ORDEM DE PRODUCAO: ")+SC2->C2_NUM+SC2->C2_ITEM+SC2->C2_SEQUEN+SC2->C2_ITEMGRD,,)
	Li+=2
	SB1->(dbSeek(xFilial("SB1")+SC2->C2_PRODUTO))
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","ARTIGO..........: ","PRODUTO..........: ")+SC2->C2_PRODUTO+" - "+SB1->B1_DESC,,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Data prev. início: ","DATA PREV. INICIO: "),,)
	PrintOut(Li,19,SC2->C2_DATPRI,,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Data prev. entreg: ","DATA PREV. ENTREG: "),,)
	PrintOut(Li,19,SC2->C2_DATPRF,,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Quantidade.......: ","QUANTIDADE.......: ")+Transform(SC2->C2_QUANT,PesqPictQt("C2_QUANT",14)),,)
	Li+=2
	PrintOut(Li,00,If(cPaisLoc$"ANG|PTG","Observação.......: ","OBSERVACAO.......: ")+SC2->C2_OBS,,)
	Li+=2
	PrintOut(Li,00,__PrtThinLine(),,)
	Li+=2
	cOPAnt:=SC2->C2_NUM+SC2->C2_ITEM+SC2->C2_SEQUEN+SC2->C2_ITEMGRD
Endif
RestArea(aAreaSB1)
RestArea(aArea)
Return














Static Function DetalheOP(Tamanho)
Local cAlias:=Alias()
dbSelectArea("SB1")
dbSeek(xFilial()+SD4->D4_COD)
PrintOut(Li,00,SD4->D4_COD,PesqPict("SD4","D4_COD",15),)
PrintOut(Li,16,Left(SB1->B1_DESC,30),PesqPict("SB1","B1_DESC",30),)
PrintOut(Li,47,SB1->B1_UM,PesqPict("SB1","B1_UM",2),)
If !Localiza(SD4->D4_COD)
	PrintOut(Li,50,SD4->D4_LOTECTL,PesqPict("SD4","D4_LOTECTL",10),)
	PrintOut(Li,61,SD4->D4_NUMLOTE,PesqPict("SD4","D4_NUMLOTE",6),)
EndIf
dbSelectArea(cAlias)
Return















Static Function C265ImpRem( lEnd, tamanho, titulo, wnRel )



LOCAL cChaveAnt:="",cChaveDB:=""
LOCAL lExistBlock:=ExistBlock("MR265MAIL")
PRIVATE cNfAnt := Space(TamSX3("D2_DOC")[1])
PRIVATE cSerAnt:= Space(TamSX3("D2_SERIE")[1])
PRIVATE nValorNf := 0




dbSelectArea("SB1")
dbSetOrder(1)

dbSelectArea("SD2")
dbSetOrder(3)




cIndex :="D2_FILIAL+D2_DOC+D2_ITEM+D2_COD+D2_LOTECTL+D2_NUMLOTE"

cExpres:='D2_FILIAL=="'+xFilial()+'".And.'
cExpres+='D2_DOC >= "' + mv_par14 + '".And. D2_DOC<= "'+mv_par15+'".And.'
cExpres+='D2_CLIENTE>= "'+mv_par06+'".And. D2_CLIENTE<="'+mv_par07+'"'
cExpres+=".And. ("+IsRemito(2,"SD2->D2_TIPODOC")+")"
cSD2ntx := CriaTrab(, .F. )
IndRegua("SD2", cSD2ntx, cIndex,,cExpres,If( cPaisLoc $ "ANG|PTG", "A selecionar registos ...", "Selecionando Registros ..." ))
nIndex := RetIndex("SD2")



dbSetOrder( nIndex+1 )




dbGoTop()
SetRegua(LastRec())

cChaveAnt := "????????????????"

cNfAnt := Space(TamSX3("D2_DOC")[1])
cSerAnt:= Space(TamSX3("D2_SERIE")[1])

While !Eof()



	If lAbortPrint
		PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
		Exit
	Endif




	if mv_par13==2
	   if if(D2_MOEDA==0,1,D2_MOEDA)<>mv_par12
	      dbselectarea("SD2")
  		  IncRegua()
	      dbskip()
	      loop
	   endif
	endif

	dbSelectArea( "SB1" )
	dbSeek( xFilial() + SD2->D2_COD )

	If SD2->D2_TIPO =="D"
		dbSelectArea( "SA2" )
		dbSetOrder(1)
		dbSeek( xFilial() + SD2->D2_CLIENTE + SD2->D2_LOJA )
	Else
		dbSelectArea( "SA1" )
		dbSetOrder( 1 )
		dbSeek( xFilial() + SD2->D2_CLIENTE + SD2->D2_LOJA)
	EndIf




	CabecRem(Tamanho)




	DetalheRem(Tamanho)

	If Localiza( SD2->D2_COD )
		dbSelectArea( "SDB" )
		dbSetOrder(1)

		cChaveDB := xFilial("SDB")+SD2->D2_COD+SD2->D2_LOCAL+SD2->D2_NUMSEQ+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA
		If dbSeek(cChaveDB)
			While !Eof() .And.  cChaveDB == DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA
				If DB_ESTORNO == "S"
					dbSkip()
					Loop
				EndIf
				PrintOut(Li,70,DB_LOCALIZ,PesqPict("SDB","DB_LOCALIZ",15),)
				PrintOut(Li,86,DB_NUMSERI,PesqPict("SDB","DB_NUMSERI",20),)
				PrintOut(Li,107,DB_QUANT,PesqPictQt("DB_QUANT",14),)
				dbSkip()
				Li := Li + 1
				If Li > 55
					roda(cbcont,cbtxt,tamanho)
					CabecRem(Tamanho)
					DetalheRem(Tamanho)
				EndIf
			EndDo
		Else
		EndIf
	Else
		PrintOut(Li,86,SD2->D2_QUANT,PesqPictQt("D2_QUANT",14),)
	EndIf
	dbSelectArea("SD2")

	Li++
	IncRegua()
	dbSelectArea( "SD2" )



	If lExistBlock
		ExecBlock("MR265MAIL", .F. , .F. )
	EndIf
	dbSkip()
EndDo

dbSelectArea("SD2")
RetIndex("SD2")
Ferase( cSD2ntx + OrdBagExt() )

If aReturn[5] = 1
	Set( 24, "" )
	dbCommitAll()
	OurSpool(wnrel)
Endif

MS_FLUSH()
return














Static Function CabecRem(Tamanho)
Local nEsp := 15
Local cTxt := ""
If Li > 55 .Or.  (SD2->D2_REMITO <> cNfAnt .And.  SD2->D2_SERIE <> cSerAnt)
	Cabec(Titulo,Cabec1,Cabec2,NomeProg,Tamanho,18)
	If SD2->D2_TIPO $ "D"
		cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "Cliente/forn.: ", "CLIENTE/FORN.: " ),nEsp,".")
		PrintOut(Li,00,cTxt+": "+AllTrim(SA2->A2_COD)+"/"+SA2->A2_LOJA+" - "+SA2->A2_NOME,,)
		Li+=2
		cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "CONCELHO....: ", "MUNICIPIO....: " ),nEsp,".")
		PrintOut(Li,00,cTxt+": "+AllTrim(SA2->A2_MUN)+" - "+SA2->A2_EST,,)
		Li+=2
	Else
		cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "Cliente/forn.: ", "CLIENTE/FORN.: " ),nEsp,".")
		PrintOut(Li,00,cTxt+": "+AllTrim(SA1->A1_COD)+"/"+SA1->A1_LOJA+" - "+SA1->A1_NOME,,)
		Li+=2
		cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "CONCELHO....: ", "MUNICIPIO....: " ),nEsp,".")
		PrintOut(Li,00,cTxt+": "+AllTrim(SA1->A1_MUN)+" - "+SA1->A1_EST,,)
		Li+=2
	EndIf
    If cPaisloc $ "CHI"
	    cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "Guia De Despacho", "GUIA DE DESPACHO" ),nEsp,".")
    Elseif cPaisloc $ "COL|MEX|PAR"
	    cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "Remissão", "REMISION" ),nEsp,".")
    Elseif cPaisloc $ "EUA|POR"
	    cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "Conduce", "CONDUCE" ),nEsp,".")
    Elseif cPaisloc $ "ARG|URU"
	    cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "Guia de remessa", "REMITO" ),nEsp,".")
    Endif
	PrintOut(Li,00,cTxt+": "+SD2->D2_DOC,,)

    Li+=2
    cTxt := Padr(Alltrim(Upper(RetTitle("D2_SERIE"))),nEsp,".")
    PrintOut(Li,00,cTxt+": "+SD2->D2_SERIE,,)

	Li+=2
	cTxt := Padr(If( cPaisLoc $ "ANG|PTG", "Pedido.......: ", "PEDIDO.......: " ),nEsp,".")
	PrintOut(Li,00,cTxt+": "+SD2->D2_PEDIDO,,)
	Li+=2
	PrintOut(Li,00,__PrtThinLine(),,)
	Li+=2
	cNfAnt := SD2->D2_DOC
    cSerAnt:= SD2->D2_SERIE
Endif
Return














Static Function DetalheRem(Tamanho)
PrintOut(Li,00,SD2->D2_COD,PesqPict("SD2","D2_COD",15),)
PrintOut(Li,16,Left(SB1->B1_DESC,30),PesqPict("SB1","B1_DESC",30),)
PrintOut(Li,47,SB1->B1_UM,PesqPict("SB1","B1_UM",2),)
PrintOut(Li,50,SD2->D2_LOTECTL,PesqPict("SD2","D2_LOTECTL",10),)
PrintOut(Li,61,SD2->D2_NUMLOTE,PesqPict("SD2","D2_NUMLOTE",6),)
Return











Static Function AjustaSX1()

Local aArea 	:= { Alias(), IndexOrd() }
Local aHelpPor	:= {}
Local aHelpEng	:= {}
Local aHelpSpa	:= {}
Local aTamSX3	:= TamSX3("F1_DOC")
Local cPerg 	:= "MTR265"
Local cSeq		:= If(cPaisLoc=="BRA","14","16")
Local cCH		:= If(cPaisLoc=="BRA","mv_chE","mv_chG")
Local cPAR		:= If(cPaisLoc=="BRA","MV_PAR14","MV_PAR16")
Local nTamSX1 	:= Len(SX1->X1_GRUPO)

Aadd(aHelpPor,"Serie inicial a ser considerada na     ")
Aadd(aHelpPor,"filtragem do cadastro de notas fiscais.")

Aadd(aHelpSpa,"Serie inicial a considerarse en la     ")
Aadd(aHelpSpa,"filtracion del archivo de facturas.    ")

Aadd(aHelpEng,"Inicial serie to be considered in the  ")
Aadd(aHelpEng,"filtering of invoices file.            ")

PutSX1(cPerg,cSeq,"De Serie ?","¿ De serie ?","From series ?",cCH,"C",3,0,0,"G","","","","S",cPAR,"","","","","","","","","","","","","","","","",aHelpPor,aHelpEng,aHelpSpa)

cSeq := Soma1(cSeq)
cCH  := Soma1(cCH)
cPAR := Soma1(cPAR)
aHelpPor := {}
aHelpEng := {}
aHelpSpa := {}

Aadd(aHelpPor,"Serie final a ser considerada na       ")
Aadd(aHelpPor,"filtragem do cadastro de notas fiscais.")

Aadd(aHelpSpa,"Serie final a considerarse en la       ")
Aadd(aHelpSpa,"filtracion del archivo de facturas.    ")

Aadd(aHelpEng,"Final serie to be considered in the    ")
Aadd(aHelpEng,"filtering of invoices file.            ")

PutSX1(cPerg,cSeq,"A serie ?","¿ A serie ?","To series ?",cCH,"C",3,0,0,"G","","","","S",cPAR,"","","","","","","","","","","","","","","","",aHelpPor,aHelpEng,aHelpSpa)




dbSelectArea("SX1")
dbSetOrder(1)

If dbSeek(PADR(cPerg,nTamSX1)+"02") .And.  SX1->X1_TIPO == "C" .And.  SX1->X1_TAMANHO <> aTamSX3[1]
	RecLock("SX1", .F. )
	_FIELD->X1_TAMANHO := aTamSX3[1]
	MsUnLock()
EndIf

If dbSeek(PADR(cPerg,nTamSX1)+"03") .And.  SX1->X1_TIPO == "C" .And.  SX1->X1_TAMANHO <> aTamSX3[1]
	RecLock("SX1", .F. )
	_FIELD->X1_TAMANHO := aTamSX3[1]
	MsUnLock()
EndIf

dbSelectArea( aArea[1] )
dbSetOrder( aArea[2] )

Return