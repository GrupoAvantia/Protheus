#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\MATR780.CH"
#line 2 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr780.prx"
#line 1 ""
#line 17 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr780.prx"
Function MATR780()

Local oReport

If FindFunction("TRepInUse") .And.  TRepInUse()

	oReport := ReportDef()
	oReport:PrintDialog()
Else
	MATR780R3()
EndIf

Return






















Static Function ReportDef()

Local oReport

	Local cAliasSD1 := GetNextAlias()
	Local cAliasSD2 := GetNextAlias()
	Local cAliasSA1 := GetNextAlias()






Local cCodProd	:= ""
Local cDescProd	:= ""
Local cDoc		:= ""
Local cSerie	:= ""
Local dEmissao	:= CTOD("  /  /  ")
Local cUM		:= ""
Local nTotQuant	:= 0
Local nVlrUnit	:= 0
Local nValadi		:= 0
Local nVlrTot	:= 0
Local cVends	:= ""
Local cClieAnt	:= ""
Local cLojaAnt	:= ""
Local nTamData  := Len(DTOC(MsDate()))
Local lValadi		:= cPaisLoc == "MEX" .AND.  SD2->(FieldPos("D2_VALADI")) > 0

Private cSD1, cSD2












oReport := TReport():New("MATR780",If( cPaisLoc $ "ANG|PTG", "Estatisticas de Vendas (Cliente x Artigo)", "Estatisticas de Vendas (Cliente x Produto)" ),"MR780A", {|oReport| ReportPrint(oReport,cAliasSD1,cAliasSD2,cAliasSA1)},If( cPaisLoc $ "ANG|PTG", "Este Programa Irá Emitir A Relação Das Compras Efectuadas Pelo Cliente,", "Este programa ira emitir a relacao das compras efetuadas pelo Cliente," ) + " " + If( cPaisLoc $ "ANG|PTG", "A totalizar por artigo e a escolher a moeda forte para os valores.", "totalizando por produto e escolhendo a moeda forte para os Valores." ))
oReport:SetPortrait()
oReport:SetTotalInLine( .F. )

Pergunte(oReport:uParam, .F. )







































oCliente := TRSection():New(oReport,"Clientes",{"SA1","SD2TRB"},,,)
oCliente:SetTotalInLine( .F. )

TRCell():New(oCliente,"CCLIEANT"	,	,RetTitle("D2_CLIENTE"	),PesqPict("SD2","D2_CLIENTE"	),08							,,{|| cClieAnt		})
TRCell():New(oCliente,"CLOJA"		,	,RetTitle("D2_LOJA"		),PesqPict("SD2","D2_LOJA"		),TamSx3("D2_LOJA"			)[1],,{|| cLojaAnt				})
TRCell():New(oCliente,"A1_NOME"		,	,RetTitle("A1_NOME"		),PesqPict("SA1","A1_NOME"		),TamSx3("A1_NOME"			)[1],,{|| (cAliasSA1)->A1_NOME	})
TRCell():New(oCliente,"A1_OBSERV"	,	,RetTitle("A1_OBSERV"	) ,PesqPict("SA1","A1_OBSERV"	),TamSx3("A1_OBSERV"		)[1],,{|| (cAliasSA1)->A1_OBSERV	})


oReport:Section(1):SetHeaderPage()




oProduto := TRSection():New(oCliente,If( cPaisLoc $ "ANG|PTG", "Itens das Facturas de Saída", "Itens das Notas Fiscais de Saida" ),{},,,)
oProduto:SetTotalInLine( .F. )

TRCell():New(oProduto,"CCODPROD"	,,RetTitle("D2_COD"		),PesqPict("SD2","D2_COD"					),TamSx3("D2_COD"		)[1],,{|| cCodProd	})
TRCell():New(oProduto,"CDESCPROD"	,,RetTitle("B1_DESC"		),PesqPict("SB1","B1_DESC"					),TamSx3("B1_DESC"		)[1],,{|| cDescProd	})
TRCell():New(oProduto,"CDOC"		,,RetTitle("D2_DOC"		),PesqPict("SD2","D2_DOC"					),TamSx3("D2_DOC"		)[1],,{|| cDoc		})
TRCell():New(oProduto,"CSERIE" 		,,RetTitle("D2_SERIE"		),PesqPict("SD2","D2_SERIE"					),TamSx3("D2_SERIE"		)[1],,{|| cSerie		})
TRCell():New(oProduto,"DEMISSAO"	,,RetTitle("D2_EMISSAO"	),PesqPict("SD2","D2_EMISSAO"				),nTamData					,,{|| dEmissao	})
TRCell():New(oProduto,"CUM"			,,RetTitle("B1_UM"		),PesqPict("SB1","B1_UM"					),TamSx3("B1_UM"		)[1],,{|| cUM			})
TRCell():New(oProduto,"NTOTQUANT"	,,RetTitle("D2_QUANT"		),PesqPict("SD2","D2_QUANT"					),TamSx3("D2_QUANT"		)[1],,{|| nTotQuant	})
TRCell():New(oProduto,"NVLRUNIT"	,,RetTitle("D2_PRCVEN"	),PesqPict("SD2","D2_PRCVEN"				),TamSx3("D2_PRCVEN"	)[1],,{|| nVlrUnit	})
If lValadi
	TRCell():New(oProduto,"NVALADI"	,,RetTitle("D2_VALADI"	),PesqPict("SD2","D2_VALADI"				),TamSx3("D2_VALADI"	)[1],,{|| nValadi	})
EndIf
TRCell():New(oProduto,"NVLRTOT"		,,RetTitle("D2_TOTAL"		),PesqPict("SD2","D2_TOTAL"					),TamSx3("D2_TOTAL"		)[1],,{|| nVlrTot		})
TRCell():New(oProduto,"CVENDS"		,,"Vendedor"					 ,PesqPict("SF2","F2_VEND1"					),TamSx3("F2_VEND1"		)[1],,{|| cVends		})


oProduto:Cell("NTOTQUANT"):SetHeaderAlign("RIGHT")
oProduto:Cell("NVLRUNIT"):SetHeaderAlign("RIGHT")
If lValadi
	oProduto:Cell("NVALADI"):SetHeaderAlign("RIGHT")
EndIf
oProduto:Cell("NVLRTOT"):SetHeaderAlign("RIGHT")


oTotal1 := TRFunction():New(oProduto:Cell("NTOTQUANT"	),,"SUM",,,,, .T. , .T. ,)
If lValadi
	TRFunction():New(oProduto:Cell("NVALADI"	),,"SUM",,,,, .T. , .T. ,)
EndIf
oTotal2 := TRFunction():New(oProduto:Cell("NVLRTOT"	),,"SUM",,,,, .T. , .F. ,)


oTotal3 := TRFunction():New(oProduto:Cell("NTOTQUANT"	),,"SUM",,,,, .T. , .F. ,,oCliente)
If lValadi
	TRFunction():New(oProduto:Cell("NVALADI"	),,"SUM",,,,, .T. , .F. ,,oCliente)
EndIf
oTotal4 := TRFunction():New(oProduto:Cell("NVLRTOT"	),,"SUM",,,,, .T. , .T. ,,oCliente)


oReport:Section(1):Section(1):SetHeaderPage()




oTemp1 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Devoluções", "Devolucoes" ),{"SD1"},,,)
oTemp1:SetTotalInLine( .F. )




oTemp3 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Itens das Facturas de Saída", "Itens das Notas Fiscais de Saida" ),{"SD2"},,,)
oTemp3:SetTotalInLine( .F. )

oReport:Section(2):SetEditCell( .F. )
oReport:Section(3):SetEditCell( .F. )

Return(oReport)























Static Function ReportPrint(oReport,cAliasSD1,cAliasSD2,cAliasSA1)

Local  nV := 0
Local cProdAnt	  := "", cLojaAnt := ""
Local lNewProd	  := .T. 
Local nTamRef	  := Val(Substr(GetMv("MV_MASCGRD"),1,2))
Local cProdRef	  := ""
Local cUM		  := ""
Local nTotQuant	  := 0
Local nReg		  := 0
Local cFiltro	  := ""
Local cEstoq	  := If( (mv_par13 == 1),"S",If( (mv_par13 == 2),"N","SN" ))
Local cDupli	  := If( (mv_par14 == 1),"S",If( (mv_par14 == 2),"N","SN" ))
Local cArqTrab1, cArqTrab2, cCondicao1
Local aDevImpr	  := {}
Local cVends	  := ""
Local nVend		  := FA440CntVend()
Local nDevQtd	  := 0
Local nDevVal	  := 0
Local aDev		  := {}
Local nIndD2	  := 0
Local aStru
Local lNfD2Ori	  := .F. 
Local cVendedores := ""
Local lNewCli     := .T. 
Local lValadi		:= cPaisLoc == "MEX" .AND.  SD2->(FieldPos("D2_VALADI")) > 0

	Local nj	:= 0
	Local cWhere:= ""




Private nIndD1  :=0
Private nDecs	:=msdecimais(mv_par09)






oReport:Section(1):Cell("CCLIEANT" 	):SetBlock({|| cClieAnt		})
oReport:Section(1):Cell("CLOJA" 	):SetBlock({|| cLojaAnt		})
oReport:Section(1):Section(1):Cell("CCODPROD" 	):SetBlock({|| cCodProd		})
oReport:Section(1):Section(1):Cell("CDESCPROD" ):SetBlock({|| cDescProd	})
oReport:Section(1):Section(1):Cell("CDOC"		):SetBlock({|| cDoc			})
oReport:Section(1):Section(1):Cell("CSERIE" 	):SetBlock({|| cSerie 		})
oReport:Section(1):Section(1):Cell("DEMISSAO" 	):SetBlock({|| dEmissao		})
oReport:Section(1):Section(1):Cell("CUM"		):SetBlock({|| cUM			})
oReport:Section(1):Section(1):Cell("NTOTQUANT"	):SetBlock({|| nTotQuant	})
oReport:Section(1):Section(1):Cell("NVLRUNIT" 	):SetBlock({|| nVlrUnit		})
If lValadi
	oReport:Section(1):Section(1):Cell("NVALADI" 	):SetBlock({|| nValadi		})
EndIf
oReport:Section(1):Section(1):Cell("NVLRTOT" 	):SetBlock({|| nVlrTot		})
oReport:Section(1):Section(1):Cell("CVENDS" 	):SetBlock({|| cVends		})




SF1->(dbsetorder(1))
SF2->(dbsetorder(1))
SB1->(dbSetOrder(1))
SA7->(dbSetOrder(2))




oReport:SetTitle(oReport:Title() + " " + "Valores em " +GetMV("MV_SIMB"+Str(mv_par09,1)))




MakeSqlExpr(oReport:uParam)




dbSelectArea("SD1")
cArqTrab1  := CriaTrab( "" , .F.  )

    If (TcSrvType()#"AS/400")
        cSD1   := "SD1TMP"
	    aStru  := dbStruct()
        cWhere := "%NOT ("+IsRemito(3,"SD1.D1_TIPODOC")+ ")%"
        oReport:Section(2):BeginQuery()











__execSql(cAliasSD1," SELECT * FROM  "+RetSqlName('SD1')+" SD1 WHERE SD1.D1_FILIAL =  '" +xFilial('SD1')+"'  AND SD1.D1_FORNECE >=  "+___SQLGetValue(MV_PAR01)+" AND SD1.D1_FORNECE <=  "+___SQLGetValue(MV_PAR02)+" AND SD1.D1_DTDIGIT >=  "+___SQLGetValue(DTOS(MV_PAR03))+" AND SD1.D1_DTDIGIT <=  "+___SQLGetValue(DTOS(MV_PAR04))+" AND SD1.D1_COD >=  "+___SQLGetValue(MV_PAR05)+" AND SD1.D1_COD <=  "+___SQLGetValue(MV_PAR06)+" AND SD1.D1_TIPO = 'D' AND  "+___SQLGetValue(CWHERE)+" AND SD1.D_E_L_E_T_= ' ' ORDER BY SD1.D1_FILIAL,SD1.D1_FORNECE,SD1.D1_LOJA,SD1.D1_COD",{},.F.)
	    oReport:Section(2):EndQuery()

	    A780CriaTmp(cArqTrab1, aStru, cSD1, cALiasSD1 )
	    IndRegua(cSD1,cArqTrab1,"D1_FILIAL+D1_FORNECE+D1_LOJA+D1_COD",,".T.",If( cPaisLoc $ "ANG|PTG", "A seleccionar registos...", "Selecionando Registros..." ))
	Else

	    cSD1	   := "SD1"
		dbSelectArea("SD1")
	    cCondicao1 := 'D1_FILIAL=="' + xFilial("SD1") + '".And.'
	    cCondicao1 += 'D1_FORNECE>="' + mv_par01 + '".And.'
	    cCondicao1 += 'D1_FORNECE<="' + mv_par02 + '".And.'
	    cCondicao1 += 'DtoS(D1_DTDIGIT)>="' + DtoS(mv_par03) + '".And.'
	    cCondicao1 += 'DtoS(D1_DTDIGIT)<="' + DtoS(mv_par04) + '".And.'
	    cCondicao1 += 'D1_COD>="' + mv_par05 + '".And.'
	    cCondicao1 += 'D1_COD<="' + mv_par06 + '".And.'
	    cCondicao1 += 'D1_TIPO=="D" .And. !('+IsRemito(2,"SD1->D1_TIPODOC")+")"

	    cArqTrab1  := CriaTrab("", .F. )
	    IndRegua(cSD1,cArqTrab1,"D1_FILIAL+D1_FORNECE+D1_LOJA+D1_COD",,cCondicao1,If( cPaisLoc $ "ANG|PTG", "A seleccionar registos...", "Selecionando Registros..." ))
	    nIndD1 := RetIndex()





	    dbSetOrder(nIndD1+1)

    Endif






DbSelectArea("SD2")
cFiltro := SD2->(dbFilter())
If Empty(cFiltro)
	bFiltro := { || .T.  }
Else
	cFiltro := "{ || " + cFiltro + " }"
	bFiltro := &(cFiltro)
Endif




DbSelectArea("SD2")
cArqTrab2  := CriaTrab( "" , .F.  )

    If (TcSrvType()#"AS/400")
	    cSD2   := "SD2TMP"
	    aStru  := dbStruct()
        cWhere := "%NOT ("+IsRemito(3,"SD2.D2_TIPODOC")+ ")%"
        oReport:Section(3):BeginQuery()











__execSql(cAliasSD2," SELECT * FROM  "+RetSqlName('SD2')+" SD2 WHERE SD2.D2_FILIAL =  '" +xFilial('SD2')+"'  AND SD2.D2_CLIENTE BETWEEN  "+___SQLGetValue(MV_PAR01)+" AND  "+___SQLGetValue(MV_PAR02)+" AND SD2.D2_EMISSAO BETWEEN  "+___SQLGetValue(DTOS(MV_PAR03))+" AND  "+___SQLGetValue(DTOS(MV_PAR04))+" AND SD2.D2_COD BETWEEN  "+___SQLGetValue(MV_PAR05)+" AND  "+___SQLGetValue(MV_PAR06)+" AND SD2.D2_TIPO <> 'B' AND SD2.D2_TIPO <> 'D' AND  "+___SQLGetValue(CWHERE)+" AND SD2.D_E_L_E_T_= ' ' ORDER BY SD2.D2_FILIAL,SD2.D2_CLIENTE,SD2.D2_LOJA,SD2.D2_COD,SD2.D2_ITEM",{},.F.)
	    oReport:Section(3):EndQuery()

	    A780CriaTmp(cArqTrab2, aStru, cSD2, cAliasSD2)
	    IndRegua(cSD2,cArqTrab2,"D2_FILIAL+D2_CLIENTE+D2_LOJA+D2_COD+D2_SERIE+D2_DOC+D2_ITEM",,".T.",If( cPaisLoc $ "ANG|PTG", "A seleccionar registos...", "Selecionando Registros..." ))

    Else

	    cSD2	   := "SD2"
	    cCondicao := 'D2_FILIAL == "' + xFilial("SD2") + '" .And. '
	    cCondicao += 'D2_CLIENTE >= "' + mv_par01 + '" .And. '
	    cCondicao += 'D2_CLIENTE <= "' + mv_par02 + '" .And. '
	    cCondicao += 'DTOS(D2_EMISSAO) >= "' + DTOS(mv_par03) + '" .And. '
	    cCondicao += 'DTOS(D2_EMISSAO) <= "' + DTOS(mv_par04) + '" .And. '
	    cCondicao += 'D2_COD >= "' + mv_par05 + '" .And. '
	    cCondicao += 'D2_COD <= "' + mv_par06 + '" .And. '
	    cCondicao += '!(D2_TIPO $ "BD")'
	    cCondicao += ".And. !("+IsRemito(2,"SD2->D2_TIPODOC")+")"

	    IndRegua("SD2",cArqTrab2,"D2_FILIAL+D2_CLIENTE+D2_LOJA+D2_COD+D2_SERIE+D2_DOC+D2_ITEM",,cCondicao,If( cPaisLoc $ "ANG|PTG", "A seleccionar registos...", "Selecionando Registros..." ))
	    nIndD2 := RetIndex()





	    dbSetOrder(nIndD2+1)

	Endif



dbSelectArea("SA1")
dbSetOrder(1)

    oReport:Section(1):BeginQuery()








__execSql(cALiasSA1," SELECT A1_FILIAL,A1_COD,A1_LOJA,A1_NOME,A1_OBSERV FROM  "+RetSqlName('SA1')+" SA1 WHERE SA1.A1_FILIAL =  '" +xFilial('SA1')+"'  AND SA1.A1_COD >=  "+___SQLGetValue(MV_PAR01)+" AND SA1.A1_COD <=  "+___SQLGetValue(MV_PAR02)+" AND SA1.D_E_L_E_T_= ' ' ORDER BY A1_FILIAL,A1_COD",{},.F.)
    oReport:Section(1):EndQuery()





oReport:SetMeter(RecCount())

If ( (cSD2)->D2_GRADE=="S" .And.  MV_PAR12 == 1)
	lGrade := .T. 
	bGrade := { || Substr((cSD2)->D2_COD, 1, nTamref) }
Else
	lGrade := .F. 
	bGrade := { || (cSD2)->D2_COD }
Endif







While !oReport:Cancel() .And.  (cAliasSA1)->( ! EOF() .AND.  A1_COD <= MV_PAR02 ) .And.  (cAliasSA1)->A1_FILIAL == xFilial("SA1")




	DbSelectArea(cSD2)
	If DbSeek(xFilial("SD2")+(cAliasSA1)->A1_COD+(cAliasSA1)->A1_LOJA)
		lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)




		cClieAnt := (cAliasSA1)->A1_COD
		cLojaAnt := (cAliasSA1)->A1_LOJA
		lNewProd := .T. 
		lNewCli  := .T. 

		While !oReport:Cancel() .And. !Eof() .and.  ((cSD2)->(D2_FILIAL+D2_CLIENTE+D2_LOJA)) == (xFilial("SD2")+cClieAnt+cLojaAnt)






			lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)
			If	! Eval(bFiltro) .Or.  !A780Vend(@cVends,nVend) .Or.  !lRet
				dbSkip()
				Loop
			EndIf




			cProdAnt := Eval(bGrade)
			lNewProd := .T. 
			oReport:Section(1):Section(1):Init()


			While !oReport:Cancel() .And.  ! Eof() .And.  (cSD2)->(D2_FILIAL + D2_CLIENTE + D2_LOJA  + EVAL(bGrade) ) == ( xFilial("SD2") + cClieAnt   + cLojaAnt + cProdAnt )
				oReport:IncMeter()




				lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)
				If !AvalTes((cSD2)->D2_TES,cEstoq,cDupli) .Or.  !Eval(bFiltro) .Or.  !lRet
					dbSkip()
					Loop
				Endif

				If !A780Vend(@cVends,nVend)
					dbskip()
					Loop
				Endif

				If lNewCli
					oReport:Section(1):Init()
					oReport:Section(1):PrintLine()
					lNewCli := .F. 
				EndIf



				If lNewProd
					lNewProd := .F. 
					oReport:Section(1):Section(1):Cell("CCODPROD"	):Show()
					oReport:Section(1):Section(1):Cell("CDESCPROD"	):Show()
				Else
					oReport:Section(1):Section(1):Cell("CCODPROD"	):Hide()
					oReport:Section(1):Section(1):Cell("CDESCPROD"	):Hide()
				EndIf




				If lGrade
					cProdRef:= Substr((cSD2)->D2_COD,1,nTamRef)
					cNumPed := (cSD2)->D2_PEDIDO
					nReg    := 0
					nDevQtd := 0
					nDevVal := 0



					While !oReport:Cancel() .And.  !Eof() .And.  cProdRef == Eval(bGrade) .And.  (cSD2)->D2_GRADE == "S" .And.  cNumPed == (cSD2)->D2_PEDIDO .And.  (cSD2)->D2_FILIAL == xFilial("SD2")

						nReg := Recno()



						lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)
						If !lRet .Or.  !Eval(bFiltro)
							dbSkip()
							Loop
						EndIf




						If mv_par10 == 1
							SomaDev(@nDevQtd, @nDevVal , @aDev, cEstoq, cDupli)
						EndIf

						nTotQuant += (cSD2)->D2_QUANT
						dbSkip()

					EndDo




					If nReg > 0
						dbGoto(nReg)
						nReg:=0
					EndIf

				Else



					nDevQtd :=0
					nDevVal :=0

					If mv_par10 == 1
						SomaDev(@nDevQtd, @nDevVal , @aDev, cEstoq, cDupli)
					EndIf

					nTotQuant := (cSD2)->D2_QUANT

				EndIf




				SB1->(dbSeek(xFilial("SB1")+(cSD2)->D2_COD))
				If mv_par16 = 1
					cDescProd := SB1->B1_DESC
				Else
					If SA7->(dbSeek(xFilial("SA7")+(cSD2)->(D2_COD+D2_CLIENTE+D2_LOJA)))
						cDescProd := SA7->A7_DESCCLI
					Else
						cDescProd := SB1->B1_DESC
					Endif
				EndIf

				SF2->(dbSeek(xFilial("SF2")+(cSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA)))
				cUM      := (cSD2)->D2_UM
				cDoc     := (cSD2)->D2_DOC
				cSerie   := (cSD2)->D2_SERIE
				dEmissao := (cSD2)->D2_EMISSAO




				nVlrUnit := xMoeda((cSD2)->D2_PRCVEN,SF2->F2_MOEDA,MV_PAR09,(cSD2)->D2_EMISSAO,nDecs+1,SF2->F2_TXMOEDA)
				If lValadi
					nValadi := xMoeda((cSD2)->D2_VALADI,SF2->F2_MOEDA,MV_PAR09,(cSD2)->D2_EMISSAO,nDecs+1,SF2->F2_TXMOEDA)
				EndIf
				If (cSD2)->D2_TIPO $ "CIP"
					If cPaisLoc == "BRA"
						nVlrTot:= nVlrUnit
					ElseIf (cSD2)->D2_TIPO $ "C"
						nVlrTot:= nTotQuant * nVlrUnit
					EndIf
				Else
					If (cSD2)->D2_GRADE == "S" .And.  MV_PAR12 == 1
						nVlrTot:= nVlrUnit * nTotQuant
					Else
						nVlrTot:=xmoeda((cSD2)->D2_TOTAL,SF2->F2_MOEDA,mv_par09,(cSD2)->D2_EMISSAO,nDecs+1,SF2->F2_TXMOEDA)
					EndIf
				EndIf

				cCodProd 	:= Eval(bGrade)
				A780Vend(@cVends,nVend)
				cVendedores := cVends
				cVends 		:= Subs(cVendedores,1,7)
				oReport:Section(1):Section(1):PrintLine()




				oReport:section(1):section(1):Cell("CCODPROD"	):Hide()
				oReport:section(1):section(1):Cell("CDESCPROD"	):Hide()
				oReport:section(1):section(1):Cell("CDOC"		):Hide()
				oReport:section(1):section(1):Cell("CSERIE"	):Hide()
				oReport:section(1):section(1):Cell("DEMISSAO"	):Hide()
				oReport:section(1):section(1):Cell("CUM"		):Hide()
				oReport:section(1):section(1):Cell("NTOTQUANT"	):Hide()
				oReport:section(1):section(1):Cell("NVLRUNIT"	):Hide()
				If lValadi
					oReport:section(1):section(1):Cell("NVALADI"	):Hide()
				EndIf
				oReport:section(1):section(1):Cell("NVLRTOT"	):Hide()

				nTotQuant := 0
				nVlrTot   := 0
				For nV := 8 to Len(cVendedores)
					cVends := Space(20)+Subs(cVendedores,nV,7)
				   	oReport:Section(1):Section(1):PrintLine()
					nV += 6
				Next

				oReport:section(1):section(1):Cell("CCODPROD"	):Show()
				oReport:section(1):section(1):Cell("CDESCPROD"	):Show()
				oReport:section(1):section(1):Cell("CDOC"		):Show()
				oReport:section(1):section(1):Cell("CSERIE"	):Show()
				oReport:section(1):section(1):Cell("DEMISSAO"	):Show()
				oReport:section(1):section(1):Cell("CUM"		):Show()
				oReport:section(1):section(1):Cell("NTOTQUANT"	):Show()
				oReport:section(1):section(1):Cell("NVLRUNIT"	):Show()
				If lValadi
					oReport:section(1):section(1):Cell("NVALADI"	):Show()
				EndIf
				oReport:section(1):section(1):Cell("NVLRTOT"	):Show()





				If nDevQtd<>0
					cSerie 	  := If( cPaisLoc $ "ANG|PTG", "Dev", "DEV" )
					nVlrTot   := nDevVal
					nTotQuant := nDevQtd

					oReport:Section(1):Section(1):Cell("CDOC"		):Hide()
					oReport:Section(1):Section(1):Cell("DEMISSAO"	):Hide()
					oReport:Section(1):Section(1):Cell("NVLRUNIT"	):Hide()
					If lValadi
						oReport:section(1):section(1):Cell("NVALADI"	):Hide()
					EndIf
					oReport:Section(1):Section(1):Cell("CVENDS"	):Hide()

					oReport:Section(1):Section(1):PrintLine()

					oReport:Section(1):Section(1):Cell("CDOC"		):Show()
					oReport:Section(1):Section(1):Cell("DEMISSAO"	):Show()
					oReport:Section(1):Section(1):Cell("NVLRUNIT"	):Show()
					If lValadi
						oReport:section(1):section(1):Cell("NVALADI"	):Show()
					EndIf
					oReport:Section(1):Section(1):Cell("CVENDS"	):Show()

				EndIf
				nTotQuant := 0
				dbSkip()

			EndDo




			oReport:Section(1):Section(1):SetTotalText(If( cPaisLoc $ "ANG|PTG", "TOTAL DO ARTIGO - ", "TOTAL DO PRODUTO - " ) + cProdAnt)
			oReport:Section(1):Section(1):Finish()

		EndDo
		oReport:Section(1):SetTotalText(If( cPaisLoc $ "ANG|PTG", "Total do cliente - ", "TOTAL DO CLIENTE - " ) + cClieAnt)
		If !lNewCli
			oReport:section(1):Finish()
		EndIf
		cClieAnt := ""
		cLojaAnt := ""

	EndIf



	DbSelectArea(cSD1)
	If DbSeek(xFilial("SD1")+(cAliasSA1)->A1_COD+(cAliasSA1)->A1_LOJA)
		lRet:=ValidMasc((cSD1)->D1_COD,MV_PAR11)




		If mv_par10 == 1




			oReport:Section(1):Init()

			While !oReport:Cancel() .And.  (cSD1)->(D1_FILIAL + D1_FORNECE + D1_LOJA) == ( xFilial("SD1") + (cAliasSA1)->A1_COD+ (cAliasSA1)->A1_LOJA) .AND.  ! Eof()
				lRet:=ValidMasc((cSD1)->D1_COD,MV_PAR11)





				CtrlVndDev := .F. 
				lNfD2Ori   := .F. 
				If AvalTes((cSD1)->D1_TES,cEstoq,cDupli)
					dbSelectArea("SD2")
					nSavOrd := IndexOrd()
					dbSetOrder(3)

					dbSeek(xFilial("SD2")+(cSD1)->(D1_NFORI+D1_SERIORI+D1_FORNECE+D1_LOJA+D1_COD))

					While !oReport:Cancel() .And.  !Eof() .And.  (xFilial("SD2")+(cSD1)->(D1_NFORI+D1_SERIORI+D1_FORNECE+D1_LOJA+D1_COD)) == D2_FILIAL+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_COD

						lRet:=ValidMasc((cSD1)->D1_COD,MV_PAR11)

						If !Empty((cSD1)->D1_ITEMORI) .AND.  AllTrim((cSD1)->D1_ITEMORI) <> D2_ITEM .Or.  !lRet .Or.  !Eval(bFiltro)
							dbSkip()
							Loop
						Else
							CtrlVndDev := A780Vend(@cVends,nVend)
							If Ascan(aDev,D2_CLIENTE + D2_LOJA + D2_COD + D2_DOC + D2_SERIE + D2_ITEM) > 0
								lNfD2Ori := .T. 
							EndIf
						Endif
						dbSkip()
					End

					dbSelectArea("SD2")
					dbSetOrder(nSavOrd)
					dbSelectArea(cSD1)

					If !(CtrlVndDev) .Or.  lNfD2Ori
						dbSkip()
						Loop
					EndIf

					SF1->(dbSeek(xFilial("SF1")+(cSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))
					cUM := (cSD1)->D1_UM
					cDoc := (cSD1)->D1_DOC
					cSerie := (cSD1)->D1_SERIE
					dEmissao := (cSD1)->D1_EMISSAO
					nVlrTot:=xMoeda((cSD1)->(D1_TOTAL-D1_VALDESC),SF1->F1_MOEDA,mv_par09,(cSD1)->D1_DTDIGIT,nDecs,SF1->F1_TXMOEDA)
					If SD2TMP->(EOF()) .And.  SD1TMP->(!EOF())
						cClieAnt := (cAliasSA1)->A1_COD
						cLojaAnt := (cAliasSA1)->A1_LOJA
						cCodProd := D1_COD
						cDescProd := Posicione("SB1",1,xFilial("SB1")+cCodProd,"B1_DESC")
						cDoc := D1_DOC
						cSerie := D1_SERIE
						dEmissao := D1_EMISSAO
						cUM := D1_UM
						nTotQuant := D1_QUANT * -1
						nVlrUnit := D1_VUNIT * -1
						nVlrTot := D1_TOTAL * -1
						cVends := cVends
						oReport:Section(1):PrintLine()
						oReport:Section(1):Section(1):Init()
					EndIf
					oReport:Section(1):Section(1):PrintLine()
				Endif
				dbSkip()
			EndDo
		EndIf

	Endif

	DbSelectArea(cAliasSA1)
	DbSkip()
EndDo

(cSD1)->(DbCloseArea())
(cSD2)->(DbCloseArea())

Return






























Function Matr780R3()



LOCAL wnrel
LOCAL tamanho:=IIF(cPaisLoc=="MEX","G","M")
LOCAL titulo := OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Estatisticas de Vendas (Cliente x Artigo)", "Estatisticas de Vendas (Cliente x Produto)" ))
LOCAL cDesc1 := OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Este Programa Irá Emitir A Relação Das Compras Efectuadas Pelo Cliente,", "Este programa ira emitir a relacao das compras efetuadas pelo Cliente," ))
LOCAL cDesc2 := OemToAnsi(If( cPaisLoc $ "ANG|PTG", "A totalizar por artigo e a escolher a moeda forte para os valores.", "totalizando por produto e escolhendo a moeda forte para os Valores." ))
LOCAL cDesc3 := ""
LOCAL cString:= "SD2"

PRIVATE aReturn := { OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Código de barras", "Zebrado" )), 1,OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Administração", "Administracao" )), 1, 2, 1, "",1 }
PRIVATE nomeprog:="MATR780"
PRIVATE nLastKey := 0
PRIVATE cPerg   :="MR780A"




pergunte("MR780A", .F. )


























titulo := If( cPaisLoc $ "ANG|PTG", "Estatisticas De Vendas (cliente X Artigo)", "ESTATISTICAS DE VENDAS (Cliente X Produto)" )
Cabec1 := If( cPaisLoc $ "ANG|PTG", "Cliente   Razao Social", "CLIENTE   RAZAO SOCIAL" )
Cabec2 := If( cPaisLoc $ "ANG|PTG", "ARTIGO         DESCRICAO                  FACTURA        EMISSAO   UN   QUANTIDADE    PRECO UNITARIO            TOTAL  VENDEDOR", "PRODUTO         DESCRICAO                  NOTA FISCAL        EMISSAO   UN   QUANTIDADE    PRECO UNITARIO            TOTAL  VENDEDOR" )


wnrel:="MATR780"

wnrel:=SetPrint(cString,wnrel,cPerg,@Titulo,cDesc1,cDesc2,cDesc3, .F. ,"",,Tamanho,, .T. )

If nLastKey==27
	dbClearFilter()
	Return
Endif

SetDefault(aReturn,cString)

If nLastKey==27
	dbClearFilter()
	Return
Endif

RptStatus({|lEnd| C780Imp(@lEnd,wnRel,cString)},Titulo)

Return














Static Function C780Imp(lEnd,WnRel,cString)

LOCAL CbTxt
LOCAL CbCont,cabec1,cabec2,cabec3
LOCAL nTotCli1:= 0,nTotCli2:=0,nTotGer1 := 0,nTotGer2 := 0
LOCAL nOrdem
LOCAL tamanho:= "M"
LOCAL limite := IIF(cPaisLoc=="MEX",144,132)
LOCAL titulo := OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Estatisticas De Vendas (cliente X Artigo)", "ESTATISTICAS DE VENDAS (Cliente X Produto)" ))
LOCAL cDesc1 := OemToAnsi(If( cPaisLoc $ "ANG|PTG", "Este Programa Irá Emitir A Relação Das Compras Efectuadas Pelo Cliente,", "Este programa ira emitir a relacao das compras efetuadas pelo Cliente," ))
LOCAL cDesc2 := OemToAnsi(If( cPaisLoc $ "ANG|PTG", "A totalizar por artigo e a escolher a moeda forte para os valores.", "totalizando por produto e escolhendo a moeda forte para os Valores." ))
LOCAL cDesc3 := ""
LOCAL cMoeda
LOCAL nAcN1  := 0, nAcN2 := 0, nV := 0
LOCAL cClieAnt := "", cProdAnt := "", cLojaAnt := ""
LOCAL lContinua := .T.  , lProcessou := .F.  , lNewProd := .T. 
LOCAL cMascara :=GetMv("MV_MASCGRD")
LOCAL nTamRef  :=Val(Substr(cMascara,1,2))
LOCAL nTamLin  :=Val(Substr(cMascara,4,2))
LOCAL nTamCol  :=Val(Substr(cMascara,7,2))
LOCAL cProdRef :=""
Local cUM      :=""
LOCAL nTotQuant:=0
LOCAL nReg     :=0
LOCAL cFiltro  := ""
Local cEstoq := If( (mv_par13 == 1),"S",If( (mv_par13 == 2),"N","SN" ))
Local cDupli := If( (mv_par14 == 1),"S",If( (mv_par14 == 2),"N","SN" ))
Local cArqTrab1, cArqTrab2, cCondicao1
Local aDevImpr := {}
Local cVends   := ""
Local nVend    := FA440CntVend()
Local nDevQtd 	:=0
Local nDevVal 	:=0
Local aDev		:={}
Local nIndD2    :=0
Local cQuery, aStru
Local lNfD2Ori   := .F. 

Local aColuna   := IIf(cPaisLoc=="MEX",{46,71,82,86,99,116,135},{46,61,72,76,89,106,125})

	Local nj := 0
	Local cAliasSA1 := "SA1"


Private cSD1, cSD2
Private nIndD1  :=0
Private nDecs:=msdecimais(mv_par09)




SF1->(dbsetorder(1))
SF2->(dbsetorder(1))
SB1->(dbSetOrder(1))
SA7->(dbSetOrder(2))




titulo := If( cPaisLoc $ "ANG|PTG", "Estatisticas De Vendas (cliente X Artigo)", "ESTATISTICAS DE VENDAS (Cliente X Produto)" )
Cabec1 := If( cPaisLoc $ "ANG|PTG", "Cliente  Razao Social", "CLIENTE  RAZAO SOCIAL" )

Cabec2 := If( cPaisLoc $ "ANG|PTG", "ARTIGO         DESCRICAO                  FACTURA        EMISSAO   UN   QUANTIDADE    PRECO UNITARIO            TOTAL  VENDEDOR", "PRODUTO         DESCRICAO                  NOTA FISCAL        EMISSAO   UN   QUANTIDADE    PRECO UNITARIO            TOTAL  VENDEDOR" )
If cPaisLoc=="MEX"
   Cabec2 := Substr(Cabec2,1,54)+space(10)+Substr(Cabec2,55)
EndIf




cbtxt    := SPACE(10)
cbcont   := 0
li       := 80
m_pag    := 1

cMoeda := "Valores em "+GetMV("MV_SIMB"+Str(mv_par09,1))
titulo := titulo+" "+cMoeda





dbSelectArea("SD1")
cArqTrab1  := CriaTrab( "" , .F.  )

    If (TcSrvType()#"AS/400")



	    cSD1   := "SD1TMP"
	    aStru  := dbStruct()
	    cQuery := "SELECT * FROM " + RetSqlName("SD1") + " SD1 "
	    cQuery += "WHERE SD1.D1_FILIAL = '"+xFilial("SD1")+"' AND "
	    cQuery += "SD1.D1_FORNECE BETWEEN '"+mv_par01+"' AND '"+mv_par02+"' AND "
	    cQuery += "SD1.D1_DTDIGIT BETWEEN '"+DtoS(mv_par03)+"' AND '"+DtoS(mv_par04)+ "' AND "
	    cQuery += "SD1.D1_COD BETWEEN '"+mv_par05+"' AND '"+mv_par06+"' AND "
	    cQuery += "SD1.D1_TIPO = 'D' AND "
    	 cQuery += " NOT ("+IsRemito(3,"SD1.D1_TIPODOC")+ ") AND "
	    cQuery += "SD1.D_E_L_E_T_ <> '*' "
	    cQuery += " ORDER BY SD1.D1_FILIAL,SD1.D1_FORNECE,SD1.D1_LOJA,SD1.D1_COD"
	    cQuery := ChangeQuery(cQuery)
	    MsAguarde({|| dbUseArea( .T. , "TOPCONN", TCGenQry(,,cQuery),"SD1TRB", .F. , .T. )},OemToAnsi(If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." )))
	    For nj := 1 to Len(aStru)
		    If aStru[nj,2] <> "C"
			   TCSetField("SD1TRB", aStru[nj,1], aStru[nj,2],aStru[nj,3],aStru[nj,4])
		    EndIf
	    next
	    A780CriaTmp(cArqTrab1, aStru, cSD1, "SD1TRB")
	    IndRegua(cSD1,cArqTrab1,"D1_FILIAL+D1_FORNECE+D1_LOJA+D1_COD",,".T.",If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
	Else

	    cSD1	   := "SD1"
	    cCondicao1 := 'D1_FILIAL=="' + xFilial("SD1") + '".And.'
	    cCondicao1 += 'D1_FORNECE>="' + mv_par01 + '".And.'
	    cCondicao1 += 'D1_FORNECE<="' + mv_par02 + '".And.'
	    cCondicao1 += 'DtoS(D1_DTDIGIT)>="' + DtoS(mv_par03) + '".And.'
	    cCondicao1 += 'DtoS(D1_DTDIGIT)<="' + DtoS(mv_par04) + '".And.'
	    cCondicao1 += 'D1_COD>="' + mv_par05 + '".And.'
	    cCondicao1 += 'D1_COD<="' + mv_par06 + '".And.'
	    cCondicao1 += 'D1_TIPO=="D" .And. !('+IsRemito(2,"SD1->D1_TIPODOC")+")"

	    cArqTrab1  := CriaTrab("", .F. )
	    IndRegua(cSD1,cArqTrab1,"D1_FILIAL+D1_FORNECE+D1_LOJA+D1_COD",,cCondicao1,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
	    nIndD1 := RetIndex()





	    dbSetOrder(nIndD1+1)

    Endif


dbSeek(xFilial("SD1"))




DbSelectArea("SD2")
cFiltro := SD2->(dbFilter())
If Empty(cFiltro)
	bFiltro := { || .T.  }
Else
	cFiltro := "{ || " + cFiltro + " }"
	bFiltro := &(cFiltro)
Endif



cArqTrab2  := CriaTrab( "" , .F.  )

    If (TcSrvType()#"AS/400")



	    cSD2   := "SD2TMP"
	    aStru  := dbStruct()
	    cQuery := "SELECT * FROM " + RetSqlName("SD2") + " SD2 "
	    cQuery += "WHERE SD2.D2_FILIAL = '"+xFilial("SD2")+"' AND "
	    cQuery += "SD2.D2_CLIENTE BETWEEN '"+mv_par01+"' AND '"+mv_par02+"' AND "
	    cQuery += "SD2.D2_EMISSAO BETWEEN '"+DTOS(mv_par03)+"' AND '"+DTOS(mv_par04)+"' AND "
	    cQuery += "SD2.D2_COD     BETWEEN '"+ mv_par05+"' AND '"+mv_par06+"' AND "
	    cQuery += "SD2.D2_TIPO <> 'B' AND SD2.D2_TIPO <> 'D' AND "
    	 cQuery += " NOT ("+IsRemito(3,"SD2.D2_TIPODOC")+ ") AND "
	    cQuery += "SD2.D_E_L_E_T_ <> '*' "
	    cQuery += "ORDER BY SD2.D2_FILIAL,SD2.D2_CLIENTE,SD2.D2_LOJA,SD2.D2_COD,SD2.D2_ITEM"
	    cQuery := ChangeQuery(cQuery)
	    MsAguarde({|| dbUseArea( .T. , "TOPCONN", TCGenQry(,,cQuery),"SD2TRB", .F. , .T. )},OemToAnsi(If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." )))
	    For nj := 1 to Len(aStru)
		    If aStru[nj,2] <> "C"
			    TCSetField("SD2TRB", aStru[nj,1], aStru[nj,2],aStru[nj,3],aStru[nj,4])
		    EndIf
	    next

	    A780CriaTmp(cArqTrab2, aStru, cSD2, "SD2TRB")
	    IndRegua(cSD2,cArqTrab2,"D2_FILIAL+D2_CLIENTE+D2_LOJA+D2_COD+D2_SERIE+D2_DOC+D2_ITEM",,".T.",If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
    Else

	    cSD2	  := "SD2"
	    cCondicao := 'D2_FILIAL == "' + xFilial("SD2") + '" .And. '
	    cCondicao += 'D2_CLIENTE >= "' + mv_par01 + '" .And. '
	    cCondicao += 'D2_CLIENTE <= "' + mv_par02 + '" .And. '
	    cCondicao += 'DTOS(D2_EMISSAO) >= "' + DTOS(mv_par03) + '" .And. '
	    cCondicao += 'DTOS(D2_EMISSAO) <= "' + DTOS(mv_par04) + '" .And. '
	    cCondicao += 'D2_COD >= "' + mv_par05 + '" .And. '
	    cCondicao += 'D2_COD <= "' + mv_par06 + '" .And. '
	    cCondicao += '!(D2_TIPO $ "BD")'
	    cCondicao += ".And. !("+IsRemito(2,"SD2->D2_TIPODOC")+")"

	    IndRegua(cString,cArqTrab2,"D2_FILIAL+D2_CLIENTE+D2_LOJA+D2_COD+D2_SERIE+D2_DOC+D2_ITEM",,cCondicao,If( cPaisLoc $ "ANG|PTG", "A Seleccionar Registos...", "Selecionando Registros..." ))
	    nIndD2 := RetIndex()





	    dbSetOrder(nIndD2+1)

	Endif



dbSelectArea("SA1")
dbSetOrder(1)

    cAliasSA1 := GetNextAlias()
    aStru  := dbStruct()
    cQuery := "SELECT A1_FILIAL,A1_COD,A1_LOJA,A1_NOME,A1_OBSERV "
    cQuery += "FROM " + RetSqlName("SA1") + " SA1 "
    cQuery += "WHERE SA1.A1_FILIAL = '"+xFilial("SA1")+"' AND "
    cQuery += "SA1.A1_COD >= '"        +MV_PAR01+"' AND "
	cQuery += "SA1.A1_COD <= '"        +MV_PAR02+"' AND "
    cQuery += "SA1.D_E_L_E_T_ = ' ' "
    cQuery += " ORDER BY "+SqlOrder(SA1->(IndexKey()))
    cQuery := ChangeQuery(cQuery)
    dbUseArea( .T. , "TOPCONN", TCGenQry(,,cQuery),cAliasSA1, .F. , .T. )







SetRegua(RecCount())

If ( (cSD2)->D2_GRADE=="S" .And.  MV_PAR12 == 1)
	lGrade := .T. 
	bGrade := { || Substr((cSD2)->D2_COD, 1, nTamref) }
Else
	lGrade := .F. 
	bGrade := { || (cSD2)->D2_COD }
Endif







While (cAliasSA1)->( ! EOF() .AND.  A1_COD <= MV_PAR02 ) .And.  lContinua .And.  (cAliasSA1)->A1_FILIAL == xFilial("SA1")

	If lEnd
		PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
		lContinua := .F. 
		Exit
	EndIf

	lNewCli := .T. 




	DbSelectArea(cSD2)
	If DbSeek(xFilial("SD2")+(cAliasSA1)->A1_COD+(cAliasSA1)->A1_LOJA)
		lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)




		cClieAnt := (cAliasSA1)->A1_COD
		cLojaAnt := (cAliasSA1)->A1_LOJA
		lNewProd := .T. 
		lNewCli  := .T. 
		nTotCli1 := 0
		nTotCli2 := 0

		While !Eof() .and.  ((cSD2)->(D2_FILIAL+D2_CLIENTE+D2_LOJA)) == (xFilial("SD2")+cClieAnt+cLojaAnt)






			lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)
			If	! Eval(bFiltro) .Or.  !A780Vend(@cVends,nVend) .Or.  !lRet
				dbSkip()
				Loop
			EndIf




			If Li > 55
				cabec(titulo,cabec1,cabec2,nomeprog,tamanho,15)
				lProcessou := .T. 
			EndIf





			cProdAnt := Eval(bGrade)
			lNewProd := .T. 



			While ! Eof() .And.  (cSD2)->(D2_FILIAL + D2_CLIENTE + D2_LOJA  + EVAL(bGrade) ) == ( xFilial("SD2") + cClieAnt   + cLojaAnt + cProdAnt )
				IncRegua()




				lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)
				If !AvalTes((cSD2)->D2_TES,cEstoq,cDupli) .Or.  !Eval(bFiltro) .Or.  !lRet
					dbSkip()
					Loop
				Endif

				If !A780Vend(@cVends,nVend)
					dbskip()
					Loop
				Endif




				If lNewCli

					If Li > 51
						cabec(titulo,cabec1,cabec2,nomeprog,tamanho,15)
						lProcessou := .T. 
					EndIf

					PrintOut(Li,000,Repli("-",limite),,)
					Li++
					PrintOut(Li,000,(cSD2)->D2_CLIENTE+"   "+(cAliasSA1)->A1_NOME,,)
					If !Empty((cAliasSA1)->A1_OBSERV)
						Li++
						PrintOut(Li,000,If(cPaisLoc$"ANG|PTG","Obs.:","Obs.: ")+(cAliasSA1)->A1_OBSERV,,)
					EndIf
					Li++
					lNewCli := .F. 
				Endif




				If li > 55
					cabec(titulo,cabec1,cabec2,nomeprog,tamanho,15)
					PrintOut(Li,000,Repli("-",limite),,)
					Li++
					PrintOut(Li,000,(cSD2)->D2_CLIENTE+"   "+(cAliasSA1)->A1_NOME,,)
					If !Empty((cAliasSA1)->A1_OBSERV)
						Li++
						PrintOut(Li,000,If(cPaisLoc$"ANG|PTG","Obs.:","Obs.: ")+(cAliasSA1)->A1_OBSERV,,)
					EndIf
					Li+=2
				EndIf




				If lNewProd
					lNewProd := .F. 
					Li+=2
					PrintOut(Li,0,Eval(bGrade),,)
					SB1->(dbSeek(xFilial("SB1")+(cSD2)->D2_COD))
					If mv_par16 = 1
						PrintOut(li,16,Substr(SB1->B1_DESC,1,28),,)
					Else
						If SA7->(dbSeek(xFilial("SA7")+(cSD2)->(D2_COD+D2_CLIENTE+D2_LOJA)))
							PrintOut(li,16,Substr(SA7->A7_DESCCLI,1,30),,)
						Else
							PrintOut(li,16,Substr(SB1->B1_DESC,1,28),,)
						Endif
					EndIf
				EndIf




				If lGrade
					cProdRef:= Substr((cSD2)->D2_COD,1,nTamRef)
					cNumPed := (cSD2)->D2_PEDIDO
					nReg    := 0
					nDevQtd :=0
					nDevVal :=0



					While !Eof() .And.  cProdRef == Eval(bGrade) .And.  (cSD2)->D2_GRADE == "S" .And.  cNumPed == (cSD2)->D2_PEDIDO .And.  (cSD2)->D2_FILIAL == xFilial("SD2")

						nReg := Recno()



						lRet:=ValidMasc((cSD2)->D2_COD,MV_PAR11)
						If !lRet .Or.  !Eval(bFiltro)
							dbSkip()
							Loop
						EndIf




						If mv_par10 == 1
							SomaDev(@nDevQtd, @nDevVal , @aDev, cEstoq, cDupli)
						EndIf

						nTotQuant += (cSD2)->D2_QUANT
						dbSkip()

					EndDo




					If nReg > 0
						dbGoto(nReg)
						nReg:=0
					EndIf

				Else



					nDevQtd :=0
					nDevVal :=0

					If mv_par10 == 1
						SomaDev(@nDevQtd, @nDevVal , @aDev, cEstoq, cDupli)
					EndIf

					nTotQuant := (cSD2)->D2_QUANT

				EndIf





				SF2->(dbSeek(xFilial("SF2")+(cSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA)))
				cUM := (cSD2)->D2_UM

				PrintOut(Li,aColuna[1],(cSD2)->(D2_DOC+"/"+D2_SERIE),,)
				PrintOut(Li,aColuna[2],(cSD2)->D2_EMISSAO,,)
				PrintOut(Li,aColuna[3],cUM,,)
				PrintOut(Li,aColuna[4],nTotQuant,PesqPictqt("D2_QUANT",14),)

				nAcN1 += nTotQuant




				nVlrUnit := xMoeda((cSD2)->D2_PRCVEN,SF2->F2_MOEDA,MV_PAR09,(cSD2)->D2_EMISSAO,nDecs+1,SF2->F2_TXMOEDA)
				PrintOut(Li,aColuna[5],nVlrUnit,PesqPict("SD2","D2_PRCVEN",14,mv_par09),)

				If (cSD2)->D2_TIPO $ "CIP"
					PrintOut(Li,aColuna[6],nVlrUnit,PesqPict("SD2","D2_TOTAL",16,mv_par09),)
					nAcN2 += nVlrUnit
				Else
					If (cSD2)->D2_GRADE == "S" .And.  MV_PAR12 == 1
						nVlrTot:= nVlrUnit * nTotQuant
						PrintOut(Li,aColuna[6],nVlrTot,PesqPict("SD2","D2_TOTAL",16,mv_par09),)
					Else
						nVlrTot:=xmoeda((cSD2)->D2_TOTAL,SF2->F2_MOEDA,mv_par09,(cSD2)->D2_EMISSAO,nDecs+1,SF2->F2_TXMOEDA)
						PrintOut(Li,aColuna[6],nVlrTot,PesqPict("SD2","D2_TOTAL",16,mv_par09),)
					EndIf
					nAcN2 += nVlrTot
				EndIf

				A780Vend(@cVends,nVend)
				PrintOut(Li,aColuna[7],Subs(cVends,1,7),,)
				For nV := 8 to Len(cVends)
					li ++
					PrintOut(Li,aColuna[7],Subs(cVends,nV,7),,)
					nV += 6
				Next




				If nDevQtd<>0
					Li++
					PrintOut(Li,053,If(cPaisLoc$"ANG|PTG","Dev","DEV"),,)
					nVlrTot:= nDevVal
					PrintOut(Li,aColuna[3],cUM,,)
					PrintOut(Li,aColuna[4],nDevQtd,"@)"+PesqPictqt("D2_QUANT",14),)
					PrintOut(Li,aColuna[6],nVlrTot,"@)"+PesqPict("SD2","D2_TOTAL",16,mv_par09),)
					nAcN1+= nDevQtd
					nAcN2+= nVlrTot
				EndIf
				Li++
				nTotQuant := 0
				dbSkip()

			EndDo




			nTotGer1 += nAcN1
			nTotGer2 += nAcN2




			nTotCli1 += nAcN1
			nTotCli2 += nAcN2




			If nAcN1#0 .Or.  nAcN2#0 .Or.  nDevQtd#0
				Li++
				PrintOut(Li,07,If(cPaisLoc$"ANG|PTG","TOTAL DO ARTIGO - ","TOTAL DO PRODUTO - ")+cProdAnt,,)
				PrintOut(Li,52,"---->",,)
				PrintOut(Li,aColuna[3],cUM,,)
				PrintOut(Li,aColuna[4],nAcN1,PesqPictqt("D2_QUANT",14),)
				PrintOut(Li,aColuna[6],nAcN2,PesqPict("SD2","D2_TOTAL",16,mv_par09),)
				nAcN1 := 0
				nAcN2 := 0
				cProdAnt := (cSD2)->D2_COD
			EndIf

		EndDo



		If !(lNewCli)
			LI+=2
			PrintOut(Li,07,If(cPaisLoc$"ANG|PTG","Total do cliente - ","TOTAL DO CLIENTE - ")+cClieAnt+"/"+cLojaAnt,,)
			PrintOut(Li,52,"---->",,)
			PrintOut(Li,aColuna[4],nTotCli1,PesqPictqt("D2_QUANT",16),)
			PrintOut(Li,aColuna[6],nTotCli2,PesqPict("SD2","D2_TOTAL",18,mv_par09),)
			LI++
		EndIf
		cClieAnt := ""
		cLojaAnt := ""
		nTotCli1 := 0
		nTotCli2 := 0

	EndIf



	nTotCli1 := 0
	nTotCli2 := 0
	DbSelectArea(cSD1)
	If DbSeek(xFilial("SD1")+(cAliasSA1)->A1_COD+(cAliasSA1)->A1_LOJA)
		lRet:=ValidMasc((cSD1)->D1_COD,MV_PAR11)




		If mv_par10 == 1





			While (cSD1)->(D1_FILIAL + D1_FORNECE + D1_LOJA) == ( xFilial("SD1") + (cAliasSA1)->A1_COD+ (cAliasSA1)->A1_LOJA) .AND.  ! Eof()
				lRet:=ValidMasc((cSD1)->D1_COD,MV_PAR11)





				CtrlVndDev := .F. 
				lNfD2Ori   := .F. 
				If AvalTes((cSD1)->D1_TES,cEstoq,cDupli)
					dbSelectArea("SD2")
					nSavOrd := IndexOrd()
					dbSetOrder(3)

					dbSeek(xFilial("SD2")+(cSD1)->(D1_NFORI+D1_SERIORI+D1_FORNECE+D1_LOJA+D1_COD))

					While !Eof() .And.  (xFilial("SD2")+(cSD1)->(D1_NFORI+D1_SERIORI+D1_FORNECE+D1_LOJA+D1_COD)) == D2_FILIAL+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_COD

						lRet:=ValidMasc((cSD1)->D1_COD,MV_PAR11)

						If !Empty((cSD1)->D1_ITEMORI) .AND.  AllTrim((cSD1)->D1_ITEMORI) <> D2_ITEM .Or.  !lRet .Or.  !Eval(bFiltro)
							dbSkip()
							Loop
						Else
							CtrlVndDev := A780Vend(@cVends,nVend)
							If Ascan(aDev,D2_CLIENTE + D2_LOJA + D2_COD + D2_DOC + D2_SERIE + D2_ITEM) > 0
								lNfD2Ori := .T. 
							EndIf
						Endif
						dbSkip()
					End

					dbSelectArea("SD2")
					dbSetOrder(nSavOrd)
					dbSelectArea(cSD1)

					If !(CtrlVndDev) .Or.  lNfD2Ori
						dbSkip()
						Loop
					EndIf

					lProcessou := .t. 

					If li > 55
						cabec(titulo,cabec1,cabec2,nomeprog,tamanho,15)
					EndIf

					If lNewCli

						If li > 51
							cabec(titulo,cabec1,cabec2,nomeprog,tamanho,15)
						EndIf

						PrintOut(Li,000,Repli("-",limite),,)

						Li++
						PrintOut(Li,000,(cAliasSA1)->A1_COD,,)
						PrintOut(Li,009,(cAliasSA1)->A1_NOME,,)
						If !Empty((cAliasSA1)->A1_OBSERV)
							Li++
							PrintOut(Li,000,If(cPaisLoc$"ANG|PTG","Obs.:","Obs.: ")+(cAliasSA1)->A1_OBSERV,,)
						EndIf

						Li+=2

						lNewCli := .F. 

					EndIf

					LI++
					SF1->(dbSeek(xFilial("SF1")+(cSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))
					cUM := (cSD1)->D1_UM

					PrintOut(Li,0,(cSD1)->D1_COD,,)
					PrintOut(li,16,If(cPaisLoc$"ANG|PTG","Dev","DEV"),,)
					PrintOut(Li,46,(cSD1)->(D1_DOC+"/"+D1_SERIE),,)
					nVlrTot:=xMoeda((cSD1)->(D1_TOTAL-D1_VALDESC),SF1->F1_MOEDA,mv_par09,(cSD1)->D1_DTDIGIT,nDecs,SF1->F1_TXMOEDA)
					PrintOut(Li,aColuna[3],cUM,,)
					PrintOut(Li,aColuna[4],-(cSD1)->D1_QUANT,"@)"+PesqPictqt("D1_QUANT",14),)
					PrintOut(Li,aColuna[6],-nVlrTot,"@)"+PesqPict("SD1","D1_TOTAL",16,mv_par09),)
					nTotCli1 -= (cSD1)->D1_QUANT
					nTotCli2 -= nVlrTot
					nTotGer1 -= (cSD1)->D1_QUANT
					nTotGer2 -= nVlrTot
				Endif
				dbSkip()
			EndDo

			If (nTotCli1 <> 0) .or.  (nTotCli2 <> 0)
				LI+=2
				PrintOut(Li,07,If(cPaisLoc$"ANG|PTG","Total do cliente - ","TOTAL DO CLIENTE - ")+(cAliasSA1)->A1_COD,,)
				PrintOut(Li,52,"---->",,)
				PrintOut(Li,aColuna[4],nTotCli1,"@)"+PesqPictqt("D2_QUANT",16),)
				PrintOut(Li,aColuna[6],nTotCli2,"@)"+PesqPict("SD2","D2_TOTAL",18,mv_par09),)
				LI+=1
			EndIf

		EndIf

	Endif

	DbSelectArea(cAliasSA1)
	DbSkip()
EndDo

If lProcessou
	If li > 55
		cabec(titulo,cabec1,cabec2,nomeprog,tamanho,15)
	EndIf
	Li+=2
	PrintOut(Li,07,If(cPaisLoc$"ANG|PTG","T o t a l   crial                        ---->","T O T A L   G E R A L                        ---->"),,)
    PrintOut(Li,aColuna[4],nTotGer1,"@)"+PesqPictqt("D2_QUANT",16),)
    PrintOut(Li,aColuna[6],nTotGer2,"@)"+PesqPict("SD2","D2_TOTAL",18,mv_par09),)
	roda(cbcont,cbtxt,tamanho)
Endif

dbSelectArea("SD1")
dbClearFilter()
RetIndex("SD1")

dbSelectArea("SD2")
dbClearFilter()
RetIndex("SD2")

(cSD1)->(DbCloseArea())
(cSD2)->(DbCloseArea())
fErase(cArqTrab1+OrdBagExt())
fErase(cArqTrab2+OrdBagExt())

    fErase(cArqTrab1+GetDbExtension())
    fErase(cArqTrab2+GetDbExtension())


If aReturn[5] = 1
	Set( 24, "" )
	dbcommitAll()
	ourspool(wnrel)
EndIf

MS_FLUSH()

Return .T. 














Function A780Vend(cVends,nVend)
Local cAlias:=Alias(),sVend,sCampo
Local lVend, cVend, cBusca
Local nx
lVend  := .F. 
cVends := ""

cBusca := xFilial("SF2")+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA
dbSelectArea("SF2")
If dbSeek(cBusca)
	cVend := "1"
	For nx := 1 to nVend
		sCampo := "F2_VEND" + cVend
		sVend := FieldGet(FieldPos(sCampo))
		If (sVend >= mv_par07 .And.  sVend <= mv_par08) .And.  (!Empty(sVend))
			cVends += If(Len(cVends)>0,"/","") + sVend
		EndIf
		If (sVend >= mv_par07 .And.  sVend <= mv_par08) .And.  (nX == 1 .Or.  !Empty(sVend))
			lVend := .T. 
		EndIf
		cVend := Soma1(cVend, 1)
	Next
EndIf
dbSelectArea(cAlias)
Return(lVend)














Static Function SomaDev(nDevQtd, nDevVal, aDev, cEstoq, cDupli )

Local DtMoedaDev  := (cSD2)->D2_EMISSAO

If (cSD1)->(dbSeek(xFilial("SD1")+(cSD2)->(D2_CLIENTE + D2_LOJA + D2_COD )))



	While (cSD1)->(D1_FILIAL+D1_FORNECE+D1_LOJA+D1_COD) == (cSD2)->( xFilial("SD2")+D2_CLIENTE+D2_LOJA+D2_COD) .AND. !(cSD1)->(Eof())




		If !AvalTes((cSD1)->D1_TES,cEstoq,cDupli)
	        (cSD1)->(dbSkip())
			Loop
		Endif

        DtMoedaDev  := IIF(MV_PAR17 == 1,(cSD1)->D1_DTDIGIT,(cSD2)->D2_EMISSAO)

		SF1->(dbSeek(xFilial("SF1")+(cSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA)))

		If (cSD1)->(D1_NFORI + D1_SERIORI + AllTrim(D1_ITEMORI)) == (cSD2)->(D2_DOC   + D2_SERIE   + D2_ITEM )

			Aadd(aDev, (cSD1)->(D1_FORNECE + D1_LOJA + D1_COD + D1_NFORI + D1_SERIORI + AllTrim(D1_ITEMORI)))
			nDevQtd -= (cSD1)->D1_QUANT
			nDevVal -=xMoeda((cSD1)->(D1_TOTAL-D1_VALDESC),SF1->F1_MOEDA,mv_par09,DtMoedaDev,nDecs+1,SF1->F1_TXMOEDA)




		ElseIf mv_par15 == 2 .And.  (cSD1)->D1_DTDIGIT < (cSD2)->D2_EMISSAO .And.  (cSD1)->(D1_NFORI + D1_SERIORI + AllTrim(D1_ITEMORI)) < (cSD2)->(D2_DOC   + D2_SERIE   + D2_ITEM ) .And.  Ascan(aDev, (cSD1)->(D1_FORNECE + D1_LOJA + D1_COD + D1_NFORI + D1_SERIORI + AllTrim(D1_ITEMORI))) == 0

			Aadd(aDev, (cSD1)->(D1_FORNECE + D1_LOJA + D1_COD + D1_NFORI + D1_SERIORI + AllTrim(D1_ITEMORI)))
			nDevQtd -= (cSD1)->D1_QUANT
			nDevVal -=xMoeda((cSD1)->(D1_TOTAL-D1_VALDESC),SF1->F1_MOEDA,mv_par09,DtMoedaDev,nDecs+1,SF1->F1_TXMOEDA)

		EndIf

        (cSD1)->(dbSkip())

	EndDo

EndIf
Return .t. 











Function A780CriaTmp(cArqTmp, aStruTmp, cAliasTmp, cAlias)
	Local nI, nF, nPos
	Local cFieldName := ""
	nF := (cAlias)->(Fcount())
    dbCreate(cArqTmp,aStruTmp)
    DbUseArea( .T. ,,cArqTmp,cAliasTmp, .T. , .F. )
	(cAlias)->(DbGoTop())
	While ! (cAlias)->(Eof())
        (cAliasTmp)->(DbAppend())
		For nI := 1 To nF
			cFieldName := (cAlias)->( FieldName( ni ))
		    If (nPos := (cAliasTmp)->(FieldPos(cFieldName))) > 0
		   		    (cAliasTmp)->(FieldPut(nPos,(cAlias)->(FieldGet((cAlias)->(FieldPos(cFieldName))))))
            EndIf
		Next
		(cAlias)->(DbSkip())
	End
	(cAlias)->(dbCloseArea())
    DbSelectArea(cAliasTmp)
Return Nil