#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\MATR906.CH"
#line 2 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr906.prx"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Dialog.ch"
#line 28 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Font.ch"
#line 29 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\PTMenu.ch"
#line 31 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Print.ch"
#line 33 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Colors.ch"
#line 35 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\Folder.ch"
#line 37 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\msobject.ch"
#line 38 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\VKey.ch"
#line 42 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\WinApi.ch"
#line 44 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCommand.ch"
#line 47 "PROTHEUS.CH"
#line 1 "D:\TOTVS 11\MICROSIGA\PROTHEUS\INCLUDE\FWCSS.CH"
#line 50 "PROTHEUS.CH"
#line 15 "d:\totvs 11\microsiga\protheus\my projects\materiais\matr906.prx"
FUNCTION MATR906()



















AjustaSX1()
If FindFunction("TRepInUse") .And.  TRepInUse()
	oReport:=ReportDef()
	oReport:PrintDialog()
Else
	MATR906R3()
EndIf

Return















Static Function ReportDef()
Local oReport
Local oPISCOF1, oPISCOF2, oPISCOF3
Local oTotAliq, oContr, oComple, oResumo, oTotCFOP, oTotDTEMI
Local oResCFOP, oResAliq, oResMov
Local oBreakRFS


















oReport := TReport():New("MATR906",If( cPaisLoc $ "ANG|PTG", "Relatório - (pis/cofins)", "Relatório - (PIS/COFINS)" ),"MTR906",{|oReport| ReportPrint(oReport)},If( cPaisLoc $ "ANG|PTG", "Este programa emite relatório das contribuições ao pis e cofins", "Este programa emite Relatório das Contribuições ao PIS e COFINS" ))

oReport:SetLandscape()

Pergunte("MTR906", .F. )



oPISCOF1 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Pis/cofins - Por Cfop", "PIS/COFINS - por CFOP" ),{"TRB"},{"Cfop",If( cPaisLoc $ "ANG|PTG", "Nr. fact. + série + emissão", "Num. NF + Série + Emissão" ),If( cPaisLoc $ "ANG|PTG", "Emissão + nr. fact. + série", "Emissão + Num. NF + Série" )})
TRCell():New(oPISCOF1,"TIPO"     ,"TRB","Tipo",						  ,06					         ,,)
TRCell():New(oPISCOF1,"ES"       ,"TRB",If( cPaisLoc $ "ANG|PTG", "Entrada/saída", "Entrada/Saida" ),						  ,01				      	   ,,{|| TRB->ES })
TRCell():New(oPISCOF1,"CFOP"     ,"TRB","Cfop",						  ,TamSx3("D2_CF")[1]	   ,,)
TRCell():New(oPISCOF1,"PRODUTO"  ,"TRB","Produto",						  ,TamSx3("D2_COD")[1]		,,)
TRCell():New(oPISCOF1,"NCM"      ,"TRB",If( cPaisLoc $ "ANG|PTG", "Ncm", "NCM" ),			 			  ,TamSx3("B1_POSIPI")[1] ,,)
TRCell():New(oPISCOF1,"VALORCONT","TRB",If( cPaisLoc $ "ANG|PTG", "Valor contabilístico", "Valor Contábil" ),PesqPict("SD2","D2_TOTAL")  ,TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oPISCOF1,"ZFRANCA"  ,"TRB","Zona Franca",PesqPict("SD2","D2_DESCZFR"),TamSx3("D2_DESCZFR")[1],,)
TRCell():New(oPISCOF1,"ALIQ"     ,"TRB","Alíq",PesqPict("SB1","B1_VLR_COF"),TamSx3("B1_VLR_COF")[1],,)
TRCell():New(oPISCOF1,"VALDEBT"  ,     ,If( cPaisLoc $ "ANG|PTG", "Val. Contr. Débito", "Val. Contr. Debito" ),PesqPict("SD2","D2_TOTAL")  ,TamSx3("D2_TOTAL")[1]	,,{|| IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E" ,TRB->PISDENT,  TRB->PISDSAI)   , IIF(TRB->ES == "E" ,TRB->COFDENT  ,TRB->COFDSAI))   })
TRCell():New(oPISCOF1,"VALCRED"  ,     ,If( cPaisLoc $ "ANG|PTG", "Val. Contr Crédito", "Val. Contr Credito" ),PesqPict("SD2","D2_TOTAL")  ,TamSx3("D2_TOTAL")[1]	,,{|| IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E" ,TRB->PISCENT,  TRB->PISCSAI)   , IIF(TRB->ES == "E" ,TRB->COFCENT  ,TRB->COFCSAI))   })
TRCell():New(oPISCOF1,"BASEDEBT" ,     ,If( cPaisLoc $ "ANG|PTG", "Base Contr. Débito", "Base Contr. Debito" ),PesqPict("SD2","D2_TOTAL")  ,TamSx3("D2_TOTAL")[1]	,,{|| IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E" ,TRB->BASPIDENT,TRB->BASPIDSAI) , IIF(TRB->ES == "E" ,TRB->BASCODENT,TRB->BASCODSAI)) })
TRCell():New(oPISCOF1,"BASECRED" ,     ,If( cPaisLoc $ "ANG|PTG", "Base Contr Crédito", "Base Contr Credito" ),PesqPict("SD2","D2_TOTAL")  ,TamSx3("D2_TOTAL")[1]	,,{|| IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E" ,TRB->BASPICENT,TRB->BASPICSAI) , IIF(TRB->ES == "E" ,TRB->BASCOCENT,TRB->BASCOCSAI)) })
TRCell():New(oPISCOF1,"NUMNF"    ,"TRB","Documento",				        ,TamSx3("D2_DOC")[1]	   ,,)
TRCell():New(oPISCOF1,"SERIE"    ,"TRB","Série",				        ,TamSx3("D2_SERIE")[1]	,,)
TRCell():New(oPISCOF1,"EMISSAO"  ,"TRB","Emissão",PesqPict("SD2","D2_EMISSAO"),13                      ,,)
TRCell():New(oPISCOF1,"CLIFOR"   ,"TRB",If( cPaisLoc $ "ANG|PTG", "Cliente/fornecedor", "Cliente/Fornecedor" ),		         	  ,40					         ,,)

oPISCOF2 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Pis/cofins - Por Num.factura", "PIS/COFINS - por Num.NF" ),{"TRB"},{"CFOP",If( cPaisLoc $ "ANG|PTG", "Nr. fact. + série + emissão", "Num. NF + Série + Emissão" ),If( cPaisLoc $ "ANG|PTG", "Emissão + nr. fact. + série", "Emissão + Num. NF + Série" )})
TRCell():New(oPISCOF2,"TIPO"     ,"TRB","Tipo",							,06								,,)
TRCell():New(oPISCOF2,"ES"       ,"TRB",If( cPaisLoc $ "ANG|PTG", "Entrada/saída", "Entrada/Saida" ),							,01								,,{|| TRB->ES })
TRCell():New(oPISCOF2,"NUMNF"    ,"TRB","Documento",PesqPict("SD2","D2_DOC")			,TamSx3("D2_DOC")[1]			,,)
TRCell():New(oPISCOF2,"SERIE"    ,"TRB","Série",							,TamSx3("D2_SERIE")[1]		,,)
TRCell():New(oPISCOF2,"EMISSAO"  ,"TRB","Emissão",PesqPict("SD2","D2_EMISSAO")	,13	,,)
TRCell():New(oPISCOF2,"CLIFOR"   ,"TRB",If( cPaisLoc $ "ANG|PTG", "Cliente/fornecedor", "Cliente/Fornecedor" ),							,40								,,)
TRCell():New(oPISCOF2,"PRODUTO"  ,"TRB","Produto",							,TamSx3("D2_COD")[1]			,,)
TRCell():New(oPISCOF2,"NCM"      ,"TRB",If( cPaisLoc $ "ANG|PTG", "Ncm", "NCM" ),							,TamSx3("B1_POSIPI")[1]		,,)
TRCell():New(oPISCOF2,"VALORCONT","TRB",If( cPaisLoc $ "ANG|PTG", "Valor contabilístico", "Valor Contábil" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oPISCOF2,"ZFRANCA"  ,"TRB","Zona Franca",PesqPict("SD2","D2_DESCZFR")	,TamSx3("D2_DESCZFR")[1]	,,)
TRCell():New(oPISCOF2,"ALIQ"     ,"TRB","Alíq",PesqPict("SB1","B1_VLR_COF")	,TamSx3("B1_VLR_COF")[1]	,,)
TRCell():New(oPISCOF2,"VALDEBT"  ,     ,If( cPaisLoc $ "ANG|PTG", "Val. Contr. Débito", "Val. Contr. Debito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->PISDENT,  TRB->PISDSAI)  ,IIF(TRB->ES=="E",TRB->COFDENT  ,TRB->COFDSAI))   })
TRCell():New(oPISCOF2,"VALCRED"  ,     ,If( cPaisLoc $ "ANG|PTG", "Val. Contr Crédito", "Val. Contr Credito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->PISCENT,  TRB->PISCSAI)  ,IIF(TRB->ES=="E",TRB->COFCENT  ,TRB->COFCSAI))   })
TRCell():New(oPISCOF2,"BASEDEBT" ,     ,If( cPaisLoc $ "ANG|PTG", "Base Contr. Débito", "Base Contr. Debito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->BASPIDENT,TRB->BASPIDSAI),IIF(TRB->ES=="E",TRB->BASCODENT,TRB->BASCODSAI)) })
TRCell():New(oPISCOF2,"BASECRED" ,     ,If( cPaisLoc $ "ANG|PTG", "Base Contr Crédito", "Base Contr Credito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->BASPICENT,TRB->BASPICSAI),IIF(TRB->ES=="E",TRB->BASCOCENT,TRB->BASCOCSAI)) })

oPISCOF3 := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Pis/cofins - Por Emissão", "PIS/COFINS - por Emissão" ),{"TRB"},{"CFOP",If( cPaisLoc $ "ANG|PTG", "Nr. fact. + série + emissão", "Num. NF + Série + Emissão" ),If( cPaisLoc $ "ANG|PTG", "Emissão + nr. fact. + série", "Emissão + Num. NF + Série" )})
TRCell():New(oPISCOF3,"TIPO"     ,"TRB","Tipo",							,06								,,)
TRCell():New(oPISCOF3,"ES"       ,"TRB",If( cPaisLoc $ "ANG|PTG", "Entrada/saída", "Entrada/Saida" ),							,01								,,{|| TRB->ES })
TRCell():New(oPISCOF3,"EMISSAO"  ,"TRB","Emissão",PesqPict("SD2","D2_EMISSAO")	,13	,,)
TRCell():New(oPISCOF3,"CLIFOR"   ,"TRB",If( cPaisLoc $ "ANG|PTG", "Cliente/fornecedor", "Cliente/Fornecedor" ),							,40								,,)
TRCell():New(oPISCOF3,"NUMNF"    ,"TRB","Documento",							,TamSx3("D2_DOC")[1]			,,)
TRCell():New(oPISCOF3,"SERIE"    ,"TRB","Série",							,TamSx3("D2_SERIE")[1]		,,)
TRCell():New(oPISCOF3,"PRODUTO"  ,"TRB","Produto",							,TamSx3("D2_COD")[1]			,,)
TRCell():New(oPISCOF3,"NCM"      ,"TRB",If( cPaisLoc $ "ANG|PTG", "Ncm", "NCM" ),							,TamSx3("B1_POSIPI")[1]		,,)
TRCell():New(oPISCOF3,"VALORCONT","TRB",If( cPaisLoc $ "ANG|PTG", "Valor contabilístico", "Valor Contábil" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oPISCOF3,"ZFRANCA"  ,"TRB","Zona Franca",PesqPict("SD2","D2_DESCZFR")	,TamSx3("D2_DESCZFR")[1]	,,)
TRCell():New(oPISCOF3,"ALIQ"     ,"TRB","Alíq",PesqPict("SB1","B1_VLR_COF") ,TamSx3("B1_VLR_COF")[1]  ,,)
TRCell():New(oPISCOF3,"VALDEBT"  ,     ,If( cPaisLoc $ "ANG|PTG", "Val. Contr. Débito", "Val. Contr. Debito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->PISDENT,  TRB->PISDSAI)  ,IIF(TRB->ES=="E",TRB->COFDENT  ,TRB->COFDSAI))   })
TRCell():New(oPISCOF3,"VALCRED"  ,     ,If( cPaisLoc $ "ANG|PTG", "Val. Contr Crédito", "Val. Contr Credito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->PISCENT,  TRB->PISCSAI)  ,IIF(TRB->ES=="E",TRB->COFCENT  ,TRB->COFCSAI))   })
TRCell():New(oPISCOF3,"BASEDEBT" ,     ,If( cPaisLoc $ "ANG|PTG", "Base Contr. Débito", "Base Contr. Debito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->BASPIDENT,TRB->BASPIDSAI),IIF(TRB->ES=="E",TRB->BASCODENT,TRB->BASCODSAI)) })
TRCell():New(oPISCOF3,"BASECRED" ,     ,If( cPaisLoc $ "ANG|PTG", "Base Contr Crédito", "Base Contr Credito" ),PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,{|| IIF(TRB->TIPO=="PIS",IIF(TRB->ES=="E",TRB->BASPICENT,TRB->BASPICSAI),IIF(TRB->ES=="E",TRB->BASCOCENT,TRB->BASCOCSAI)) })

oTotAliq := TRSection():New(oReport,Alltrim(If( cPaisLoc $ "ANG|PTG", "Total da taxa", "Total da Alíquota" )),{},{})
TRCell():New(oTotAliq,"DESCRI"   ,,				,										,30							,,)
TRCell():New(oTotAliq,"VALORCONT",,If( cPaisLoc $ "ANG|PTG", "Valor contabilístico", "Valor Contábil" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oTotAliq,"ZFRANCA"  ,,"Zona Franca"	,PesqPict("SD2","D2_DESCZFR")	,TamSx3("D2_DESCZFR")[1],,)
TRCell():New(oTotAliq,"	ESPACA"   ,,"Alíq"	,                           	,TamSx3("B1_VLR_COF")[1],,)
TRCell():New(oTotAliq,"VALDEBT"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr. Débito", "Val. Contr. Debito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oTotAliq,"VALCRED"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr Crédito", "Val. Contr Credito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oTotAliq,"BASEDEBT" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr. Débito", "Base Contr. Debito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oTotAliq,"BASECRED" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr Crédito", "Base Contr Credito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]	,,)
oTotAliq:SetTotalInLine( .F. )

TRFunction():New(oTotAliq:Cell("VALORCONT"),NIL,"SUM",,,,, .T. , .F. , .F. ,,,,,,,, .T. )
TRFunction():New(oTotAliq:Cell("ZFRANCA"),	NIL,"SUM",,,,, .T. , .F. , .F. ,,,,,,,, .T. )
TRFunction():New(oTotAliq:Cell("VALDEBT"),	NIL,"SUM",,,,, .T. , .F. , .F. ,,,,,,,, .T. )
TRFunction():New(oTotAliq:Cell("VALCRED"),	NIL,"SUM",,,,, .T. , .F. , .F. ,,,,,,,, .T. )
TRFunction():New(oTotAliq:Cell("BASEDEBT"),	NIL,"SUM",,,,, .T. , .F. , .F. ,,,,,,,, .T. )
TRFunction():New(oTotAliq:Cell("BASECRED"),	NIL,"SUM",,,,, .T. , .F. , .F. ,,,,,,,, .T. )

oContr := TRSection():New(oReport,"Contribuição",{},{})
TRCell():New(oContr,"CFOP"     ,,"Cfop",											,06						 		,,)
TRCell():New(oContr,"VALOR"    ,,"Valor",PesqPict("SD2","D2_TOTAL")		,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oContr,"CD"       ,,If( cPaisLoc $ "ANG|PTG", "Crédito/débito", "Credito/Debito" ),											,03								,,)
TRCell():New(oContr,"VALORCONT",,If( cPaisLoc $ "ANG|PTG", "Valor contabilístico", "Valor Contábil" ),PesqPict("SD2","D2_TOTAL")		,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oContr,"ZFRANCA"  ,,"Zona Franca",PesqPict("SD2","D2_TOTAL")		,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oContr,"ALIQ"     ,,If( cPaisLoc $ "ANG|PTG", "Taxa", "Aliquota" ),											,TamSx3("B1_VLR_COF")[1]	,,)
TRCell():New(oContr,"VALDEBT"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr. Débito", "Val. Contr. Debito" ),PesqPict("SD2","D2_TOTAL")		,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oContr,"VALCRED"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr Crédito", "Val. Contr Credito" ),PesqPict("SD2","D2_TOTAL")		,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oContr,"BASEDEBT" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr. Débito", "Base Contr. Debito" ),PesqPict("SD2","D2_TOTAL")		,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oContr,"BASECRED" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr Crédito", "Base Contr Credito" ),PesqPict("SD2","D2_TOTAL")		,TamSx3("D2_TOTAL")[1]		,,)

oComple := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Inf. do apuramento", "Inf. da Apuração" ),{},{})
TRCell():New(oComple,"DESCR",,"Descrição",										,70							,,)
TRCell():New(oComple,"VALOR",,"Valor",PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]	,,)

oResumo := TRSection():New(oReport,"Resumo",{},{})
TRCell():New(oResumo,"DESCR" ,,If( cPaisLoc $ "ANG|PTG", "Valores Para Cálculo", "Valores para Cálculo" ),									,30							,,)
TRCell():New(oResumo,"TRIBUT",,"Tributado",PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oResumo,"OUTROS",,"Outros",PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oResumo,"TOTAL" ,,"Total",PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)

oResCFOP := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Resumo Por Cód. Fiscal", "Resumo por CFOP" ),{},{})
TRCell():New(oResCFOP,"CFOP"     ,     ,"Cfop",									,04,							,)
TRCell():New(oResCFOP,"X5_DESCRI","SX5","Descrição",									,40,							,)
TRCell():New(oResCFOP,"FILIAL"   ,     ,"Filial",									,02,							,)
TRCell():New(oResCFOP,"BASECNT"  ,     ,If( cPaisLoc $ "ANG|PTG", "Base da contribuição", "Base da Contribuição" ),PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oResCFOP,"VALORCNT" ,     ,If( cPaisLoc $ "ANG|PTG", "Valor da contribuição", "Valor da Contribuição" ),PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)

oBreakRFS := TRBreak():New(oResCFOP,oResCFOP:Cell("CFOP"),If( cPaisLoc $ "ANG|PTG", "Total Do Cód. Fiscal", "Total do CFOP" ), .F. )
TRFunction():New(oResCFOP:Cell("BASECNT"), NIL,"SUM",oBreakRFS,,,, .F. , .F. , .F. )
TRFunction():New(oResCFOP:Cell("VALORCNT"),NIL,"SUM",oBreakRFS,,,, .F. , .F. , .F. )

oResAliq := TRSection():New(oReport,If( cPaisLoc $ "ANG|PTG", "Filiais por taxa", "Filiais por Alíquota" ),{},{})
TRCell():New(oResAliq,"FILIAL",,"Filial",										,08,								,)
TRCell():New(oResAliq,"ALIQ"  ,,"Alíq",PesqPict("SB1","B1_VLR_COF"),TamSx3("B1_VLR_COF")[1]	,,)
TRCell():New(oResAliq,"VALOR" ,,"Valor",PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)

oResAliq:SetTotalText("Total")
oResAliq:SetTotalInLine( .F. )
TRFunction():New(oResAliq:Cell("VALOR"),NIL,"SUM",,,,, .T. , .F. , .F. )

oResMov := TRSection():New(oReport,"Resumo Processado",{},{})
TRCell():New(oResMov,"DESCR" ,,If( cPaisLoc $ "ANG|PTG", "Valores Para Cálculo", "Valores para Cálculo" ),									,30,							,)
TRCell():New(oResMov,"TRIBUT",,"Tributado",PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oResMov,"OUTROS",,"Outros",PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)
TRCell():New(oResMov,"TOTAL" ,,"Total",PesqPict("SD2","D2_TOTAL"),TamSx3("D2_TOTAL")[1]	,,)

oTotCFOP := TRSection():New(oReport,Alltrim(If( cPaisLoc $ "ANG|PTG", "Total Por Código Fiscal:", "Total por CFOP:" )),{},{})
TRCell():New(oTotCFOP,"DESCRI"   ,,				,										,30								,,)
TRCell():New(oTotCFOP,"VALORCONT",,If( cPaisLoc $ "ANG|PTG", "Valor contabilístico", "Valor Contábil" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotCFOP,"ZFRANCA"  ,,"Zona Franca"	,PesqPict("SD2","D2_DESCZFR")	,TamSx3("D2_DESCZFR")[1]	,,)
TRCell():New(oTotCFOP,"ESPACA"   ,,"Alíq"	,PesqPict("SB1","B1_VLR_COF")	,TamSx3("B1_VLR_COF")[1]	,,)
TRCell():New(oTotCFOP,"VALDEBT"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr. Débito", "Val. Contr. Debito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotCFOP,"VALCRED"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr Crédito", "Val. Contr Credito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotCFOP,"BASEDEBT" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr. Débito", "Base Contr. Debito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotCFOP,"BASECRED" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr Crédito", "Base Contr Credito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
oTotCFOP:SetTotalInLine( .F. )

oTotDTEMI := TRSection():New(oReport,Alltrim(If( cPaisLoc $ "ANG|PTG", "Total Do Dia", "Total do Dia" )),{},{})
TRCell():New(oTotDTEMI,"DESCRI"   ,,			,										,30								,,)
TRCell():New(oTotDTEMI,"VALORCONT",,If( cPaisLoc $ "ANG|PTG", "Valor contabilístico", "Valor Contábil" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotDTEMI,"ZFRANCA"  ,,"Zona Franca"	,PesqPict("SD2","D2_DESCZFR")	,TamSx3("D2_DESCZFR")[1]	,,)
TRCell():New(oTotDTEMI,"ESPACA"   ,,"Alíq"	,PesqPict("SB1","B1_VLR_COF")	,TamSx3("B1_VLR_COF")[1]	,,)
TRCell():New(oTotDTEMI,"VALDEBT"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr. Débito", "Val. Contr. Debito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotDTEMI,"VALCRED"  ,,If( cPaisLoc $ "ANG|PTG", "Val. Contr Crédito", "Val. Contr Credito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotDTEMI,"BASEDEBT" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr. Débito", "Base Contr. Debito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
TRCell():New(oTotDTEMI,"BASECRED" ,,If( cPaisLoc $ "ANG|PTG", "Base Contr Crédito", "Base Contr Credito" )	,PesqPict("SD2","D2_TOTAL")	,TamSx3("D2_TOTAL")[1]		,,)
oTotDTEMI:SetTotalInLine( .F. )
Return(oReport)

















Static Function ReportPrint(oReport)

Local nOrdem 		:= oReport:Section(1):GetOrder()
Local oPISCOF		:= oReport:Section(nOrdem)
Local oContr 		:= oReport:Section(5)
Local oComple		:= oReport:Section(6)
Local oResumo		:= oReport:Section(7)

Local aAliqEs	  	:= {}
Local aAliqCFGer	:= {}
Local aCFOPCOFE  	:= {}
Local aCFOPCOFS  	:= {}
Local aTAlCOFE		:= {}
Local aTAlCOFS		:= {}
Local aCFOPPISE  	:= {}
Local aCFOPPISS		:= {}
Local aTAlPISE		:= {}
Local aTAlPISS		:= {}
Local aTotDoCFOP	:= {}
Local aTotPorCFOP	:= {}
Local aTotDtEmis    := {}
Local aTotResumo	:= CriaArrRes()
Local aAreaSM0   	:= SM0->(GetArea())

Local nContCp
Local nPosAliq		:= 0
Local nX			:= 0
Local nY			:= 0
Local nTeste		:= 0
Local nScanPis   	:= 0
Local nScanCof   	:= 0

Local cFilOri   	:= ""
Local cFilIni    	:= ""
Local cFilFin    	:= ""
Local cCfopAnt 		:= ""
Local cEsAnt		:= ""
Local cTipoAnt		:= ""
Local cCliFor		:= ""
Local cContArq
Local cArqCp
Local cLinArq
Local lFirstReg		:= .T. 
Local lResumo		:= .F. 
Local cEs			:= ""
Local cCfop			:= ""
Local nPag          := 0
Local cTipo			:= ""
Local dDtEmis		:= CToD("  /  /    ")
Local nTamDsc		:= 0
Local oFont01

Private lApurCof	:= .F. 
Private lApurPis	:= .F. 

Private aResumo		:= {}
Private aTApurPIS	:= {0,0,0,0,0,0,0}
Private aTApurCOF	:= {0,0,0,0,0,0,0}
Private aRelImp		:= MaFisRelImp("MT100",{ "SD1" })
Private aRelImp2	:= MaFisRelImp("MT100",{ "SD2" })

Private cCpVlPisEn 	:= ""
Private cCpBsPisEn 	:= ""
Private cCpVlPisSa 	:= ""
Private cCpBsPisSa 	:= ""
Private cCpAlPisSa 	:= ""
Private cCpAlPisEn 	:= ""
Private cCpVlCofEn 	:= ""
Private cCpBsCofEn 	:= ""
Private cCpVlCofSa 	:= ""
Private cCpBsCofSa 	:= ""
Private cCpAlCofEn 	:= ""
Private cCpAlCofSa 	:= ""

Private nPsVlPisEn 	:= 0
Private nPsBsPisEn 	:= 0
Private nPsVlPisSa 	:= 0
Private nPsBsPisSa 	:= 0
Private nPsAlPisEn 	:= 0
Private nPsAlPisSa 	:= 0
Private nPsVlCofEn 	:= 0
Private nPsBsCofEn 	:= 0
Private nPsVlCofSa 	:= 0
Private nPsBsCofSa 	:= 0
Private nPsAlCofEn 	:= 0
Private nPsAlCofSa 	:= 0
Private nTDedPIS	:= 0
Private nTDedCOF   	:= 0

Private cArqTemp	:= ""
Private aArqTemp	:= CriaArrTRB()

TrataCpos()

TRPosition():New(oPISCOF,"SX5",1,{|| xFilial("SX5")+"13"+TRB->CFOP })

oPISCOF:Cell("TIPO"):Disable()
oPISCOF:Cell("ES"):Disable()


nTamDsc := TamSx3("D2_COD")[1] + 1
If nOrdem==2
	If oReport:GetOrientation() == 1
		nTamDsc := TamSx3("D2_DOC")[1] + TamSx3("D2_SERIE")[1] + TamSx3("D2_EMISSAO")[1] + 19 + TamSx3("D2_COD")[1] - 5 + TamSx3("B1_POSIPI")[1] + 7
    Else
		nTamDsc := TamSx3("D2_DOC")[1] + TamSx3("D2_SERIE")[1] + TamSx3("D2_EMISSAO")[1] + 40 + TamSx3("D2_COD")[1] + TamSx3("B1_POSIPI")[1] + 7
	EndIf
ElseIf nOrdem==3
	If oReport:GetOrientation() == 1
		nTamDsc := TamSx3("D2_DOC")[1] + TamSx3("D2_SERIE")[1] + TamSx3("D2_EMISSAO")[1] + 19 + TamSx3("D2_COD")[1] - 5 + TamSx3("B1_POSIPI")[1] + 7
	Else
		nTamDsc := TamSx3("D2_DOC")[1] + TamSx3("D2_SERIE")[1] + TamSx3("D2_EMISSAO")[1] + 40 + TamSx3("D2_COD")[1] + TamSx3("B1_POSIPI")[1] + 7
	EndIf
endif

If mv_par12 == 3
	oReport:SetTitle(If( cPaisLoc $ "ANG|PTG", "Relatório de pis/cofins", "Relatório de PIS/COFINS" ))
ElseIf mv_par12 == 1
	oReport:SetTitle("PIS/COFINS CUMULATIVO/NÃO CUMULATIVO")
Else
	oReport:SetTitle("PIS/COFINS NÃO CUMULATIVO")
EndIf


If mv_par06 == 1
	cFilIni := mv_par07
	cFilFin := mv_par08
Else
	cFilIni := cFilAnt
	cFilFin := cFilAnt
Endif

cFilOri := cFilAnt
dbSelectArea("SM0")
SM0->(dbSeek(cEmpAnt+cFilIni, .T. ))
While SM0->M0_CODIGO == cEmpAnt .And.  SM0->M0_CODFIL <= cFilFin .And.  !SM0->(Eof())
	cFilAnt := SM0->M0_CODFIL

	IF MontaTRB()
		DbSelectArea("TRB")
		oReport:SetMeter(TRB->(LastRec()))
		DbGoTop()

		oReport:PrintText("Empresa : " + SM0->M0_NOMECOM,,10)
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Nif: ", "CNPJ: " ) + Transform(SM0->M0_CGC,"@R 99.999.999/9999-99"),,10)
		oReport:PrintText("Período : " + DTOC(mv_par02) + " a " + DTOC(mv_par03),,10)
		oReport:SkipLine()
		oReport:FatLine()

		If nOrdem == 1
			If oReport:GetOrientation() == 1
				oFont01:= TFont():New("Serif",,7,, .F. ,,,, .T. , .F. )
				oPISCOF:SetAutoSize()
				oPISCOF:SetLineBreak()
				oPISCOF:nColSpace := 0
				oPISCOF:ACELL[4]:oFONTBODY := oFont01
				oPISCOF:ACELL[5]:oFONTBODY := oFont01
				oPISCOF:ACELL[6]:oFONTBODY := oFont01
				oPISCOF:ACELL[7]:oFONTBODY := oFont01
				oPISCOF:ACELL[8]:oFONTBODY := oFont01
				oPISCOF:ACELL[8]:nSize     := 5
				oPISCOF:ACELL[9]:oFONTBODY := oFont01
				oPISCOF:ACELL[10]:oFONTBODY := oFont01
				oPISCOF:ACELL[11]:oFONTBODY := oFont01
				oPISCOF:ACELL[12]:oFONTBODY := oFont01
				oPISCOF:ACELL[13]:oFONTBODY := oFont01
				oPISCOF:ACELL[14]:oFONTBODY := oFont01
				oPISCOF:ACELL[15]:oFONTBODY := oFont01
				oPISCOF:ACELL[15]:nSize     := 10
				oPISCOF:ACELL[16]:oFONTBODY := oFont01
				oPISCOF:ACELL[16]:nSize     := 20
		    EndIf
   	   	    oPISCOF:Cell("CFOP"):Disable()

			If mv_par11 == 1
				oPISCOF:Cell("PRODUTO")	:Hide()
				oPISCOF:Cell("NCM")		:Hide()
			EndIf
	  		oPISCOF:Init()

			If mv_par04 == 2
				oPISCOF:Cell("VALORCONT")	:Enable()
				oPISCOF:Cell("ZFRANCA")		:Enable()
				oPISCOF:Cell("VALDEBT")		:Enable()
				oPISCOF:Cell("VALCRED")		:Enable()
				oPISCOF:Cell("BASEDEBT")	:Enable()
				oPISCOF:Cell("BASECRED")	:Enable()

				oPISCOF:Cell("PRODUTO")		:SetTitle("")
				oPISCOF:Cell("NCM")			:SetTitle("")
				oPISCOF:Cell("ALIQ")		:SetTitle("")
				oPISCOF:Cell("NUMNF")		:SetTitle("")
				oPISCOF:Cell("SERIE")		:SetTitle("")
				oPISCOF:Cell("EMISSAO")		:SetTitle("")
				oPISCOF:Cell("CLIFOR")		:SetTitle("")

				oPISCOF:Cell("PRODUTO")		:Hide()
				oPISCOF:Cell("NCM")			:Hide()
				oPISCOF:Cell("ALIQ")		:Hide()
				oPISCOF:Cell("NUMNF")		:Hide()
				oPISCOF:Cell("SERIE")		:Hide()
				oPISCOF:Cell("EMISSAO")		:Hide()
				oPISCOF:Cell("CLIFOR")		:Hide()
			EndIf

			While !TRB->(Eof())
				cTipo	:= TRB->TIPO

				oPISCOF:SetHeaderSection( .T. )
				oPISCOF:PrintHeader()
				oPISCOF:SetHeaderSection( .F. )
				oReport:SkipLine()

				While !TRB->(Eof()) .and.  TRB->TIPO == cTipo
				   if cES <> TRB->ES

						oReport:PrintText(IIF(TRB->TIPO == "PIS",If( cPaisLoc $ "ANG|PTG", "Pis - programa de integração social", "PIS - Programa de Integração Social" ),If( cPaisLoc $ "ANG|PTG", "Cofins - contribuição para o financiamento da seguridade social", "COFINS - Contribuição para o Financiamento da Seguridade Social" )) + " - " + IIF(TRB->ES == "E","Entradas","Saídas"),,1100)
					endif
					cES := TRB->ES
					While !TRB->(Eof()) .and.  TRB->TIPO == cTipo .and.  TRB->ES == cES
						cCFOP := TRB->CFOP

						oReport:PrintText(TRB->CFOP+IIF(SX5->(MsSeek(xFilial("SX5")+"13"+TRB->CFOP))," - "+AllTrim(SX5->X5_DESCRI),""))

						While !TRB->(Eof()) .and.  TRB->TIPO == cTipo .and.  TRB->ES == cES .and.  TRB->CFOP == cCFOP
							dDtEmis := TRB->EMISSAO
							While !TRB->(Eof()) .and.  TRB->TIPO == cTipo .and.  TRB->ES == cES .and.  TRB->CFOP == cCFOP .and.  TRB->EMISSAO == dDtEmis

								M906TotRel(@aAliqCFGer,@aAliqEs,@aCFOPPISE,@aCFOPPISS,@aCFOPCOFE,@aCFOPCOFS,@aTAlPISE,@aTAlPISS,@aTAlCOFE,@aTAlCOFS,@aTotDoCFOP,@aTotDtEmis)
								If mv_par04 == 1
									oPISCOF:Printline()
									oReport:IncMeter()
								EndIf
								TRB->(dbSkip())
							EndDo
							If mv_par09 == 1 .and.  (nOrdem >= 2 .or.  (nOrdem == 1 .and.  mv_par04 == 1))
								M906DTEMIS(oReport,aTotDtEmis,nTamDsc)
							Endif
						EndDo
		                If mv_par04 == 1
							M906CFOP(oReport,aTotDoCFOP,aTotPorCFOP,nTamDsc)
						Else
							AADD(aTotPorCFOP,aTotDoCFOP)
							aTotDoCFOP	:= {}
						Endif
					EndDo
					oReport:SkipLine()
					If mv_par10 == 1
					   M906TCFOP(oReport,aTotPorCFOP,nTamDsc)
                    Endif
					M906ENTSAI(oReport,aAliqEs,nTamDsc)
				EndDo
				CONTRI906(oReport,aAliqCFGer,cTipo)
			EndDo
			oPISCOF:Finish()
		Else

			If nOrdem == 2

				If oReport:GetOrientation() == 1
					oFont01:= TFont():New("Courier",,7,, .F. ,,,, .T. , .F. )
					oPISCOF:SetAutoSize()
					oPISCOF:SetLineBreak()
					oPISCOF:nColSpace := 0
					oPISCOF:ACELL[3]:oFONTBODY  := oFont01
					oPISCOF:ACELL[4]:oFONTBODY  := oFont01
					oPISCOF:ACELL[5]:oFONTBODY  := oFont01
					oPISCOF:ACELL[6]:oFONTBODY  := oFont01
					oPISCOF:ACELL[6]:nSize      := 22
					oPISCOF:ACELL[7]:oFONTBODY  := oFont01
					oPISCOF:ACELL[7]:nSize      := oPISCOF:ACELL[7]:nSize
					oPISCOF:ACELL[8]:oFONTBODY  := oFont01
					oPISCOF:ACELL[9]:oFONTBODY  := oFont01
					oPISCOF:ACELL[10]:oFONTBODY := oFont01
					oPISCOF:ACELL[11]:oFONTBODY := oFont01
					oPISCOF:ACELL[11]:nSize     := 5
					oPISCOF:ACELL[12]:oFONTBODY := oFont01
					oPISCOF:ACELL[13]:oFONTBODY := oFont01
					oPISCOF:ACELL[14]:oFONTBODY := oFont01
					oPISCOF:ACELL[15]:oFONTBODY := oFont01
			    EndIf
				cCpoOrd := "TRB->NUMNF + TRB->SERIE"
				IndRegua ("TRB", cArqTemp, "TIPO+ES+NUMNF+SERIE+DToS(EMISSAO)")

			ElseIf nOrdem == 3

				If oReport:GetOrientation() == 1
					oFont01:= TFont():New("Serif",,7,, .F. ,,,, .T. , .F. )
					oPISCOF:SetAutoSize()
					oPISCOF:SetLineBreak()
					oPISCOF:nColSpace := 0
					oPISCOF:ACELL[3]:oFONTBODY  := oFont01
					oPISCOF:ACELL[4]:oFONTBODY  := oFont01
					oPISCOF:ACELL[4]:nSize      := 22
					oPISCOF:ACELL[5]:oFONTBODY  := oFont01
					oPISCOF:ACELL[6]:oFONTBODY  := oFont01
					oPISCOF:ACELL[7]:oFONTBODY  := oFont01
					oPISCOF:ACELL[8]:oFONTBODY  := oFont01
					oPISCOF:ACELL[9]:oFONTBODY  := oFont01
					oPISCOF:ACELL[10]:oFONTBODY := oFont01
					oPISCOF:ACELL[11]:oFONTBODY := oFont01
					oPISCOF:ACELL[11]:nSize     := 5
					oPISCOF:ACELL[12]:oFONTBODY := oFont01
					oPISCOF:ACELL[13]:oFONTBODY := oFont01
					oPISCOF:ACELL[14]:oFONTBODY := oFont01
					oPISCOF:ACELL[15]:oFONTBODY := oFont01
			    EndIf
				cCpoOrd := "DToS(TRB->EMISSAO)"
				IndRegua ("TRB", cArqTemp, "TIPO+ES+DToS(EMISSAO)+NUMNF+SERIE")
			EndIf
	  		oPISCOF:Init()
			While !TRB->(Eof())
				cTipo	:= TRB->TIPO
				While !TRB->(Eof()) .and.  TRB->TIPO == cTipo
				   if cES <> TRB->ES

						oReport:PrintText(IIF(TRB->TIPO == "PIS",If( cPaisLoc $ "ANG|PTG", "Pis - programa de integração social", "PIS - Programa de Integração Social" ),If( cPaisLoc $ "ANG|PTG", "Cofins - contribuição para o financiamento da seguridade social", "COFINS - Contribuição para o Financiamento da Seguridade Social" )) + " - " + IIF(TRB->ES == "E","Entradas","Saídas"),,1100)
					endif
					oPISCOF:SetHeaderSection( .T. )
					oPISCOF:PrintHeader()
					oPISCOF:SetHeaderSection( .F. )
					cES := TRB->ES
					While !TRB->(Eof()) .and.  TRB->TIPO == cTipo .and.  TRB->ES == cES
						If nOrdem == 2
							cQuebra := TRB->NUMNF + TRB->SERIE
						Else
							cQuebra := DToS(TRB->EMISSAO)
						Endif
						While !TRB->(Eof()) .and.  TRB->TIPO == cTipo .and.  TRB->ES == cES .and.  &cCpoOrd == cQuebra

							M906TotRel(@aAliqCFGer,@aAliqEs,@aCFOPPISE,@aCFOPPISS,@aCFOPCOFE,@aCFOPCOFS,@aTAlPISE,@aTAlPISS,@aTAlCOFE,@aTAlCOFS,@aTotDoCFOP,@aTotDtEmis)
							If mv_par04 == 1
								oPISCOF:Printline()
								oReport:IncMeter()
							EndIf
							TRB->(dbSkip())
						EndDo
						If mv_par09 == 1 .and.  (nOrdem >= 2 .or.  (nOrdem == 1 .and.  mv_par04 == 1))
							M906DTEMIS(oReport,aTotDtEmis,nTamDsc)
						Endif
					EndDo
					If mv_par04 == 1
						M906CFOP(oReport,aTotDoCFOP,aTotPorCFOP,nTamDsc)
					Else
						AADD(aTotPorCFOP,aTotDoCFOP)
						aTotDoCFOP	:= {}
					Endif
					oReport:SkipLine()
					If mv_par10 == 1
					   M906TCFOP(oReport,aTotPorCFOP,nTamDsc)
                    Endif
					M906ENTSAI(oReport,aAliqEs,nTamDsc)
				EndDo
				CONTRI906(oReport,aAliqCFGer,cTipo)
			EndDo
			oPISCOF:Finish()
		EndIf


		If mv_par12 == 1
			cArqCp := strzero(month(mv_par02),2)+substr(strzero(year(mv_par02),4),3,2)+SM0->M0_CODIGO+SM0->M0_CODFIL+".CNC"
		Else
			cArqCp := strzero(month(mv_par02),2)+substr(strzero(year(mv_par02),4),3,2)+SM0->M0_CODIGO+SM0->M0_CODFIL+".CP"
		EndIf
		If File(cArqCp)
			oReport:SetTitle(If( cPaisLoc $ "ANG|PTG", "Inf. do apuramento", "Inf. da Apuração" ))

			oComple:Cell("DESCR"):SetBlock( {|| Substr(cLinArq,01,70)      } )
			oComple:Cell("VALOR"):SetBlock( {|| Val(Substr(cLinArq,71,14)) } )

			cContArq	:=	MemoRead(cArqCp)

			oComple:Init()
			For nContCp :=1 to MlCount(cContArq,100)
				cLinArq := MemoLine(cContArq,100,nContCp)
				oComple:PrintLine()
			Next
			oComple:Finish()
			oReport:EndPage()

			lResumo:= .T. 
		Endif

		If lResumo
			oResumo:Cell("DESCR"):SetBlock ( {|| aResumo[nX][1]} )
			oResumo:Cell("TRIBUT"):SetBlock( {|| aResumo[nX][2]} )
			oResumo:Cell("OUTROS"):SetBlock( {|| aResumo[nX][3]} )
			oResumo:Cell("TOTAL"):SetBlock ( {|| aResumo[nX][2] + aResumo[nX][3]} )
			oReport:SetTitle("Resumo")
			oResumo:Init()
			For nX := 1 To Len(aResumo)
				oResumo:Printline()
				For nY := 2 To 3
					aTotResumo[nX][nY] += aResumo[nX][nY]
				Next
			Next
			oResumo:Finish()
			oReport:EndPage()
		EndIf
	EndIf

	TRB->(DbCloseArea())
	FErase(cArqTemp+GetDBExtension())



	SM0->(dbSkip())
EndDo
DbSelectArea("SM0")
SM0->(DbGoTop())
SM0->(dbSeek(cEmpAnt+cFilOri, .T. ))
cFilAnt := cFilOri

If mv_par06 == 1
	oResCFOP	:= oReport:Section(8)
	oResAliq	:= oReport:Section(9)
	oResMov 	:= oReport:Section(10)

   oReport:SetTitle(If( cPaisLoc $ "ANG|PTG", "Resumo geral - totalização das filiais", "Resumo Geral - Totalização das Filiais" ))

	If len(aCFOPCOFE) > 0 .or.  len(aCFOPCOFS) > 0 .or.  len(aTAlCOFE) > 0 .or.  len(aTAlCOFS) > 0
		cTipo := "COF"
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Cofins - contribuição para o financiamento da seguridade social", "COFINS - Contribuição para o Financiamento da Seguridade Social" ),,1100)
		oReport:FatLine()
		If nOrdem == 1
			If len(aCFOPCOFE) > 0
				aCFOPCOFE := aSORT(aCFOPCOFE,,,{|X,Y|X[2]+X[1]<Y[2]+Y[1]})
				lEntrada  := .T. 

				oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo Por Cfop Processado - Entradas", "RESUMO POR CFOP PROCESSADO - ENTRADAS" ),,10)
				oReport:ThinLine()

				oResCFOP:Cell("CFOP"):SetBlock( {|| aCFOPCOFE[nX][2]} )
				oResCFOP:Cell("FILIAL"):SetBlock( {|| aCFOPCOFE[nX][1]} )
				oResCFOP:Cell("BASECNT"):SetBlock( {|| Abs(aCFOPCOFE[nX][3])} )
				oResCFOP:Cell("VALORCNT"):SetBlock( {|| Abs(aCFOPCOFE[nX][4])} )

				oResCFOP:Init()

				cCfopAnt := " "
				For nX := 1 To Len(aCFOPCOFE)
			    	If cCfopAnt <> aCFOPCOFE[nX][2]
			    		cCfopAnt :=aCFOPCOFE[nX][2]
						SX5->(MsSeek(xFilial("SX5")+"13"+cCfopAnt))
			    		oResCFOP:Cell("CFOP"):Show()
			    		oResCFOP:Cell("X5_DESCRI"):Show()
			    	Else
			    		oResCFOP:Cell("CFOP"):Hide()
			    		oResCFOP:Cell("X5_DESCRI"):Hide()
			    	EndIf
			    	oResCFOP:PrintLine()
				Next

				oResCFOP:Finish()
				oReport:SkipLine()
				oReport:ThinLine()
			EndIf

			If len(aCFOPCOFS) > 0
				aCFOPCOFS := aSORT(aCFOPCOFS,,,{|X,Y|X[2]+X[1]<Y[2]+Y[1]})
				lEntrada  := .F. 

				oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo Por Cfop Processado - Saídas", "RESUMO POR CFOP PROCESSADO - SAIDAS" ),,10)
				oReport:ThinLine()

				oResCFOP:Cell("CFOP"):SetBlock( {|| aCFOPCOFS[nX][2]} )
				oResCFOP:Cell("FILIAL"):SetBlock( {|| aCFOPCOFS[nX][1]} )
				oResCFOP:Cell("BASECNT"):SetBlock( {|| Abs(aCFOPCOFS[nX][3])} )
				oResCFOP:Cell("VALORCNT"):SetBlock( {|| Abs(aCFOPCOFS[nX][4])} )

				oResCFOP:Init()

				cCfopAnt := " "
				For nX := 1 To Len(aCFOPCOFS)
			    	If cCfopAnt <> aCFOPCOFS[nX][2]
			    		cCfopAnt := aCFOPCOFS[nX][2]
						SX5->(MsSeek(xFilial("SX5")+"13"+cCfopAnt))
			    		oResCFOP:Cell("CFOP"):Show()
			    		oResCFOP:Cell("X5_DESCRI"):Show()
			    	Else
			    		oResCFOP:Cell("CFOP"):Hide()
			    		oResCFOP:Cell("X5_DESCRI"):Hide()
			    	EndIf
			    	oResCFOP:PrintLine()

				Next

				oResCFOP:Finish()
				oReport:SkipLine()
				oReport:ThinLine()
			EndIf
		EndIf

		If len(aTAlCOFE) > 0
			oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo por taxa processada - entradas", "RESUMO POR ALÍQUOTA PROCESSADA - ENTRADAS" ),,10)
			oReport:ThinLine()

			oResAliq:Cell("FILIAL"):SetBlock( {|| aTAlCOFE[nX][1]} )
			oResAliq:Cell("ALIQ"):SetBlock( {|| aTAlCOFE[nX][2]} )
			oResAliq:Cell("VALOR"):SetBlock( {|| Abs(aTAlCOFE[nX][3])} )

			oResAliq:Init()

			For nX := 1 To Len(aTAlCOFE)
		    	oResAliq:PrintLine()
			Next

			oResAliq:Finish()
			oReport:SkipLine()
			oReport:ThinLine()
		EndIf

		If len(aTAlCOFS) > 0
			oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo por taxa processada - saidas", "RESUMO POR ALÍQUOTA PROCESSADA - SAÍDAS" ),,10)
			oReport:ThinLine()

			oResAliq:Cell("FILIAL"):SetBlock( {|| aTAlCOFS[nX][1]} )
			oResAliq:Cell("ALIQ"):SetBlock( {|| aTAlCOFS[nX][2]} )
			oResAliq:Cell("VALOR"):SetBlock( {|| Abs(aTAlCOFS[nX][3])} )

			oResAliq:Init()

			For nX := 1 To Len(aTAlCOFS)
		    	oResAliq:PrintLine()
			Next

			oResAliq:Finish()
			oReport:SkipLine()
			oReport:ThinLine()
		EndIf
	EndIf

	If lApurCof
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo Apurado", "RESUMO APURADO" ),,10)
		oReport:ThinLine()
		oReport:PrintText("Total Apurado...........:",,10)

		nLin := oReport:Row()
		oReport:PrintText(Transform(ABS(aTApurCOF[1]),PesqPict("SD2","D2_TOTAL"))	,nLin,oContr:Cell("VALOR"):ColPos())
		oReport:PrintText(IIf(aTApurCOF[1] < 0,"(C)","(D)")							  	,nLin,oContr:Cell("CD"):ColPos())
		oReport:PrintText(Transform(Abs(aTApurCOF[2]),PesqPict("SD2","D2_TOTAL"))	,nLin,oContr:Cell("VALORCONT"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[3],PesqPict("SD2","D2_TOTAL"))		,nLin,oContr:Cell("ZFRANCA"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[4],PesqPict("SD2","D2_TOTAL"))		,nLin,oContr:Cell("VALDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[5],PesqPict("SD2","D2_TOTAL"))		,nLin,oContr:Cell("VALCRED"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[6],PesqPict("SD2","D2_TOTAL"))		,nLin,oContr:Cell("BASEDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[7],PesqPict("SD2","D2_TOTAL"))		,nLin,oContr:Cell("BASECRED"):ColPos())

		oReport:SkipLine(2)
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Total de retenção.......:", "Total de Retenção.......:" ),,10)
		oReport:PrintText(Transform(nTDedCOF,PesqPict("SD2","D2_TOTAL")),,oContr:Cell("VALOR"):ColPos())

		oReport:SkipLine()
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Total da contribuição...:", "Total da Contribuição...:" ),,10)
		nLin := oReport:Row()
		oReport:PrintText(Transform(ABS(aTApurCOF[1] - nTDedCOF),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALOR"):ColPos())
		oReport:PrintText(IIf(aTApurCOF[1] < 0,"(C)","(D)"),nLin,oContr:Cell("CD"):ColPos())
		oReport:PrintText(Transform(Abs(aTApurCOF[2]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALORCONT"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[3],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("ZFRANCA"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[4],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[5],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALCRED"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[6],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASEDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurCOF[7],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASECRED"):ColPos())
		oReport:SkipLine(2)
		oReport:FatLine()
	EndIf

	If len(aCFOPPISE) > 0 .or.  len(aCFOPPISS) > 0 .or.  len(aTAlPISE) > 0 .or.  len(aTAlPISS) > 0
		cTipo := "PIS"
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Pis - programa de integração social", "PIS - Programa de Integração Social" ),,1200)
		oReport:FatLine()

		If nOrdem == 1
			If len(aCFOPPISE) > 0
				aCFOPPISE := aSORT(aCFOPPISE,,,{|X,Y|X[2]+X[1]<Y[2]+Y[1]})
				lEntrada  := .T. 

				oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo Por Cfop Processado - Entradas", "RESUMO POR CFOP PROCESSADO - ENTRADAS" ),,10)
				oReport:ThinLine()

				oResCFOP:Cell("CFOP"):SetBlock( {|| aCFOPPISE[nX][2]} )
				oResCFOP:Cell("FILIAL"):SetBlock( {|| aCFOPPISE[nX][1]} )
				oResCFOP:Cell("BASECNT"):SetBlock( {|| Abs(aCFOPPISE[nX][3])} )
				oResCFOP:Cell("VALORCNT"):SetBlock( {|| Abs(aCFOPPISE[nX][4])} )

				oResCFOP:Init()

				cCfopAnt := " "
				For nX := 1 To Len(aCFOPPISE)
			    	If cCfopAnt <> aCFOPPISE[nX][2]
			    		cCfopAnt := aCFOPPISE[nX][2]
						SX5->(MsSeek(xFilial("SX5")+"13"+cCfopAnt))
			    		oResCFOP:Cell("CFOP"):Show()
			    		oResCFOP:Cell("X5_DESCRI"):Show()
			    	Else
			    		oResCFOP:Cell("CFOP"):Hide()
			    		oResCFOP:Cell("X5_DESCRI"):Hide()
			    	EndIf
			    	oResCFOP:PrintLine()
				Next

				oResCFOP:Finish()
				oReport:SkipLine()
				oReport:ThinLine()
			EndIf

			If len(aCFOPPISS) > 0
				aCFOPPISS := aSORT(aCFOPPISS,,,{|X,Y|X[2]+X[1]<Y[2]+Y[1]})
				lEntrada  := .F. 
				oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo Por Cfop Processado - Saídas", "RESUMO POR CFOP PROCESSADO - SAIDAS" ),,10)
				oReport:ThinLine()

				oResCFOP:Cell("CFOP"):SetBlock( {|| aCFOPPISS[nX][2]} )
				oResCFOP:Cell("FILIAL"):SetBlock( {|| aCFOPPISS[nX][1]} )
				oResCFOP:Cell("BASECNT"):SetBlock( {|| Abs(aCFOPPISS[nX][3])} )
				oResCFOP:Cell("VALORCNT"):SetBlock( {|| Abs(aCFOPPISS[nX][4])} )

				oResCFOP:Init()

				cCfopAnt := " "
				For nX := 1 To Len(aCFOPPISS)
			    	If cCfopAnt <> aCFOPPISS[nX][2]
			    		cCfopAnt :=aCFOPPISS[nX][2]
						SX5->(MsSeek(xFilial("SX5")+"13"+cCfopAnt))
			    		oResCFOP:Cell("CFOP"):Show()
			    		oResCFOP:Cell("X5_DESCRI"):Show()
			    	Else
			    		oResCFOP:Cell("CFOP"):Hide()
			    		oResCFOP:Cell("X5_DESCRI"):Hide()
			    	EndIf
			    	oResCFOP:PrintLine()
				Next

				oResCFOP:Finish()
				oReport:SkipLine()
				oReport:ThinLine()
			EndIf
		EndIf

		If len(aTAlPISE) > 0
			oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo por taxa processada - entradas", "RESUMO POR ALÍQUOTA PROCESSADA - ENTRADAS" ),,10)
			oReport:ThinLine()

			oResAliq:Cell("FILIAL"):SetBlock( {|| aTAlPISE[nX][1]} )
			oResAliq:Cell("ALIQ"):SetBlock( {|| aTAlPISE[nX][2]} )
			oResAliq:Cell("VALOR"):SetBlock( {|| Abs(aTAlPISE[nX][3])} )

			oResAliq:Init()

			For nX := 1 To Len(aTAlPISE)
		    	oResAliq:PrintLine()
			Next

			oResAliq:Finish()
			oReport:SkipLine()
			oReport:ThinLine()
		EndIf

		If len(aTAlPISS) > 0
			oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo por taxa processada - saidas", "RESUMO POR ALÍQUOTA PROCESSADA - SAÍDAS" ),,10)
			oReport:ThinLine()

			oResAliq:Cell("FILIAL"):SetBlock( {|| aTAlPISS[nX][1]} )
			oResAliq:Cell("ALIQ"):SetBlock( {|| aTAlPISS[nX][2]} )
			oResAliq:Cell("VALOR"):SetBlock( {|| Abs(aTAlPISS[nX][3])} )

			oResAliq:Init()

			For nX := 1 To Len(aTAlPISS)
		    	oResAliq:PrintLine()
			Next

			oResAliq:Finish()
			oReport:SkipLine()
			oReport:ThinLine()
		EndIf
	EndIf

	If lApurPis
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Resumo Apurado", "RESUMO APURADO" ),,10)
		oReport:ThinLine()
		oReport:PrintText("Total Apurado...........:",,10)

		nLin := oReport:Row()
		oReport:PrintText(Transform(ABS(aTApurPIS[1]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALOR"):ColPos())
		oReport:PrintText(IIf(aTApurPIS[1] < 0,"(C)","(D)"),nLin,oContr:Cell("CD"):ColPos())
		oReport:PrintText(Transform(Abs(aTApurPIS[2]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALORCONT"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[3],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("ZFRANCA"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[4],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[5],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALCRED"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[6],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASEDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[7],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASECRED"):ColPos())

		oReport:SkipLine(2)
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Total de retenção.......:", "Total de Retenção.......:" ),,10)
		oReport:PrintText(Transform(nTDedPIS,PesqPict("SD2","D2_TOTAL")),,oContr:Cell("VALOR"):ColPos())

		oReport:SkipLine()
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Total da contribuição...:", "Total da Contribuição...:" ),,10)
		nLin := oReport:Row()
		oReport:PrintText(Transform(ABS(aTApurPIS[1] - nTDedPIS),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALOR"):ColPos())
		oReport:PrintText(IIf(aTApurPIS[1] < 0,"(C)","(D)"),nLin,oContr:Cell("CD"):ColPos())
		oReport:PrintText(Transform(Abs(aTApurPIS[2]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALORCONT"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[3],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("ZFRANCA"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[4],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[5],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALCRED"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[6],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASEDEBT"):ColPos())
		oReport:PrintText(Transform(aTApurPIS[7],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASECRED"):ColPos())
		oReport:SkipLine(2)
		oReport:FatLine()
	EndIf

	If lResumo
		oReport:PrintText("Resumo Processado",,1300)
		oReport:FatLine()

		oResMov:Cell("DESCR"):SetBlock( {|| aTotResumo[nX][1]} )
		oResMov:Cell("TRIBUT"):SetBlock( {|| aTotResumo[nX][2]} )
		oResMov:Cell("OUTROS"):SetBlock( {|| aTotResumo[nX][3]} )
		oResMov:Cell("TOTAL"):SetBlock( {|| aTotResumo[nX][2] + aTotResumo[nX][3]} )

		oResMov:Init()

		For nX := 1 To Len(aTotResumo)
	    	oResMov:PrintLine()
		Next

		oResMov:Finish()
	EndIf
EndIf

RestArea(aAreaSM0)
cFilAnt := SM0->M0_CODFIL
Return














Static Function M906ENTSAI(oReport,aAliqes,nTamDsc)

Local nX
Local nOrdem 	:= oReport:Section(1):GetOrder()
Local oTotAliq	:= oReport:Section(4)

oTotAliq:SetTotalText(Iif(TRB->ES=="S",If( cPaisLoc $ "ANG|PTG", "Total De Entradas", "Total de Entradas" ),If( cPaisLoc $ "ANG|PTG", "Total de saídas", "Total de Saídas" )))
oTotAliq:SetHeaderSection( .F. )
oTotAliq:Cell("DESCRI")   :SetSize(nTamDsc+5, .f. )
oTotAliq:Cell("DESCRI")   :SetBlock( {|| If( cPaisLoc $ "ANG|PTG", "Total da taxa", "Total da Alíquota" ) + Transform(aAliqEs[nX][1],"@E 99.99%")} )
oTotAliq:Cell("VALORCONT"):SetBlock( {|| aAliqEs[nX][2]} )
oTotAliq:Cell("ZFRANCA")  :SetBlock( {|| aAliqEs[nX][3]} )
oTotAliq:Cell("VALDEBT")  :SetBlock( {|| aAliqEs[nX][4]} )
oTotAliq:Cell("VALCRED")  :SetBlock( {|| aAliqEs[nX][5]} )
oTotAliq:Cell("BASEDEBT") :SetBlock( {|| aAliqEs[nX][6]} )
oTotAliq:Cell("BASECRED") :SetBlock( {|| aAliqEs[nX][7]} )

oTotAliq:Init()
For nX := 1 to len(aAliqes)
	oTotAliq:PrintLine()
Next
oTotAliq:Finish()
aAliqes := {}

oReport:SkipLine()
oReport:SkipLine()

Return












Static Function M906CFOP(oReport,aTotDoCFOP,aTotPorCFOP,nTamDsc)

Local nX
Local nOrdem 	:= oReport:Section(1):GetOrder()
Local oTotCFOP	:= oReport:Section(11)

oTotCFOP:SetHeaderSection( .F. )
oTotCFOP:Cell("DESCRI")   :SetSize(nTamDsc+5, .f. )
oTotCFOP:Cell("DESCRI")   :SetBlock( {|| If( cPaisLoc $ "ANG|PTG", "Total Do Cód. Fiscal", "Total do CFOP" ) + " - " + aTotDoCFOP[nX][1]} )
oTotCFOP:Cell("VALORCONT"):SetBlock( {|| aTotDoCFOP[nX][2]} )
oTotCFOP:Cell("ZFRANCA")  :SetBlock( {|| aTotDoCFOP[nX][3]} )
oTotCFOP:Cell("VALDEBT")  :SetBlock( {|| aTotDoCFOP[nX][4]} )
oTotCFOP:Cell("VALCRED")  :SetBlock( {|| aTotDoCFOP[nX][5]} )
oTotCFOP:Cell("BASEDEBT") :SetBlock( {|| aTotDoCFOP[nX][6]} )
oTotCFOP:Cell("BASECRED") :SetBlock( {|| aTotDoCFOP[nX][7]} )

oTotCFOP:Init()
For nX := 1 to len(aTotDoCFOP)
	oTotCFOP:PrintLine()
Next
oTotCFOP:Finish()

AADD(aTotPorCFOP,aTotDoCFOP)
aTotDoCFOP	:= {}

oReport:SkipLine()
Return












Static Function M906TCFOP(oReport,aTotPorCFOP,nTamDsc)

Local nX
Local nOrdem	:= oReport:Section(1):GetOrder()
Local oTotCFOP	:= oReport:Section(11)

oTotCFOP:SetHeaderSection( .F. )
oTotCFOP:Cell("DESCRI")   :SetSize(nTamDsc+5, .f. )
oTotCFOP:Cell("DESCRI")   :SetBlock( {|| iif(nX==1,If( cPaisLoc $ "ANG|PTG", "Total Por Código Fiscal:", "Total por CFOP:" ),space(len(If( cPaisLoc $ "ANG|PTG", "Total Por Código Fiscal:", "Total por CFOP:" )))) + " " + aTotPorCFOP[nX][1][1]} )
oTotCFOP:Cell("VALORCONT"):SetBlock( {|| aTotPorCFOP[nX][1][2]} )
oTotCFOP:Cell("ZFRANCA")  :SetBlock( {|| aTotPorCFOP[nX][1][3]} )
oTotCFOP:Cell("VALDEBT")  :SetBlock( {|| aTotPorCFOP[nX][1][4]} )
oTotCFOP:Cell("VALCRED")  :SetBlock( {|| aTotPorCFOP[nX][1][5]} )
oTotCFOP:Cell("BASEDEBT") :SetBlock( {|| aTotPorCFOP[nX][1][6]} )
oTotCFOP:Cell("BASECRED") :SetBlock( {|| aTotPorCFOP[nX][1][7]} )

oTotCFOP:Init()
For nX := 1 to len(aTotPorCFOP)
	oTotCFOP:PrintLine()
Next
oTotCFOP:Finish()

aTotPorCFOP	:= {}

Return













Static Function M906DTEMIS(oReport,aTotDtEmis,nTamDsc)

Local nX
Local nOrdem		:= oReport:Section(1):GetOrder()
Local oTotDTEMI	:= oReport:Section(12)

oTotDTEMI:SetHeaderSection( .F. )
oTotDTEMI:Cell("DESCRI")   :SetSize(nTamDsc+5, .f. )
oTotDTEMI:Cell("DESCRI")   :SetBlock( {|| If( cPaisLoc $ "ANG|PTG", "Total Do Dia", "Total do Dia" ) + " " + DtoC(aTotDtEmis[nX][1])} )
oTotDTEMI:Cell("VALORCONT"):SetBlock( {|| aTotDtEmis[nX][2]} )
oTotDTEMI:Cell("ZFRANCA")  :SetBlock( {|| aTotDtEmis[nX][3]} )
oTotDTEMI:Cell("VALDEBT")  :SetBlock( {|| aTotDtEmis[nX][4]} )
oTotDTEMI:Cell("VALCRED")  :SetBlock( {|| aTotDtEmis[nX][5]} )
oTotDTEMI:Cell("BASEDEBT") :SetBlock( {|| aTotDtEmis[nX][6]} )
oTotDTEMI:Cell("BASECRED") :SetBlock( {|| aTotDtEmis[nX][7]} )

oTotDTEMI:Init()
For nX := 1 to len(aTotDtEmis)
	oTotDTEMI:PrintLine()
Next
oTotDTEMI:Finish()

aTotDtEmis := {}

oReport:SkipLine()
Return














Static Function CONTRI906(oReport,aAliqCFGer,cTipo)

Local oContr 		:= oReport:Section(5)
Local nOrdem 		:= oReport:Section(1):GetOrder()
Local oPISCOF		:= oReport:Section(nOrdem)
Local nAliq 		:= 0
Local nX			:= 0
Local nY			:= 0
Local aValContri	:= {0,0,0,0,0,0,0}
Local aContAliq 	:= {0,0,0,0,0,0,0}
Local aRet			:= {0,0}
Local lOrgPub		:= IIF(mv_par13 == 1, .T. , .F. )
Local aDedRet		:= FsCalcRet(mv_par02,mv_par03,,,2,,@aRet,, .T. ,cFilAnt,,lOrgPub)
Local nDedRet		:= IIF(cTipo=="PIS",aDedRet[1],aDedRet[2])
Local nRetencao	:= IIF(cTipo=="PIS",aRet[1],aRet[2])
Local lFirst 		:= .T. 

nTDedPIS	+= IIF(cTipo=="PIS",nDedRet,0)
nTDedCOF	+= IIF(cTipo=="PIS",0,nDedRet)

Asort(aAliqCFGer,,,{|x,y|Str(x[1])+x[2] < Str(y[1])+y[2]})

If nOrdem >= 2
	oContr:Cell("CD"):SetSize(31, .F. )
EndIf

oContr:Cell("CFOP"):SetBlock( {|| aAliqCFGer[nX][2]} )
oContr:Cell("VALOR"):SetBlock( {|| abs(aAliqCFGer[nX][3])} )
oContr:Cell("CD"):SetBlock( {|| IIf(aAliqCFGer[nX][3] < 0,"(C)","(D)")} )
oContr:Cell("VALORCONT"):SetBlock( {|| abs(aAliqCFGer[nX][4])} )
oContr:Cell("ZFRANCA"):SetBlock( {|| aAliqCFGer[nX][5]} )
oContr:Cell("ALIQ"):SetValue( Space(TamSx3("B1_VLR_COF")[1]) )
oContr:Cell("VALDEBT"):SetBlock( {|| aAliqCFGer[nX][6]} )
oContr:Cell("VALCRED"):SetBlock( {|| aAliqCFGer[nX][7]} )
oContr:Cell("BASEDEBT"):SetBlock( {|| aAliqCFGer[nX][8]} )
oContr:Cell("BASECRED"):SetBlock( {|| aAliqCFGer[nX][9]} )

oReport:SkipLine(2)
oReport:FatLine()
oReport:PrintText("Contribuição: ",,10)

nAliq		:= 0
lFirst	:= .T. 

oContr:Init()
For nX := 1 To Len(aAliqCFGer)

	If mv_par10 == 2
		oContr:Hide()
	EndIf
	If nAliq <> aAliqCFGer[nX][1]
		If !lFirst
			oContr:Finish()
			oReport:SkipLine()
			oReport:PrintText("Total",,10)
			oReport:ThinLine()
			nLin := oReport:Row()
			oReport:PrintText(Transform(ABS(aContAliq[1]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALOR"):ColPos())
			oReport:PrintText(IIf(aContAliq[1] < 0,"(C)","(D)"),nLin,oContr:Cell("CD"):ColPos())
			oReport:PrintText(Transform(Abs(aContAliq[2]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALORCONT"):ColPos())
			oReport:PrintText(Transform(aContAliq[3],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("ZFRANCA"):ColPos())
			oReport:PrintText(Transform(aContAliq[4],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALDEBT"):ColPos()+28)
			oReport:PrintText(Transform(aContAliq[5],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALCRED"):ColPos()+26)
			oReport:PrintText(Transform(aContAliq[6],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASEDEBT"):ColPos()+22)
			oReport:PrintText(Transform(aContAliq[7],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASECRED"):ColPos()+20)
			oContr:Init()
		EndIf
		aContAliq := {0,0,0,0,0,0,0}
		nAliq     := aAliqCFGer[nX][1]
		oReport:SkipLine(2)
		oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Quota: ", "Alíquota: " ) + Transform(nAliq,Iif(nAliq<>0,PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]),PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]))),,10)
		lFirst    := .F. 
	Endif

	If mv_par10 == 2
		oContr:Hide()
	EndIf

	For nY := 1 to 7
		aContAliq[nY]  += aAliqCFGer[nX][nY+2]
		aValContri[nY] += aAliqCFGer[nX][nY+2]
		If cTipo == "PIS"
			aTApurPIS[nY] += aAliqCFGer[nX][nY+2]
			lApurPis := .T. 
		Else
			aTApurCOF[nY] += aAliqCFGer[nX][nY+2]
			lApurCof := .T. 
		EndIf
	Next

	oContr:Printline()
Next
oContr:Finish()

If Len(aAliqCFGer) > 0
	oReport:SkipLine()
	oReport:PrintText("Total",,10)
	oReport:ThinLine()
	nLin := oReport:Row()
	oReport:PrintText(Transform(ABS(aContAliq[1]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALOR"):ColPos())
	oReport:PrintText(IIf(aContAliq[1] < 0,"(C)","(D)"),nLin,oContr:Cell("CD"):ColPos())
	oReport:PrintText(Transform(Abs(aContAliq[2]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALORCONT"):ColPos())
	oReport:PrintText(Transform(aContAliq[3],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("ZFRANCA"):ColPos())
	oReport:PrintText(Transform(aContAliq[4],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALDEBT"):ColPos()+28)
	oReport:PrintText(Transform(aContAliq[5],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALCRED"):ColPos()+26)
	oReport:PrintText(Transform(aContAliq[6],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASEDEBT"):ColPos()+22)
	oReport:PrintText(Transform(aContAliq[7],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASECRED"):ColPos()+20)

	oReport:SkipLine(2)
	oReport:PrintText("Total Apurado",,10)
	oReport:ThinLine()
	nLin := oReport:Row()
	oReport:PrintText(Transform(ABS(aValContri[1]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALOR"):ColPos())
	oReport:PrintText(IIf(aValContri[1] < 0,"(C)","(D)"),nLin,oContr:Cell("CD"):ColPos())
	oReport:PrintText(Transform(Abs(aValContri[2]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALORCONT"):ColPos())
	oReport:PrintText(Transform(aValContri[3],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("ZFRANCA"):ColPos())
	oReport:PrintText(Transform(aValContri[4],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALDEBT"):ColPos()+28)
	oReport:PrintText(Transform(aValContri[5],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALCRED"):ColPos()+26)
	oReport:PrintText(Transform(aValContri[6],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASEDEBT"):ColPos()+22)
	oReport:PrintText(Transform(aValContri[7],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASECRED"):ColPos()+20)

	oReport:SkipLine(2)
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Total de retenção(modalidade da dedução: validade)........: ", "Total de Retenção(Modalidade da Dedução: Vencimento)........: " ),,10)
	oReport:ThinLine()
	oReport:PrintText(Transform(nRetencao,PesqPict("SD2","D2_TOTAL")),,oContr:Cell("VALOR"):ColPos())

	oReport:SkipLine(2)
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Total de retenção - órgãos públicos(modalidade da dedução: pagamento)........: ", "Total de Retenção - Orgãos Públicos(Modalidade da Dedução: Pagamento)........: " ),,10)
	oReport:ThinLine()
	oReport:PrintText(Transform((nDedRet-nRetencao),PesqPict("SD2","D2_TOTAL")),,oContr:Cell("VALOR"):ColPos())

	oReport:SkipLine()
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "Total da contribuição", "Total da Contribuição" ),,10)
	oReport:ThinLine()
	nLin := oReport:Row()
	oReport:PrintText(Transform(ABS(aValContri[1] - nDedRet),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALOR"):ColPos())
	oReport:PrintText(IIf(aValContri[1] < 0,"(C)","(D)"),nLin,oContr:Cell("CD"):ColPos())
	oReport:PrintText(Transform(Abs(aValContri[2]),PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALORCONT"):ColPos())
	oReport:PrintText(Transform(aValContri[3],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("ZFRANCA"):ColPos())
	oReport:PrintText(Transform(aValContri[4],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALDEBT"):ColPos()+28)
	oReport:PrintText(Transform(aValContri[5],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("VALCRED"):ColPos()+26)
	oReport:PrintText(Transform(aValContri[6],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASEDEBT"):ColPos()+22)
	oReport:PrintText(Transform(aValContri[7],PesqPict("SD2","D2_TOTAL")),nLin,oContr:Cell("BASECRED"):ColPos()+20)

	oReport:SkipLine(2)
	oReport:PrintText(If( cPaisLoc $ "ANG|PTG", "(c) Crédito / (d) Débito", "(C) Credito / (D) Debito" ),,10)
EndIf
oReport:EndPage()
aAliqCFGer	:= {}
Return










Static Function MONTATRB()


	Local aStruSD1		:= {}
	Local aStruSD2		:= {}
	Local aStruSB1 	 	:= {}
	Local aStruSF2		:= {}
	Local aStruSF1		:= {}
	Local aStruSF4		:= {}
	Local nX			:= 0


Local cAliasSD2  	:= "SD2"
Local cAliasSD1  	:= "SD1"
Local cAliasSB1  	:= "SB1"
Local cAliasSF4  	:= "SF4"
Local cAliasSF2  	:= "SF2"
Local cAliasSF1  	:= "SF1"
Local cB1_GRTRIB 	:= ""
Local cCliFor		:= ""
Local dDtCorte	  	:= GetNewPar("MV_DTCORTE",CtoD("01/02/2004"))
Local lApurac    	:= (SF4->(FieldPos("F4_PISFISC")) > 0)
Local lA1_GRPTRIB	:= SA1->(FieldPos("A1_GRPTRIB")) <> 0
Local lA2_GRPTRIB	:= SA2->(FieldPos("A2_GRPTRIB")) <> 0
Local nRedPis	  	:= 1
Local nRedCOF	  	:= 1
Local nValPisPas 	:= 0
Local nBasPisPas 	:= 0
Local nValCofins 	:= 0
Local nBasCofins 	:= 0
Local nTxPis     	:= 0
Local nTxCof     	:= 0
Local nExPis     	:= 0
Local nExCof     	:= 0
Local nPautaPIS		:= 0
Local nPautaCOF		:= 0
Local cDebSTPIS		:= GetNewPar("MV_DBSTPIS","1")
Local cDebSTCOF		:= GetNewPar("MV_DBSTCOF","1")


	Local cDEDBCOF		:= GetNewPar("MV_DEDBCOF"," ")
	Local cDEDBPIS		:= GetNewPar("MV_DEDBPIS"," ")



aResumo	:= {}
AADD(aResumo,{"Saídas",0,0})
AADD(aResumo,{If( cPaisLoc $ "ANG|PTG", "Devoluções de saídas", "Devoluções de Saídas" ),0,0})
AADD(aResumo,{"Entradas",0,0})
AADD(aResumo,{If( cPaisLoc $ "ANG|PTG", "Devoluções de entradas", "Devoluções de Entradas" ),0,0})

cArqTemp := CriaTrab(aArqTemp)
dbUseArea( .T. ,__LocalDriver,cArqTemp,"TRB")
IndRegua("TRB",cArqTemp,IIF(MV_PAR09==1,"TIPO+CFOP+DTOS(EMISSAO)","TIPO+CFOP"))
dbSelectArea("TRB")

dbSelectArea("SD2")
SD2->(dbSetOrder(5))

	lQuery		:= .T. 
	cAliasSD2	:= "a906AMontSD2"
	cAliasSF2	:= "a906AMontSD2"
	cAliasSF4	:= "a906AMontSD2"
	cAliasSB1	:= "a906AMontSD2"

	aStruSD2	:= SD2->(dbStruct())
	aStruSB1	:= SB1->(dbStruct())
	aStruSF4	:= SF4->(dbStruct())
	aStruSF2	:= SF2->(dbStruct())

	cQuery		:= "SELECT F4_AGREG,F4_IPI,F2_SERIE,F2_DOC,F2_SEGURO,F2_FRETE,F2_DESPESA,F2_VALMERC,D2_TOTAL,D2_DOC,D2_SERIE,D2_EMISSAO,D2_CF,D2_COD,D2_DESCZFR,B1_POSIPI,D2_TIPO,"
	cQuery		+= "D2_ICMSRET,D2_VALIPI,D2_VALFRE,D2_SEGURO,D2_DESPESA,D2_CLIENTE,D2_LOJA,D2_VALBRUT "
	If !Empty( nPsVlPisSa )
		cQuery += "," + cCpVlPisSa
	EndIf
	If !Empty( nPsBsPisSa )
		cQuery += "," + cCpBsPisSa
	EndIf
	If !Empty( nPsAlPisSa )
		cQuery += "," + cCpAlPisSa
	EndIf
	If !Empty( nPsVlCofSa )
		cQuery += "," + cCpVlCOfSa
	EndIf
	If !Empty( nPsBsCofSa )
		cQuery += "," + cCpBsCofSa
	EndIf
	If !Empty( nPsAlCofSa )
		cQuery += "," + cCpAlCOfSa
	EndIf
	If SB1->(FieldPos("B1_PPIS")) >0
		cQuery += ",B1_PPIS "
	Endif
	If SB1->(FieldPos("B1_REDPIS")) > 0
		cQuery += ",B1_REDPIS "
	Endif
	If SB1->(FieldPos("B1_VLR_PIS")) >0
		cQuery += ",B1_VLR_PIS "
	Endif
	If SB1->(FieldPos("B1_REDCOF")) > 0
		cQuery += ",B1_REDCOF "
	Endif
	If SB1->(FieldPos("B1_PCOFINS")) > 0
		cQuery += ",B1_PCOFINS "
	Endif
	If SB1->(FieldPos("B1_VLR_COF")) >0
		cQuery += ",B1_VLR_COF "
	Endif
	If SB1->(FieldPos("B1_GRTRIB")) > 0
		cQuery += ",B1_GRTRIB "
	Endif
	If SF4->(FieldPos("F4_BASEPIS")) > 0
		cQuery += ",F4_BASEPIS "
	Endif
	If SF4->(FieldPos("F4_BASECOF")) > 0
		cQuery += ",F4_BASECOF "
	Endif
	If SF4->(FieldPos("F4_PISCOF")) > 0
		cQuery += ",F4_PISCOF "
	Endif
	If SF4->(FieldPos("F4_PISCRED")) > 0
		cQuery += ",F4_PISCRED "
	Endif
	If SF4->(FieldPos("F4_TPREG")) > 0
		cQuery += ",F4_TPREG "
	Endif
	If lApurac
		cQuery += ",F4_PISFISC "
	Endif

	cQuery 	+= "FROM "+RetSqlName("SD2")+" SD2, "
	cQuery 	+= RetSqlName("SF4")+" SF4, "
	cQuery 	+= RetSqlName("SB1")+" SB1, "
	cQuery 	+= RetSqlName("SF2")+" SF2 "

	cQuery 	+= "WHERE D2_FILIAL='"+xFilial("SD2")+"' AND "
	cQuery 	+= "D2_EMISSAO>='"+Dtos(MV_PAR02)+"' AND "
	cQuery 	+= "D2_EMISSAO<='"+Dtos(MV_PAR03)+"' AND "
	cQuery  += "SD2.D_E_L_E_T_ = ' ' AND "

	cQuery  += "F4_FILIAL = '"+xFilial("SF4")+"' AND "
	cQuery  += "F4_CODIGO = D2_TES AND "
	cQuery  += "SF4.D_E_L_E_T_ = ' ' AND "


	If !((Empty (MV_PAR05)) .Or.  ("*"$MV_PAR05))
		cQuery += " F4_NRLIVRO='"+MV_PAR05+"' AND "
	EndIf
	cQuery  += "B1_FILIAL = '"+xFilial("SB1")+"' AND "
	cQuery  += "B1_COD = D2_COD AND "
	cQuery  += "SB1.D_E_L_E_T_ = ' ' AND "

	cQuery  += "F2_FILIAL = '"+xFilial("SF2")+"' AND "
	cQuery  += "F2_DOC = D2_DOC AND "
	cQuery  += "F2_SERIE = D2_SERIE AND "
	cQuery  += "F2_CLIENTE = D2_CLIENTE AND "
	cQuery  += "F2_LOJA = D2_LOJA AND "
	cQuery  += "F2_EMISSAO = D2_EMISSAO AND "
	cQuery  += "SF2.D_E_L_E_T_ = ' ' "





	If Upper(cDEDBCOF) $ "P#S" .Or.  Upper(cDEDBPIS) $ "P#S"
		cQuery  += " AND ((F4_IPI = 'S' AND F4_CREDIPI = 'N' "
		cQuery  += " AND SF2.F2_TIPO IN('I', 'P'))  "
		cQuery  += " OR  (SF2.F2_TIPO NOT IN('I', 'P'))) "
	Else
		cQuery  += " AND SF2.F2_TIPO NOT IN('I', 'P') "
	EndIF

	If ExistBlock("MT996QRY")
		cQuery := ExecBlock("MT996QRY", .F. , .F. ,{cQuery,1})
	EndIf

    If mv_par11 ==1
		cQuery += "ORDER BY D2_CF, D2_DOC, D2_CLIENTE"
	Else
		cQuery += "ORDER BY D2_CF, D2_COD, D2_CLIENTE"
	Endif

	cQuery := ChangeQuery(cQuery)
	dbUseArea( .T. ,"TOPCONN",TcGenQry(,,cQuery),cAliasSD2, .T. , .T. )

	For nX := 1 To len(aStruSD2)
		If aStruSD2[nX][2] <> "C" .And.  FieldPos(aStruSD2[nX][1])<>0
			TcSetField(cAliasSD2,aStruSD2[nX][1],aStruSD2[nX][2],aStruSD2[nX][3],aStruSD2[nX][4])
		EndIf
	next

	For nX := 1 To len(aStruSB1)
		If aStruSB1[nX][2] <> "C" .And.  FieldPos(aStruSB1[nX][1])<>0
			TcSetField(cAliasSB1,aStruSB1[nX][1],aStruSB1[nX][2],aStruSB1[nX][3],aStruSB1[nX][4])
		EndIf
	next

	For nX := 1 To len(aStruSF4)
		If aStruSF4[nX][2] <> "C" .And.  FieldPos(aStruSF4[nX][1])<>0
			TcSetField(cAliasSF4,aStruSF4[nX][1],aStruSF4[nX][2],aStruSF4[nX][3],aStruSF4[nX][4])
		EndIf
	next

	For nX := 1 To len(aStruSF2)
		If aStruSF2[nX][2] <> "C" .And.  FieldPos(aStruSF2[nX][1])<>0
			TcSetField(cAliasSF2,aStruSF2[nX][1],aStruSF2[nX][2],aStruSF2[nX][3],aStruSF2[nX][4])
		EndIf
	next

	dbSelectArea(cAliasSD2)
	nPsVlPisSa := ( cAliasSD2 )->( FieldPos( cCpVlPisSa ) )
	nPsBsPisSa := ( cAliasSD2 )->( FieldPos( cCpBsPisSa ) )
	nPsAlPisSa := ( cAliasSD2 )->( FieldPos( cCpAlPisSa ) )
	nPsVlCofSa := ( cAliasSD2 )->( FieldPos( cCpVlCofSa ) )
	nPsBsCOfSa := ( cAliasSD2 )->( FieldPos( cCpBsCofSa ) )
	nPsAlCofSa := ( cAliasSD2 )->( FieldPos( cCpAlCofSa ) )
















While (cAliasSD2)->(!Eof())
	nPautaPIS := 0
	nPautaCOF := 0

	If !lQuery
		SF4->(dbSetOrder(1))
		SF4->(MsSeek(xFilial("SF4")+(cAliasSD2)->D2_TES))
		SB1->(dbSetOrder(1))
		SB1->(MsSeek(xFilial("SB1")+(cAliasSD2)->D2_COD))
		SF2->(dbSetOrder(1))
		SF2->(MsSeek(xFilial("SF2")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
		cB1_GRTRIB := SB1->B1_GRTRIB
	Else
		cB1_GRTRIB := (cAliasSB1)->B1_GRTRIB
	EndIf

	SA1->(dbSetOrder(1))
	SA2->(dbSetOrder(1))
	If (cAliasSD2)->D2_TIPO$"DB"
		SA2->(MsSeek(xFilial("SA2")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
		cCliFor 	:= SA2->A2_NOME
	Else
		SA1->(MsSeek(xFilial("SA1")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
		cCliFor 	:= SA1->A1_NOME
	Endif

	cGrpTrib 	:= ""
	cUF		 	:= ""
	nExPis		:= 0
	nExCof 		:= 0
	If lA1_GRPTRIB .And.  lA2_GRPTRIB .And.  !Empty(cB1_GRTRIB)
		SA1->(dbSetOrder(1))
		SA2->(dbSetOrder(1))
		If (cAliasSD2)->D2_TIPO$"DB"
			SA2->(MsSeek(xFilial("SA2")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
			cGrpTrib 	:= SA2->A2_GRPTRIB
			cUF			:= SA2->A2_EST
		Else
			SA1->(MsSeek(xFilial("SA2")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
			cGrpTrib	:= SA1->A1_GRPTRIB
			cUF		:= SA1->A1_EST
		Endif
		If !Empty(cGrpTrib)
			dbSelectArea("SF7")
			SF7->(dbSetOrder(1))
			If SF7->(dbSeek(xFilial("SF7")+cB1_GRTRIB+cGrpTrib))
				While !SF7->(Eof()) .And.  SF7->F7_FILIAL+SF7->F7_GRTRIB+SF7->F7_GRPCLI == xFilial("SF7")+cB1_GRTRIB+cGrpTrib
					If (cUF == SF7->F7_EST .Or.  SF7->F7_EST == "**")
						nExPis	:= Iif(SF7->(FieldPos("F7_ALIQPIS")) > 0,SF7->F7_ALIQPIS,0)
						nExCof 	:= Iif(SF7->(FieldPos("F7_ALIQCOF")) > 0,SF7->F7_ALIQCOF,0)
						Exit
					Endif
					SF7->(dbSkip())
				End
			EndIf
		EndIf
	EndIf

	If (cAliasSF4)->F4_AGREG <> "N"
		If SB1->(FieldPos("B1_PPIS")) >0
			nTxPIS	:= 	Iif((cAliasSB1)->B1_PPIS <> 0,(cAliasSB1)->B1_PPIS , GetMv("MV_TXPIS"))
		Endif
		If SB1->(FieldPos("B1_REDPIS")) > 0
			nRedPIS	:= 	Iif((cAliasSB1)->B1_REDPIS > 0,1-((cAliasSB1)->B1_REDPIS / 100 ), 1 )
		Endif
		If SF4->(FieldPos("F4_BASEPIS")) > 0
			nRedPIS	*= 	Iif((cAliasSF4)->F4_BASEPIS > 0,1-((cAliasSF4)->F4_BASEPIS / 100 ), 1 )
		Endif
		If SB1->(FieldPos("B1_VLR_PIS")) >0
			nPautaPIS := (cAliasSB1)->B1_VLR_PIS
		Endif
		If SB1->(FieldPos("B1_REDCOF")) > 0
			nRedCOF	:= 	Iif((cAliasSB1)->B1_REDCOF > 0,1-((cAliasSB1)->B1_REDCOF / 100 ), 1 )
		EndIf
		If SF4->(FieldPos("F4_BASECOF")) > 0
			nRedCOF	*= 	Iif((cAliasSF4)->F4_BASECOF > 0,1-((cAliasSF4)->F4_BASECOF / 100 ), 1 )
		EndIf
		If SB1->(FieldPos("B1_PCOFINS")) > 0
			nTxCOF	:=	if((cAliasSB1)->B1_PCOFINS <> 0,(cAliasSB1)->B1_PCOFINS , GetMv("MV_TXCOFIN"))
		Endif
		If SB1->(FieldPos("B1_VLR_COF")) >0
			nPautaCOF := (cAliasSB1)->B1_VLR_COF
		Endif

		If SF4->(FieldPos("F4_PISCOF")) > 0
			If !lApurac .Or.  ((cAliasSF4)->F4_PISFISC<>"2")
				If (cAliasSF4)->F4_PISCOF $ "13"
					nValPisPas := 0
					nBasPisPas := 0


					If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlPisSa ) .And.  !Empty( nPsBsPisSa ) .And.   !Empty( nPsAlPisSa )
						nValPisPas	:= ( cAliasSD2 )->( FieldGet( nPsVlPisSa ) )
						nBasPisPas	:= ( cAliasSD2 )->( FieldGet( nPsBsPisSa ) )
						nTxPIS		:= ( cAliasSD2 )->( FieldGet( nPsAlPisSa ) )
					EndIf

					If mv_par01 <> 2 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
						RecLock("TRB", .T. )
						TRB->NUMNF     	:= (cAliasSD2)->D2_DOC
						TRB->SERIE     	:= (cAliasSD2)->D2_SERIE
						TRB->EMISSAO   	:= (cAliasSD2)->D2_EMISSAO
						TRB->CFOP      	:= (cAliasSD2)->D2_CF
						TRB->PRODUTO   	:= (cAliasSD2)->D2_COD
						TRB->NCM       	:= (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT 	:= CompVlCont(cAliasSD2)
						TRB->ZFRANCA   	:= (cAliasSD2)->D2_DESCZFR
						TRB->ALIQ      	:= Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
						TRB->TIPO      	:= "PIS"
						TRB->ES				:=	"S"
						TRB->CLIFOR			:= cCliFor
						TRB->PAUTA			:= Iif(nPautaPIS <> 0,"S","N")
						MsUnlock()

						If (cAliasSD2)->D2_EMISSAO >= dDtCorte

							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
									TRB->PISDSAI   := nValPisPas
									TRB->BASPIDSAI := nBasPisPas
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCSAI   := nValPisPas
									TRB->BASPICSAI := nBasPisPas
								Endif
								MsUnlock()
							Endif
						Else

							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
									TRB->PISDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedPis ) * (TRB->ALIQ/100)
									TRB->BASPIDSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPICSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
								Endif
								MsUnlock()
							Endif
						EndIf
					Endif
					If mv_par01 <> 2 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
						RecLock("TRB", .T. )
						TRB->NUMNF     	:= (cAliasSD2)->D2_DOC
						TRB->SERIE     	:= (cAliasSD2)->D2_SERIE
						TRB->EMISSAO   	:= (cAliasSD2)->D2_EMISSAO
						TRB->CFOP      	:= (cAliasSD2)->D2_CF
						TRB->PRODUTO   	:= (cAliasSD2)->D2_COD
						TRB->NCM       	:= (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT 	:= CompVlCont(cAliasSD2)
						TRB->ZFRANCA   	:= (cAliasSD2)->D2_DESCZFR
						TRB->ALIQ      	:= Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
						TRB->TIPO      	:= "PIS"
						TRB->ES			:=	"S"
						TRB->CLIFOR		:= cCliFor
						TRB->PAUTA		:= Iif(nPautaPIS <> 0,"S","N")
						MsUnlock()

						If (cAliasSD2)->D2_EMISSAO >= dDtCorte

							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->PISDSAI   := nValPisPas
									TRB->BASPIDSAI := nBasPisPas
								Endif

								If (cAliasSF4)->F4_PISCOF $ "23" .And.  (cAliasSF4)->F4_PISCRED == "1" .And.  mv_par01 <> 1
									TRB->PISCSAI   := nValPisPas
									TRB->BASPICSAI := nBasPisPas
								Endif
								MsUnlock()
							Endif
						Else

							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->PISDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedPis ) * (TRB->ALIQ/100)
									TRB->BASPIDSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPICSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
								Endif
								MsUnlock()
							Endif
						EndIf
					Endif

					If mv_par01 <> 2 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
						RecLock("TRB", .T. )
						TRB->NUMNF     	:= (cAliasSD2)->D2_DOC
						TRB->SERIE     	:= (cAliasSD2)->D2_SERIE
						TRB->EMISSAO   	:= (cAliasSD2)->D2_EMISSAO
						TRB->CFOP      	:= (cAliasSD2)->D2_CF
						TRB->PRODUTO   	:= (cAliasSD2)->D2_COD
						TRB->NCM       	:= (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT 	:= CompVlCont(cAliasSD2)
						TRB->ZFRANCA   	:= (cAliasSD2)->D2_DESCZFR
						TRB->ALIQ      	:= Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
						TRB->TIPO      	:= "PIS"
						TRB->ES			:=	"S"
						TRB->CLIFOR		:= cCliFor
						TRB->PAUTA		:= Iif(nPautaPIS <> 0,"S","N")
						MsUnlock()

						If (cAliasSD2)->D2_EMISSAO >= dDtCorte

							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->PISDSAI   := nValPisPas
									TRB->BASPIDSAI := nBasPisPas
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCSAI   := nValPisPas
									TRB->BASPICSAI := nBasPisPas
								Endif
								MsUnlock()
							Endif
						Else

							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->PISDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedPis ) * (TRB->ALIQ/100)
									TRB->BASPIDSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPICSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
								Endif
								MsUnlock()
							Endif
						EndIf
					Endif
				EndIf

				If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
					nValCofins := 0
					nBasCofins := 0


					If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlCofSa ) .And.  !Empty( nPsBsCofSa ) .And.  !Empty( nPsAlCofSa )
						nValCofins	:= ( cAliasSD2 )->( FieldGet( nPsVlCofSa ) )
						nBasCofins	:= ( cAliasSD2 )->( FieldGet( nPsBsCofSa ) )
						nTxCOF		:= ( cAliasSD2 )->( FieldGet( nPsAlCofSa ) )
					EndIf
					RecLock("TRB", .T. )
					TRB->NUMNF     := (cAliasSD2)->D2_DOC
					TRB->SERIE     := (cAliasSD2)->D2_SERIE
					TRB->EMISSAO   := (cAliasSD2)->D2_EMISSAO
					TRB->CFOP      := (cAliasSD2)->D2_CF
					TRB->PRODUTO   := (cAliasSD2)->D2_COD
					TRB->NCM       := (cAliasSB1)->B1_POSIPI
					TRB->VALORCONT := CompVlCont(cAliasSD2)
					TRB->ZFRANCA   := (cAliasSD2)->D2_DESCZFR
					TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
					TRB->TIPO      := "COF"
					TRB->ES        := "S"
					TRB->CLIFOR		:= cCliFor
					TRB->PAUTA		:= Iif(nPautaCOF <> 0,"S","N")
					MsUnlock()

					If (cAliasSD2)->D2_EMISSAO >= dDtCorte
						If SF4->(FieldPos("F4_PISCRED")) >0
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
								TRB->COFDSAI   := nValCofins
								TRB->BASCODSAI := nBasCofins
							Endif
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCSAI   := nValCofins
								TRB->BASCOCSAI := nBasCofins
							Endif
							MsUnlock()
						Endif
		            Else
						If SF4->(FieldPos("F4_PISCRED")) >0
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
								TRB->COFDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCODSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
							Endif
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCOCSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
							Endif
							MsUnlock()
						Endif
					Endif
				EndIf

				If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
					nValCofins := 0
					nBasCofins := 0


					If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlCofSa ) .And.  !Empty( nPsBsCofSa ) .And.  !Empty( nPsAlCofSa )
						nValCofins	:= ( cAliasSD2 )->( FieldGet( nPsVlCofSa ) )
						nBasCofins	:= ( cAliasSD2 )->( FieldGet( nPsBsCofSa ) )
						nTxCOF		:= ( cAliasSD2 )->( FieldGet( nPsAlCofSa ) )
					EndIf
					RecLock("TRB", .T. )
					TRB->NUMNF     := (cAliasSD2)->D2_DOC
					TRB->SERIE     := (cAliasSD2)->D2_SERIE
					TRB->EMISSAO   := (cAliasSD2)->D2_EMISSAO
					TRB->CFOP      := (cAliasSD2)->D2_CF
					TRB->PRODUTO   := (cAliasSD2)->D2_COD
					TRB->NCM       := (cAliasSB1)->B1_POSIPI
					TRB->VALORCONT := CompVlCont(cAliasSD2)
					TRB->ZFRANCA   := (cAliasSD2)->D2_DESCZFR
					TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
					TRB->TIPO      := "COF"
					TRB->ES        := "S"
					TRB->CLIFOR	   := cCliFor
					TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
					MsUnlock()



					If (cAliasSD2)->D2_EMISSAO >= dDtCorte
						If SF4->(FieldPos("F4_PISCRED")) >0
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED <> "4"
								TRB->COFDSAI   := nValCofins
								TRB->BASCODSAI := nBasCofins
							Endif
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCSAI   := nValCofins
								TRB->BASCOCSAI := nBasCofins
							Endif
							MsUnlock()
						Endif
		            Else
						If SF4->(FieldPos("F4_PISCRED")) >0
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED <> "4"
								TRB->COFDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCODSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
							Endif
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCOCSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
							Endif
							MsUnlock()
						Endif
					Endif
				EndIf

				If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
					nValCofins := 0
					nBasCofins := 0


					If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlCofSa ) .And.  !Empty( nPsBsCofSa ) .And.  !Empty( nPsAlCofSa )
						nValCofins	:= ( cAliasSD2 )->( FieldGet( nPsVlCofSa ) )
						nBasCofins	:= ( cAliasSD2 )->( FieldGet( nPsBsCofSa ) )
						nTxCOF		:= ( cAliasSD2 )->( FieldGet( nPsAlCofSa ) )
					EndIf
					RecLock("TRB", .T. )
					TRB->NUMNF     := (cAliasSD2)->D2_DOC
					TRB->SERIE     := (cAliasSD2)->D2_SERIE
					TRB->EMISSAO   := (cAliasSD2)->D2_EMISSAO
					TRB->CFOP      := (cAliasSD2)->D2_CF
					TRB->PRODUTO   := (cAliasSD2)->D2_COD
					TRB->NCM       := (cAliasSB1)->B1_POSIPI
					TRB->VALORCONT := CompVlCont(cAliasSD2)
					TRB->ZFRANCA   := (cAliasSD2)->D2_DESCZFR
					TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
					TRB->TIPO      := "COF"
					TRB->ES        := "S"
					TRB->CLIFOR	   := cCliFor
					TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
					MsUnlock()

					If (cAliasSD2)->D2_EMISSAO >= dDtCorte
						If SF4->(FieldPos("F4_PISCRED")) >0
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED <> "4"
								TRB->COFDSAI   := nValCofins
								TRB->BASCODSAI := nBasCofins
							Endif
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCSAI   := nValCofins
								TRB->BASCOCSAI := nBasCofins
							Endif
							MsUnlock()
						Endif
		            Else
						If SF4->(FieldPos("F4_PISCRED")) >0
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED <> "4"
								TRB->COFDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCODSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
							Endif
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCOCSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
							Endif
							MsUnlock()
						Endif
					Endif
				EndIf

				If mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
					If (cAliasSF4)->F4_PISCOF $ "123"
						If !(cAliasSD2)->D2_TIPO $ "BD"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf

						EndIf

						If (cAliasSD2)->D2_TIPO == "D"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6" .And.  cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf

						EndIF
					ELSE
						If !(cAliasSD2)->D2_TIPO $ "BD"
							aResumo[1][3] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA

						EndIF

			   		If (cAliasSD2)->D2_TIPO == "D"
							aResumo[4][3] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA

						EndIF
					Endif
				Endif

				If mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
					If (cAliasSF4)->F4_PISCOF $ "123"
						If !(cAliasSD2)->D2_TIPO $ "BD"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf

						EndIf

						If (cAliasSD2)->D2_TIPO == "D"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf

						EndIF
					ELSE
						If !(cAliasSD2)->D2_TIPO $ "BD"
							aResumo[1][3] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA

						EndIF
			   		If (cAliasSD2)->D2_TIPO == "D"
							aResumo[4][3] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)

						EndIF
					Endif
				EndIf

				If mv_par12 == 3 .And.  !((cAliasSF4)->F4_TPREG$"123") .And.  !(cAliasSF4)->F4_TPREG$"123"
					If (cAliasSF4)->F4_PISCOF $ "123"

						If !(cAliasSD2)->D2_TIPO $ "BD"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[1][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6" .And.  cDebSTPIS=="6" ,0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf

						EndIf

						If (cAliasSD2)->D2_TIPO == "D"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6" .And.  cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[4][2] += (cAliasSD2)->D2_TOTAL+If(cDebSTPIS=="6" .And.  cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf

						EndIF

					ELSE
						If !(cAliasSD2)->D2_TIPO $ "BD"
							aResumo[1][3] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA

						EndIF

			   		If (cAliasSD2)->D2_TIPO == "D"
							aResumo[4][3] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA

						EndIF
					Endif
				EndIf
			Endif
		EndIf
	EndIf
	(cAliasSD2)->( dbSkip())
EndDo
If lQuery
	dbSelectArea(cAliasSD2)
	dbCloseArea()
	dbSelectArea("SD2")
Else
	dbSelectArea("SD2")
	RetIndex("SD2")
	dbClearFilter()
	Ferase(cIndex+OrdBagExt())
EndIf

dbSelectArea("SD1")
SD1->(dbSetOrder(6))

	lQuery		:= .T. 
	cAliasSD1	:= "a906AMontSD1"
	cAliasSF4	:= "a906AMontSD1"
	cAliasSB1	:= "a906AMontSD1"
	cAliasSF1	:= "a906AMontSD1"

	aStruSD1	:= SD1->(dbStruct())
	aStruSB1	:= SB1->(dbStruct())
	aStruSF4	:= SF4->(dbStruct())
	aStruSF1	:= SF1->(dbStruct())

	cQuery		:= "SELECT D1_CF,D1_COD,D1_TOTAL,D1_VALDESC,B1_POSIPI,D1_DOC,D1_SERIE,D1_DTDIGIT,D1_TIPO, "
	cQuery		+= "D1_ICMSRET,D1_VALIPI,D1_VALFRE,D1_SEGURO,D1_DESPESA,D1_VALICM,D1_FORNECE,D1_LOJA, "

	If !Empty( nPsVlPisEn )
		cQuery += cCpVlPisEn + ","
	EndIf
	If !Empty( nPsBsPisEn )
		cQuery += cCpBsPisEn + ","
	EndIf
	If !Empty( nPsAlPisEn )
		cQuery += cCpAlPisEn + ","
	EndIf
	If !Empty( nPsVlCofEn )
		cQuery += cCpVlCofEn + ","
	EndIf
	If !Empty( nPsBsCofEn )
		cQuery += cCpBsCofEn + ","
	EndIf
	If !Empty( nPsAlCofEn )
		cQuery += cCpAlCofEn + ","
	EndIf
	If SF4->( FieldPos( "F4_AGRPIS" ) )>0
		cQuery	+=	"F4_AGRPIS,"
	EndIF
	If SF4->( FieldPos( "F4_AGRCOF" ) )>0
		cQuery	+=	"F4_AGRCOF,"
	EndIF

	cQuery  += "F4_AGREG,F4_PISCOF,F4_IPI,F1_SEGURO,F1_FRETE,F1_DESPESA,F1_VALMERC,F1_DOC,F1_SERIE,F1_FORNECE,F1_LOJA "

	If SB1->(FieldPos("B1_PPIS")) >0
		cQuery += ",B1_PPIS "
	Endif
	If SB1->(FieldPos("B1_REDPIS")) > 0
		cQuery += ",B1_REDPIS "
	Endif
	If SB1->(FieldPos("B1_VLR_PIS")) >0
		cQuery += ",B1_VLR_PIS "
	Endif
	If SB1->(FieldPos("B1_REDCOF")) > 0
		cQuery += ",B1_REDCOF "
	Endif
	If SB1->(FieldPos("B1_PCOFINS")) > 0
		cQuery += ",B1_PCOFINS "
	Endif
	If SB1->(FieldPos("B1_VLR_COF")) >0
		cQuery += ",B1_VLR_COF "
	Endif
	If SB1->(FieldPos("B1_GRTRIB")) > 0
		cQuery += ",B1_GRTRIB "
	Endif
	If SF4->(FieldPos("F4_BASEPIS")) > 0
		cQuery += ",F4_BASEPIS "
	Endif
	If SF4->(FieldPos("F4_PISCOF")) > 0
		cQuery += ",F4_PISCOF "
	Endif
	If SF4->(FieldPos("F4_BASECOF")) > 0
		cQuery += ",F4_BASECOF "
	Endif
	If SF4->(FieldPos("F4_PISCRED")) > 0
		cQuery += ",F4_PISCRED "
	Endif
	If SF4->(FieldPos("F4_TPREG")) > 0
		cQuery += ",F4_TPREG "
	Endif
	If lApurac
		cQuery += ",F4_PISFISC "
	Endif

	If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
	    cQuery += ",F4_MALQCOF,D1_VALCMAJ"
	EndIf

	cQuery 	+= "FROM "+RetSqlName("SD1")+" SD1, "
	cQuery 	+= RetSqlName("SF4")+" SF4, "
	cQuery 	+= RetSqlName("SB1")+" SB1, "
	cQuery 	+= RetSqlName("SF1")+" SF1 "

	cQuery 	+= "WHERE D1_FILIAL='"+xFilial("SD1")+"' AND "
	cQuery 	+= "D1_DTDIGIT>='"+Dtos(MV_PAR02)+"' AND "
	cQuery 	+= "D1_DTDIGIT<='"+Dtos(MV_PAR03)+"' AND "
	cQuery	+= "SD1.D_E_L_E_T_ = ' ' AND "

	cQuery	+= "F4_FILIAL ='"+xFilial("SF4")+"' AND "
	cQuery	+= "F4_CODIGO = D1_TES AND "
	cQuery	+= "SF4.D_E_L_E_T_ = ' ' AND "


	If !((Empty (MV_PAR05)) .Or.  ("*"$MV_PAR05))
		cQuery += " F4_NRLIVRO='"+MV_PAR05+"' AND "
	EndIf

	cQuery  += "B1_FILIAL = '"+xFilial("SB1")+"' AND "
	cQuery  += "B1_COD = D1_COD AND "
	cQuery  += "SB1.D_E_L_E_T_ = ' ' AND "

	cQuery  += "F1_FILIAL = '"+xFilial("SF1")+"' AND "
	cQuery  += "F1_DOC = D1_DOC AND "
	cQuery  += "F1_SERIE = D1_SERIE AND "
	cQuery  += "F1_FORNECE = D1_FORNECE AND "
	cQuery  += "F1_LOJA = D1_LOJA AND "
	cQuery  += "F1_DTDIGIT = D1_DTDIGIT AND "
	cQuery  += "SF1.D_E_L_E_T_ = ' '  "





	If Upper(cDEDBCOF) $ "P#S" .Or.  Upper(cDEDBPIS) $ "P#S"
		cQuery  += " AND ((F4_IPI = 'S' AND F4_CREDIPI = 'N' "
		cQuery  += " AND SF1.F1_TIPO IN('I', 'P'))  "
		cQuery  += " OR  (SF1.F1_TIPO NOT IN('I', 'P'))) "
	Else
		cQuery  += " AND SF1.F1_TIPO NOT IN('I', 'P') "
	EndIF

	If ExistBlock("MT996QRY")
		cQuery := ExecBlock("MT996QRY", .F. , .F. ,{cQuery,2})
	EndIf

	If mv_par11 ==1
		cQuery += "ORDER BY D1_CF, D1_DOC"
	Else
		cQuery += "ORDER BY D1_CF, D1_COD"
	Endif

	cQuery := ChangeQuery(cQuery)
	dbUseArea( .T. ,"TOPCONN",TcGenQry(,,cQuery),cAliasSD1, .T. , .T. )

	For nX := 1 To len(aStruSD1)
		If aStruSD1[nX][2] <> "C" .And.  FieldPos(aStruSD1[nX][1])<>0
			TcSetField(cAliasSD1,aStruSD1[nX][1],aStruSD1[nX][2],aStruSD1[nX][3],aStruSD1[nX][4])
		EndIf
	next

	For nX := 1 To len(aStruSB1)
		If aStruSB1[nX][2] <> "C" .And.  FieldPos(aStruSB1[nX][1])<>0
			TcSetField(cAliasSB1,aStruSB1[nX][1],aStruSB1[nX][2],aStruSB1[nX][3],aStruSB1[nX][4])
		EndIf
	next

	For nX := 1 To len(aStruSF4)
		If aStruSF4[nX][2] <> "C" .And.  FieldPos(aStruSF4[nX][1])<>0
			TcSetField(cAliasSF4,aStruSF4[nX][1],aStruSF4[nX][2],aStruSF4[nX][3],aStruSF4[nX][4])
		EndIf
	next

	For nX := 1 To len(aStruSF1)
		If aStruSF1[nX][2] <> "C" .And.  FieldPos(aStruSF1[nX][1])<>0
			TcSetField(cAliasSF1,aStruSF1[nX][1],aStruSF1[nX][2],aStruSF1[nX][3],aStruSF1[nX][4])
		EndIf
	next

	dbSelectArea(cAliasSD1)
	nPsVlPisEn := ( cAliasSD1 )->( FieldPos( cCpVlPisEn ) )
	nPsBsPisEn := ( cAliasSD1 )->( FieldPos( cCpBsPisEn ) )
	nPsAlPisEn := ( cAliasSD1 )->( FieldPos( cCpAlPisEn ) )
	nPsVlCofEn := ( cAliasSD1 )->( FieldPos( cCpVlCofEn ) )
	nPsBsCofEn := ( cAliasSD1 )->( FieldPos( cCpBsCofEn ) )
	nPsAlCofEn := ( cAliasSD1 )->( FieldPos( cCpAlCofEn ) )
















While (cAliasSD1)->(!Eof())
	nPautaPIS := 0
	nPautaCOF := 0

	If !lQuery
		SF4->(dbSetOrder(1))
		SF4->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))
		SB1->(dbSetOrder(1))
		SB1->(MsSeek(xFilial("SB1")+(cAliasSD1)->D1_COD))
		SF1->(dbSetOrder(1))
		SF1->(MsSeek(xFilial("SF1")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_TIPO))
		cB1_GRTRIB := SB1->B1_GRTRIB
	Else
		cB1_GRTRIB := (cAliasSB1)->B1_GRTRIB

		If !((Empty (MV_PAR05)) .Or.  ("*"$MV_PAR05))
			If !(SF4->F4_NRLIVRO==MV_PAR05)
				lValido := .F. 
			EndIf
		EndIf
	EndIf

	SA1->(dbSetOrder(1))
	SA2->(dbSetOrder(1))

	If (cAliasSD1)->D1_TIPO$"DB"
		SA1->(MsSeek(xFilial("SA1")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
		cCliFor 	:= SA1->A1_NOME
	Else
		SA2->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
		cCliFor 	:= SA2->A2_NOME
	Endif

	cGrpTrib 	:= ""
	cUF		 	:= ""
	nExPis		:= 0
	nExCof 		:= 0
	If lA1_GRPTRIB .And.  lA2_GRPTRIB .And.  !Empty(cB1_GRTRIB)
		SA1->(dbSetOrder(1))
		SA2->(dbSetOrder(1))
		If (cAliasSD1)->D1_TIPO$"DB"
			SA1->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
			cGrpTrib	:= SA1->A1_GRPTRIB
			cUF		:= SA1->A1_EST
		Else
			SA2->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
			cGrpTrib	:= SA2->A2_GRPTRIB
			cUF		:= SA2->A2_EST
		Endif
		If !Empty(cGrpTrib)
			dbSelectArea("SF7")
			SF7->(dbSetOrder(1))
			If SF7->(dbSeek(xFilial("SF7")+cB1_GRTRIB+cGrpTrib))
				While !SF7->(Eof()) .And.  SF7->F7_FILIAL+SF7->F7_GRTRIB+SF7->F7_GRPCLI == xFilial("SF7")+cB1_GRTRIB+cGrpTrib
					If (cUF == SF7->F7_EST .Or.  SF7->F7_EST == "**")
						nExPis	:= Iif(SF7->(FieldPos("F7_ALIQPIS")) > 0,SF7->F7_ALIQPIS,0)
						nExCof	:= Iif(SF7->(FieldPos("F7_ALIQCOF")) > 0,SF7->F7_ALIQCOF,0)
						Exit
					Endif
					SF7->(dbSkip())
				End
			EndIf
		EndIf
	EndIf

	If (cAliasSF4)->F4_AGREG <> "N"
		If SB1->(FieldPos("B1_PPIS")) >0
			nTxPIS	:= 	Iif((cAliasSB1)->B1_PPIS <> 0,(cAliasSB1)->B1_PPIS , GetMv("MV_TXPIS"))
		Endif
		If SB1->(FieldPos("B1_REDPIS")) > 0
			nRedPIS	:= 	Iif((cAliasSB1)->B1_REDPIS > 0,1-((cAliasSB1)->B1_REDPIS / 100 ), 1 )
		Endif
		If SB1->(FieldPos("B1_VLR_PIS")) >0
			nPautaPIS	:= 	Iif((cAliasSD1)->D1_TIPO$"C",0,(cAliasSB1)->B1_VLR_PIS)
		Endif
		If SF4->(FieldPos("F4_BASEPIS")) > 0
			nRedPIS	*= 	Iif((cAliasSF4)->F4_BASEPIS > 0,1-((cAliasSF4)->F4_BASEPIS / 100 ), 1 )
		Endif
		If SB1->(FieldPos("B1_REDCOF")) > 0
			nRedCOF	:= 	Iif((cAliasSB1)->B1_REDCOF > 0,1-((cAliasSB1)->B1_REDCOF / 100 ), 1 )
		Endif
		If SF4->(FieldPos("F4_BASECOF")) > 0
			nRedCOF	*= 	Iif((cAliasSF4)->F4_BASECOF > 0,1-((cAliasSF4)->F4_BASECOF / 100 ), 1 )
		EndIf
		If SB1->(FieldPos("B1_PCOFINS")) > 0
			nTxCOF	:=	if((cAliasSB1)->B1_PCOFINS <> 0,(cAliasSB1)->B1_PCOFINS , GetMv("MV_TXCOFIN"))
		Endif
		If SB1->(FieldPos("B1_VLR_COF")) >0
			nPautaCOF	:= 	Iif((cAliasSD1)->D1_TIPO$"C",0,(cAliasSB1)->B1_VLR_COF)
		Endif
		If SF4->(FieldPos("F4_PISCOF")) >0
			If !lApurac .Or.  ((cAliasSF4)->F4_PISFISC<>"2")
				If (cAliasSF4)->F4_PISCOF $ "13"
					If SF4->(FieldPos("F4_PISCRED")) >0
						nValPisPas := 0
						nBasPisPas := 0


						If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlPisEn ) .And.  !Empty( nPsBsPisEn ) .And.  !Empty( nPsAlPisEn )
							nValPisPas	:= ( cAliasSD1 )->( FieldGet( nPsVlPisEn ) )
							nBasPisPas	:= ( cAliasSD1 )->( FieldGet( nPsBsPisEn ) )
							nTxPIS		:= ( cAliasSD1 )->( FieldGet( nPsAlPisEn ) )
						EndIf

						If mv_par01 <> 2 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
							RecLock("TRB", .T. )
							TRB->NUMNF     := (cAliasSD1)->D1_DOC
							TRB->SERIE     := (cAliasSD1)->D1_SERIE
							TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
							TRB->CFOP      := (cAliasSD1)->D1_CF
							TRB->PRODUTO   := (cAliasSD1)->D1_COD
							TRB->NCM       := (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
							TRB->ZFRANCA   := 0
							TRB->ALIQ      := Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
							TRB->TIPO      := "PIS"
							TRB->ES        := "E"
							TRB->CLIFOR	   := cCliFor
							TRB->PAUTA	   := Iif(nPautaPIS <> 0,"S","N")
							MsUnlock()

							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCENT   := nValPisPas
									TRB->BASPICENT := nBasPisPas
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->PISDENT   := nValPisPas
									TRB->BASPIDENT := nBasPisPas
                        Endif
								MsUnlock()
							Else
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPICENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedPis
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->PISDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPIDENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedPis
                        Endif
								MsUnlock()
							EndIf


							If SF4->(FieldPos("F4_AGRPIS")) > 0
								If (cAliasSF4)->F4_AGRPIS = "1"
								    RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED == "1"
								    	TRB->VALORCONT += TRB->PISCENT
								 	Else
								 		TRB->VALORCONT += TRB->PISDENT
								 	Endif
							    	MsUnlock()
								Endif
							Endif
						Endif

						If mv_par01 <> 2 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
							RecLock("TRB", .T. )
							TRB->NUMNF     := (cAliasSD1)->D1_DOC
							TRB->SERIE     := (cAliasSD1)->D1_SERIE
							TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
							TRB->CFOP      := (cAliasSD1)->D1_CF
							TRB->PRODUTO   := (cAliasSD1)->D1_COD
							TRB->NCM       := (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
							TRB->ZFRANCA   := 0
							TRB->ALIQ      := Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
							TRB->TIPO      := "PIS"
							TRB->ES        := "E"
							TRB->CLIFOR	   := cCliFor
							TRB->PAUTA	   := Iif(nPautaPIS <> 0,"S","N")
							MsUnlock()

							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCENT   := nValPisPas
									TRB->BASPICENT := nBasPisPas
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->PISDENT   := nValPisPas
									TRB->BASPIDENT := nBasPisPas
                        Endif
								MsUnlock()
							Else
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPICENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedPis
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->PISDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPIDENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedPis
                        Endif
								MsUnlock()
							EndIf


							If SF4->(FieldPos("F4_AGRPIS")) > 0
								If (cAliasSF4)->F4_AGRPIS = "1"
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED == "1"
								    	TRB->VALORCONT += TRB->PISCENT
								 	Else
								 		TRB->VALORCONT += TRB->PISDENT
								 	Endif
							    	MsUnlock()
								Endif
							Endif
						Endif

						If mv_par01 <> 2 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
							RecLock("TRB", .T. )
							TRB->NUMNF     := (cAliasSD1)->D1_DOC
							TRB->SERIE     := (cAliasSD1)->D1_SERIE
							TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
							TRB->CFOP      := (cAliasSD1)->D1_CF
							TRB->PRODUTO   := (cAliasSD1)->D1_COD
							TRB->NCM       := (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
							TRB->ZFRANCA   := 0
							TRB->ALIQ      := Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
							TRB->TIPO      := "PIS"
							TRB->ES        := "E"
							TRB->CLIFOR	   := cCliFor
							TRB->PAUTA	   := Iif(nPautaPIS <> 0,"S","N")
							MsUnlock()

							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCENT   := nValPisPas
									TRB->BASPICENT := nBasPisPas
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->PISDENT   := nValPisPas
									TRB->BASPIDENT := nBasPisPas
                        Endif
								MsUnlock()
							Else
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->PISCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPICENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedPis
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->PISDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
									TRB->BASPIDENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedPis
                        Endif
								MsUnlock()
							EndIf


							If SF4->(FieldPos("F4_AGRPIS")) > 0
								If (cAliasSF4)->F4_AGRPIS = "1"
								    RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED == "1"
								    	TRB->VALORCONT += TRB->PISCENT
								 	Else
								 		TRB->VALORCONT += TRB->PISDENT
								 	Endif
							    	MsUnlock()
								Endif
							Endif
						Endif
					EndIf
				Endif

				If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
					If SF4->(FieldPos("F4_PISCRED")) >0
						nValCofins := 0
						nBasCofins := 0


						If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlCofEn ) .And.  !Empty( nPsBsCofEn ) .And.  !Empty( nPsAlCofEn )
							nValCofins	:= ( cAliasSD1 )->( FieldGet( nPsVlCofEn ) )
							nBasCofins	:= ( cAliasSD1 )->( FieldGet( nPsBsCofEn ) )
							nTxCOF		:= ( cAliasSD1 )->( FieldGet( nPsAlCofEn ) )

							If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
							    If (cAliasSF4)->F4_MALQCOF > 0
							    	nTxCOF := nTxCOF - (cAliasSF4)->F4_MALQCOF
							    EndIf
							    If (cAliasSD1)->D1_VALCMAJ > 0
							    	nValCofins := nValCofins - (cAliasSD1)->D1_VALCMAJ
							    EndIf
							EndIf
						EndIf
						RecLock("TRB", .T. )
						TRB->NUMNF     := (cAliasSD1)->D1_DOC
						TRB->SERIE     := (cAliasSD1)->D1_SERIE
						TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
						TRB->CFOP      := (cAliasSD1)->D1_CF
						TRB->PRODUTO   := (cAliasSD1)->D1_COD
						TRB->NCM       := (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
						TRB->ZFRANCA   := 0
						TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
						TRB->TIPO      := "COF"
						TRB->ES        := "E"
						TRB->CLIFOR    := cCliFor
						TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
						MsUnlock()

						If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCENT   := nValCofins
								TRB->BASCOCENT := nBasCofins
							ElseIf (cAliasSF4)->F4_PISCRED =="2"
								TRB->COFDENT   := nValCofins
								TRB->BASCODENT := nBasCofins
                    Endif
                    MsUnlock()
						Else
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCOCENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
							ElseIf	(cAliasSF4)->F4_PISCRED =="2"
								TRB->COFDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCODENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
							Endif
							MsUnlock()
						Endif


						If SF4->(FieldPos("F4_AGRCOF")) > 0
							If (cAliasSF4)->F4_AGRCOF = "1"
							    RecLock("TRB", .F. )
							    If (cAliasSF4)->F4_PISCRED == "1"
									 TRB->VALORCONT += TRB->COFCENT
							    Else
							    	 TRB->VALORCONT += TRB->COFDENT
							    Endif
						    	 MsUnlock()
							Endif
						Endif
					Endif
				Endif

				If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
					If SF4->(FieldPos("F4_PISCRED")) >0
						nValCofins := 0
						nBasCofins := 0




						If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlCofEn ) .And.  !Empty( nPsBsCofEn ) .And.  !Empty( nPsAlCofEn )
							nValCofins := ( cAliasSD1 )->( FieldGet( nPsVlCofEn ) )
							nBasCofins := ( cAliasSD1 )->( FieldGet( nPsBsCofEn ) )
							nTxCOF := ( cAliasSD1 )->( FieldGet( nPsAlCofEn ) )

							If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
							    If (cAliasSF4)->F4_MALQCOF > 0
							    	nTxCOF := nTxCOF - (cAliasSF4)->F4_MALQCOF
							    EndIf
							    If (cAliasSD1)->D1_VALCMAJ > 0
							    	nValCofins := nValCofins - (cAliasSD1)->D1_VALCMAJ
							    EndIf
							EndIf
						EndIf

						RecLock("TRB", .T. )
						TRB->NUMNF     := (cAliasSD1)->D1_DOC
						TRB->SERIE     := (cAliasSD1)->D1_SERIE
						TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
						TRB->CFOP      := (cAliasSD1)->D1_CF
						TRB->PRODUTO   := (cAliasSD1)->D1_COD
						TRB->NCM       := (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
						TRB->ZFRANCA   := 0
						TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
						TRB->TIPO      := "COF"
						TRB->ES        := "E"
						TRB->CLIFOR    := cCliFor
						TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
						MsUnlock()



						If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCENT   := nValCofins
								TRB->BASCOCENT := nBasCofins
							ElseIf (cAliasSF4)->F4_PISCRED =="2"
								TRB->COFDENT   := nValCofins
								TRB->BASCODENT := nBasCofins
                     Endif
                     MsUnlock()
						Else
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCOCENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
							ElseIf (cAliasSF4)->F4_PISCRED =="2"
								TRB->COFDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCODENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
							Endif
							MsUnlock()
						Endif


						If SF4->(FieldPos("F4_AGRCOF")) > 0
							If (cAliasSF4)->F4_AGRCOF = "1"
							    RecLock("TRB", .F. )
							    If (cAliasSF4)->F4_PISCRED == "1"
								    	TRB->VALORCONT += TRB->COFCENT
							    Else
								    	TRB->VALORCONT += TRB->COFDENT
							    Endif
						    	MsUnlock()
							Endif
						Endif
					Endif
				Endif

				If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
					If SF4->(FieldPos("F4_PISCRED")) >0
						nValCofins := 0
						nBasCofins := 0


						If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlCofEn ) .And.  !Empty( nPsBsCofEn ) .And.  !Empty( nPsAlCofEn )
							nValCofins	:= ( cAliasSD1 )->( FieldGet( nPsVlCofEn ) )
							nBasCofins	:= ( cAliasSD1 )->( FieldGet( nPsBsCofEn ) )
							nTxCOF		:= ( cAliasSD1 )->( FieldGet( nPsAlCofEn ) )

							If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
							    If (cAliasSF4)->F4_MALQCOF > 0
							    	nTxCOF := nTxCOF - (cAliasSF4)->F4_MALQCOF
							    EndIf
							    If (cAliasSD1)->D1_VALCMAJ > 0
							    	nValCofins := nValCofins - (cAliasSD1)->D1_VALCMAJ
							    EndIf
							EndIf
						EndIf
						RecLock("TRB", .T. )
						TRB->NUMNF     := (cAliasSD1)->D1_DOC
						TRB->SERIE     := (cAliasSD1)->D1_SERIE
						TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
						TRB->CFOP      := (cAliasSD1)->D1_CF
						TRB->PRODUTO   := (cAliasSD1)->D1_COD
						TRB->NCM       := (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
 						TRB->ZFRANCA   := 0
						TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
						TRB->TIPO      := "COF"
						TRB->ES        := "E"
						TRB->CLIFOR    := cCliFor
						TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
						MsUnlock()

						If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCENT   := nValCofins
								TRB->BASCOCENT := nBasCofins
							ElseIf (cAliasSF4)->F4_PISCRED =="2"
								TRB->COFDENT   := nValCofins
								TRB->BASCODENT := nBasCofins
                    Endif
                    MsUnlock()
						Else
							RecLock("TRB", .F. )
							If (cAliasSF4)->F4_PISCRED =="1"
								TRB->COFCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCOCENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
							ElseIf	(cAliasSF4)->F4_PISCRED =="2"
								TRB->COFDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
								TRB->BASCODENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
							Endif
							MsUnlock()
						Endif


						If SF4->(FieldPos("F4_AGRCOF")) > 0
							If (cAliasSF4)->F4_AGRCOF = "1"
							    RecLock("TRB", .F. )
							    If (cAliasSF4)->F4_PISCRED == "1"
							    	 TRB->VALORCONT += TRB->COFCENT
							    Else
							    	 TRB->VALORCONT += TRB->COFDENT
							    Endif
						    	MsUnlock()
							Endif
						Endif
					Endif
				Endif

				If mv_par12 == 3 .And.  !((cAliasSF4)->F4_TPREG$"123") .And.  !(cAliasSF4)->F4_TPREG$"123"
					If (cAliasSF4)->F4_PISCOF $ "123"
						If !(cAliasSD1)->D1_TIPO $ "BD"
							If (cAliasSF4)->F4_PISCOF == "1"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf

						EndIf

						If (cAliasSD1)->D1_TIPO == "D"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf

						EndIF
					ELSE
						If !(cAliasSD1)->D1_TIPO $ "BD"
							 aResumo[3][3] += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC

						EndIF
						If (cAliasSD1)->D1_TIPO == "D"
							aResumo[2][3] += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC

						EndIF
					EndIf
				EndIf

				If mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
					If (cAliasSF4)->F4_PISCOF $ "123"
						If !(cAliasSD1)->D1_TIPO $ "BD"
							If (cAliasSF4)->F4_PISCOF == "1"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf

						EndIf

						If (cAliasSD1)->D1_TIPO == "D"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf

						EndIF
					ELSE
						If !(cAliasSD1)->D1_TIPO $ "BD"
							 aResumo[3][3] += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC

						EndIF
						If (cAliasSD1)->D1_TIPO == "D"
							aResumo[2][3] += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC

						EndIF
					EndIf
				EndIf

				If mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
					If (cAliasSF4)->F4_PISCOF $ "123"
						If !(cAliasSD1)->D1_TIPO $ "BD"
							If (cAliasSF4)->F4_PISCOF == "1"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
						 		aResumo[3][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTPIS=="6" .And.  cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
						 	EndIf

						EndIf
						If (cAliasSD1)->D1_TIPO == "D"
							If (cAliasSF4)->F4_PISCOF == "1"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								aResumo[2][2] += ((cAliasSD1)->D1_TOTAL + IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
							EndIf

						EndIF
					ELSE
						If !(cAliasSD1)->D1_TIPO $ "BD"
							 aResumo[3][3] += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC

						EndIF
						If (cAliasSD1)->D1_TIPO == "D"
							aResumo[2][3] += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC

						EndIF
					EndIf
				EndIf
			EndIf
		EndIf
	EndIf
	(cAliasSD1)->( dbSkip())
EndDo

If lQuery
	dbSelectArea(cAliasSD1)
	dbCloseArea()
	dbSelectArea("SD1")
Else
	dbSelectArea("SD1")
	RetIndex("SD1")
	dbClearFilter()
	Ferase(cIndex1+OrdBagExt())
EndIf
Return (TRB->(LastRec())>0)










Static Function CriaArrTRB()
Private aArqTemp := {}

AADD(aArqTemp,{"NUMNF"		,"C",TamSx3("D2_DOC")[1]		,0})
AADD(aArqTemp,{"SERIE"		,"C",TamSx3("D2_SERIE")[1]		,0})
AADD(aArqTemp,{"EMISSAO"   ,"D",TamSx3("D2_EMISSAO")[1]	,0})
AADD(aArqTemp,{"TIPO"		,"C",03								,0})
AADD(aArqTemp,{"CFOP"	   ,"C",04								,0})
AADD(aArqTemp,{"PRODUTO"	,"C",TamSx3("D2_COD")[1]		,0})
AADD(aArqTemp,{"NCM"			,"C",TamSx3("B1_POSIPI")[1]	,0})
AADD(aArqTemp,{"VALORCONT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"ZFRANCA"	,"N",TamSx3("D2_DESCZFR")[1]	,TamSx3("D2_DESCZFR")[2]})
AADD(aArqTemp,{"ALIQ"		,"N",TamSx3("B1_VLR_COF")[1]	,TamSx3("B1_VLR_COF")[2]})
AADD(aArqTemp,{"PISCSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"PISDSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASPICSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASPIDSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"PISCENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"PISDENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASPICENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASPIDENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"COFCSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"COFDSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASCOCSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASCODSAI"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"COFCENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"COFDENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASCOCENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"BASCODENT"	,"N",TamSx3("D2_TOTAL")[1]		,TamSx3("D2_TOTAL")[2]})
AADD(aArqTemp,{"ES"			,"C",01								,0})
AADD(aArqTemp,{"CLIFOR"		,"C",40								,0})
AADD(aArqTemp,{"PAUTA"		,"C",01								,0})
Return aArqTemp










Static Function CriaArrRes()
Private aTotResumo := {}

AADD(aTotResumo,{"Saídas",0,0})
AADD(aTotResumo,{If( cPaisLoc $ "ANG|PTG", "Devoluções de saídas", "Devoluções de Saídas" ),0,0})
AADD(aTotResumo,{"Entradas",0,0})
AADD(aTotResumo,{If( cPaisLoc $ "ANG|PTG", "Devoluções de entradas", "Devoluções de Entradas" ),0,0})
Return aTotResumo










Static Function TrataCpos()

If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_BASEPS2"} ) )
	cCpBsPisEn := aRelImp[nScanPis,2]
	nPsBsPisEn := SD1->(FieldPos(cCpBsPisEn))
EndIf
If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_VALPS2"} ) )
	cCpVlPisEn := aRelImp[nScanPis,2]
	nPsVlPisEn := SD1->(FieldPos(cCpVlPisEn))
EndIf
If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_ALIQPS2"} ) )
	cCpAlPisEn := aRelImp[nScanPis,2]
	nPsAlPisEn := SD1->(FieldPos(cCpAlPisEn))
EndIf

If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_BASEPS2"} ) )
	cCpBsPisSa := aRelImp2[nScanPis,2]
	nPsBsPisSa := SD2->(FieldPos(cCpBsPisSa))
EndIf
If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_VALPS2"} ) )
	cCpVlPisSa := aRelImp2[nScanPis,2]
	nPsVlPisSa := SD2->(FieldPos(cCpVlPisSa))
EndIf
If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_ALIQPS2"} ) )
	cCpAlPisSa := aRelImp2[nScanPis,2]
	nPsAlPisSa := SD2->(FieldPos(cCpAlPisSa))
EndIf

If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_BASECF2"} ) )
	cCpBsCofEn := aRelImp[nScanCof,2]
	nPsBsCofEn := SD1->(FieldPos(cCpBsCofEn))
EndIf
If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_VALCF2"} ) )
	cCpVlCofEn := aRelImp[nScanCof,2]
	nPsVlCofEn := SD1->(FieldPos(cCpVlCofEn))
EndIf
If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_ALIQCF2"} ) )
	cCpAlCofEn := aRelImp[nScanCof,2]
	nPsAlCofEn := SD1->(FieldPos(cCpAlCofEn))
EndIf

If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_BASECF2"} ) )
	cCpBsCofSa := aRelImp2[nScanCof,2]
	nPsBsCofSa := SD2->(FieldPos(cCpBsCofSa))
EndIf
If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_VALCF2"} ) )
	cCpVlCofSa := aRelImp2[nScanCof,2]
	nPsVlCofSa := SD2->(FieldPos(cCpVlCofSa))
EndIf
If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_ALIQCF2"} ) )
	cCpAlCofSa := aRelImp2[nScanCof,2]
	nPsAlCofSa := SD2->(FieldPos(cCpAlCofSa))
EndIf
Return .T. 










Function M906TotRel(aAliqCFGer,aAliqEs,aCFOPPISE,aCFOPPISS,aCFOPCOFE,aCFOPCOFS,aTAlPISE,aTAlPISS,aTAlCOFE,aTAlCOFS,aTotDoCFOP,aTotDtEmis)
Local nAliq		:= 0
Local nPos		:= 0
Local cCFOP		:= ""
Local dDtEmis	:= CtoD("  /  /    ")


dDtEmis	:= TRB->EMISSAO
nPos		:= Ascan(aTotDtEmis,{|x| x[1]==dDtEmis})
If nPos > 0
	aTotDtEmis[nPos][2]  += TRB->VALORCONT
	aTotDtEmis[nPos][3]  += TRB->ZFRANCA
	aTotDtEmis[nPos][4]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISDENT,TRB->PISDSAI) , IIF(TRB->ES == "E",TRB->COFDENT,TRB->COFDSAI))
	aTotDtEmis[nPos][5]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISCENT,TRB->PISCSAI) , IIF(TRB->ES == "E",TRB->COFCENT,TRB->COFCSAI))
	aTotDtEmis[nPos][6]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPIDENT,TRB->BASPIDSAI) , IIF(TRB->ES == "E",TRB->BASCODENT,TRB->BASCODSAI))
	aTotDtEmis[nPos][7]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPICENT,TRB->BASPICSAI) , IIF(TRB->ES == "E",TRB->BASCOCENT,TRB->BASCOCSAI))
Else
	If TRB->TIPO == "PIS"
		AADD(aTotDtEmis,{TRB->EMISSAO,TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->ES=="E",TRB->PISDENT,TRB->PISDSAI),IIF(TRB->ES=="E",TRB->PISCENT,TRB->PISCSAI),IIF(TRB->ES=="E",TRB->BASPIDENT,TRB->BASPIDSAI),IIF(TRB->ES=="E",TRB->BASPICENT,TRB->BASPICSAI)})
	Else
		AADD(aTotDtEmis,{TRB->EMISSAO,TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->ES=="E",TRB->COFDENT,TRB->COFDSAI),IIF(TRB->ES=="E",TRB->COFCENT,TRB->COFCSAI),IIF(TRB->ES=="E",TRB->BASCODENT,TRB->BASCODSAI),IIF(TRB->ES=="E",TRB->BASCOCENT,TRB->BASCOCSAI)})
	EndIf
Endif

nAliq	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
nPos  := Ascan(aAliqCFGer,{|x| x[1]==nAliq .And.  x[2]==TRB->CFOP})
If nPos > 0
	aAliqCFGer[nPos][3]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISDENT,TRB->PISDSAI)-IIF(TRB->ES == "E",TRB->PISCENT,TRB->PISCSAI) , IIF(TRB->ES == "E",TRB->COFDENT,TRB->COFDSAI)-IIF(TRB->ES == "E",TRB->COFCENT,TRB->COFCSAI))
	aAliqCFGer[nPos][4]  += (TRB->VALORCONT * IIF(TRB->ES=="E",-1,1))
	aAliqCFGer[nPos][5]  += TRB->ZFRANCA
	aAliqCFGer[nPos][6]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISDENT,TRB->PISDSAI) , IIF(TRB->ES == "E",TRB->COFDENT,TRB->COFDSAI))
	aAliqCFGer[nPos][7]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISCENT,TRB->PISCSAI) , IIF(TRB->ES == "E",TRB->COFCENT,TRB->COFCSAI))
	aAliqCFGer[nPos][8]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPIDENT,TRB->BASPIDSAI) , IIF(TRB->ES == "E",TRB->BASCODENT,TRB->BASCODSAI))
	aAliqCFGer[nPos][9]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPICENT,TRB->BASPICSAI) , IIF(TRB->ES == "E",TRB->BASCOCENT,TRB->BASCOCSAI))
Else
	If TRB->TIPO == "PIS"
		AADD(aAliqCFGer,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->CFOP,IIF(TRB->ES=="E",TRB->PISDENT,TRB->PISDSAI)-IIF(TRB->ES=="E",TRB->PISCENT,TRB->PISCSAI),TRB->VALORCONT*IIF(TRB->ES=="E",-1,1),TRB->ZFRANCA,IIF(TRB->ES == "E",TRB->PISDENT,TRB->PISDSAI),IIF(TRB->ES == "E",TRB->PISCENT,TRB->PISCSAI),IIF(TRB->ES == "E",TRB->BASPIDENT,TRB->BASPIDSAI),IIF(TRB->ES == "E",TRB->BASPICENT,TRB->BASPICSAI)})
	Else
		AADD(aAliqCFGer,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->CFOP,IIF(TRB->ES=="E",TRB->COFDENT,TRB->COFDSAI)-IIF(TRB->ES=="E",TRB->COFCENT,TRB->COFCSAI),TRB->VALORCONT*IIF(TRB->ES=="E",-1,1),TRB->ZFRANCA,IIF(TRB->ES == "E",TRB->COFDENT,TRB->COFDSAI),IIF(TRB->ES == "E",TRB->COFCENT,TRB->COFCSAI),IIF(TRB->ES == "E",TRB->BASCODENT,TRB->BASCODSAI),IIF(TRB->ES == "E",TRB->BASCOCENT,TRB->BASCOCSAI)})
	EndIf
Endif

nAliq	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
nPos 	:= Ascan(aAliqEs,{|x| x[1]==nAliq})
If nPos > 0
	aAliqEs[nPos][2]  += TRB->VALORCONT
	aAliqEs[nPos][3]  += TRB->ZFRANCA
	aAliqEs[nPos][4]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISDENT,TRB->PISDSAI) , IIF(TRB->ES == "E",TRB->COFDENT,TRB->COFDSAI))
	aAliqEs[nPos][5]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISCENT,TRB->PISCSAI) , IIF(TRB->ES == "E",TRB->COFCENT,TRB->COFCSAI))
	aAliqEs[nPos][6]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPIDENT,TRB->BASPIDSAI) , IIF(TRB->ES == "E",TRB->BASCODENT,TRB->BASCODSAI))
	aAliqEs[nPos][7]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPICENT,TRB->BASPICSAI) , IIF(TRB->ES == "E",TRB->BASCOCENT,TRB->BASCOCSAI))
Else
	If TRB->TIPO == "PIS"
		AADD(aAliqEs,{Iif(TRB->PAUTA=="	S",0,TRB->ALIQ),TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->ES == "E",TRB->PISDENT,TRB->PISDSAI),IIF(TRB->ES == "E",TRB->PISCENT,TRB->PISCSAI),IIF(TRB->ES == "E",TRB->BASPIDENT,TRB->BASPIDSAI),IIF(TRB->ES == "E",TRB->BASPICENT,TRB->BASPICSAI)})
	Else
		AADD(aAliqEs,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->ES == "E",TRB->COFDENT,TRB->COFDSAI),IIF(TRB->ES == "E",TRB->COFCENT,TRB->COFCSAI),IIF(TRB->ES == "E",TRB->BASCODENT,TRB->BASCODSAI),IIF(TRB->ES == "E",TRB->BASCOCENT,TRB->BASCOCSAI)})
	EndIf
Endif

cCFOP	:= TRB->CFOP
nPos 	:= Ascan(aTotDoCFOP,{|x| x[1]==cCFOP})
If nPos > 0
	aTotDoCFOP[nPos][2]  += TRB->VALORCONT
	aTotDoCFOP[nPos][3]  += TRB->ZFRANCA
	aTotDoCFOP[nPos][4]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISDENT,TRB->PISDSAI) , IIF(TRB->ES == "E",TRB->COFDENT,TRB->COFDSAI))
	aTotDoCFOP[nPos][5]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->PISCENT,TRB->PISCSAI) , IIF(TRB->ES == "E",TRB->COFCENT,TRB->COFCSAI))
	aTotDoCFOP[nPos][6]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPIDENT,TRB->BASPIDSAI) , IIF(TRB->ES == "E",TRB->BASCODENT,TRB->BASCODSAI))
	aTotDoCFOP[nPos][7]  += IIF(TRB->TIPO == "PIS" , IIF(TRB->ES == "E",TRB->BASPICENT,TRB->BASPICSAI) , IIF(TRB->ES == "E",TRB->BASCOCENT,TRB->BASCOCSAI))
Else
	If TRB->TIPO == "PIS"
		AADD(aTotDoCFOP,{TRB->CFOP,TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->ES=="E",TRB->PISDENT,TRB->PISDSAI),IIF(TRB->ES=="E",TRB->PISCENT,TRB->PISCSAI),IIF(TRB->ES=="E",TRB->BASPIDENT,TRB->BASPIDSAI),IIF(TRB->ES=="E",TRB->BASPICENT,TRB->BASPICSAI)})
	Else
		AADD(aTotDoCFOP,{TRB->CFOP,TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->ES=="E",TRB->COFDENT,TRB->COFDSAI),IIF(TRB->ES=="E",TRB->COFCENT,TRB->COFCSAI),IIF(TRB->ES=="E",TRB->BASCODENT,TRB->BASCODSAI),IIF(TRB->ES=="E",TRB->BASCOCENT,TRB->BASCOCSAI)})
	EndIf
Endif

If mv_par06 == 1
	If TRB->TIPO == "PIS"
		nPos := Ascan(If(TRB->ES=="E",aCFOPPISE,aCFOPPISS),{|x| x[1]==SM0->M0_CODFIL .And.  x[2]==TRB->CFOP})
		If nPos > 0
			If TRB->ES=="E"
				aCFOPPISE[nPos][3]  += TRB->BASPIDENT - TRB->BASPICENT
				aCFOPPISE[nPos][4]  += TRB->PISDENT 	- TRB->PISCENT
			Else
				aCFOPPISS[nPos][3]  += TRB->BASPIDSAI - TRB->BASPICSAI
				aCFOPPISS[nPos][4]  += TRB->PISDSAI 	- TRB->PISCSAI
			EndIf
		Else
			If TRB->ES=="E"
				AADD(aCFOPPISE,{SM0->M0_CODFIL,TRB->CFOP,TRB->BASPIDENT - TRB->BASPICENT,TRB->PISDENT - TRB->PISCENT})
			Else
				AADD(aCFOPPISS,{SM0->M0_CODFIL,TRB->CFOP,TRB->BASPIDSAI - TRB->BASPICSAI,TRB->PISDSAI - TRB->PISCSAI})
			EndIf
		EndIf
	Else
		nPos := Ascan(If(TRB->ES=="E",aCFOPCOFE,aCFOPCOFS),{|x| x[1]==SM0->M0_CODFIL .And.  x[2]==TRB->CFOP})
		If nPos > 0
			If TRB->ES=="E"
				aCFOPCOFE[nPos][3]  += TRB->BASCODENT - TRB->BASCOCENT
				aCFOPCOFE[nPos][4]  += TRB->COFDENT 	- TRB->COFCENT
			Else
				aCFOPCOFS[nPos][3]  += TRB->BASCODSAI - TRB->BASCOCSAI
				aCFOPCOFS[nPos][4]  += TRB->COFDSAI 	- TRB->COFCSAI
			EndIf
		Else
			If TRB->ES=="E"
				AADD(aCFOPCOFE,{SM0->M0_CODFIL,TRB->CFOP,TRB->BASCODENT - TRB->BASCOCENT,TRB->COFDENT - TRB->COFCENT})
			Else
				AADD(aCFOPCOFS,{SM0->M0_CODFIL,TRB->CFOP,TRB->BASCODSAI - TRB->BASCOCSAI,TRB->COFDSAI - TRB->COFCSAI})
			EndIf
		EndIf
	EndIf

	If TRB->TIPO == "PIS"
		nAliq := Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
		nPos  := Ascan(If(TRB->ES=="E",aTAlPISE,aTAlPISS),{|x| x[1]==SM0->M0_CODFIL .And.  x[2]==nAliq})
		If nPos > 0
			If TRB->ES=="E"
				aTAlPISE[nPos][3] += TRB->PISDENT-TRB->PISCENT
			Else
				aTAlPISS[nPos][3] += TRB->PISDSAI-TRB->PISCSAI
			EndIf
		Else
			If TRB->ES=="E"
				AADD(aTAlPISE,{SM0->M0_CODFIL,Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->PISDENT-TRB->PISCENT})
			Else
				AADD(aTAlPISS,{SM0->M0_CODFIL,Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->PISDSAI-TRB->PISCSAI})
			EndIf
		EndIf
	Else
		nAliq	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
		nPos	:= Ascan(If(TRB->ES=="E",aTAlCOFE,aTAlCOFS),{|x| x[1]==SM0->M0_CODFIL .And.  x[2]==nAliq})
		If nPos > 0
			If TRB->ES=="E"
				aTAlCOFE[nPos][3] += TRB->COFDENT-TRB->COFCENT
			Else
				aTAlCOFS[nPos][3] += TRB->COFDSAI-TRB->COFCSAI
			EndIf
		Else
			If TRB->ES=="E"
				AADD(aTAlCOFE,{SM0->M0_CODFIL,Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->COFDENT-TRB->COFCENT})
			Else
				AADD(aTAlCOFS,{SM0->M0_CODFIL,Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->COFDSAI-TRB->COFCSAI})
			EndIf
		EndIf
	EndIf
EndIf
Return .T. 













Static Function CompVlCont(cAlias,cF4Agreg,cF4Ipi)
Local   nVlCtb		:= 0
cF4Agreg := If( cF4Agreg == nil, "", cF4Agreg ) ;
cF4Ipi := If( cF4Ipi == nil, "", cF4Ipi ) ;

If At("D1",cAlias)>0







	nVlCtb :=	(cAlias)->D1_TOTAL+ (cAlias)->D1_ICMSRET+ IIF(cF4Ipi$"R",0,(cAlias)->D1_VALIPI)+					(cAlias)->D1_VALFRE+ (cAlias)->D1_SEGURO+ (cAlias)->D1_DESPESA+ IIf(cF4Agreg$"I/B",(cAlias)->D1_VALICM,0)- (cAlias)->D1_VALDESC
ElseIf At("D2",cAlias)>0
	nVlCtb :=	(cAlias)->D2_VALBRUT
Endif
Return nVlCtb












Function MATR906R3
Local	 cText1   := If( cPaisLoc $ "ANG|PTG", "Este Programa Emite Relatório Das Contribuições Ao Pis E Cofins", "Este programa emite Relatorio das Contribuicoes ao PIS e COFINS" )
Local	 cString  := "SD2"
Local	 aOrd	  := {"Cfop", If( cPaisLoc $ "ANG|PTG", "Nº Factura+série+emissão", "Num. Nf+Serie+Emissao" ), If( cPaisLoc $ "ANG|PTG", "Emissão+número Da Factura+série", "Emissao+Numero NF+Serie" )}
Private	 cTitulo  := If( cPaisLoc $ "ANG|PTG", "Relatório - (pis/cofins)", "Relatorio - (PIS/COFINS)" )
Private	 cPerg    := "MTR906"
Private	 nLastKey := 0
Private  m_pag    := 01
Private  Limite   := 220
Private  cTamanho := "G"
Private  lEnd     := .F. 
Private  NomeProg := "MATR906"
Private  aReturn  := { If( cPaisLoc $ "ANG|PTG", "Código de barras", "Zebrado" ) , 1, If( cPaisLoc $ "ANG|PTG", "Administração", "Administracao" ) , 2, 2, 1, "",1 }

AjustaSX1()
Pergunte(cPerg, .F. )

wnrel	:=	"MATR906"
wnrel	:=	SetPrint(cString,wnrel,cPerg,cTitulo,cText1,,, .F. ,aOrd,,cTamanho,, .F. )
If nLastKey==27
   dbClearFilter()
   Return
Endif
SetDefault(aReturn,cString)
If nLastKey==27
   dbClearFilter()
   Return
Endif

RptStatus({|lEnd| a906Relat(@lEnd,wnRel,cString,cTamanho)},cTitulo)

Return










Static Function A906Relat(lEnd,WnRel,cString,cTamanho)

Local aStruSD1	  := {}
Local aStruSD2	  := {}
Local aStruSB1 	  := {}
Local aStruSF2	  := {}
Local aStruSF1	  := {}
Local aStruSF4	  := {}
Local aResAliCF	  := {}
Local aArqTemp	  := {}
Local aPIS		  := {}
Local aCOFINS	  := {}
Local aRelImp	  := MaFisRelImp("MT100",{ "SD1" })
Local aRelImp2	  := MaFisRelImp("MT100",{ "SD2" })
Local aTotaisPIS  := Array( 8 )
Local aTotaisCOF  := Array( 8 )
Local aAliqs	  := {}
Local aDedRet	  := {0,0}
Local aTotSai	  := Array(3)
Local aTotDevS	  := Array(3)
Local aTotEnt	  := Array(3)
Local aTotDevE	  := Array(3)
Local aTotApur	  := Array(2,3)
Local aTAlPISS	  := {}
Local aTAlCOFS	  := {}
Local aTAlPISE	  := {}
Local aTAlCOFE	  := {}
Local aCFOPPISS	  := {}
Local aCFOPCOFS   := {}
Local aCFOPPISE   := {}
Local aCFOPCOFE   := {}
Local aAliqCFGer  := {}
Local aContrAliq  := Array(6)
Local aValContri  := Array(6)
Local aRet		  := {0,0}

Local cAliasSD2   := "SD2"
Local cAliasSD1   := "SD1"
Local cAliasSB1   := "SB1"
Local cAliasSF4   := "SF4"
Local cAliasSF2   := "SF2"
Local cAliasSF1   := "SF1"
Local cCpVlPisEn  := ""
Local cCpBsPisEn  := ""
Local cCpVlPisSa  := ""
Local cCpBsPisSa  := ""
Local cCpAlPisSa  := ""
Local cCpAlPisEn  := ""
Local cCpVlCofEn  :=  ""
Local cCpBsCofEn  :=  ""
Local cCpVlCofSa  := ""
Local cCpBsCofSa  := ""
Local cCpAlCofEn  := ""
Local cCpAlCofSa  := ""
Local cLinha      := ""
Local cLinha2	  := ""
Local cArqTemp    := ""
Local cabec1      := ""
Local cabec2      := ""
Local cQuebra     := ""
Local cChave	  := ""
Local cTipo       := ""
Local cCodCfop    := ""
Local cContArq    := ""
Local cLinArq     := ""
Local cArqCp      := ""
Local cB1_GRTRIB  := ""
Local cFilOri     := SM0->M0_CODFIL
Local cFilIni     := ""
Local cFilFin     := ""
Local cFilProc    := ""
Local cCFOP		  := ""
Local cDesc_cfop  := ""
Local CNumNota	  := ""
Local cSerie      := ""
Local cEmissao    := ""
Local cNcm        := ""
Local cProd       := ""
Local dDtCorte	  := GetNewPar("MV_DTCORTE",CtoD("01/02/2004"))
Local cCliFor	  := ""
Local cDebSTPIS   := GetNewPar("MV_DBSTPIS","1")
Local cDebSTCOF   := GetNewPar("MV_DBSTCOF","1")

Local lRet        := .F. 
Local lContinua   := .T. 
Local lEntrada    := .F. 
Local lQuebra     := .F. 
Local lFirst      := .F. 
Local lResumo	  := .F. 
Local lApurac     := (SF4->(FieldPos("F4_PISFISC")) > 0)

Local nPos		  	:= 0
Local nX		      := 0
Local nRedPis	  	:= 1
Local nRedCOF	  	:= 1
Local nValPisPas 	:= 0
Local nBasPisPas 	:= 0
Local nPsVlPisEn 	:= 0
Local nPsBsPisEn 	:= 0
Local nPsVlPisSa 	:= 0
Local nPsBsPisSa 	:= 0
Local nPsAlPisEn 	:= 0
Local nPsAlPisSa 	:= 0
Local nPosCofins 	:= 0
Local nValCofins 	:= 0
Local nBasCofins 	:= 0
Local nPsVlCofEn 	:= 0
Local nPsBsCofEn 	:= 0
Local nPsVlCofSa 	:= 0
Local nPsBsCofSa 	:= 0
Local nPsAlCofEn 	:= 0
Local nPsAlCofSa 	:= 0
Local nScanPis   	:= 0
Local nScanCof   	:= 0
Local nTxPis     	:= 0
Local nTxCof     	:= 0
Local nCredPis   	:= 0
Local nCredCof   	:= 0
Local nValCont   	:= 0
Local nZFranca   	:= 0
Local nValDebi   	:= 0
Local nValCred   	:= 0
Local nBasDebi   	:= 0
Local nBasCred   	:= 0
Local nDValCont  	:= 0
Local nDZFranca  	:= 0
Local nDValDebi  	:= 0
Local nDValCred  	:= 0
Local nDBasDebi  	:= 0
Local nDBasCred  	:= 0
Local nGValCont  	:= 0
Local nGZFranca  	:= 0
Local nGValDebi  	:= 0
Local nGValCred  	:= 0
Local nGBasDebi  	:= 0
Local nGBasCred  	:= 0
Local nValContri 	:= 0
Local nContCp    	:= 0
Local nExPis     	:= 0
Local nExCof     	:= 0
Local nValDevVend	:= 0
Local nValComp   	:= 0
Local nValVend   	:= 0
Local nValDevComp	:= 0
Local nVendTrib  	:= 0
Local nDevCompT  	:= 0
Local nCompTrib  	:= 0
Local nDevVendT  	:= 0
Local nTValPIS   	:= 0
Local nTValCOF   	:= 0
Local nTotal     	:= 0
Local nTot_emp	  	:= 0
Local nPosAliq   	:= 0
Local nContrAli	    := 0
Local nAliq			:= 0
Local nAcVlrCtb 	:= 0
Local nAcZfranca	:= 0
Local nAcVlrCtbD	:= 0
Local nAcVlrCtbC	:= 0
Local nAcBsCtbD	    := 0
Local nAcBsCtbC		:= 0
Local nCt			:= 0
Local nPautaPIS		:= 0
Local nPautaCOF		:= 0
Local nXX			:= 0
Local nLiAnt	    := 0
Local nAliqP		:= 0
Local lOrgPub		:= IIF(mv_par13 == 1, .T. , .F. )
Local cDEDBCOF      := GetNewPar("MV_DEDBCOF"," ")
Local cDEDBPIS      := GetNewPar("MV_DEDBPIS"," ")

cbtxt      := Space(10)
cbcont     := 00
li         := 80

If mv_par04 == 1
	Cabec1 := If( cPaisLoc $ "ANG|PTG", " produto          ncm         valor contabil            zona franca      taxa              valor da contribuição                            base da contribuição              documento serie emissão  cliente/forn.  ", " Produto          NCM         Valor Contabil            Zona Franca      Aliquota              Valor da Contribuicao                            Base da Contribuicao              Documento Serie Emissao  Cliente/Forn.  " )
Else
	Cabec1 := "                Valor Contabil         Zona Franca                      Aliquota               Valor da Contribuicao    Base da Contribuicao Base da Contribuicao"
Endif

Cabec2 := "                                                           Desconto                                                Debito                   Credito              Debito                 "







SetRegua(SD1->(LastRec())+SD2->(LastRec()))


For nCt := 1 To len(aValContri)
	aValContri[nCt] := 0
next


If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_BASEPS2"} ) )
	cCpBsPisEn := aRelImp[nScanPis,2]
	nPsBsPisEn := SD1->(FieldPos(cCpBsPisEn))
EndIf
If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_VALPS2"} ) )
	cCpVlPisEn := aRelImp[nScanPis,2]
	nPsVlPisEn := SD1->(FieldPos(cCpVlPisEn))
EndIf
If !Empty( nScanPis := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_ALIQPS2"} ) )
	cCpAlPisEn := aRelImp[nScanPis,2]
	nPsAlPisEn := SD1->(FieldPos(cCpAlPisEn))
EndIf

If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_BASEPS2"} ) )
	cCpBsPisSa := aRelImp2[nScanPis,2]
	nPsBsPisSa := SD2->(FieldPos(cCpBsPisSa))
EndIf
If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_VALPS2"} ) )
	cCpVlPisSa := aRelImp2[nScanPis,2]
	nPsVlPisSa := SD2->(FieldPos(cCpVlPisSa))
EndIf
If !Empty( nScanPis := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_ALIQPS2"} ) )
	cCpAlPisSa := aRelImp2[nScanPis,2]
	nPsAlPisSa := SD2->(FieldPos(cCpAlPisSa))
EndIf

AFill( aTotaisCof, 0 )


If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_BASECF2"} ) )
	cCpBsCofEn := aRelImp[nScanCof,2]
	nPsBsCofEn := SD1->(FieldPos(cCpBsCofEn))
EndIf

If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_VALCF2"} ) )
	cCpVlCofEn := aRelImp[nScanCof,2]
	nPsVlCofEn := SD1->(FieldPos(cCpVlCofEn))
EndIf

If !Empty( nScanCof := aScan(aRelImp,{|x| x[1]=="SD1" .And.  x[3]=="IT_ALIQCF2"} ) )
	cCpAlCofEn := aRelImp[nScanCof,2]
	nPsAlCofEn := SD1->(FieldPos(cCpAlCofEn))
EndIf


If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_BASECF2"} ) )
	cCpBsCofSa := aRelImp2[nScanCof,2]
	nPsBsCofSa := SD2->(FieldPos(cCpBsCofSa))
EndIf

If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_VALCF2"} ) )
	cCpVlCofSa := aRelImp2[nScanCof,2]
	nPsVlCofSa := SD2->(FieldPos(cCpVlCofSa))
EndIf

If !Empty( nScanCof := aScan(aRelImp2,{|x| x[1]=="SD2" .And.  x[3]=="IT_ALIQCF2"} ) )
	cCpAlCofSa := aRelImp2[nScanCof,2]
	nPsAlCofSa := SD2->(FieldPos(cCpAlCofSa))
EndIf

AADD(aArqTemp,{"NUMNF"		,"C",TamSx3("D2_DOC")[1],0})
AADD(aArqTemp,{"SERIE"		,"C",03,0})
AADD(aArqTemp,{"EMISSAO"   ,"D",TamSx3("D2_EMISSAO")[1],0})
AADD(aArqTemp,{"TIPO"		,"C",03,0})
AADD(aArqTemp,{"CFOP"	   ,"C",04,0})
AADD(aArqTemp,{"PRODUTO"	,"C",15,0})
AADD(aArqTemp,{"NCM"			,"C",10,0})
AADD(aArqTemp,{"VALORCONT"	,"N",14,2})
AADD(aArqTemp,{"ZFRANCA"	,"N",14,2})
AADD(aArqTemp,{"ALIQ"		,"N",TamSx3("B1_VLR_COF")[1],TamSx3("B1_VLR_COF")[2]})
AADD(aArqTemp,{"PISCSAI"	,"N",14,2})
AADD(aArqTemp,{"PISDSAI"	,"N",14,2})
AADD(aArqTemp,{"BASPICSAI"	,"N",14,2})
AADD(aArqTemp,{"BASPIDSAI"	,"N",14,2})
AADD(aArqTemp,{"PISCENT"	,"N",14,2})
AADD(aArqTemp,{"PISDENT"	,"N",14,2})
AADD(aArqTemp,{"BASPICENT"	,"N",14,2})
AADD(aArqTemp,{"BASPIDENT"	,"N",14,2})
AADD(aArqTemp,{"COFCSAI"	,"N",14,2})
AADD(aArqTemp,{"COFDSAI"	,"N",14,2})
AADD(aArqTemp,{"BASCOCSAI"	,"N",14,2})
AADD(aArqTemp,{"BASCODSAI"	,"N",14,2})
AADD(aArqTemp,{"COFCENT"	,"N",14,2})
AADD(aArqTemp,{"COFDENT"	,"N",14,2})
AADD(aArqTemp,{"BASCOCENT"	,"N",14,2})
AADD(aArqTemp,{"BASCODENT"	,"N",14,2})
AADD(aArqTemp,{"ES"			,"C",01,0})
AADD(aArqTemp,{"CLIFOR"		,"C",16,0})
AADD(aArqTemp,{"PAUTA"		,"C",01,0})

For nX := 1 to 3
	aTotSai[nX] 		:= 0
	aTotDevS[nX]		:= 0
	aTotEnt[nX]			:= 0
	aTotDevE[nX]		:= 0
	aTotApur[1][nX]	:= 0
	aTotApur[2][nX]	:= 0
Next


If mv_par06 == 1
	cFilIni := mv_par07
	cFilFin := mv_par08
Else
	cFilIni := cFilAnt
	cFilFin := cFilAnt
Endif

dbSelectArea("SM0")
SM0->(dbSeek(cEmpAnt+cFilIni, .T. ))

cFilProc := cFilIni
While SM0->M0_CODIGO == cEmpAnt .And.  SM0->M0_CODFIL <= cFilFin .And.  !SM0->(Eof())
	cFilAnt := SM0->M0_CODFIL

	cArqTemp := CriaTrab(aArqTemp)
	dbUseArea( .T. ,__LocalDriver,cArqTemp,"TRB")
	IndRegua("TRB",cArqTemp,IIF(MV_PAR09==1,"TIPO+CFOP+DTOS(EMISSAO)","TIPO+CFOP"))
	dbSelectArea("TRB")

	dbSelectArea("SD2")
	SD2->(dbSetOrder(5))

		lQuery		:= .T. 
		cAliasSD2	:= "a906AMontSD2"
		cAliasSF2	:= "a906AMontSD2"
		cAliasSF4	:= "a906AMontSD2"
		cAliasSB1	:= "a906AMontSD2"

		aStruSD2	:= SD2->(dbStruct())
		aStruSB1	:= SB1->(dbStruct())
		aStruSF4	:= SF4->(dbStruct())
		aStruSF2	:= SF2->(dbStruct())

		cQuery		:= "SELECT F4_AGREG,F4_IPI,F2_SERIE,F2_DOC,F2_SEGURO,F2_FRETE,F2_DESPESA,F2_VALMERC,D2_TOTAL,D2_DOC,D2_SERIE,D2_EMISSAO,D2_CF,D2_COD,D2_DESCZFR,B1_POSIPI,D2_TIPO,"
		cQuery		+= "D2_ICMSRET,D2_VALIPI,D2_VALFRE,D2_SEGURO,D2_DESPESA,D2_CLIENTE,D2_LOJA,D2_VALBRUT "

		If !Empty( nPsVlPisSa )
			cQuery += "," + cCpVlPisSa
		EndIf

		If !Empty( nPsBsPisSa )
			cQuery += "," + cCpBsPisSa
		EndIf

		If !Empty( nPsAlPisSa )
			cQuery += "," + cCpAlPisSa
		EndIf

		If !Empty( nPsVlCofSa )
			cQuery += "," + cCpVlCOfSa
		EndIf

		If !Empty( nPsBsCofSa )
			cQuery += "," + cCpBsCofSa
		EndIf

		If !Empty( nPsAlCofSa )
			cQuery += "," + cCpAlCOfSa
		EndIf

		If SB1->(FieldPos("B1_PPIS")) >0
			cQuery += ",B1_PPIS "
		Endif

		If SB1->(FieldPos("B1_REDPIS")) > 0
			cQuery += ",B1_REDPIS "
		Endif

		If SB1->(FieldPos("B1_VLR_PIS")) > 0
			cQuery += ",B1_VLR_PIS "
		Endif

		If SB1->(FieldPos("B1_REDCOF")) > 0
			cQuery += ",B1_REDCOF "
		Endif

		If SB1->(FieldPos("B1_PCOFINS")) > 0
			cQuery += ",B1_PCOFINS "
		Endif

		If SB1->(FieldPos("B1_VLR_COF")) > 0
			cQuery += ",B1_VLR_COF "
        Endif

		If SB1->(FieldPos("B1_GRTRIB")) > 0
			cQuery += ",B1_GRTRIB "
		Endif

		If SF4->(FieldPos("F4_BASEPIS")) > 0
			cQuery += ",F4_BASEPIS "
		Endif

		If SF4->(FieldPos("F4_BASECOF")) > 0
			cQuery += ",F4_BASECOF "
		Endif

		If SF4->(FieldPos("F4_PISCOF")) > 0
			cQuery += ",F4_PISCOF "
		Endif

		If SF4->(FieldPos("F4_PISCRED")) > 0
			cQuery += ",F4_PISCRED "
		Endif

		If SF4->(FieldPos("F4_TPREG")) > 0
			cQuery += ",F4_TPREG "
		Endif
		If lApurac
			cQuery += ",F4_PISFISC "
		Endif

		cQuery 	+= "FROM "+RetSqlName("SD2")+" SD2, "
		cQuery 	+= RetSqlName("SF4")+" SF4, "
		cQuery 	+= RetSqlName("SB1")+" SB1, "
		cQuery 	+= RetSqlName("SF2")+" SF2 "

		cQuery 	+= "WHERE D2_FILIAL='"+xFilial("SD2")+"' AND "
		cQuery 	+= "D2_EMISSAO>='"+Dtos(MV_PAR02)+"' AND "
		cQuery 	+= "D2_EMISSAO<='"+Dtos(MV_PAR03)+"' AND "
		cQuery	+= "SD2.D_E_L_E_T_ = ' ' AND "

		cQuery	+= "F4_FILIAL = '"+xFilial("SF4")+"' AND "
		cQuery	+= "F4_CODIGO = D2_TES AND "
		cQuery	+= "SF4.D_E_L_E_T_ = ' ' AND "


		If !((Empty (MV_PAR05)) .Or.  ("*"$MV_PAR05))
			cQuery += " F4_NRLIVRO='"+MV_PAR05+"' AND "
		EndIf
		cQuery  += "B1_FILIAL = '"+xFilial("SB1")+"' AND "
		cQuery  += "B1_COD = D2_COD AND "
		cQuery  += "SB1.D_E_L_E_T_ = ' ' AND "

		cQuery  += "F2_FILIAL = '"+xFilial("SF2")+"' AND "
		cQuery  += "F2_DOC = D2_DOC AND "
		cQuery  += "F2_SERIE = D2_SERIE AND "
		cQuery  += "F2_CLIENTE = D2_CLIENTE AND "
		cQuery  += "F2_LOJA = D2_LOJA AND "
		cQuery  += "F2_EMISSAO = D2_EMISSAO AND "
		cQuery  += "SF2.D_E_L_E_T_ = ' ' "





		If Upper(cDEDBCOF) $ "P#S" .Or.  Upper(cDEDBPIS) $ "P#S"
			cQuery  += " AND ((F4_IPI = 'S' AND F4_CREDIPI = 'N' "
			cQuery  += " AND SF2.F2_TIPO IN('I', 'P'))  "
			cQuery  += " OR  (SF2.F2_TIPO NOT IN('I', 'P'))) "
		Else
			cQuery  += " AND SF2.F2_TIPO NOT IN('I', 'P') "
		EndIF

		If ExistBlock("MT996QRY")
			cQuery := ExecBlock("MT996QRY", .F. , .F. ,{cQuery,1})
		EndIf

	    If mv_par11 ==1
			cQuery += "ORDER BY D2_CF, D2_DOC"
		Else
			cQuery += "ORDER BY D2_CF, D2_COD"
		Endif

		cQuery := ChangeQuery(cQuery)
		dbUseArea( .T. ,"TOPCONN",TcGenQry(,,cQuery),cAliasSD2, .T. , .T. )

		For nX := 1 To len(aStruSD2)
			If aStruSD2[nX][2] <> "C" .And.  FieldPos(aStruSD2[nX][1])<>0
				TcSetField(cAliasSD2,aStruSD2[nX][1],aStruSD2[nX][2],aStruSD2[nX][3],aStruSD2[nX][4])
			EndIf
		next

		For nX := 1 To len(aStruSB1)
			If aStruSB1[nX][2] <> "C" .And.  FieldPos(aStruSB1[nX][1])<>0
				TcSetField(cAliasSB1,aStruSB1[nX][1],aStruSB1[nX][2],aStruSB1[nX][3],aStruSB1[nX][4])
			EndIf
		next

		For nX := 1 To len(aStruSF4)
			If aStruSF4[nX][2] <> "C" .And.  FieldPos(aStruSF4[nX][1])<>0
				TcSetField(cAliasSF4,aStruSF4[nX][1],aStruSF4[nX][2],aStruSF4[nX][3],aStruSF4[nX][4])
			EndIf
		next

		For nX := 1 To len(aStruSF2)
			If aStruSF2[nX][2] <> "C" .And.  FieldPos(aStruSF2[nX][1])<>0
				TcSetField(cAliasSF2,aStruSF2[nX][1],aStruSF2[nX][2],aStruSF2[nX][3],aStruSF2[nX][4])
			EndIf
		next

		dbSelectArea(cAliasSD2)
		nPsVlPisSa := ( cAliasSD2 )->( FieldPos( cCpVlPisSa ) )
		nPsBsPisSa := ( cAliasSD2 )->( FieldPos( cCpBsPisSa ) )
		nPsAlPisSa := ( cAliasSD2 )->( FieldPos( cCpAlPisSa ) )
		nPsVlCofSa := ( cAliasSD2 )->( FieldPos( cCpVlCofSa ) )
		nPsBsCOfSa := ( cAliasSD2 )->( FieldPos( cCpBsCofSa ) )
		nPsAlCofSa := ( cAliasSD2 )->( FieldPos( cCpAlCofSa ) )
















	While (cAliasSD2)->(!Eof())
		nPautaPIS := 0
		nPautaCOF := 0

		If !lQuery
			SF4->(dbSetOrder(1))
			SF4->(MsSeek(xFilial("SF4")+(cAliasSD2)->D2_TES))
			SB1->(dbSetOrder(1))
			SB1->(MsSeek(xFilial("SB1")+(cAliasSD2)->D2_COD))
			SF2->(dbSetOrder(1))
			SF2->(MsSeek(xFilial("SF2")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
			cB1_GRTRIB := SB1->B1_GRTRIB
		Else
			cB1_GRTRIB := (cAliasSB1)->B1_GRTRIB
		EndIf

		SA1->(dbSetOrder(1))
		SA2->(dbSetOrder(1))
		If (cAliasSD2)->D2_TIPO$"DB"
			SA2->(MsSeek(xFilial("SA2")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
			cCliFor 	:= SA2->A2_NOME
		Else
			SA1->(MsSeek(xFilial("SA1")+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA))
			cCliFor 	:= SA1->A1_NOME
		Endif

		If (cAliasSF4)->F4_AGREG <> "N"
			If SB1->(FieldPos("B1_PPIS")) >0
				nTxPIS	:= 	Iif((cAliasSB1)->B1_PPIS <> 0,(cAliasSB1)->B1_PPIS , GetMv("MV_TXPIS"))
			Endif
			If SB1->(FieldPos("B1_REDPIS")) > 0
				nRedPIS	:= 	Iif((cAliasSB1)->B1_REDPIS > 0,1-((cAliasSB1)->B1_REDPIS / 100 ), 1 )
			Endif
			If SF4->(FieldPos("F4_BASEPIS")) > 0
				nRedPIS	*= 	Iif((cAliasSF4)->F4_BASEPIS > 0,1-((cAliasSF4)->F4_BASEPIS / 100 ), 1 )
			Endif
			If SB1->(FieldPos("B1_VLR_PIS")) > 0
				nPautaPIS	:= 	(cAliasSB1)->B1_VLR_PIS
			Endif
			If SB1->(FieldPos("B1_REDCOF")) > 0
				nRedCOF	:= 	Iif((cAliasSB1)->B1_REDCOF > 0,1-((cAliasSB1)->B1_REDCOF / 100 ), 1 )
			EndIf
			If SF4->(FieldPos("F4_BASECOF")) > 0
				nRedCOF	*= 	Iif((cAliasSF4)->F4_BASECOF > 0,1-((cAliasSF4)->F4_BASECOF / 100 ), 1 )
			EndIf
			If SB1->(FieldPos("B1_PCOFINS")) > 0
				nTxCOF	:=	if((cAliasSB1)->B1_PCOFINS <> 0,(cAliasSB1)->B1_PCOFINS , GetMv("MV_TXCOFIN"))
			Endif
			If SB1->(FieldPos("B1_VLR_COF")) > 0
				nPautaCOF	:= 	(cAliasSB1)->B1_VLR_COF
			Endif
			If SF4->(FieldPos("F4_PISCOF")) > 0
				If !lApurac .Or.  ((cAliasSF4)->F4_PISFISC<>"2")
					If (cAliasSF4)->F4_PISCOF $ "13"
						nValPisPas := 0
						nBasPisPas := 0


						If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlPisSa ) .And.  !Empty( nPsBsPisSa ) .And.   !Empty( nPsAlPisSa )
							nValPisPas	:= ( cAliasSD2 )->( FieldGet( nPsVlPisSa ) )
							nBasPisPas	:= ( cAliasSD2 )->( FieldGet( nPsBsPisSa ) )
							nTxPIS		:= ( cAliasSD2 )->( FieldGet( nPsAlPisSa ) )
						EndIf

						If mv_par01 <> 2 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
							RecLock("TRB", .T. )
							TRB->NUMNF     	:= (cAliasSD2)->D2_DOC
							TRB->SERIE     	:= (cAliasSD2)->D2_SERIE
							TRB->EMISSAO   	:= (cAliasSD2)->D2_EMISSAO
							TRB->CFOP      	:= (cAliasSD2)->D2_CF
							TRB->PRODUTO   	:= (cAliasSD2)->D2_COD
							TRB->NCM       	:= (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT 	:= CompVlCont(cAliasSD2)
							TRB->ZFRANCA   	:= (cAliasSD2)->D2_DESCZFR
							TRB->ALIQ      	:= Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
							TRB->TIPO      	:= "PIS"
							TRB->ES			:=	"S"
							TRB->CLIFOR		:= cCliFor
							TRB->PAUTA		:= Iif(nPautaPIS <> 0,"S","N")
							MsUnlock()

							If (cAliasSD2)->D2_EMISSAO >= dDtCorte

								If SF4->(FieldPos("F4_PISCRED")) >0
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
										TRB->PISDSAI   := nValPisPas
										TRB->BASPIDSAI := nBasPisPas
									Endif
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCSAI   := nValPisPas
										TRB->BASPICSAI := nBasPisPas
									Endif
									MsUnlock()
								Endif
							Else

								If SF4->(FieldPos("F4_PISCRED")) >0
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
										TRB->PISDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedPis ) * (TRB->ALIQ/100)
										TRB->BASPIDSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
									Endif
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPICSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
									Endif
									MsUnlock()
								Endif
							EndIf
						Endif
						If mv_par01 <> 2 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
							RecLock("TRB", .T. )
							TRB->NUMNF     	:= (cAliasSD2)->D2_DOC
							TRB->SERIE     	:= (cAliasSD2)->D2_SERIE
							TRB->EMISSAO   	:= (cAliasSD2)->D2_EMISSAO
							TRB->CFOP      	:= (cAliasSD2)->D2_CF
							TRB->PRODUTO   	:= (cAliasSD2)->D2_COD
							TRB->NCM       	:= (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT 	:= CompVlCont(cAliasSD2)
							TRB->ZFRANCA   	:= (cAliasSD2)->D2_DESCZFR
							TRB->ALIQ      	:= Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
							TRB->TIPO      	:= "PIS"
							TRB->ES			:=	"S"
							TRB->CLIFOR		:= cCliFor
							TRB->PAUTA		:= Iif(nPautaPIS <> 0,"S","N")
							MsUnlock()

							If (cAliasSD2)->D2_EMISSAO >= dDtCorte

								If SF4->(FieldPos("F4_PISCRED")) >0
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED <> "4"
										TRB->PISDSAI   := nValPisPas
										TRB->BASPIDSAI := nBasPisPas
									Endif
									If (cAliasSF4)->F4_PISCOF $ "23" .And.  (cAliasSF4)->F4_PISCRED == "1" .And.  mv_par01 <> 1
										TRB->PISCSAI   := nValPisPas
										TRB->BASPICSAI := nBasPisPas
									Endif
									MsUnlock()
								Endif
							Else

								If SF4->(FieldPos("F4_PISCRED")) >0
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED <> "4"
										TRB->PISDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedPis ) * (TRB->ALIQ/100)
										TRB->BASPIDSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
									Endif
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPICSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
									Endif
									MsUnlock()
								Endif
							EndIf
						Endif

						If mv_par01 <> 2 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
							RecLock("TRB", .T. )
							TRB->NUMNF     	:= (cAliasSD2)->D2_DOC
							TRB->SERIE     	:= (cAliasSD2)->D2_SERIE
							TRB->EMISSAO   	:= (cAliasSD2)->D2_EMISSAO
							TRB->CFOP      	:= (cAliasSD2)->D2_CF
							TRB->PRODUTO   	:= (cAliasSD2)->D2_COD
							TRB->NCM       	:= (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT 	:= CompVlCont(cAliasSD2)
							TRB->ZFRANCA   	:= (cAliasSD2)->D2_DESCZFR
							TRB->ALIQ      	:= Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
							TRB->TIPO      	:= "PIS"
							TRB->ES			:=	"S"
							TRB->CLIFOR		:= cCliFor
							TRB->PAUTA		:= Iif(nPautaPIS <> 0,"S","N")
							MsUnlock()

							If (cAliasSD2)->D2_EMISSAO >= dDtCorte

								If SF4->(FieldPos("F4_PISCRED")) >0
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED <> "4"
										TRB->PISDSAI   := nValPisPas
										TRB->BASPIDSAI := nBasPisPas
									Endif
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCSAI   := nValPisPas
										TRB->BASPICSAI := nBasPisPas
									Endif
									MsUnlock()
								Endif
							Else

								If SF4->(FieldPos("F4_PISCRED")) >0
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED <> "4"
										TRB->PISDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedPis ) * (TRB->ALIQ/100)
										TRB->BASPIDSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
									Endif
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPICSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedPis
									Endif
									MsUnlock()
								Endif
							EndIf
						Endif
					EndIf
					If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
						nValCofins := 0
						nBasCofins := 0


						If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlCofSa ) .And.  !Empty( nPsBsCofSa ) .And.  !Empty( nPsAlCofSa )
							nValCofins := ( cAliasSD2 )->( FieldGet( nPsVlCofSa ) )
							nBasCofins := ( cAliasSD2 )->( FieldGet( nPsBsCofSa ) )
							nTxCOF := ( cAliasSD2 )->( FieldGet( nPsAlCofSa ) )
						EndIf
						RecLock("TRB", .T. )
						TRB->NUMNF     := (cAliasSD2)->D2_DOC
						TRB->SERIE     := (cAliasSD2)->D2_SERIE
						TRB->EMISSAO   := (cAliasSD2)->D2_EMISSAO
						TRB->CFOP      := (cAliasSD2)->D2_CF
						TRB->PRODUTO   := (cAliasSD2)->D2_COD
						TRB->NCM       := (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT := CompVlCont(cAliasSD2)
						TRB->ZFRANCA   := (cAliasSD2)->D2_DESCZFR
						TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
						TRB->TIPO      := "COF"
						TRB->ES        := "S"
						TRB->CLIFOR	   := cCliFor
						TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
						MsUnlock()

						If (cAliasSD2)->D2_EMISSAO >= dDtCorte
							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
									TRB->COFDSAI   := nValCofins
									TRB->BASCODSAI := nBasCofins
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCSAI   := nValCofins
									TRB->BASCOCSAI := nBasCofins
								Endif
								MsUnlock()
							Endif
			            Else
							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4" .And.  (cAliasSF4)->F4_PISCRED <> "1"
									TRB->COFDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCODSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCOCSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
								Endif
								MsUnlock()
							Endif
						Endif
					EndIf

					If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
						nValCofins := 0
						nBasCofins := 0


						If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlCofSa ) .And.  !Empty( nPsBsCofSa ) .And.  !Empty( nPsAlCofSa )
							nValCofins	:= ( cAliasSD2 )->( FieldGet( nPsVlCofSa ) )
							nBasCofins	:= ( cAliasSD2 )->( FieldGet( nPsBsCofSa ) )
							nTxCOF		:= ( cAliasSD2 )->( FieldGet( nPsAlCofSa ) )
						EndIf
						RecLock("TRB", .T. )
						TRB->NUMNF     := (cAliasSD2)->D2_DOC
						TRB->SERIE     := (cAliasSD2)->D2_SERIE
						TRB->EMISSAO   := (cAliasSD2)->D2_EMISSAO
						TRB->CFOP      := (cAliasSD2)->D2_CF
						TRB->PRODUTO   := (cAliasSD2)->D2_COD
						TRB->NCM       := (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT := CompVlCont(cAliasSD2)
						TRB->ZFRANCA   := (cAliasSD2)->D2_DESCZFR
						TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
						TRB->TIPO      := "COF"
						TRB->ES        := "S"
						TRB->CLIFOR	   := cCliFor
						TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
						MsUnlock()

						If (cAliasSD2)->D2_EMISSAO >= dDtCorte
							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->COFDSAI   := nValCofins
									TRB->BASCODSAI := nBasCofins
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCSAI   := nValCofins
									TRB->BASCOCSAI := nBasCofins
								Endif
								MsUnlock()
							Endif
			            Else
							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->COFDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCODSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCOCSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
								Endif
								MsUnlock()
							Endif
						Endif
					EndIf

					If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
						nValCofins := 0
						nBasCofins := 0


						If (cAliasSD2)->D2_EMISSAO >= dDtCorte .And.  !Empty( nPsVlCofSa ) .And.  !Empty( nPsBsCofSa ) .And.  !Empty( nPsAlCofSa )
							nValCofins := ( cAliasSD2 )->( FieldGet( nPsVlCofSa ) )
							nBasCofins := ( cAliasSD2 )->( FieldGet( nPsBsCofSa ) )
							nTxCOF := ( cAliasSD2 )->( FieldGet( nPsAlCofSa ) )
						EndIf
						RecLock("TRB", .T. )
						TRB->NUMNF     := (cAliasSD2)->D2_DOC
						TRB->SERIE     := (cAliasSD2)->D2_SERIE
						TRB->EMISSAO   := (cAliasSD2)->D2_EMISSAO
						TRB->CFOP      := (cAliasSD2)->D2_CF
						TRB->PRODUTO   := (cAliasSD2)->D2_COD
						TRB->NCM       := (cAliasSB1)->B1_POSIPI
						TRB->VALORCONT := CompVlCont(cAliasSD2)
						TRB->ZFRANCA   := (cAliasSD2)->D2_DESCZFR
						TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
						TRB->TIPO      := "COF"
						TRB->ES        := "S"
						TRB->CLIFOR	   := cCliFor
						TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
						MsUnlock()



						If (cAliasSD2)->D2_EMISSAO >= dDtCorte
							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->COFDSAI   := nValCofins
									TRB->BASCODSAI := nBasCofins
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCSAI   := nValCofins
									TRB->BASCOCSAI := nBasCofins
								Endif
								MsUnlock()
							Endif
			            Else
							If SF4->(FieldPos("F4_PISCRED")) >0
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED <> "4"
									TRB->COFDSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) ) * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCODSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
								Endif
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCSAI   := ( ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC) )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCOCSAI := ( (cAliasSD2)->D2_TOTAL+((cAliasSD2)->D2_TOTAL*((cAliasSF2)->F2_SEGURO+(cAliasSF2)->F2_DESPESA+(cAliasSF2)->F2_FRETE)/(cAliasSF2)->F2_VALMERC)  ) * nRedCOF
								Endif
								MsUnlock()
							Endif
						Endif
					EndIf

					If (cAliasSF4)->F4_PISCOF $ "123"
						If !(cAliasSD2)->D2_TIPO $ "BD"
							If (cAliasSF4)->F4_PISCOF == "1"
								nVendTrib += (cAliasSD2)->D2_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								nVendTrib += (cAliasSD2)->D2_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								nVendTrib += (cAliasSD2)->D2_TOTAL+IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
						EndIf
						If (cAliasSD2)->D2_TIPO == "D"
							If (cAliasSF4)->F4_PISCOF == "1"
								nDevCompT += (cAliasSD2)->D2_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "2"
								nDevCompT += (cAliasSD2)->D2_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
							If (cAliasSF4)->F4_PISCOF == "3"
								nDevCompT += (cAliasSD2)->D2_TOTAL+IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA)
							EndIf
						EndIF
					ELSE
						If !(cAliasSD2)->D2_TIPO $ "BD"
							nValVend += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA
						EndIF
			   		If (cAliasSD2)->D2_TIPO == "D"
							nValDevComp += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD2)->D2_TIPO=="P",0,(cAliasSD2)->D2_VALIPI))+(cAliasSD2)->D2_VALFRE+(cAliasSD2)->D2_SEGURO+(cAliasSD2)->D2_DESPESA
						EndIF
					Endif
				Endif
			EndIf
		EndIf
		(cAliasSD2)->( dbSkip())
		IncRegua()
	EndDo
	If lQuery
		dbSelectArea(cAliasSD2)
		dbCloseArea()
		dbSelectArea("SD2")
	Else
		dbSelectArea("SD2")
		RetIndex("SD2")
		dbClearFilter()
		Ferase(cIndex+OrdBagExt())
	EndIf

	dbSelectArea("SD1")
	SD1->(dbSetOrder(6))

		lQuery		:= .T. 
		cAliasSD1	:= "a906AMontSD1"
		cAliasSF4	:= "a906AMontSD1"
		cAliasSB1	:= "a906AMontSD1"
		cAliasSF1	:= "a906AMontSD1"

		aStruSD1	:= SD1->(dbStruct())
		aStruSB1	:= SB1->(dbStruct())
		aStruSF4	:= SF4->(dbStruct())
		aStruSF1	:= SF1->(dbStruct())

		cQuery		:= "SELECT D1_CF,D1_COD,D1_TOTAL,D1_VALDESC,B1_POSIPI,D1_DOC,D1_SERIE,D1_DTDIGIT,D1_TIPO,"
		cQuery		+= "D1_ICMSRET,D1_VALIPI,D1_VALFRE,D1_SEGURO,D1_DESPESA,D1_VALICM,D1_FORNECE,D1_LOJA, "

		If !Empty( nPsVlPisEn )
			cQuery += cCpVlPisEn + ","
		EndIf

		If !Empty( nPsBsPisEn )
			cQuery += cCpBsPisEn + ","
		EndIf

		If !Empty( nPsAlPisEn )
			cQuery += cCpAlPisEn + ","
		EndIf

		If !Empty( nPsVlCofEn )
			cQuery += cCpVlCofEn + ","
		EndIf

		If !Empty( nPsBsCofEn )
			cQuery += cCpBsCofEn + ","
		EndIf

		If !Empty( nPsAlCofEn )
			cQuery += cCpAlCofEn + ","
		EndIf

		If SF4->( FieldPos( "F4_AGRPIS" ) )>0
			cQuery	+=	"F4_AGRPIS,"
		EndIF

		If SF4->( FieldPos( "F4_AGRCOF" ) )>0
			cQuery	+=	"F4_AGRCOF,"
		EndIF

		cQuery  += "F4_AGREG,F4_PISCOF,F4_IPI,F1_SEGURO,F1_FRETE,F1_DESPESA,F1_VALMERC,F1_DOC,F1_SERIE,F1_FORNECE,F1_LOJA "

		If SB1->(FieldPos("B1_PPIS")) >0
			cQuery += ",B1_PPIS "
		Endif

		If SB1->(FieldPos("B1_REDPIS")) > 0
			cQuery += ",B1_REDPIS "
		Endif

		If SB1->(FieldPos("B1_VLR_PIS")) > 0
			cQuery += ",B1_VLR_PIS "
		Endif

		If SB1->(FieldPos("B1_REDCOF")) > 0
			cQuery += ",B1_REDCOF "
		Endif

		If SB1->(FieldPos("B1_PCOFINS")) > 0
			cQuery += ",B1_PCOFINS "
		Endif

		If SB1->(FieldPos("B1_VLR_COF")) > 0
			cQuery += ",B1_VLR_COF "
		Endif

		If SB1->(FieldPos("B1_GRTRIB")) > 0
			cQuery += ",B1_GRTRIB "
		Endif

		If SF4->(FieldPos("F4_BASEPIS")) > 0
			cQuery += ",F4_BASEPIS "
		Endif

		If SF4->(FieldPos("F4_PISCOF")) > 0
			cQuery += ",F4_PISCOF "
		Endif

		If SF4->(FieldPos("F4_BASECOF")) > 0
			cQuery += ",F4_BASECOF "
		Endif

		If SF4->(FieldPos("F4_PISCRED")) > 0
			cQuery += ",F4_PISCRED "
		Endif

		If SF4->(FieldPos("F4_TPREG")) > 0
			cQuery += ",F4_TPREG "
		Endif
		If lApurac
			cQuery += ",F4_PISFISC "
		Endif

		If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
			cQuery += ",F4_MALQCOF,D1_VALCMAJ "
		EndIf

		cQuery 	+= "FROM "+RetSqlName("SD1")+" SD1, "
		cQuery 	+= RetSqlName("SF4")+" SF4, "
		cQuery 	+= RetSqlName("SB1")+" SB1, "
		cQuery 	+= RetSqlName("SF1")+" SF1 "

		cQuery 	+= "WHERE D1_FILIAL='"+xFilial("SD1")+"' AND "
		cQuery 	+= "D1_DTDIGIT>='"+Dtos(MV_PAR02)+"' AND "
		cQuery 	+= "D1_DTDIGIT<='"+Dtos(MV_PAR03)+"' AND "
		cQuery	+= "SD1.D_E_L_E_T_ = ' ' AND "

		cQuery	+= "F4_FILIAL ='"+xFilial("SF4")+"' AND "
		cQuery	+= "F4_CODIGO = D1_TES AND "
		cQuery	+= "SF4.D_E_L_E_T_ = ' ' AND "


		If !((Empty (MV_PAR05)) .Or.  ("*"$MV_PAR05))
			cQuery += " F4_NRLIVRO='"+MV_PAR05+"' AND "
		EndIf

		cQuery  += "B1_FILIAL = '"+xFilial("SB1")+"' AND "
		cQuery  += "B1_COD = D1_COD AND "
		cQuery  += "SB1.D_E_L_E_T_ = ' ' AND "

		cQuery  += "F1_FILIAL = '"+xFilial("SF1")+"' AND "
		cQuery  += "F1_DOC = D1_DOC AND "
		cQuery  += "F1_SERIE = D1_SERIE AND "
		cQuery  += "F1_FORNECE = D1_FORNECE AND "
		cQuery  += "F1_LOJA = D1_LOJA AND "
		cQuery  += "F1_DTDIGIT = D1_DTDIGIT AND "
		cQuery  += "SF1.D_E_L_E_T_ = ' ' "





		If Upper(cDEDBCOF) $ "P#S" .Or.  Upper(cDEDBPIS) $ "P#S"
			cQuery  += " AND ((F4_IPI = 'S' AND F4_CREDIPI = 'N' "
			cQuery  += " AND SF1.F1_TIPO IN('I', 'P'))  "
			cQuery  += " OR  (SF1.F1_TIPO NOT IN('I', 'P'))) "
		Else
			cQuery  += " AND SF1.F1_TIPO NOT IN('I', 'P') "
		EndIF

		If ExistBlock("MT996QRY")
			cQuery := ExecBlock("MT996QRY", .F. , .F. ,{cQuery,2})
		EndIf

	    If mv_par11 ==1
			cQuery += "ORDER BY D1_CF, D1_DOC, D1_FORNECE"
		Else
			cQuery += "ORDER BY D1_CF, D1_COD, D1_FORNECE"
		Endif

		cQuery := ChangeQuery(cQuery)
		dbUseArea( .T. ,"TOPCONN",TcGenQry(,,cQuery),cAliasSD1, .T. , .T. )

		For nX := 1 To len(aStruSD1)
			If aStruSD1[nX][2] <> "C" .And.  FieldPos(aStruSD1[nX][1])<>0
				TcSetField(cAliasSD1,aStruSD1[nX][1],aStruSD1[nX][2],aStruSD1[nX][3],aStruSD1[nX][4])
			EndIf
		next

		For nX := 1 To len(aStruSB1)
			If aStruSB1[nX][2] <> "C" .And.  FieldPos(aStruSB1[nX][1])<>0
				TcSetField(cAliasSB1,aStruSB1[nX][1],aStruSB1[nX][2],aStruSB1[nX][3],aStruSB1[nX][4])
			EndIf
		next

		For nX := 1 To len(aStruSF4)
			If aStruSF4[nX][2] <> "C" .And.  FieldPos(aStruSF4[nX][1])<>0
				TcSetField(cAliasSF4,aStruSF4[nX][1],aStruSF4[nX][2],aStruSF4[nX][3],aStruSF4[nX][4])
			EndIf
		next

		For nX := 1 To len(aStruSF1)
			If aStruSF1[nX][2] <> "C" .And.  FieldPos(aStruSF1[nX][1])<>0
				TcSetField(cAliasSF1,aStruSF1[nX][1],aStruSF1[nX][2],aStruSF1[nX][3],aStruSF1[nX][4])
			EndIf
		next

		dbSelectArea(cAliasSD1)
		nPsVlPisEn := ( cAliasSD1 )->( FieldPos( cCpVlPisEn ) )
		nPsBsPisEn := ( cAliasSD1 )->( FieldPos( cCpBsPisEn ) )
		nPsAlPisEn := ( cAliasSD1 )->( FieldPos( cCpAlPisEn ) )
		nPsVlCofEn := ( cAliasSD1 )->( FieldPos( cCpVlCofEn ) )
		nPsBsCofEn := ( cAliasSD1 )->( FieldPos( cCpBsCofEn ) )
		nPsAlCofEn := ( cAliasSD1 )->( FieldPos( cCpAlCofEn ) )
















	While (cAliasSD1)->(!Eof())
		nPautaPIS := 0
		nPautaCOF := 0

		If !lQuery
			SF4->(dbSetOrder(1))
			SF4->(MsSeek(xFilial("SF4")+(cAliasSD1)->D1_TES))
			SB1->(dbSetOrder(1))
			SB1->(MsSeek(xFilial("SB1")+(cAliasSD1)->D1_COD))
			SF1->(dbSetOrder(1))
			SF1->(MsSeek(xFilial("SF1")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_TIPO))
			cB1_GRTRIB := SB1->B1_GRTRIB
		Else
			cB1_GRTRIB := (cAliasSB1)->B1_GRTRIB

			If !((Empty (MV_PAR05)) .Or.  ("*"$MV_PAR05))
				If !(SF4->F4_NRLIVRO==MV_PAR05)
					lValido := .F. 
				EndIf
			EndIf
		EndIf

		SA1->(dbSetOrder(1))
		SA2->(dbSetOrder(1))
		If (cAliasSD1)->D1_TIPO$"DB"
			SA1->(MsSeek(xFilial("SA1")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
			cCliFor 	:= SA1->A1_NOME
		Else
			SA2->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA))
			cCliFor 	:= SA2->A2_NOME
		Endif
		If (cAliasSF4)->F4_AGREG <> "N"
			If SB1->(FieldPos("B1_PPIS")) >0
				nTxPIS	:= 	Iif((cAliasSB1)->B1_PPIS <> 0,(cAliasSB1)->B1_PPIS , GetMv("MV_TXPIS"))
			Endif
			If SB1->(FieldPos("B1_REDPIS")) > 0
				nRedPIS	:= 	Iif((cAliasSB1)->B1_REDPIS > 0,1-((cAliasSB1)->B1_REDPIS / 100 ), 1 )
			Endif
			If SB1->(FieldPos("B1_VLR_PIS")) > 0
				nPautaPIS	:= 	Iif((cAliasSD1)->D1_TIPO$"C",0,(cAliasSB1)->B1_VLR_PIS)
			Endif
			If SF4->(FieldPos("F4_BASEPIS")) > 0
				nRedPIS	*= 	Iif((cAliasSF4)->F4_BASEPIS > 0,1-((cAliasSF4)->F4_BASEPIS / 100 ), 1 )
			Endif
			If SB1->(FieldPos("B1_REDCOF")) > 0
				nRedCOF	:= 	Iif((cAliasSB1)->B1_REDCOF > 0,1-((cAliasSB1)->B1_REDCOF / 100 ), 1 )
			Endif
			If SF4->(FieldPos("F4_BASECOF")) > 0
				nRedCOF	*= 	Iif((cAliasSF4)->F4_BASECOF > 0,1-((cAliasSF4)->F4_BASECOF / 100 ), 1 )
			EndIf
			If SB1->(FieldPos("B1_PCOFINS")) > 0
				nTxCOF	:=	if((cAliasSB1)->B1_PCOFINS <> 0,(cAliasSB1)->B1_PCOFINS , GetMv("MV_TXCOFIN"))
			Endif
			If SB1->(FieldPos("B1_VLR_COF")) > 0
				nPautaCOF	:= 	Iif((cAliasSD1)->D1_TIPO$"C",0,(cAliasSB1)->B1_VLR_COF)
			Endif
			If SF4->(FieldPos("F4_PISCOF")) >0
				If !lApurac .Or.  ((cAliasSF4)->F4_PISFISC<>"2")
					If (cAliasSF4)->F4_PISCOF $ "13"
						If SF4->(FieldPos("F4_PISCRED")) >0
							nValPisPas := 0
							nBasPisPas := 0


							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlPisEn ) .And.  !Empty( nPsBsPisEn ) .And.  !Empty( nPsAlPisEn )
								nValPisPas	:= ( cAliasSD1 )->( FieldGet( nPsVlPisEn ) )
								nBasPisPas	:= ( cAliasSD1 )->( FieldGet( nPsBsPisEn ) )
								nTxPIS		:= ( cAliasSD1 )->( FieldGet( nPsAlPisEn ) )
							EndIf
							If mv_par01 <> 2 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
								RecLock("TRB", .T. )
								TRB->NUMNF     := (cAliasSD1)->D1_DOC
								TRB->SERIE     := (cAliasSD1)->D1_SERIE
								TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
								TRB->CFOP      := (cAliasSD1)->D1_CF
								TRB->PRODUTO   := (cAliasSD1)->D1_COD
								TRB->NCM       := (cAliasSB1)->B1_POSIPI
								TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
								TRB->ZFRANCA   := 0
								TRB->ALIQ      := Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
								TRB->TIPO      := "PIS"
								TRB->ES        := "E"
								TRB->CLIFOR	   := cCliFor
								TRB->PAUTA		:= Iif(nPautaPIS <> 0,"S","N")
								MsUnlock()

								If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCENT   := nValPisPas
										TRB->BASPICENT := nBasPisPas
									ElseIf (cAliasSF4)->F4_PISCRED =="2"
										TRB->PISDENT   := nValPisPas
										TRB->BASPIDENT := nBasPisPas
	                        Endif
									MsUnlock()
								Else
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPICENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedPis
									ElseIf (cAliasSF4)->F4_PISCRED =="2"
										TRB->PISDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPIDENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedPis
	                        Endif
									MsUnlock()
								EndIf


								If SF4->(FieldPos("F4_AGRPIS")) > 0
									If (cAliasSF4)->F4_AGRPIS = "1"
									    RecLock("TRB", .F. )
										If (cAliasSF4)->F4_PISCRED == "1"
									    	TRB->VALORCONT += TRB->PISCENT
									 	Else
									 		TRB->VALORCONT += TRB->PISDENT
									 	Endif
								    	MsUnlock()
									Endif
								Endif
							Endif
							If mv_par01 <> 2 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
								RecLock("TRB", .T. )
								TRB->NUMNF     := (cAliasSD1)->D1_DOC
								TRB->SERIE     := (cAliasSD1)->D1_SERIE
								TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
								TRB->CFOP      := (cAliasSD1)->D1_CF
								TRB->PRODUTO   := (cAliasSD1)->D1_COD
								TRB->NCM       := (cAliasSB1)->B1_POSIPI
								TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
								TRB->ZFRANCA   := 0
								TRB->ALIQ      := Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
								TRB->TIPO      := "PIS"
								TRB->ES        := "E"
								TRB->CLIFOR	   := cCliFor
								TRB->PAUTA	   := Iif(nPautaPIS <> 0,"S","N")
								MsUnlock()

								If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCENT   := nValPisPas
										TRB->BASPICENT := nBasPisPas
									ElseIf (cAliasSF4)->F4_PISCRED =="2"
										TRB->PISDENT   := nValPisPas
										TRB->BASPIDENT := nBasPisPas
	                        Endif
									MsUnlock()
								Else
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPICENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedPis
									ElseIf (cAliasSF4)->F4_PISCRED =="2"
										TRB->PISDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPIDENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedPis
	                        Endif
									MsUnlock()
								EndIf


								If SF4->(FieldPos("F4_AGRPIS")) > 0
									If (cAliasSF4)->F4_AGRPIS = "1"
										RecLock("TRB", .F. )
										If (cAliasSF4)->F4_PISCRED == "1"
									    	TRB->VALORCONT += TRB->PISCENT
									 	Else
									 		TRB->VALORCONT += TRB->PISDENT
									 	Endif
								    	MsUnlock()
									Endif
								Endif
							Endif
							If mv_par01 <> 2 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
								RecLock("TRB", .T. )
								TRB->NUMNF     := (cAliasSD1)->D1_DOC
								TRB->SERIE     := (cAliasSD1)->D1_SERIE
								TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
								TRB->CFOP      := (cAliasSD1)->D1_CF
								TRB->PRODUTO   := (cAliasSD1)->D1_COD
								TRB->NCM       := (cAliasSB1)->B1_POSIPI
								TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
								TRB->ZFRANCA   := 0
								TRB->ALIQ      := Iif(nExPis == 0,Iif(nPautaPIS <> 0,nPautaPIS,nTxPIS),nExPis)
								TRB->TIPO      := "PIS"
								TRB->ES        := "E"
								TRB->CLIFOR	   := cCliFor
								TRB->PAUTA	   := Iif(nPautaPIS <> 0,"S","N")
								MsUnlock()

								If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCENT   := nValPisPas
										TRB->BASPICENT := nBasPisPas
									ElseIf (cAliasSF4)->F4_PISCRED =="2"
										TRB->PISDENT   := nValPisPas
										TRB->BASPIDENT := nBasPisPas
	                        Endif
									MsUnlock()
								Else
									RecLock("TRB", .F. )
									If (cAliasSF4)->F4_PISCRED =="1"
										TRB->PISCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPICENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedPis
									ElseIf (cAliasSF4)->F4_PISCRED =="2"
										TRB->PISDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC) * nRedPis) * (TRB->ALIQ/100)
										TRB->BASPIDENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedPis
	                        Endif
									MsUnlock()
								EndIf


								If SF4->(FieldPos("F4_AGRPIS")) > 0
									If (cAliasSF4)->F4_AGRPIS = "1"
									    RecLock("TRB", .F. )
										If (cAliasSF4)->F4_PISCRED == "1"
									    	TRB->VALORCONT += TRB->PISCENT
									 	Else
									 		TRB->VALORCONT += TRB->PISDENT
									 	Endif
								    	MsUnlock()
									Endif
								Endif
							Endif
						EndIf
					Endif
					If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 3 .And.  !(cAliasSF4)->F4_TPREG$"123"
						If SF4->(FieldPos("F4_PISCRED")) >0
							nValCofins := 0
							nBasCofins := 0




							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlCofEn ) .And.  !Empty( nPsBsCofEn ) .And.  !Empty( nPsAlCofEn )
								nValCofins := ( cAliasSD1 )->( FieldGet( nPsVlCofEn ) )
								nBasCofins := ( cAliasSD1 )->( FieldGet( nPsBsCofEn ) )
								nTxCOF := ( cAliasSD1 )->( FieldGet( nPsAlCofEn ) )

								If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
								    If (cAliasSF4)->F4_MALQCOF > 0
								    	nTxCOF := nTxCOF - (cAliasSF4)->F4_MALQCOF
								    EndIf
								    If (cAliasSD1)->D1_VALCMAJ > 0
								    	nValCofins := nValCofins - (cAliasSD1)->D1_VALCMAJ
								    EndIf
							    EndIf
							EndIf
							RecLock("TRB", .T. )
							TRB->NUMNF     := (cAliasSD1)->D1_DOC
							TRB->SERIE     := (cAliasSD1)->D1_SERIE
							TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
							TRB->CFOP      := (cAliasSD1)->D1_CF
							TRB->PRODUTO   := (cAliasSD1)->D1_COD
							TRB->NCM       := (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
							TRB->ZFRANCA   := 0
							TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
							TRB->TIPO      := "COF"
							TRB->ES        := "E"
							TRB->CLIFOR	   := cCliFor
							TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
							MsUnlock()

							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCENT   := nValCofins
									TRB->BASCOCENT := nBasCofins
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->COFDENT   := nValCofins
									TRB->BASCODENT := nBasCofins
	                    Endif
	                    MsUnlock()
							Else
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCOCENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
								ElseIf	(cAliasSF4)->F4_PISCRED =="2"
									TRB->COFDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCODENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
								Endif
								MsUnlock()
							Endif


							If SF4->(FieldPos("F4_AGRCOF")) > 0
								If (cAliasSF4)->F4_AGRCOF = "1"
								    RecLock("TRB", .F. )
								    If (cAliasSF4)->F4_PISCRED == "1"
								    	TRB->VALORCONT += TRB->COFCENT
								    Else
								    	TRB->VALORCONT += TRB->COFDENT
								    Endif
							    	MsUnlock()
								Endif
							Endif
						Endif
					Endif

					If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
						If SF4->(FieldPos("F4_PISCRED")) >0
							nValCofins := 0
							nBasCofins := 0


							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlCofEn ) .And.  !Empty( nPsBsCofEn ) .And.  !Empty( nPsAlCofEn )
								nValCofins := ( cAliasSD1 )->( FieldGet( nPsVlCofEn ) )
								nBasCofins := ( cAliasSD1 )->( FieldGet( nPsBsCofEn ) )
								nTxCOF := ( cAliasSD1 )->( FieldGet( nPsAlCofEn ) )

								If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
								    If (cAliasSF4)->F4_MALQCOF > 0
								    	nTxCOF := nTxCOF - (cAliasSF4)->F4_MALQCOF
								    EndIf
								    If (cAliasSD1)->D1_VALCMAJ > 0
								    	nValCofins := nValCofins - (cAliasSD1)->D1_VALCMAJ
								    EndIf
							    EndIf
							EndIf
							RecLock("TRB", .T. )
							TRB->NUMNF     := (cAliasSD1)->D1_DOC
							TRB->SERIE     := (cAliasSD1)->D1_SERIE
							TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
							TRB->CFOP      := (cAliasSD1)->D1_CF
							TRB->PRODUTO   := (cAliasSD1)->D1_COD
							TRB->NCM       := (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
							TRB->ZFRANCA   := 0
							TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
							TRB->TIPO      := "COF"
							TRB->ES        := "E"
							TRB->CLIFOR	   := cCliFor
							TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
							MsUnlock()

							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCENT   := nValCofins
									TRB->BASCOCENT := nBasCofins
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->COFDENT   := nValCofins
									TRB->BASCODENT := nBasCofins
	                     Endif
	                     MsUnlock()
							Else
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCOCENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
								ElseIf	(cAliasSF4)->F4_PISCRED =="2"
									TRB->COFDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCODENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
								Endif
								MsUnlock()
							Endif


							If SF4->(FieldPos("F4_AGRCOF")) > 0
								If (cAliasSF4)->F4_AGRCOF = "1"
								    RecLock("TRB", .F. )
								    If (cAliasSF4)->F4_PISCRED == "1"
								    	TRB->VALORCONT += TRB->COFCENT
								    Else
								    	TRB->VALORCONT += TRB->COFDENT
								    Endif
							    	MsUnlock()
								Endif
							Endif
						Endif
					Endif

					If (cAliasSF4)->F4_PISCOF $ "23" .And.  mv_par01 <> 1 .And.  mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
						If SF4->(FieldPos("F4_PISCRED")) >0
							nValCofins := 0
							nBasCofins := 0


							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte .And.  !Empty( nPsVlCofEn ) .And.  !Empty( nPsBsCofEn ) .And.  !Empty( nPsAlCofEn )
								nValCofins := ( cAliasSD1 )->( FieldGet( nPsVlCofEn ) )
								nBasCofins := ( cAliasSD1 )->( FieldGet( nPsBsCofEn ) )
								nTxCOF := ( cAliasSD1 )->( FieldGet( nPsAlCofEn ) )

								If SF4->(FieldPos("F4_MALQCOF") > 0) .And.  SD1->(FieldPos("D1_VALCMAJ") > 0)
								    If (cAliasSF4)->F4_MALQCOF > 0
								    	nTxCOF := nTxCOF - (cAliasSF4)->F4_MALQCOF
								    EndIf
								    If (cAliasSD1)->D1_VALCMAJ > 0
								    	nValCofins := nValCofins - (cAliasSD1)->D1_VALCMAJ
								    EndIf
							    EndIf
							EndIf
							RecLock("TRB", .T. )
							TRB->NUMNF     := (cAliasSD1)->D1_DOC
							TRB->SERIE     := (cAliasSD1)->D1_SERIE
							TRB->EMISSAO   := (cAliasSD1)->D1_DTDIGIT
							TRB->CFOP      := (cAliasSD1)->D1_CF
							TRB->PRODUTO   := (cAliasSD1)->D1_COD
							TRB->NCM       := (cAliasSB1)->B1_POSIPI
							TRB->VALORCONT := CompVlCont(cAliasSD1,(cAliasSF4)->F4_AGREG,(cAliasSF4)->F4_IPI)
							TRB->ZFRANCA   := 0
							TRB->ALIQ      := Iif(nExCof == 0,Iif(nPautaCOF <> 0,nPautaCOF,nTxCOF),nExCof)
							TRB->TIPO      := "COF"
							TRB->ES        := "E"
							TRB->CLIFOR	   := cCliFor
							TRB->PAUTA	   := Iif(nPautaCOF <> 0,"S","N")
							MsUnlock()

							If (cAliasSD1)->D1_DTDIGIT >= dDtCorte
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCENT   := nValCofins
									TRB->BASCOCENT := nBasCofins
								ElseIf (cAliasSF4)->F4_PISCRED =="2"
									TRB->COFDENT   := nValCofins
									TRB->BASCODENT := nBasCofins
	                     	Endif
			               MsUnlock()
							Else
								RecLock("TRB", .F. )
								If (cAliasSF4)->F4_PISCRED =="1"
									TRB->COFCENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCOCENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
								ElseIf	(cAliasSF4)->F4_PISCRED =="2"
									TRB->COFDENT   := ( ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC )  * nRedCOF) * (TRB->ALIQ/100)
									TRB->BASCODENT := ( (cAliasSD1)->D1_TOTAL+((cAliasSD1)->D1_TOTAL*((cAliasSF1)->F1_SEGURO+(cAliasSF1)->F1_DESPESA+(cAliasSF1)->F1_FRETE)/(cAliasSF1)->F1_VALMERC)-(cAliasSD1)->D1_VALDESC  ) * nRedCOF
								Endif
								MsUnlock()
							Endif


							If SF4->(FieldPos("F4_AGRCOF")) > 0
								If (cAliasSF4)->F4_AGRCOF = "1"
								    RecLock("TRB", .F. )
								    If (cAliasSF4)->F4_PISCRED == "1"
								    	 TRB->VALORCONT += TRB->COFCENT
								    Else
								    	 TRB->VALORCONT += TRB->COFDENT
								    Endif
							    	MsUnlock()
								Endif
							Endif
						Endif
					Endif

					If mv_par12 == 3 .And.  !((cAliasSF4)->F4_TPREG$"123") .And.  !(cAliasSF4)->F4_TPREG$"123"
						If (cAliasSF4)->F4_PISCOF $ "123"
							If !(cAliasSD1)->D1_TIPO $ "BD"
								If (cAliasSF4)->F4_PISCOF == "1"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
								If (cAliasSF4)->F4_PISCOF == "2"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
								If (cAliasSF4)->F4_PISCOF == "3"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							EndIf
							If (cAliasSD1)->D1_TIPO == "D"
								If (cAliasSF4)->F4_PISCOF == "1"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
								If (cAliasSF4)->F4_PISCOF == "2"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
								If (cAliasSF4)->F4_PISCOF == "3"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6" .And.  cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							EndIF
						ELSE
							If !(cAliasSD1)->D1_TIPO $ "BD"
								nValComp += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC
							EndIF
							If (cAliasSD1)->D1_TIPO == "D"
								nValDevVend += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC
							EndIF
						EndIf
					EndIf
					If mv_par12 == 1 .And.  (cAliasSF4)->F4_TPREG$"123"
						If (cAliasSF4)->F4_PISCOF $ "123"
							If !(cAliasSD1)->D1_TIPO $ "BD"
							 	If (cAliasSF4)->F4_PISCOF == "1"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "2"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "3"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6" .And.  cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							EndIf
							If (cAliasSD1)->D1_TIPO == "D"
							 	If (cAliasSF4)->F4_PISCOF == "1"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "2"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "3"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6" .And.  cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							EndIF
						ELSE
							If !(cAliasSD1)->D1_TIPO $ "BD"
								nValComp += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC
							EndIF
							If (cAliasSD1)->D1_TIPO == "D"
								nValDevVend += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC
							EndIF
						EndIf
					EndIf

					If mv_par12 == 2 .And.  (cAliasSF4)->F4_TPREG$"1"
						If (cAliasSF4)->F4_PISCOF $ "123"
							If !(cAliasSD1)->D1_TIPO $ "BD"
							 	If (cAliasSF4)->F4_PISCOF == "1"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "2"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "3"
							 		nCompTrib += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6" .And.  cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							EndIf
							If (cAliasSD1)->D1_TIPO == "D"
							 	If (cAliasSF4)->F4_PISCOF == "1"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "2"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							 	If (cAliasSF4)->F4_PISCOF == "3"
									nDevVendT += ((cAliasSD1)->D1_TOTAL+IIf(cDebSTPIS=="6" .And.  cDebSTCOF=="6",0,(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC)
								EndIf
							EndIF
						ELSE
							If !(cAliasSD1)->D1_TIPO $ "BD"
								nValComp += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC
							EndIF
							If (cAliasSD1)->D1_TIPO == "D"
								nValDevVend += ((cAliasSD1)->D1_TOTAL+(cAliasSD1)->D1_ICMSRET+If((cAliasSF4)->F4_IPI=="R",0,If((cAliasSD1)->D1_TIPO=="P",0,(cAliasSD1)->D1_VALIPI))+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA)-(cAliasSD1)->D1_VALDESC
							EndIF
						EndIf
					EndIf
				EndIf
			EndIf
		EndIf
		(cAliasSD1)->( dbSkip())
		IncRegua()
	EndDo

	If lQuery
		dbSelectArea(cAliasSD1)
		dbCloseArea()
		dbSelectArea("SD1")
	Else
		dbSelectArea("SD1")
		RetIndex("SD1")
		dbClearFilter()
		Ferase(cIndex1+OrdBagExt())
	EndIf

	aDedRet := {}
	aDedRet := FsCalcRet(mv_par02,mv_par03,,,2,,@aRet,, .T. ,cFilAnt,,lOrgPub)

	dbSelectArea("TRB")
	SetRegua(RecCount())
	dbGoTop()

	If (aReturn[8]>=2)
		R906Imp (cArqTemp,@aTAlPISS,@aTAlCOFS,@aTAlPISE,@aTAlCOFE,@aTotApur, aReturn[8])
		lResumo	:= .T. 
	Else
		While !Eof() .And.  lContinua
			IF lEnd
				PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
				lContinua := .F. 
				Exit
			Endif
			IncRegua()

			cTitulo  := If( cPaisLoc $ "ANG|PTG", "Relatório - (pis/cofins)", "Relatorio - (PIS/COFINS)" )
			If mv_par04 == 1
				Cabec1 := If( cPaisLoc $ "ANG|PTG", " produto          ncm         valor contabil            zona franca      taxa              valor da contribuição                            base da contribuição              documento serie emissão  cliente/forn.  ", " Produto          NCM         Valor Contabil            Zona Franca      Aliquota              Valor da Contribuicao                            Base da Contribuicao              Documento Serie Emissao  Cliente/Forn.  " )
			Else
				Cabec1 := "                Valor Contabil         Zona Franca                      Aliquota               Valor da Contribuicao    Base da Contribuicao Base da Contribuicao"
			Endif
			Cabec2 := "                                                           Desconto                                                Debito                   Credito              Debito                 "
			nLiAnt	:=	li
			If li > 58
				cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
			EndIf
			nValCont	:= 0
			nZFranca	:= 0
			nValDebi	:= 0
			nValCred	:= 0
			nBasDebi	:= 0
			nBasCred	:= 0
			nDValCont	:= 0
			nDZFranca	:= 0
			nDValDebi	:= 0
			nDValCred	:= 0
			nDBasDebi	:= 0
			nDBasCred	:= 0
			nAcVlrCtb	:= 0
			nAcZfranca	:= 0
			nAcVlrCtbD	:= 0
			nAcVlrCtbC	:= 0
			nAcBsCtbD	:= 0
			nAcBsCtbC	:= 0

			IF MV_PAR09==1
				dDT_EMISS	:=	TRB->EMISSAO
			ENDIF

			lEntrada := IIf(Substr(TRB->CFOP,1,1) < "5", .T. , .F. )

			If !lFirst
				PrintOut(Li,001,OemToAnsi("Empresa : ")+SM0->M0_NOMECOM,,)
				Li++
				PrintOut(Li,001,OemToAnsi(If(cPaisLoc$"ANG|PTG","Cnpj    : ","CNPJ    : "))+Transform(SM0->M0_CGC,"@R 99.999.999/9999-99"),,)
				Li++
				PrintOut(Li,001,OemToAnsi(If(cPaisLoc$"ANG|PTG","Período : ","Periodo : "))+Dtoc(mv_par02)+" - "+Dtoc(mv_par03),,)
				Li := Li + 2
				lFirst := .T. 
			Endif

			If TRB->TIPO <> cTipo .Or.  lQuebra
				If lQuebra .And.  TRB->TIPO <> cTipo .And.  !nLiAnt>58
					cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
				Endif

				PrintOut(Li,001,IIf(TRB->TIPO=="PIS",PADC(If(cPaisLoc$"ANG|PTG","Pis - Programa De Integração Social","PIS - Programa de Integracao Social")+IIf(Substr(TRB->CFOP,1,1)<"5",If(cPaisLoc$"ANG|PTG"," - Entradas"," - ENTRADAS"),If(cPaisLoc$"ANG|PTG"," - Saídas"," - SAIDAS")),Limite),PADC(If(cPaisLoc$"ANG|PTG","Cofins - Contribuição Para O Financiamento Da Seguridade Social","COFINS - Contribuicao para o Financiamento da Seguridade Social")+IIf(Substr(TRB->CFOP,1,1)<"5",If(cPaisLoc$"ANG|PTG"," - Entradas"," - ENTRADAS"),If(cPaisLoc$"ANG|PTG"," - Saídas"," - SAIDAS")),Limite)),,)
				Li := Li + 2
				cTipo := TRB->TIPO
				lQuebra  := .F. 

				PrintOut(Li,001,TRB->CFOP+IIF(SX5->(MsSeek(xFilial("SX5")+"13"+TRB->CFOP))," - "+AllTrim(SX5->X5_DESCRI),""),,)
				Li++
			Else
				If TRB->TIPO == cTipo .And.  TRB->CFOP <> cCodCfop
					PrintOut(Li,001,TRB->CFOP+IIF(SX5->(MsSeek(xFilial("SX5")+"13"+TRB->CFOP))," - "+AllTrim(SX5->X5_DESCRI),""),,)
					Li++
				EndIf
			Endif

			If mv_par14 == 1
				cQuebra	:=	TRB->TIPO+TRB->CFOP+TRB->CLIFOR
			Elseif mv_par14 == 2
				cQuebra	:=	TRB->TIPO+TRB->CFOP
			Endif

			If mv_par14 == 1
				cChave	:=	TRB->TIPO+TRB->CFOP+TRB->CLIFOR
			Elseif mv_par14 == 2
				cChave	:=		TRB->TIPO+TRB->CFOP
			Endif

			While !Eof() .And.  cChave == cQuebra
				If li > 58
					cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
				EndIf
				cCodCfop := TRB->CFOP
				If mv_par04 == 1 .and.  mv_par11 <> 1
					PrintOut(Li,001,TRB->PRODUTO,,)
					PrintOut(Li,018,TRB->NCM,,)
					PrintOut(Li,030,TRB->VALORCONT,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,050,TRB->ZFRANCA,PesqPict("SD2","D2_DESCZFR",14),)
					PrintOut(Li,070,Transform(TRB->ALIQ,Iif(TRB->PAUTA=="S",PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]),PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]))),,)
					If Substr(TRB->CFOP,1,1) >= "5"
						PrintOut(Li,083,IIF(TRB->TIPO=="PIS",TRB->PISDSAI,TRB->COFDSAI),PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,107,IIF(TRB->TIPO=="PIS",TRB->PISCSAI,TRB->COFCSAI),PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,131,IIF(TRB->TIPO=="PIS",TRB->BASPIDSAI,TRB->BASCODSAI),PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,155,IIF(TRB->TIPO=="PIS",TRB->BASPICSAI,TRB->BASCOCSAI),PesqPict("SD2","D2_TOTAL",14),)
					Else
						PrintOut(Li,083,IIF(TRB->TIPO=="PIS",TRB->PISDENT,TRB->COFDENT),PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,107,IIF(TRB->TIPO=="PIS",TRB->PISCENT,TRB->COFCENT),PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,131,IIF(TRB->TIPO=="PIS",TRB->BASPIDENT,TRB->BASCODENT),PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,155,IIF(TRB->TIPO=="PIS",TRB->BASPICENT,TRB->BASCOCENT),PesqPict("SD2","D2_TOTAL",14),)
					Endif
					PrintOut(Li,178,TRB->NUMNF,,)
					PrintOut(Li,189,TRB->SERIE,,)
					PrintOut(Li,194,TRB->EMISSAO,,)
					PrintOut(Li,203,TRB->CLIFOR,,)
		      Endif
	         If mv_par11 == 1
					If mv_par04 == 1
						nAcVlrCtb += TRB->VALORCONT
						nAcZfranca += TRB->ZFRANCA
						If Substr(TRB->CFOP,1,1) >= "5"
							nAcVlrCtbD += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
							nAcVlrCtbC += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
							nAcBsCtbD += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
							nAcBsCtbC += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)
						Else
							nAcVlrCtbD += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
							nAcVlrCtbC += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
							nAcBsCtbD += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
							nAcBsCtbC += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)
						Endif
						cNumNota :=  TRB->NUMNF
						cSerie   :=  TRB->SERIE
						cEmissao :=  TRB->EMISSAO
						cNcm     :=  TRB->NCM
						cProd    :=  TRB->PRODUTO
						cCliFor  :=  TRB->CLIFOR
			      Endif
		      EndIf
				nValCont  += TRB->VALORCONT
				nZFranca  += TRB->ZFRANCA
				nDValCont += TRB->VALORCONT
				nDZFranca += TRB->ZFRANCA
				nGValCont += TRB->VALORCONT
				nGZFranca += TRB->ZFRANCA

				If Substr(TRB->CFOP,1,1) >= "5"
					nValDebi += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
					nValCred += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
					nBasDebi += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
					nBasCred += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)

					nDValDebi += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
					nDValCred += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
					nDBasDebi += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
					nDBasCred += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)

					nGValDebi += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
					nGValCred += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
					nGBasDebi += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
					nGBasCred += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)

					nAliqP   := Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq := Ascan(aAliqs,{|x| x[1]==nAliqP})
					If nPosAliq > 0
						aAliqs[nPosAliq][2]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
						aAliqs[nPosAliq][3]  += TRB->VALORCONT
						aAliqs[nPosAliq][4]  += TRB->ZFRANCA
						aAliqs[nPosAliq][5]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
						aAliqs[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
						aAliqs[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
						aAliqs[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)
						If TRB->TIPO == "PIS"
							nAliqP					:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
							nPosAliq					:= Ascan(aTAlPISS,{|x| x[1]==nAliqP .AND.  X[3]==SM0->M0_CODFIL})
							aTAlPISS[nPosAliq][2]+= TRB->PISDSAI-TRB->PISCSAI
						Else
							nAliqP					:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
							nPosAliq					:= Ascan(aTAlCOFS,{|x| x[1]==nAliqP .AND.  X[3]==SM0->M0_CODFIL})
							aTAlCOFS[nPosAliq][2]+= TRB->COFDSAI-TRB->COFCSAI
						Endif
					Else








						AADD(aAliqs,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ), IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI), TRB->VALORCONT, TRB->ZFRANCA, IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI), IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI), IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI), IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI), TRB->PAUTA})
						If TRB->TIPO == "PIS"
							AADD(aTAlPISS,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->PISDSAI-TRB->PISCSAI,SM0->M0_CODFIL})
						Else
							AADD(aTAlCOFS,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->COFDSAI-TRB->COFCSAI,SM0->M0_CODFIL})
						Endif
					Endif

					nAliqP	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq := Ascan(aAliqCFGer,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
					If nPosAliq > 0
						aAliqCFGer[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
						aAliqCFGer[nPosAliq][4]  += TRB->VALORCONT
						aAliqCFGer[nPosAliq][5]  += TRB->ZFRANCA
						aAliqCFGer[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
						aAliqCFGer[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
						aAliqCFGer[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
						aAliqCFGer[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)
					Else
						AADD(aAliqCFGer,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->CFOP,IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI),TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI),IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI),IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI),IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)})
					Endif

					nAliqP 	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq := aScan(aResAliCF,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
					If nPosAliq == 0









						AADD(aResAliCF,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ), TRB->CFOP, IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI), TRB->VALORCONT, TRB->ZFRANCA, IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI), IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI), IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI), IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI), TRB->PAUTA})
					Else
						aResAliCF[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
						aResAliCF[nPosAliq][4]  += TRB->VALORCONT
						aResAliCF[nPosAliq][5]  += TRB->ZFRANCA
						aResAliCF[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
						aResAliCF[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
						aResAliCF[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
						aResAliCF[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)
					Endif
				Else
					nValDebi += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
					nValCred += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
					nBasDebi += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
					nBasCred += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)

					nDValDebi += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
					nDValCred += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
					nDBasDebi += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
					nDBasCred += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)

					nGValDebi += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
					nGValCred += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
					nGBasDebi += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
					nGBasCred += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)

					nAliqP 	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq := Ascan(aAliqs,{|x| x[1]==nAliqP})
					If nPosAliq > 0
						aAliqs[nPosAliq][2]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
						aAliqs[nPosAliq][3]  += TRB->VALORCONT
						aAliqs[nPosAliq][4]  += TRB->ZFRANCA
						aAliqs[nPosAliq][5]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
						aAliqs[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
						aAliqs[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
						aAliqs[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)
						If TRB->TIPO == "PIS"
	  					   nAliqP					:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
	  					   nPosAliq					:= Ascan(aTAlPISE,{|x| x[1]==nAliqP .AND.  X[3]==SM0->M0_CODFIL})
							aTAlPISE[nPosAliq][2]+= TRB->PISDENT-TRB->PISCENT
						Else
							nAliqP					:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
							nPosAliq					:= Ascan(aTAlCOFE,{|x| x[1]==nAliqP .AND.  X[3]==SM0->M0_CODFIL})
							aTAlCOFE[nPosAliq][2]+= TRB->COFDENT-TRB->COFCENT
						Endif
					Else








						AADD(aAliqs,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ), IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT), TRB->VALORCONT, TRB->ZFRANCA, IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT), IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT), IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT), IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT), TRB->PAUTA})
						If TRB->TIPO == "PIS"
							AADD(aTAlPISE,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->PISDENT-TRB->PISCENT,SM0->M0_CODFIL})
						Else
							AADD(aTAlCOFE,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->COFDENT-TRB->COFCENT,SM0->M0_CODFIL})
						Endif
					Endif

					nAliqP	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq := Ascan(aAliqCFGer,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
					If nPosAliq > 0
						aAliqCFGer[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
						aAliqCFGer[nPosAliq][4]  += (TRB->VALORCONT * IIF(TRB->ES=="E",-1,1))
						aAliqCFGer[nPosAliq][5]  += TRB->ZFRANCA
						aAliqCFGer[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
		 				aAliqCFGer[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
	   				aAliqCFGer[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
	   				aAliqCFGer[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)
					Else
						AADD(aAliqCFGer,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->CFOP,IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT),(TRB->VALORCONT * IIF(TRB->ES=="E",-1,1)),TRB->ZFRANCA,IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT),IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT),IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT),IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)})
					Endif

					nAliqP 	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq := aScan(aResAliCF,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
					If nPosAliq == 0









						AADD(aResAliCF,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ), TRB->CFOP, IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT), TRB->VALORCONT, TRB->ZFRANCA, IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT), IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT), IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT), IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT), TRB->PAUTA})
					Else
						aResAliCF[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
						aResAliCF[nPosAliq][4]  += TRB->VALORCONT
						aResAliCF[nPosAliq][5]  += TRB->ZFRANCA
						aResAliCF[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
						aResAliCF[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
						aResAliCF[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
						aResAliCF[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)
					Endif
				Endif
				cNumNota	:= TRB->NUMNF

				Asort(aResAliCF,,,{|x,y|Str(x[1])+x[2] < Str(y[1])+y[2]})
				If mv_par04 == 1 .And.  mv_par11 <> 1
					Li++
				Endif
				TRB->(dbSkip())
				If cNumNota <> TRB->NUMNF .OR.  cChave <> cQuebra
					If mv_par11 == 1 .And.  mv_par04 == 1
						PrintOut(Li,030,nAcVlrCtb,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,050,nAcZfranca,PesqPict("SD2","D2_DESCZFR",14),)

						PrintOut(Li,083,nAcVlrCtbD,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,107,nAcVlrCtbC,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,131,nAcBsCtbD,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,155,nAcBsCtbC,PesqPict("SD2","D2_TOTAL",14),)

						PrintOut(Li,178,cNumNota,,)
						PrintOut(Li,191,cSerie,,)
						PrintOut(Li,196,cEmissao,,)
						PrintOut(Li,205,cCliFor,,)
	   					Li++
	   					nAcVlrCtb 	:= 0
						nAcZfranca	:= 0
						nAcVlrCtbD	:= 0
						nAcVlrCtbC	:= 0
						nAcBsCtbD	:= 0
						nAcBsCtbC	:= 0
					EndIf
				EndIf

				IF MV_PAR09 ==1
					If  TRB->EMISSAO <> dDT_EMISS .OR.  cChave <> cQuebra
						PrintOut(Li,001,__PrtThinLine(),,)
						Li++
						PrintOut(Li,001,"Total do dia - ",,)
						TRB->(dbSkip(-1))
						PrintOut(Li,016,TRB->EMISSAO,,)
						PrintOut(Li,030,nDValCont,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,050,nDZFranca,PesqPict("SD2","D2_DESCZFR",14),)
						PrintOut(Li,083,nDValDebi,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,107,nDValCred,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,131,nDBasDebi,PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,155,nDBasCred,PesqPict("SD2","D2_TOTAL",14),)
						Li    	  := Li + 2
						nDValCont := 0
						nDZFranca := 0
						nDValDebi := 0
						nDValCred := 0
						nDBasDebi := 0
						nDBasCred := 0
						TRB->(dbSkip())
						dDT_EMISS := TRB->EMISSAO
					EndIf
				ENDIF

				If  cChave <> cQuebra
					PrintOut(Li,001,__PrtThinLine(),,)
					Li++
					PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total do cfop - ","Total do CFOP - ")+Substr(cQuebra,4,4),,)
					PrintOut(Li,030,nValCont,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,050,nZFranca,PesqPict("SD2","D2_DESCZFR",14),)
					PrintOut(Li,083,nValDebi,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,107,nValCred,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,131,nBasDebi,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,155,nBasCred,PesqPict("SD2","D2_TOTAL",14),)
					Li := Li + 2
					TRB->(dbSkip(-1))
					SX5->(DBSETORDER(1))
					IF SX5->(dbseek(xFILIAL("SX5")+"13"+TRB->CFOP))
						cDesc_CFOP	:=	SX5->X5_DESCRI
					ENDIF
					IF TRB->TIPO=="COF"
						IF TRB->ES=="E"
							AADD(aCFOPCOFE,{TRB->CFOP,nValDebi-nValCred,SM0->M0_CODFIL,nBasDebi-nBasCred,cDesc_CFOP})
						ELSE
					    	AADD(aCFOPCOFS,{TRB->CFOP,nValDebi-nValCred,SM0->M0_CODFIL,nBasDebi-nBasCred,cDesc_CFOP})
						ENDIF
					ELSE
						IF TRB->ES="E"
							AADD(aCFOPPISE,{TRB->CFOP,nValDebi-nValCred,SM0->M0_CODFIL,nBasDebi-nBasCred,cDesc_CFOP})
						ELSE
							AADD(aCFOPPISS,{TRB->CFOP,nValDebi-nValCred,SM0->M0_CODFIL,nBasDebi-nBasCred,cDesc_CFOP})
						ENDIF
					ENDIF
					TRB->(dbSkip())
				Endif

				If ( (Substr(TRB->CFOP,1,1) >= "5" .And.  lEntrada) .Or.  TRB->(Eof()) ) .Or.  (!lEntrada .And.  TRB->(Eof())) .Or.  TRB->TIPO <> cTipo
					PrintOut(Li,001,__PrtThinLine(),,)
					Li++
					aSort(aALiqs,,,{|x,y| x[1]>y[1]})
					For nX := 1 To Len(aAliqs)
						aContrAliq	:=	{aALiqs[nX][3], aALiqs[nX][4], aALiqs[nX][5], aALiqs[nX][6], aALiqs[nX][7], aALiqs[nX][8]}
						If Li > 58
							Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
						EndIf

						If mv_par10 == 1
							nPosAliq := aScan(aResAliCF,{|x| x[1]==aAliqs[nX][1]})
							If nPosAliq > 0
								For nPos := nPosAliq to Len(aResAliCF)
									If aResAliCF[nPos][01] <> aAliqs[nX][1]
										Exit
									Endif

									If nPos == nPosAliq
										PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total Por Código Fiscal:","Total por CFOP:"),,)
									Endif
									If Li > 58
										Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
									EndIf
									PrintOut(Li,021,aResAliCF[nPos][2],,)
									PrintOut(Li,030,aResAliCF[nPos][4],PesqPict("SD2","D2_TOTAL",14),)
									PrintOut(Li,050,aResAliCF[nPos][5],PesqPict("SD2","D2_DESCZFR",14),)
									PrintOut(Li,083,aResAliCF[nPos][6],PesqPict("SD2","D2_TOTAL",14),)
									PrintOut(Li,107,aResAliCF[nPos][7],PesqPict("SD2","D2_TOTAL",14),)
									PrintOut(Li,131,aResAliCF[nPos][8],PesqPict("SD2","D2_TOTAL",14),)
									PrintOut(Li,155,aResAliCF[nPos][9],PesqPict("SD2","D2_TOTAL",14),)
									Li++
								Next
							Endif
						Endif

						If aAliqs[nX][9]=="S"
							aContrAliq	:=	{0,0,0,0,0,0}
							For nXX := nX To Len(aALiqs)
								If aAliqs[nXX][9]=="S" .And.  aAliqs[nX][1]==0
									nX				 := nXX
									aContrAliq[1]+= aALiqs[nXX][3]
									aContrAliq[2]+= aALiqs[nXX][4]
									aContrAliq[3]+= aALiqs[nXX][5]
									aContrAliq[4]+= aALiqs[nXX][6]
									aContrAliq[5]+= aALiqs[nXX][7]
									aContrAliq[6]+= aALiqs[nXX][8]
								Else
									Exit
								EndIf
							next
						EndIf

						PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total da taxa ","Total da Aliquota ")+Transform(aAliqs[nX][1],"@E 99.99%"),,)
						PrintOut(Li,030,aContrAliq[1],PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,050,aContrAliq[2],PesqPict("SD2","D2_DESCZFR",14),)
						PrintOut(Li,083,aContrAliq[3],PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,107,aContrAliq[4],PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,131,aContrAliq[5],PesqPict("SD2","D2_TOTAL",14),)
						PrintOut(Li,155,aContrAliq[6],PesqPict("SD2","D2_TOTAL",14),)
						Li += 2
					Next
					PrintOut(Li,001,__PrtThinLine(),,)
					Li++
					PrintOut(Li,001,"Total de "+IIF(lEntrada,"Entradas",If(cPaisLoc$"ANG|PTG","Saídas","Saidas")),,)
					PrintOut(Li,030,nGValCont,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,050,nGZFranca,PesqPict("SD2","D2_DESCZFR",14),)
					PrintOut(Li,083,nGValDebi,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,107,nGValCred,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,131,nGBasDebi,PesqPict("SD2","D2_TOTAL",14),)
					PrintOut(Li,155,nGBasCred,PesqPict("SD2","D2_TOTAL",14),)
					Li				:= Li + 3
					nValContri	+= nGValDebi-nGValCred
					nAliq			:= 0
					nContrAli	:= 0
					For nCt := 1 To len(aContrAliq)
   					aContrAliq[nCt] := 0
					next

					If TRB->TIPO <> cTipo
						PrintOut(Li,001,Repli("-",Limite),,)
						Li++
						PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Contribuição : ","Contribuicao : "),,)
						Li++
						Li++

						Asort(aAliqCFGer,,,{|x,y|Str(x[1])+x[2] < Str(y[1])+y[2]})

						For nX := 1 To Len(aAliqCFGer)
							If Li > 58
								Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
							EndIf
							If nAliq <> aAliqCFGer[nX][1]
								If nX <> 1
									PrintOut(Li,001,"Total:"+Space(04),,)

									PrintOut(Li,011,Transform(Abs(nContrAli),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Transform(Abs(aContrAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aContrAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aContrAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aContrAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aContrAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
									Li			+= 2
									nContrAli:= 0
									For nCt:=1 To len(aContrAliq)
				   					aContrAliq[nCt] := 0
									Next
								Endif
								PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Taxa : ","Aliquota : ")+Transform(aAliqCFGer[nX][1],PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1])),,)
								Li++
								If mv_par10 == 1
									PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Código Fiscal               Valor","CFOP               Valor"),,)
									Li++
								Endif
								nAliq	:= aAliqCFGer[nX][1]
							Endif
							If mv_par10 == 1

								PrintOut(Li,001,aAliqCFGer[nX][2]+Space(06)+Transform(Abs(aAliqCFGer[nX][3]),PesqPict("SD2","D2_TOTAL",14))+IIf(aAliqCFGer[nX][3]<0,"  (C)","  (D)")+Transform(Abs(aAliqCFGer[nX][4]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aAliqCFGer[nX][5]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aAliqCFGer[nX][6]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aAliqCFGer[nX][7]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aAliqCFGer[nX][8]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aAliqCFGer[nX][9]),PesqPict("SD2","D2_TOTAL",14)),,)
								Li++
							Endif
							nContrAli	 += aAliqCFGer[nX][3]
							aContrAliq[1]+= aAliqCFGer[nX][4]
							aContrAliq[2]+= aAliqCFGer[nX][5]
							aContrAliq[3]+= aAliqCFGer[nX][6]
							aContrAliq[4]+= aAliqCFGer[nX][7]
							aContrAliq[5]+= aAliqCFGer[nX][8]
							aContrAliq[6]+= aAliqCFGer[nX][9]
							aValContri[1]+= aAliqCFGer[nX][4]
							aValContri[2]+= aAliqCFGer[nX][5]
							aValContri[3]+= aAliqCFGer[nX][6]
							aValContri[4]+= aAliqCFGer[nX][7]
							aValContri[5]+= aAliqCFGer[nX][8]
							aValContri[6]+= aAliqCFGer[nX][9]
						Next

						PrintOut(Li,001,"Total:"+Space(04)+Transform(Abs(nContrAli),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Transform(Abs(aContrAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aContrAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aContrAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aContrAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aContrAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
						Li += 2
						PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total apurado............: ","Total Apurado............: "),,)
						Li++

						PrintOut(Li,011,Transform(Abs(nValContri),PesqPict("SD2","D2_TOTAL",14))+IIf(nValContri<0,"  (C)","  (D)")+Transform(Abs(aValContri[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aValContri[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aValContri[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[6]),PesqPict("SD2","D2_TOTAL",14)),,)
						Li++
						Li++
						PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção(modalidade da dedução: validade)........: ","Total de Retenção(Modalidade da Dedução: Vencimento)........: "),,)
						Li++
						PrintOut(Li,011,Transform(IIF(cTipo=="PIS",aRet[1],aRet[2]),PesqPict("SD2","D2_TOTAL",14)),,)
						Li++
						Li++
						PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção - órgãos públicos(modalidade da dedução: pagamento)........: ","Total de Retenção - Orgãos Públicos(Modalidade da Dedução: Pagamento)........: "),,)
						Li++
						PrintOut(Li,011,Transform(IIF(cTipo=="PIS",(aDedRet[1]-aRet[1]),(aDedRet[2]-aRet[2])),PesqPict("SD2","D2_TOTAL",14)),,)
						Li++
						Li++
						nContrAli := IIF(cTipo=="PIS",nValContri-aDedRet[1],nValContri-aDedRet[2])
						PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total da contribuição....: ","Total da Contribuicao....: "),,)
						Li++

						PrintOut(Li,011,Transform(IIF(cTipo=="PIS",Abs(nValContri-aDedRet[1]),Abs(nValContri-aDedRet[2])),PesqPict("SD2","D2_TOTAL",14))+IIf(nValContri<0,"  (C)","  (D)")+Transform(Abs(aValContri[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aValContri[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aValContri[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[6]),PesqPict("SD2","D2_TOTAL",14)),,)
						Li += 2
						PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","(C) Crédito  /  (D) Débito","(C) Credito  /  (D) Debito"),,)

						If cTipo == "PIS"
							aTotApur[01][01]  += nValContri
							aTotApur[01][02]  += aDedRet[1]
							aTotApur[01][03]  += nValContri-aDedRet[1]
						Else
							aTotApur[02][01]  += nValContri
							aTotApur[02][02]  += aDedRet[2]
							aTotApur[02][03]  += nValContri-aDedRet[2]
						Endif
						nValContri	:= 0
						aAliqs 		:= {}
						aResAliCF 	:= {}
						aAliqCFGer	:= {}
						For nCt:=1 To len(aValContri)
							aValContri[nCt] := 0
						next
						Li++
					Else
						aAliqs 		:= {}
						aResAliCF 	:= {}
					Endif
					lEntrada  := .F. 
			    	lQuebra   := .T. 
					nGValCont := 0
					nGZFranca := 0
					nGValDebi := 0
					nGValCred := 0
					nGBasDebi := 0
					nGBasCred := 0
				Endif
				If mv_par14 == 1
					cChave	:=	TRB->TIPO+TRB->CFOP+TRB->CLIFOR
				Elseif mv_par14 == 2
					cChave	:=		TRB->TIPO+TRB->CFOP
				Endif
			EndDo
			lResumo:= .T. 
		EndDo
	EndIf

	cArqCp :=strzero(month(mv_par02),2)+substr(strzero(year(mv_par02),4),3,2)+SM0->M0_CODIGO+SM0->M0_CODFIL+".CP"
	If File(cArqCp)
		cTitulo := If( cPaisLoc $ "ANG|PTG", "Informações Complementares Da Apuração", "Informacoes Complementares da Apuracao" )
		cabec1  := If( cPaisLoc $ "ANG|PTG", " Descrição                                                                    Valores", " Descricao                                                                    Valores" )
		cabec2  := ""
		cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		cContArq	:=	MemoRead(cArqCp)
		For nContCp :=1 to MlCount(cContArq,100)
			cLinArq :=MemoLine(cContArq,100,nContCp)
	      PrintOut(Li,001,Substr(cLinArq,01,70),,)
			PrintOut(Li,071,Val(Substr(cLinArq,71,14)),PesqPict("SD2","D2_TOTAL",14),)
	      Li++
		Next
		lResumo:= .T. 
	Endif

	If lResumo .And.  TRB->(LastRec()) > 0
		cTitulo := "Resumo"
		cabec1  := If( cPaisLoc $ "ANG|PTG", "Valores Para Cálculo              Tributado           Outros            Total", "Valores para Calculo              Tributado           Outros            Total" )
		cabec2  := ""
		cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Saidas                   ","Saídas                   ")+Transform(nVendTrib,PesqPict("SD2","D2_TOTAL",17))+Transform(nValVend,PesqPict("SD2","D2_TOTAL",17))+Transform(nVendTrib+nValVend,PesqPict("SD2","D2_TOTAL",17)),,)
		PrintOut(Li+1,001,If(cPaisLoc$"ANG|PTG","Devoluções de saidas     ","Devoluções de Saídas     ")+Transform(nDevCompT,PesqPict("SD2","D2_TOTAL",17))+Transform(nValDevComp,PesqPict("SD2","D2_TOTAL",17))+Transform(nDevCompT+nValDevComp,PesqPict("SD2","D2_TOTAL",17)),,)
		PrintOut(Li+2,001,"Entradas                 "+Transform(nCompTrib,PesqPict("SD2","D2_TOTAL",17))+Transform(nValComp,PesqPict("SD2","D2_TOTAL",17))+Transform(nCompTrib+nValComp,PesqPict("SD2","D2_TOTAL",17)),,)
		PrintOut(Li+3,001,If(cPaisLoc$"ANG|PTG","Devoluções de entradas   ","Devoluções de Entradas   ")+Transform(nDevVendT,PesqPict("SD2","D2_TOTAL",17))+Transform(nValDevVend,PesqPict("SD2","D2_TOTAL",17))+Transform(nDevVendT+nValDevVend,PesqPict("SD2","D2_TOTAL",17)),,)
		aTotSai[01]		+= nVendTrib
		aTotSai[02]		+= nValVend
		aTotSai[03]		+= nVendTrib + nValVend
		aTotDevS[01]	+= nDevCompT
		aTotDevS[02]	+= nValDevComp
		aTotDevS[03]	+= nDevCompT + nValDevComp
		aTotEnt[01] 	+= nCompTrib
		aTotEnt[02] 	+= nValComp
		aTotEnt[03] 	+= nCompTrib + nValComp
		aTotDevE[01] 	+= nDevVendT
		aTotDevE[02] 	+= nValDevVend
		aTotDevE[03] 	+= nDevVendT + nValDevVend
	EndIf

	SM0->(dbSkip())

	cQuebra    	:= ""
	cTipo      	:= ""
	aPIS		:= {}
	aCOFINS	  	:= {}
	aTotaisPIS 	:= Array(8)
	aTotaisCOF 	:= Array(8)
	nPos		:= 0
	nX			:= 0
	nRedPis	  	:= 1
	nRedCOF	  	:= 1
	nValPisPas 	:= 0
	nBasPisPas 	:= 0
	nPosCofins 	:= 0
	nValCofins 	:= 0
	nBasCofins 	:= 0
	nScanPis   	:= 0
	nScanCof   	:= 0
	nTxPis     	:= 0
	nTxCof     	:= 0
	nCredPis   	:= 0
	nCredCof   	:= 0
	nValCont   	:= 0
	nZFranca   	:= 0
	nValDebi   	:= 0
	nValCred   	:= 0
	nBasDebi   	:= 0
	nBasCred   	:= 0
	nGValCont  	:= 0
	nGZFranca  	:= 0
	nGValDebi  	:= 0
	nGValCred  	:= 0
	nGBasDebi  	:= 0
	nGBasCred  	:= 0
	nValContri 	:= 0
	nContCp    	:= 0
	nExPis      := 0
	nExCof      := 0
	lRet       	:= .F. 
	lContinua  	:= .T. 
	lEntrada   	:= .F. 
	lQuebra    	:= .F. 
	lFirst     	:= .F. 
	nValDevVend := 0
	nValComp    := 0
	nValVend    := 0
	nValDevComp := 0
	nVendTrib	:= 0
	nDevCompT   := 0
	nCompTrib   := 0
	nDevVendT   := 0
	aAliqs 	  	:= {}
	nPosAliq    := 0
	aDedRet     := {0,0}
	cbtxt      	:= Space(10)
	cbcont     	:= 00
	li         	:= 80
	aResAliCF 	:= {}
	aAliqCFGer	:= {}
	For nCt := 1 To len(aValContri)
		aValContri[nCt] := 0
	next

	dbSelectArea("TRB")
	dbCloseArea()
	Ferase(cArqTemp+GetDBExtension())
	Ferase(cArqTemp+OrdBagExt())
Enddo

DbSelectArea("SM0")
SM0->(DbGoTop())
SM0->(dbSeek(cEmpAnt+cFilOri, .T. ))
cFilAnt := cFilOri

If mv_par06 == 1
	cTitulo := If( cPaisLoc $ "ANG|PTG", "Resumo Geral - Totalização Das Filiais", "Resumo Geral - Totalizacao das Filiais" )
	cabec1  := ""
	cabec2  := ""
	cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,PADC(If(cPaisLoc$"ANG|PTG","Cofins - Contribuição Para O Financiamento Da Seguridade Social","COFINS - Contribuicao para o Financiamento da Seguridade Social"),Limite),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++

	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Cfop Processado - Entradas","RESUMO POR CFOP PROCESSADO - ENTRADAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Cfop             Descrição","CFOP             Descrição"),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","        Filial               Base Da Contribuição     Valor Da Contribuição","        Filial               Base da Contribuição     Valor da Contribuição"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	nTotal 	:= 0
	nTot_emp := 0
	aCFOPCOFE:= aSORT(aCFOPCOFE,,,{|X,Y|X[1]+X[3]<Y[1]+Y[3]})
   For nX := 1 To Len(aCFOPCOFE)
		PrintOut(Li,001,aCFOPCOFE[nX][1],,)
	    PrintOut(Li,018,aCFOPCOFE[nX][5],,)
	    Li++
	    cCFOP  :=aCFOPCOFE[nX][1]
	    WHILE aCFOPCOFE[nX][1]==cCFOP
			If Li > 58
				Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
			EndIf
			PrintOut(LI,013,aCFOPCOFE[nX][3],,)
			PrintOut(Li,033,Transform(Abs(aCFOPCOFE[nX][4]),PesqPict("SD2","D2_TOTAL",17)),,)
			PrintOut(Li,059,Transform(Abs(aCFOPCOFE[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
			nTotal 	 += Abs(aCFOPCOFE[nX][2])
			nTot_emp += Abs(aCFOPCOFE[nX][4])
			Li++
			nX++
			IF nX>Len(aCFOPCOFE)
				EXIT
			ENDIF
		END
	   nX--
		PrintOut(Li,033,Transform(nTot_emp,PesqPict("SD2","D2_TOTAL",17)),,)
		PrintOut(Li,059,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
		Li+=2
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
		nTotal 	:= 0
		nTot_emp := 0
	Next
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Cfop Processado - Saídas","RESUMO POR CFOP PROCESSADO - SAIDAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Cfop             Descrição","CFOP             Descrição"),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","        Filial               Base Da Contribuição     Valor Da Contribuição","        Filial               Base da Contribuição     Valor da Contribuição"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	nTotal 	 := 0
	nTot_emp  := 0
	aCFOPCOFS := aSORT(aCFOPCOFS,,,{|X,Y|X[1]+X[3]<Y[1]+Y[3]})
	For nX := 1 To Len(aCFOPCOFS)
 	    PrintOut(Li,001,aCFOPCOFS[nX][1],,)
	    PrintOut(Li,018,aCFOPCOFS[nX][5],,)
	    Li++
	  	 cCFOP  := aCFOPCOFS[nX][1]
	    WHILE aCFOPCOFS[nX][1]==cCFOP
			If Li > 58
				Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
			EndIf
			PrintOut(LI,013,aCFOPCOFS[nX][3],,)
			PrintOut(Li,033,Transform(Abs(aCFOPCOFS[nX][4]),PesqPict("SD2","D2_TOTAL",17)),,)
			PrintOut(Li,059,Transform(Abs(aCFOPCOFS[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
			nTotal 	+= Abs(aCFOPCOFS[nX][2])
			nTot_emp += Abs(aCFOPCOFS[nX][4])
			Li++
			nX++
			IF nX>Len(aCFOPCOFS)
				EXIT
			ENDIF
		END
	    nX--
		PrintOut(Li,003,"Total:",,)
		PrintOut(Li,033,Transform(nTot_emp,PesqPict("SD2","D2_TOTAL",17)),,)
		PrintOut(Li,059,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
		Li+=2
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
		nTotal 	:= 0
		nTot_emp := 0
	Next
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Taxa Processada - Entradas","RESUMO POR ALIQUOTA PROCESSADA - ENTRADAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Filial  Taxa                     Valor","Filial  Aliquota                     Valor"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	For nX := 1 To Len(aTAlCOFE)
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
		PrintOut(li,005,aTAlCOFE[nX][3],,)
		PrintOut(Li,011,Transform(aTAlCOFE[nX][1],PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1])),,)
		PrintOut(Li,026,Transform(Abs(aTAlCOFE[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
		nTotal += Abs(aTAlCOFE[nX][2])
		Li++
	Next
	PrintOut(Li,003,"Total:",,)
	PrintOut(Li,026,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
	Li++
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Taxa Processada - Saidas","RESUMO POR ALIQUOTA PROCESSADA - SAIDAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Filial  Taxa                     Valor","Filial  Aliquota                     Valor"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	nTotal := 0
	For nX := 1 To Len(aTAlCOFS)
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
		PrintOut(Li,005,aTAlCOFS[nX][3],,)
		PrintOut(Li,011,Transform(aTAlCOFS[nX][1],PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1])),,)
		PrintOut(Li,026,Transform(Abs(aTAlCOFS[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
		nTotal += Abs(aTAlCOFS[nX][2])
		Li++
	Next
	PrintOut(Li,003,"Total:",,)
	PrintOut(Li,026,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
	Li++
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Apurado","RESUMO APURADO"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total apurado............: ","Total Apurado............: "),,)
	Li++

	PrintOut(Li,011,Transform(Abs(aTotApur[02][01]),PesqPict("SD2","D2_TOTAL",14))+IIf(aTotApur[02][01]<0,"  (C)","  (D)")+Transform(Abs(aValContri[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aValContri[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aValContri[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[6]),PesqPict("SD2","D2_TOTAL",14)),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção........: ","Total de Retencao........: "),,)
	Li++
	PrintOut(Li,011,Transform(aTotApur[02][02],PesqPict("SD2","D2_TOTAL",14)),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total da contribuição....: ","Total da Contribuicao....: "),,)
	Li++

	PrintOut(Li,011,Transform(Abs(aTotApur[02][03]),PesqPict("SD2","D2_TOTAL",14))+IIf(aTotApur[02][03]<0,"  (C)","  (D)")+Transform(Abs(aValContri[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aValContri[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aValContri[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[6]),PesqPict("SD2","D2_TOTAL",14)),,)
	Li++
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,PADC(If(cPaisLoc$"ANG|PTG","Pis - Programa De Integração Social","PIS - Programa de Integracao Social"),Limite),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++

	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Cfop Processado - Entradas","RESUMO POR CFOP PROCESSADO - ENTRADAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Cfop             Descrição","CFOP             Descrição"),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","        Filial               Base Da Contribuição     Valor Da Contribuição","        Filial               Base da Contribuição     Valor da Contribuição"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
  	nTotal	 := 0
  	nTot_emp  := 0
  	aCFOPPISE := aSORT(aCFOPPISE,,,{|X,Y|X[1]+X[3]<Y[1]+Y[3]})
   For nX := 1 To Len(aCFOPPISE)
	    PrintOut(Li,001,aCFOPPISE[nX][1],,)
	    PrintOut(Li,018,aCFOPPISE[nX][5],,)
	    Li++
	    cCFOP  := aCFOPPISE[nX][1]
	    WHILE aCFOPPISE[nX][1]==cCFOP
			If Li > 58
				Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
			EndIf
	  		PrintOut(LI,013,aCFOPPISE[nX][3],,)
			PrintOut(Li,033,Transform(Abs(aCFOPPISE[nX][4]),PesqPict("SD2","D2_TOTAL",17)),,)
			PrintOut(Li,059,Transform(Abs(aCFOPPISE[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
			nTotal 	+= Abs(aCFOPPISE[nX][2])
			nTot_emp += Abs(aCFOPPISE[nX][4])
			Li++
			nX++
			IF nX>Len(aCFOPPISE)
				EXIT
			ENDIF
		END
	   nX--
		PrintOut(Li,003,"Total:",,)
		PrintOut(Li,033,Transform(nTot_emp,PesqPict("SD2","D2_TOTAL",17)),,)
		PrintOut(Li,059,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
		Li+=2
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
		nTotal   := 0
		nTot_emp := 0
	Next
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Cfop Processado - Saídas","RESUMO POR CFOP PROCESSADO - SAIDAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Cfop             Descrição","CFOP             Descrição"),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","        Filial               Base Da Contribuição     Valor Da Contribuição","        Filial               Base da Contribuição     Valor da Contribuição"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	nTotal  	 := 0
	nTot_emp  := 0
	aCFOPPISS := aSORT(aCFOPPISS,,,{|X,Y|X[1]+X[3]<Y[1]+Y[3]})
	For nX := 1 To Len(aCFOPPISS)
	    PrintOut(Li,001,aCFOPPISS[nX][1],,)
	    PrintOut(Li,018,aCFOPPISS[nX][5],,)
	    Li++
	    cCFOP  := aCFOPPISS[nX][1]
	    WHILE aCFOPPISS[nX][1]==cCFOP
			If Li > 58
				Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
			EndIf
			PrintOut(LI,013,aCFOPPISS[nX][3],,)
			PrintOut(Li,033,Transform(Abs(aCFOPPISS[nX][4]),PesqPict("SD2","D2_TOTAL",17)),,)
			PrintOut(Li,059,Transform(Abs(aCFOPPISS[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
			nTotal 	+= Abs(aCFOPPISS[nX][2])
			nTot_emp += Abs(aCFOPPISS[nX][4])
			Li++
			nX++
			IF nX>Len(aCFOPPISS)
				EXIT
			ENDIF
		END
	   nX--
		PrintOut(Li,003,"Total:",,)
		PrintOut(Li,033,Transform(nTot_emp,PesqPict("SD2","D2_TOTAL",17)),,)
		PrintOut(Li,059,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
		Li+=2
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
 		nTotal   := 0
		nTot_emp := 0
	Next
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Taxa Processada - Entradas","RESUMO POR ALIQUOTA PROCESSADA - ENTRADAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Filial  Taxa                     Valor","Filial  Aliquota                     Valor"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	nTotal := 0
	For nX := 1 To Len(aTAlPISE)
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
		PrintOut(Li,005,aTAlPISE[nX][3],,)
		PrintOut(Li,011,Transform(aTAlPISE[nX][1],PesqPict("SB1","B1_VLR_PIS",12)),,)
		PrintOut(Li,026,Transform(Abs(aTAlPISE[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
		nTotal += Abs(aTAlPISE[nX][2])
		Li++
	Next
	PrintOut(Li,003,"Total:",,)
	PrintOut(Li,026,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
	Li++
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Por Taxa Processada - Saidas","RESUMO POR ALIQUOTA PROCESSADA - SAIDAS"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Filial  Taxa                     Valor","Filial  Aliquota                     Valor"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	nTotal := 0
	For nX := 1 To Len(aTAlPISS)
		If Li > 58
			Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
		EndIf
		PrintOut(Li,005,aTAlPISS[nX][3],,)
		PrintOut(Li,011,Transform(aTAlPISS[nX][1],PesqPict("SB1","B1_VLR_PIS",12)),,)
		PrintOut(Li,026,Transform(Abs(aTAlPISS[nX][2]),PesqPict("SD2","D2_TOTAL",17)),,)
		nTotal += Abs(aTAlPISS[nX][2])
		Li++
	Next
	PrintOut(Li,003,"Total:",,)
	PrintOut(Li,026,Transform(nTotal,PesqPict("SD2","D2_TOTAL",17)),,)
	Li++
	If Li > 58
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	PrintOut(Li,001,Repli("-",Limite),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Resumo Apurado","RESUMO APURADO"),,)
	Li++
	PrintOut(Li,001,Repli("-",Limite),,)
	Li++

	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total apurado............: ","Total Apurado............: ")+Transform(Abs(aTotApur[01][01]),PesqPict("SD2","D2_TOTAL",14))+IIf(aTotApur[01][01]<0,"  (C)","  (D)")+Transform(Abs(aValContri[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aValContri[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aValContri[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[6]),PesqPict("SD2","D2_TOTAL",14)),,)
	Li++
	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção........: ","Total de Retencao........: ")+Transform(aTotApur[01][02],PesqPict("SD2","D2_TOTAL",14)),,)
	Li++

	PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total da contribuição....: ","Total da Contribuicao....: ")+Transform(Abs(aTotApur[01][03]),PesqPict("SD2","D2_TOTAL",14))+IIf(aTotApur[01][03]<0,"  (C)","  (D)")+Transform(Abs(aValContri[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aValContri[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(19)+Transform(Abs(aValContri[3]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[4]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[5]),PesqPict("SD2","D2_TOTAL",14))+Space(10)+Transform(Abs(aValContri[6]),PesqPict("SD2","D2_TOTAL",14)),,)
	Li++

	If Li > 50
		Cabec(ctitulo,cabec1,cabec2,nomeprog,ctamanho,15)
	EndIf

	If lResumo
		PrintOut(Li,001,Repli("-",Limite),,)
		Li++
		PrintOut(Li,001,PadC(If(cPaisLoc$"ANG|PTG","Resumo Por Movimento Processado","Resumo por Movimento Processado"),Limite),,)
		Li++
		PrintOut(Li,001,Repli("-",Limite),,)
		Li++
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Valores Para Cálculo              Tributado           Outros            Total","Valores para Calculo              Tributado           Outros            Total"),,)
		Li++
		PrintOut(Li,001,Repli("-",Limite),,)
		Li++
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Saidas                   ","Saídas                   ")+Transform(aTotSai[01],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotSai[02],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotSai[03],PesqPict("SD2","D2_TOTAL",17)),,)
		Li++
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Devoluções de saidas     ","Devoluções de Saídas     ")+Transform(aTotDevS[01],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotDevS[02],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotDevS[03],PesqPict("SD2","D2_TOTAL",17)),,)
		Li++
		PrintOut(Li,001,"Entradas                 "+Transform(aTotEnt[01],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotEnt[02],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotEnt[03],PesqPict("SD2","D2_TOTAL",17)),,)
		Li++
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Devoluções de entradas   ","Devoluções de Entradas   ")+Transform(aTotDevE[01],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotDevE[02],PesqPict("SD2","D2_TOTAL",17))+Transform(aTotDevE[03],PesqPict("SD2","D2_TOTAL",17)),,)
		Li++
	Endif
Endif

Roda(cbcont,cbtxt,ctamanho)

If aReturn[5] == 1
	Set( 24, "" )
   dbcommitAll()
   OurSpool(wnrel)
Endif

MS_FLUSH()

Return













Static Function R906Imp(cArqTemp,aTAlPISS,aTAlCOFS,aTAlPISE,aTAlCOFE,aTotApur, nOrd)
	Local  aLay[2]
	Local  aImp			:=	{}
	Local  aAliqs 	  	:= 	{}
	Local  aDedRet     := {0,0}
	Local  aAliqCFGer	:= {}
	Local  aResAliCF	:= {}
	Local  aContrAliq  := Array(6)
	Local  aSomaAliq	:= Array(6)
	Local  cCabec1		:=	""
	Local  cCabec2		:=	""
	Local  cQuebra  	:= 	""
	Local  cTipo			:=	""
	Local  cCfop			:=	""
	Local  cCabec		:=	""
	Local  lFirst		:= .F. 
	Local  lContinua  	:= .T. 
	Local  Lin			:=	1
	Local  nContribC	:=	0
	Local  nContribD	:=	0
	Local  nContribBC	:=	0
	Local  nContribBD	:=	0
	Local  nValCont		:= 	0
	Local  nZFranca		:= 	0
	Local  nValDebi		:= 	0
	Local  nValCred		:=	 	0
	Local  nBasDebi		:= 	0
	Local  nBasCred		:= 	0
	Local  nGValDebi 	:= 	0
	Local  nGValCred 	:= 	0
	Local  nPosAliq		:=	0
	Local  nX				:=	1
	Local  nContrAli	:= 	0
	Local  nAliq			:= 	0
	Local  nPos			:= 	0
	Local  nCt			:= 	0
	Local  aTotDia		:= 	Array(7)
	Local  aRet			:= 	{0,0}
	Local  cTotDia		:= 	If( cPaisLoc $ "ANG|PTG", "  total do dia - ########                                   ##################  ##################            ##################  ##################    ##################  ##################                     ", "  Total do dia - ########                                   ##################  ##################            ##################  ##################    ##################  ##################                     " )
	Local  nXX	 		:= 	0
	Local  nAliqP 		:= 	0
	Local  nAcVlrCtb   := 	0
	Local  nAcZfranca  := 	0
	Local  nAcVlrCtbD  := 	0
	Local  nAcVlrCtbC  := 	0
	Local  nAcVlrCtbBD := 	0
	Local  nAcVlrCtbBC	:= 	0
	Local  cNumNota 	:= 	""
	Local  cSerie   	:= 	""
	Local  cEmissao 	:= 	""
	Local  cNcm     	:= 	""
	Local  cProd    	:= 	""
	Local  cCliFor  	:= 	""
	Local  cPauta	 	:= 	""
	Local  lOrgPub		:= IIF(mv_par13 == 1, .T. , .F. )

	For nCt := 1 To len(aContrAliq)
		aContrAliq[nCt] := 0
	Next
	For nCt := 1 To len(aSomaAliq)
		aSomaAliq[nCt] := 0
	Next

	aDedRet	:= FsCalcRet(mv_par02,mv_par03,,,2,,@aRet,, .T. ,cFilAnt,,lOrgPub)
	aLay[2]	:= "  ########################################################  ##################  ##################            ##################  ##################    ##################  ################## "
	Li			:=	99
	If (nOrd==2)
		If (MV_PAR04==1)
			cCabec1	:=	If( cPaisLoc $ "ANG|PTG", " documento    série  emissão   artigo          ncm         valor contabilístico      zona franca         taxa valor da contribuição                      base da contribuição      cliente/forn.     ", " Documento    Serie  Emissao   Produto          NCM         Valor Contabil      Zona Franca         Aliquota                 Valor da Contribuicao                      Base da Contribuicao      Cliente/Forn.     " )
			aLay[1]	:=	"  ######      ###    ########  ###############  ##########  ##################  ##################  ######   ##################  ##################    ##################  ##################    ##################"
		Else
			cCabec1	:=	If( cPaisLoc $ "ANG|PTG", " documento    série  emissão   artigo          ncm         valor contabilístico      zona franca         aliquota                 valor da contribuição                      base da contribuição   ", " Documento    Serie  Emissao   Produto          NCM         Valor Contabil      Zona Franca         Aliquota                 Valor da Contribuicao                      Base da Contribuicao   " )
			aLay[1]	:=	"  ######      ###    ########  ###############  ##########  ##################  ##################  ######   ##################  ##################    ##################  ################## "
		Endif
		cCabec2	:=	If( cPaisLoc $ "ANG|PTG", "                                                                                                                          débito             crédito                débito             crédito ", "                                                                                                                          Debito             Credito                Debito             Credito " )
		IndRegua ("TRB", cArqTemp, "TIPO+ES+NUMNF+SERIE+DToS (EMISSAO)")
	ElseIf (nOrd==3)
		If (MV_PAR04==1)
			cCabec1	:=	If( cPaisLoc $ "ANG|PTG", " emissão   documento    série  artigo          ncm         valor contabilístico      zona franca         taxa                 valor da contribuição                      base da contribuição      cliente/forn.     ", " Emissao   Documento    Serie  Produto          NCM         Valor Contabil      Zona Franca         Aliquota                 Valor da Contribuicao                      Base da Contribuicao      Cliente/Forn.     " )
			aLay[1]	:=	" ########   ######      ###    ###############  ##########  ##################  ##################  ######   ##################  ##################    ##################  ##################    ##################"
   		Else
			cCabec1	:=	If( cPaisLoc $ "ANG|PTG", " emissão   documento    série  produto          ncm         valor contabilístico      zona franca         taxa                 valor da contribuição                      base da contribuição   ", " Emissao   Documento    Serie  Produto          NCM         Valor Contabil      Zona Franca         Aliquota                 Valor da Contribuicao                      Base da Contribuicao   " )
			aLay[1]	:=	" ########   ######      ###    ###############  ##########  ##################  ##################  ######   ##################  ##################    ##################  ################## "
   		Endif
		cCabec2	:=	If( cPaisLoc $ "ANG|PTG", "                                                                                                                          débito             crédito                débito             crédito ", "                                                                                                                          Debito             Credito                Debito             Credito " )
		IndRegua ("TRB", cArqTemp, "TIPO+ES+DToS (EMISSAO)+NUMNF+SERIE")
	EndIF
	aTotDia[1]	:=	TRB->EMISSAO
	aTotDia[2]	:=	0
	aTotDia[3]	:=	0
	aTotDia[4]	:=	0
	aTotDia[5]	:=	0
	aTotDia[6]	:=	0
	aTotDia[7]	:=	0
	while !TRB->(Eof()) .And. (lContinua)
		If (lEnd)
			PrintOut(_PROW()+1,001,If(cPaisLoc$"ANG|PTG","Cancelado Pelo Operador","CANCELADO PELO OPERADOR"),,)
			lContinua := .F. 
			Exit
		Endif
		IncRegua()
		If (Li>58)
			cabec (ctitulo, cCabec1, cCabec2, nomeprog, ctamanho, 15)
		EndIf
		If !(lFirst)
			PrintOut(Li,001,OemToAnsi("Empresa : ")+SM0->M0_NOMECOM,,)
			Li++
			PrintOut(Li,001,OemToAnsi(If(cPaisLoc$"ANG|PTG","Cnpj    : ","CNPJ    : "))+Transform(SM0->M0_CGC,"@R 99.999.999/9999-99"),,)
			Li++
			PrintOut(Li,001,OemToAnsi(If(cPaisLoc$"ANG|PTG","Período : ","Periodo : "))+Dtoc(mv_par02)+" - "+Dtoc(mv_par03),,)
			Li++
		Endif
		cQuebra  := TRB->TIPO+TRB->ES+TRB->CLIFOR


		If (MV_PAR09==1) .And.  (nOrd==3) .And.  lFirst .And.  (TRB->EMISSAO<>aTotDia[1] .Or.  TRB->ES<>cCfop .Or.  TRB->TIPO<>cTipo)
			PrintOut(Li,001,__PrtThinLine(),,)
			Li++
			FmtLin (aTotDia,cTotDia,,"@X",@Li)
			Li++
			aTotDia[1]	:=	TRB->EMISSAO
			aTotDia[2]	:=	0
			aTotDia[3]	:=	0
			aTotDia[4]	:=	0
			aTotDia[5]	:=	0
			aTotDia[6]	:=	0
			aTotDia[7]	:=	0
		EndIf
		If (TRB->TIPO<>cTipo) .Or.  (TRB->ES<>cCfop)
			If (lFirst)
				PrintOut(Li,001,__PrtThinLine(),,)
				Li++

				aSort(aALiqs,,,{|x,y| x[1]>y[1]})
				For nX := 1 To Len (aALiqs)
					aContrAliq	:=	{aALiqs[nX][3], aALiqs[nX][4], aALiqs[nX][5], aALiqs[nX][6], aALiqs[nX][7], aALiqs[nX][8]}

					If mv_par10 == 1
						nPosAliq := aScan(aResAliCF,{|x| x[1]==aAliqs[nX][1]})
						If nPosAliq > 0
							For nPos := nPosAliq to Len(aResAliCF)
								If aResAliCF[nPos][01] <> aAliqs[nX][1]
									Exit
								Endif
								If (Li>58)
									cabec (ctitulo, cCabec1, cCabec2, nomeprog, ctamanho, 15)
								EndIf

								If nPos == nPosAliq
									cCabec := If( cPaisLoc $ "ANG|PTG", "Total Por Código Fiscal:", "Total por CFOP:" ) + Space(05) + aResAliCF[nPos][2]
								Else
									cCabec := If( cPaisLoc $ "ANG|PTG", "Total Por Código Fiscal:", "Total por CFOP:" )
									cCabec := Space(Len(cCabec)) + Space(05) + aResAliCF[nPos][2]
								Endif


								FmtLin({cCabec, Transform (aResAliCF[nPos][4], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][5], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][6], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][7], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][8], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][9], "@E 999,999,999,999.99")},aLay[2],,"@X",@Li)
							Next
						Endif
					Endif
					If aAliqs[nX][9]=="S"
						aContrAliq	:=	{0,0,0,0,0,0}
						For nXX := nX To Len(aALiqs)
							If aAliqs[nXX][9]=="S" .And.  aAliqs[nX][1]==0
								nX := nXX
								aContrAliq[1]+= aALiqs[nXX][3]
								aContrAliq[2]+= aALiqs[nXX][4]
								aContrAliq[3]+= aALiqs[nXX][5]
								aContrAliq[4]+= aALiqs[nXX][6]
								aContrAliq[5]+= aALiqs[nXX][7]
								aContrAliq[6]+= aALiqs[nXX][8]
							Else
								Exit
							EndIf
						Next
					EndIf


					FmtLin({If( cPaisLoc $ "ANG|PTG", "Total da taxa ", "Total da Aliquota " )+Transform(aAliqs[nX][1],PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1])), Transform (aContrAliq[1], "@E 999,999,999,999.99"), Transform (aContrAliq[2], "@E 999,999,999,999.99"), Transform (aContrAliq[3], "@E 999,999,999,999.99"), Transform (aContrAliq[4], "@E 999,999,999,999.99"), Transform (aContrAliq[5], "@E 999,999,999,999.99"), Transform (aContrAliq[6], "@E 999,999,999,999.99")},aLay[2],,"@X",@Li)
					Li++
				Next



				FmtLin({Iif (TRB->ES=="S", "Total de "+If( cPaisLoc $ "ANG|PTG", "Saídas", "Saidas" ), "Total de "+"Entradas"), Transform (nValCont, "@E 999,999,999,999.99"), Transform (nZFranca, "@E 999,999,999,999.99"), Transform (nValDebi, "@E 999,999,999,999.99"), Transform (nValCred, "@E 999,999,999,999.99"), Transform (nBasDebi, "@E 999,999,999,999.99"), Transform (nBasCred, "@E 999,999,999,999.99")}, aLay[2],,"@X",@Li)

				If (TRB->TIPO<>cTipo)
					Li+=2
					PrintOut(Li,001,__PrtThinLine(),,)
					Li++
					PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Contribuição : ","Contribuicao : "),,)
					Li+=2

					Asort(aAliqCFGer,,,{|x,y|Str(x[1])+x[2] < Str(y[1])+y[2]})
					aContrAliq	:=	{0,0,0,0,0,0}

					For nX := 1 To Len(aAliqCFGer)
						If (Li>58)
							cabec (ctitulo, cCabec1, cCabec2, nomeprog, ctamanho, 15)
						EndIf
						If nAliq <> aAliqCFGer[nX][1]
							If nX <> 1

					   		PrintOut(Li,001,"Total:"+Space(04)+Transform(Abs(nContrAli),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aContrAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aContrAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aContrAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
								Li+=2
								nContrAli := 0
								For nCt := 1 To len(aContrAliq)
			   					aContrAliq[nCt] := 0
								next
							Endif
							PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Taxa : ","Aliquota : ")+Transform(aAliqCFGer[nX][1],PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1])),,)
							Li++
							If mv_par10 == 1
								PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Código Fiscal               Valor","CFOP               Valor"),,)
								Li++
							Endif
							nAliq 	:= aAliqCFGer[nX][1]
						Endif
						If mv_par10 == 1

							PrintOut(Li,001,aAliqCFGer[nX][2]+Space(06)+Transform(Abs(aAliqCFGer[nX][3]),PesqPict("SD2","D2_TOTAL",14))+IIf(aAliqCFGer[nX][3]<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aAliqCFGer[nX][4]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aAliqCFGer[nX][5]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aAliqCFGer[nX][6]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aAliqCFGer[nX][7]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aAliqCFGer[nX][8]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aAliqCFGer[nX][9]),PesqPict("SD2","D2_TOTAL",14)),,)
							Li++
						Endif
						nContrAli	  += aAliqCFGer[nX][3]

						aContrAliq[1] += aAliqCFGer[nX][4]
						aContrAliq[2] += aAliqCFGer[nX][5]
						aContrAliq[3] += aAliqCFGer[nX][6]
						aContrAliq[4] += aAliqCFGer[nX][7]
						aContrAliq[5] += aAliqCFGer[nX][8]
						aContrAliq[6] += aAliqCFGer[nX][9]

						aSomaAliq[1]  += aAliqCFGer[nX][4]
						aSomaAliq[2]  += aAliqCFGer[nX][5]
						aSomaAliq[3]  += aAliqCFGer[nX][6]
						aSomaAliq[4]  += aAliqCFGer[nX][7]
						aSomaAliq[5]  += aAliqCFGer[nX][8]
						aSomaAliq[6]  += aAliqCFGer[nX][9]
					Next
					If (Li>58)
						cabec (ctitulo, cCabec1, cCabec2, nomeprog, ctamanho, 15)
					EndIf


					PrintOut(Li,001,"Total:"+Space(04)+Transform(Abs(nContrAli),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aContrAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aContrAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aContrAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
					Li+=2

					PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total apurado............: ","Total Apurado............: "),,)
					Li++

					PrintOut(Li,011,Transform(Abs(nGValDebi-nGValCred),PesqPict("SD2","D2_TOTAL",14))+IIf(nGValDebi-nGValCred<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aSomaAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aSomaAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aSomaAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
			   	Li++
			   	Li++

					PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção(modalidade da dedução: validade)........: ","Total de Retenção(Modalidade da Dedução: Vencimento)........: "),,)
					Li++
					PrintOut(Li,011,Transform(IIF(cTipo=="PIS",aRet[1],aRet[2]),PesqPict("SD2","D2_TOTAL",14)),,)
					Li++
					Li++
					PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção - órgãos públicos(modalidade da dedução: pagamento)........: ","Total de Retenção - Orgãos Públicos(Modalidade da Dedução: Pagamento)........: "),,)
					Li++
					PrintOut(Li,011,Transform(IIF(cTipo=="PIS",(aDedRet[1]-aRet[1]),(aDedRet[2]-aRet[2])),PesqPict("SD2","D2_TOTAL",14)),,)
					Li++
					Li++
					nContrAli := IIF(cTipo=="PIS",(nGValDebi-nGValCred)-aDedRet[1],(nGValDebi-nGValCred)-aDedRet[2])

					PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total da contribuição....: ","Total da Contribuicao....: "),,)
					Li++

					PrintOut(Li,011,Transform(IIF(cTipo=="PIS",Abs((nGValDebi-nGValCred)-aDedRet[1]),Abs((nGValDebi-nGValCred)-aDedRet[2])),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aSomaAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aSomaAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aSomaAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
					If cTipo == "PIS"
						aTotApur[01][01]  += nGValDebi-nGValCred
						aTotApur[01][02]  += aDedRet[1]
						aTotApur[01][03]  += (nGValDebi-nGValCred)-aDedRet[1]
					Else
						aTotApur[02][01]  += nGValDebi-nGValCred
						aTotApur[02][02]  += aDedRet[2]
						aTotApur[02][03]  += (nGValDebi-nGValCred)-aDedRet[2]
					Endif
					nGValDebi 	:= 0
					nGValCred 	:= 0
					aAliqCFGer	:=	{}
				EndIf
				aAliqs		:=	{}
				aResAliCF 	:= {}
				nValCont	:=	0
				nZFranca 	:=	0
				nValDebi	:=	0
				nValCred 	:=	0
				nBasDebi 	:=	0
				nBasCred 	:=	0
				For nCt := 1 To len(aSomaAliq)
					aSomaAliq[nCt] := 0
				next
			EndIf
			If (TRB->TIPO<>cTipo) .And.  lFirst
				Cabec (cTitulo, cCabec1, cCabec2, nomeprog, cTamanho, 15)
			EndIf
			Li++

			PrintOut(Li,001,IIf(TRB->TIPO=="PIS",PadC(If(cPaisLoc$"ANG|PTG","Pis - Programa De Integração Social","PIS - Programa de Integracao Social")+Iif(SubStr(TRB->CFOP,1,1)<"5",If(cPaisLoc$"ANG|PTG"," - Entradas"," - ENTRADAS"),If(cPaisLoc$"ANG|PTG"," - Saídas"," - SAIDAS")),Limite),PadC(If(cPaisLoc$"ANG|PTG","Cofins - Contribuição Para O Financiamento Da Seguridade Social","COFINS - Contribuicao para o Financiamento da Seguridade Social")+Iif(SubStr(TRB->CFOP,1,1)<"5",If(cPaisLoc$"ANG|PTG"," - Entradas"," - ENTRADAS"),If(cPaisLoc$"ANG|PTG"," - Saídas"," - SAIDAS")),Limite)),,)
			Li	+=	2
			cTipo :=	TRB->TIPO
			cCfop	:=	TRB->ES
			lFirst:= .T. 
		Endif
		If (SubStr (TRB->CFOP, 1, 1)>="5")
			nContribC	:=	Iif (TRB->TIPO=="PIS", TRB->PISDSAI, TRB->COFDSAI)
			nContribD	:=	Iif (TRB->TIPO=="PIS", TRB->PISCSAI, TRB->COFCSAI)
			nContribBC	:=	Iif (TRB->TIPO=="PIS", TRB->BASPIDSAI, TRB->BASCODSAI)
			nContribBD	:=	Iif (TRB->TIPO=="PIS", TRB->BASPICSAI, TRB->BASCOCSAI)
		Else
			nContribC	:=	Iif (TRB->TIPO=="PIS", TRB->PISDENT, TRB->COFDENT)
			nContribD	:=	Iif (TRB->TIPO=="PIS", TRB->PISCENT, TRB->COFCENT)
			nContribBC	:=	Iif (TRB->TIPO=="PIS", TRB->BASPIDENT, TRB->BASCODENT)
			nContribBD	:=	Iif (TRB->TIPO=="PIS", TRB->BASPICENT, TRB->BASCOCENT)
		Endif

      If MV_PAR04 == 1
        	If MV_PAR11 == 1

				nAcVlrCtb   += TRB->VALORCONT
				nAcZfranca  += TRB->ZFRANCA
				nAcVlrCtbD  += nContribD
				nAcVlrCtbC  += nContribC
				nAcVlrCtbBD += nContribBD
				nAcVlrCtbBC	+= nContribBC

				cNumNota 	:= TRB->NUMNF
				cSerie   	:= TRB->SERIE
				cEmissao 	:= TRB->EMISSAO
				cNcm     	:= TRB->NCM
				cProd    	:= TRB->PRODUTO
				cCliFor  	:= TRB->CLIFOR
				cPauta	 	:= TRB->PAUTA
        	Else
				If (nOrd==2)



			       aImp	:=	{TRB->NUMNF, TRB->SERIE, TRB->EMISSAO,	TRB->PRODUTO, TRB->NCM, Transform (TRB->VALORCONT, "@E 999,999,999,999.99"), Transform (TRB->ZFRANCA, "@E 999,999,999,999.99"), 	Transform(TRB->ALIQ,Iif(TRB->PAUTA=="S",PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]),PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]))), Transform (nContribC, "@E 999,999,999,999.99"), Transform (nContribD, "@E 999,999,999,999.99"), Transform (nContribBC, "@E 999,999,999,999.99"), Transform (nContribBD, "@E 999,999,999,999.99"), TRB->CLIFOR}
		  		ElseIf (nOrd==3)



			       aImp	:=	{TRB->EMISSAO, TRB->NUMNF, TRB->SERIE,	TRB->PRODUTO, TRB->NCM, Transform (TRB->VALORCONT, "@E 999,999,999,999.99"), Transform (TRB->ZFRANCA, "@E 999,999,999,999.99"), 	Transform(TRB->ALIQ,Iif(TRB->PAUTA=="S",PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]),PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1]))), Transform (nContribC, "@E 999,999,999,999.99"), Transform (nContribD, "@E 999,999,999,999.99"), Transform (nContribBC, "@E 999,999,999,999.99"), Transform (nContribBD, "@E 999,999,999,999.99"), TRB->CLIFOR}
			    EndIf
  				FmtLin (aImp, aLay[1],,, @Li)
			EndIf
		EndIf
	   aTotDia[2]	+=	TRB->VALORCONT
	   aTotDia[3]	+=	TRB->ZFRANCA
	   aTotDia[4]	+=	nContribC
	   aTotDia[5]	+=	nContribD
	   aTotDia[6]	+=	nContribBC
		aTotDia[7]	+=	nContribBD
		nValCont	+=	TRB->VALORCONT
		nZFranca 	+=	TRB->ZFRANCA
		If (SubStr (TRB->CFOP, 1, 1)>="5")
			nValDebi	+= 	Iif (TRB->TIPO=="PIS", TRB->PISDSAI, TRB->COFDSAI)
			nValCred 	+= 	Iif (TRB->TIPO=="PIS", TRB->PISCSAI, TRB->COFCSAI)
			nBasDebi 	+= 	Iif (TRB->TIPO=="PIS", TRB->BASPIDSAI, TRB->BASCODSAI)
			nBasCred 	+=	Iif (TRB->TIPO=="PIS", TRB->BASPICSAI, TRB->BASCOCSAI)
			nGValDebi 	+= 	Iif (TRB->TIPO=="PIS", TRB->PISDSAI, TRB->COFDSAI)
			nGValCred 	+= 	Iif (TRB->TIPO=="PIS", TRB->PISCSAI, TRB->COFCSAI)
			nAliqP 		:=  Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
			nPosAliq	:=	Ascan(aAliqs,{|x| x[1]==nAliqP})
			If (nPosAliq>0)
				aAliqs[nPosAliq][2] += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
				aAliqs[nPosAliq][3] += TRB->VALORCONT
				aAliqs[nPosAliq][4] += TRB->ZFRANCA
				aAliqs[nPosAliq][5] += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
				aAliqs[nPosAliq][6] += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
				aAliqs[nPosAliq][7] += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
				aAliqs[nPosAliq][8] += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)
				If TRB->TIPO == "PIS"
					nAliqP 	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq	:=	Ascan(atalpiss,{|x| x[1]==nAliqP .and.  x[3]==sm0->m0_codfil})
					If nPosAliq > 0
						aTAlPISS[nPosAliq][2] += TRB->PISDSAI-TRB->PISCSAI
					EndIf
				Else
					nAliqP 	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq	:=	Ascan(atalcofs,{|x| x[1]==nAliqP .and.  x[3]==sm0->m0_codfil})
					If nPosAliq > 0
						aTAlCOFS[nPosAliq][2] += TRB->COFDSAI-TRB->COFCSAI
					endIf
				Endif
			Else







				aAdd (aAliqs, {Iif(TRB->PAUTA=="S",0,TRB->ALIQ), Iif (TRB->TIPO=="PIS", TRB->PISDSAI, TRB->COFDSAI)-Iif (TRB->TIPO=="PIS", TRB->PISCSAI, TRB->COFCSAI), TRB->VALORCONT, TRB->ZFRANCA, Iif (TRB->TIPO=="PIS", TRB->PISDSAI, TRB->COFDSAI), Iif (TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI), Iif (TRB->TIPO=="PIS", TRB->BASPIDSAI, TRB->BASCODSAI), Iif (TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI), TRB->PAUTA})
				If TRB->TIPO == "PIS"
					AADD(aTAlPISS,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->PISDSAI-TRB->PISCSAI,sm0->m0_codfil})
				Else
					AADD(aTAlCOFS,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->COFDSAI-TRB->COFCSAI,sm0->m0_codfil})
				Endif
			Endif

			nAliqP   := Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
			nPosAliq := Ascan(aAliqCFGer,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
			If nPosAliq > 0
				aAliqCFGer[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
				aAliqCFGer[nPosAliq][4]  += TRB->VALORCONT
				aAliqCFGer[nPosAliq][5]  += TRB->ZFRANCA
				aAliqCFGer[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
				aAliqCFGer[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
				aAliqCFGer[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
				aAliqCFGer[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)
			Else
				AADD(aAliqCFGer,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->CFOP,IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI),TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI),IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI),IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI),IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)})
			Endif

			nAliqP 	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
			nPosAliq := aScan(aResAliCF,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
			If nPosAliq == 0









				AADD(aResAliCF,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ), TRB->CFOP, IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI), TRB->VALORCONT, TRB->ZFRANCA, IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI), IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI), IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI), IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI), TRB->PAUTA})
			Else
				aResAliCF[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)-IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
				aResAliCF[nPosAliq][4]  += TRB->VALORCONT
				aResAliCF[nPosAliq][5]  += TRB->ZFRANCA
				aResAliCF[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDSAI,TRB->COFDSAI)
				aResAliCF[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCSAI,TRB->COFCSAI)
				aResAliCF[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDSAI,TRB->BASCODSAI)
				aResAliCF[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICSAI,TRB->BASCOCSAI)
			Endif
		Else
			nValDebi 	+=		Iif (TRB->TIPO=="PIS", TRB->PISDENT, TRB->COFDENT)
			nValCred 	+= 	Iif (TRB->TIPO=="PIS", TRB->PISCENT, TRB->COFCENT)
			nBasDebi 	+= 	Iif (TRB->TIPO=="PIS", TRB->BASPIDENT, TRB->BASCODENT)
			nBasCred 	+= 	Iif (TRB->TIPO=="PIS", TRB->BASPICENT, TRB->BASCOCENT)
			nGValDebi	+= 	Iif (TRB->TIPO=="PIS", TRB->PISDENT, TRB->COFDENT)
			nGValCred	+= 	Iif (TRB->TIPO=="PIS", TRB->PISCENT, TRB->COFCENT)
			nAliqP 		:= 	Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
			nPosAliq		:=		Ascan(aAliqs,{|x| x[1]==nAliqP})
			If (nPosAliq>0)
				aAliqs[nPosAliq][2]	    += 	Iif (TRB->TIPO=="PIS", TRB->PISDENT, TRB->COFDENT)-Iif (TRB->TIPO=="PIS", TRB->PISCENT, TRB->COFCENT)
				aAliqs[nPosAliq][3] 	+= 	TRB->VALORCONT
				aAliqs[nPosAliq][4] 	+= 	TRB->ZFRANCA
				aAliqs[nPosAliq][5] 	+= 	Iif (TRB->TIPO=="PIS", TRB->PISDENT, TRB->COFDENT)
				aAliqs[nPosAliq][6] 	+= 	Iif (TRB->TIPO=="PIS", TRB->PISCENT, TRB->COFCENT)
				aAliqs[nPosAliq][7] 	+= 	Iif (TRB->TIPO=="PIS", TRB->BASPIDENT, TRB->BASCODENT)
				aAliqs[nPosAliq][8] 	+=		Iif (TRB->TIPO=="PIS", TRB->BASPICENT, TRB->BASCOCENT)
				If TRB->TIPO == "PIS"
					nAliqP 					 := Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq					 :=	Ascan(atalpise,{|x| x[1]==nAliqP .and.  x[3]==sm0->m0_codfil})
					aTAlPISE[nPosAliq][2] += TRB->PISDENT-TRB->PISCENT
				Else
					nAliqP 					 := Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
					nPosAliq					 :=	Ascan(atalcofe,{|x| x[1]==nAliqP .and.  x[3]==sm0->m0_codfil})
					aTAlCOFE[nPosAliq][2] += TRB->COFDENT-TRB->COFCENT
				Endif
			Else








				aAdd (aAliqs,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ), Iif (TRB->TIPO=="PIS", TRB->PISDENT, TRB->COFDENT)-Iif (TRB->TIPO=="PIS", TRB->PISCENT, TRB->COFCENT), TRB->VALORCONT, TRB->ZFRANCA, Iif (TRB->TIPO=="PIS", TRB->PISDENT, TRB->COFDENT), Iif (TRB->TIPO=="PIS", TRB->PISCENT, TRB->COFCENT), Iif (TRB->TIPO=="PIS", TRB->BASPIDENT, TRB->BASCODENT), Iif (TRB->TIPO=="PIS", TRB->BASPICENT, TRB->BASCOCENT), TRB->PAUTA})
				If TRB->TIPO == "PIS"
					AADD(aTAlPISE,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->PISDENT-TRB->PISCENT,sm0->m0_codfil})
				Else
					AADD(aTAlCOFE,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->COFDENT-TRB->COFCENT,sm0->m0_codfil})
				Endif
			Endif

			nAliqP   := Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
			nPosAliq := Ascan(aAliqCFGer,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
			If nPosAliq > 0
				aAliqCFGer[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
				aAliqCFGer[nPosAliq][4]  += TRB->VALORCONT
				aAliqCFGer[nPosAliq][5]  += TRB->ZFRANCA
				aAliqCFGer[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
				aAliqCFGer[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
				aAliqCFGer[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
				aAliqCFGer[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)
			Else
				AADD(aAliqCFGer,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ),TRB->CFOP,IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT),TRB->VALORCONT,TRB->ZFRANCA,IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT),IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT),IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT),IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)})
			Endif

			nAliqP 	:= Iif(TRB->PAUTA=="S",0,TRB->ALIQ)
			nPosAliq := aScan(aResAliCF,{|x| x[1]==nAliqP .And.  x[2]==TRB->CFOP})
			If nPosAliq == 0









				AADD(aResAliCF,{Iif(TRB->PAUTA=="S",0,TRB->ALIQ), TRB->CFOP, IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT), TRB->VALORCONT, TRB->ZFRANCA, IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT), IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT), IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT), IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT), TRB->PAUTA})
			Else
				aResAliCF[nPosAliq][3]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)-IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
				aResAliCF[nPosAliq][4]  += TRB->VALORCONT
				aResAliCF[nPosAliq][5]  += TRB->ZFRANCA
				aResAliCF[nPosAliq][6]  += IIF(TRB->TIPO == "PIS",TRB->PISDENT,TRB->COFDENT)
				aResAliCF[nPosAliq][7]  += IIF(TRB->TIPO == "PIS",TRB->PISCENT,TRB->COFCENT)
				aResAliCF[nPosAliq][8]  += IIF(TRB->TIPO == "PIS",TRB->BASPIDENT,TRB->BASCODENT)
				aResAliCF[nPosAliq][9]  += IIF(TRB->TIPO == "PIS",TRB->BASPICENT,TRB->BASCOCENT)
			Endif
		Endif

		Asort(aResAliCF,,,{|x,y|Str(x[1])+x[2] < Str(y[1])+y[2]})
		TRB->(DbSkip ())
		If cNumNota <> TRB->NUMNF .OR.  TRB->TIPO+TRB->ES+TRB->CLIFOR <> cQuebra .Or.  TRB->(EOF())
			If mv_par11 == 1 .And.  mv_par04 == 1

		       If (nOrd==2)




			        aImp := {cNumNota, cSerie, cEmissao, cProd, cNcm, Transform (nAcVlrCtb, "@E 999,999,999,999.99"), Transform (nAcZfranca, "@E 999,999,999,999.99"), "", Transform (nAcVlrCtbC, "@E 999,999,999,999.99"), Transform (nAcVlrCtbD, "@E 999,999,999,999.99"), Transform (nAcVlrCtbBC, "@E 999,999,999,999.99"), Transform (nAcVlrCtbBD, "@E 999,999,999,999.99"), cCliFor}
		  		ElseIf (nOrd==3)




			        aImp := {cEmissao, cNumNota, cSerie, cProd, cNcm, Transform (nAcVlrCtb, "@E 999,999,999,999.99"), Transform (nAcZfranca, "@E 999,999,999,999.99"), "", Transform (nAcVlrCtbC, "@E 999,999,999,999.99"), Transform (nAcVlrCtbD, "@E 999,999,999,999.99"), Transform (nAcVlrCtbBC, "@E 999,999,999,999.99"), Transform (nAcVlrCtbBD, "@E 999,999,999,999.99"), cCliFor}
			   EndIf

  				FmtLin (aImp, aLay[1],,, @Li)

				cNumNota 	:= TRB->NUMNF
				cSerie   	:= TRB->SERIE
				cEmissao	:= TRB->EMISSAO
				cNcm		:= TRB->NCM
				cProd		:= TRB->PRODUTO
				cCliFor 	:= TRB->CLIFOR
				cPauta		:= TRB->PAUTA
				nAcVlrCtb   := 0
				nAcZfranca  := 0
				nAcVlrCtbD  := 0
				nAcVlrCtbC  := 0
				nAcVlrCtbBD := 0
			EndIf
		EndIf
	EndDo

	If TRB->(LastRec()) > 0


		If (MV_PAR09==1) .And.  (nOrd==3) .And.  lFirst .And.  (TRB->EMISSAO<>aTotDia[1] .Or.  TRB->ES<>cCfop .Or.  TRB->TIPO<>cTipo)
			PrintOut(Li,001,__PrtThinLine(),,)
			Li++

			FmtLin (aTotDia,cTotDia,,"@X",@Li)
			Li++

			aTotDia[1]	:= TRB->EMISSAO
			aTotDia[2]	:= 0
			aTotDia[3]	:= 0
			aTotDia[4]	:= 0
			aTotDia[5]	:= 0
			aTotDia[6]	:= 0
			aTotDia[7]	:= 0
		EndIf

		PrintOut(Li,001,__PrtThinLine(),,)
		Li++

		aSort(aALiqs,,,{|x,y| x[1]>y[1]})
		For nX := 1 To Len (aALiqs)
			aContrAliq	:=	{aALiqs[nX][3], aALiqs[nX][4], aALiqs[nX][5], aALiqs[nX][6], aALiqs[nX][7], aALiqs[nX][8]}

			If mv_par10 == 1
				nPosAliq := aScan(aResAliCF,{|x| x[1]==aAliqs[nX][1]})
				If nPosAliq > 0
					For nPos := nPosAliq to Len(aResAliCF)
						If aResAliCF[nPos][01] <> aAliqs[nX][1]
							Exit
						Endif
						If (Li>58)
							cabec (ctitulo, cCabec1, cCabec2, nomeprog, ctamanho, 15)
						EndIf

						If nPos == nPosAliq
							cCabec := If( cPaisLoc $ "ANG|PTG", "Total Por Código Fiscal:", "Total por CFOP:" ) + Space(05) + aResAliCF[nPos][2]
						Else
							cCabec := If( cPaisLoc $ "ANG|PTG", "Total Por Código Fiscal:", "Total por CFOP:" )
							cCabec := Space(Len(cCabec)) + Space(05) + aResAliCF[nPos][2]
						Endif


						FmtLin ({cCabec, Transform (aResAliCF[nPos][4], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][5], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][6], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][7], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][8], "@E 999,999,999,999.99"), Transform (aResAliCF[nPos][9], "@E 999,999,999,999.99")},aLay[2],,"@X",@Li)
					Next
				Endif
			Endif

			If aAliqs[nX][9]=="S"
				aContrAliq	:=	{0,0,0,0,0,0}
				For nXX := nX To Len(aALiqs)
					If aAliqs[nXX][9]=="S" .And.  aAliqs[nX][1]==0
						nX 			 := nXX
						aContrAliq[1]+= aALiqs[nXX][3]
						aContrAliq[2]+= aALiqs[nXX][4]
						aContrAliq[3]+= aALiqs[nXX][5]
						aContrAliq[4]+= aALiqs[nXX][6]
						aContrAliq[5]+= aALiqs[nXX][7]
						aContrAliq[6]+= aALiqs[nXX][8]
					Else
						Exit
					EndIf
				next
			EndIf



			FmtLin ({If( cPaisLoc $ "ANG|PTG", "Total da taxa ", "Total da Aliquota " )+Transform (aAliqs[nX][1],PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1])), Transform (aContrAliq[1], "@E 999,999,999,999.99"), Transform (aContrAliq[2], "@E 999,999,999,999.99"), Transform (aContrAliq[3], "@E 999,999,999,999.99"), Transform (aContrAliq[4], "@E 999,999,999,999.99"), Transform (aContrAliq[5], "@E 999,999,999,999.99"), Transform (aContrAliq[6], "@E 999,999,999,999.99")},aLay[2],,"@X",@Li)
			Li++
		next



		FmtLin ({Iif (TRB->ES=="S","Total de "+If( cPaisLoc $ "ANG|PTG", "Saídas", "Saidas" ), "Total de "+"Entradas"), Transform (nValCont, "@E 999,999,999,999.99"), Transform (nZFranca, "@E 999,999,999,999.99"), Transform (nValDebi, "@E 999,999,999,999.99"), Transform (nValCred, "@E 999,999,999,999.99"), Transform (nBasDebi, "@E 999,999,999,999.99"), Transform (nBasCred, "@E 999,999,999,999.99")}, aLay[2],,"@X",@Li)

		Li+=2
		PrintOut(Li,001,__PrtThinLine(),,)
		Li++
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Contribuição : ","Contribuicao : "),,)
		Li	+=	2

		Asort(aAliqCFGer,,,{|x,y|Str(x[1])+x[2] < Str(y[1])+y[2]})
		nContrAli	:= 0
		nAliq		:= 0
		For nCt := 1 To len(aContrAliq)
  			aContrAliq[nCt] := 0
		next

		For nX := 1 To Len(aAliqCFGer)
			If (Li>58)
				cabec (ctitulo, cCabec1, cCabec2, nomeprog, ctamanho, 15)
			EndIf
			If nAliq <> aAliqCFGer[nX][1]
				If nX <> 1

					PrintOut(Li,001,"Total:"+Space(04)+Transform(Abs(nContrAli),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aContrAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aContrAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aContrAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
					Li += 2
					nContrAli 	:= 0
					For nCt := 1 To len(aContrAliq)
						aContrAliq[nCt] := 0
					next
				Endif
				PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Taxa : ","Aliquota : ")+Transform(aAliqCFGer[nX][1],PesqPict("SB1","B1_VLR_COF",TamSx3("B1_VLR_COF")[1])),,)
				Li++
				If mv_par10 == 1
					PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Código Fiscal               Valor","CFOP               Valor"),,)
					Li++
				Endif
				nAliq 	:= aAliqCFGer[nX][1]
			Endif

			If mv_par10 == 1

				PrintOut(Li,001,aAliqCFGer[nX][2]+Space(06)+Transform(Abs(aAliqCFGer[nX][3]),PesqPict("SD2","D2_TOTAL",14))+IIf(aAliqCFGer[nX][3]<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aAliqCFGer[nX][4]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aAliqCFGer[nX][5]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aAliqCFGer[nX][6]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aAliqCFGer[nX][7]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aAliqCFGer[nX][8]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aAliqCFGer[nX][9]),PesqPict("SD2","D2_TOTAL",14)),,)
				Li++
			Endif
			nContrAli	 += aAliqCFGer[nX][3]
			aContrAliq[1]+= aAliqCFGer[nX][4]
			aContrAliq[2]+= aAliqCFGer[nX][5]
			aContrAliq[3]+= aAliqCFGer[nX][6]
			aContrAliq[4]+= aAliqCFGer[nX][7]
			aContrAliq[5]+= aAliqCFGer[nX][8]
			aContrAliq[6]+= aAliqCFGer[nX][9]
			aSomaAliq[1] += aAliqCFGer[nX][4]
			aSomaAliq[2] += aAliqCFGer[nX][5]
			aSomaAliq[3] += aAliqCFGer[nX][6]
			aSomaAliq[4] += aAliqCFGer[nX][7]
			aSomaAliq[5] += aAliqCFGer[nX][8]
			aSomaAliq[6] += aAliqCFGer[nX][9]
		Next

		If (Li>58)
			cabec (ctitulo, cCabec1, cCabec2, nomeprog, ctamanho, 15)
		EndIf


		PrintOut(Li,001,"Total:"+Space(04)+Transform(Abs(nContrAli),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aContrAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aContrAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aContrAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aContrAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
		Li+=2


		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total apurado............: ","Total Apurado............: "),,)
		Li++

		PrintOut(Li,011,Transform(Abs(nGValDebi-nGValCred),PesqPict("SD2","D2_TOTAL",14))+IIf(nGValDebi-nGValCred<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aSomaAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aSomaAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aSomaAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
   	Li++
		Li++

		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção(modalidade da dedução: validade)........: ","Total de Retenção(Modalidade da Dedução: Vencimento)........: "),,)
		Li++
		PrintOut(Li,011,Transform(IIF(cTipo=="PIS",aRet[1],aRet[2]),PesqPict("SD2","D2_TOTAL",14)),,)
		Li++
		Li++
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total de retenção - órgãos públicos(modalidade da dedução: pagamento)........: ","Total de Retenção - Orgãos Públicos(Modalidade da Dedução: Pagamento)........: "),,)
		Li++
		PrintOut(Li,011,Transform(IIF(cTipo=="PIS",(aDedRet[1]-aRet[1]),(aDedRet[2]-aRet[2])),PesqPict("SD2","D2_TOTAL",14)),,)
		Li++
		Li++
		nContrAli := IIF(cTipo=="PIS",(nGValDebi-nGValCred)-aDedRet[1],(nGValDebi-nGValCred)-aDedRet[2])
		PrintOut(Li,001,If(cPaisLoc$"ANG|PTG","Total da contribuição....: ","Total da Contribuicao....: "),,)
		Li++



		PrintOut(Li,011,Transform(IIF(cTipo=="PIS",Abs((nGValDebi-nGValCred)-aDedRet[1]),Abs((nGValDebi-nGValCred)-aDedRet[2])),PesqPict("SD2","D2_TOTAL",14))+IIf(nContrAli<0,"  (C)","  (D)")+Space(34)+Transform(Abs(aSomaAliq[1]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[2]),PesqPict("SD2","D2_DESCZFR",14))+Space(16)+Transform(Abs(aSomaAliq[3]),PesqPict("SD2","D2_TOTAL",14))+Space(6)+Transform(Abs(aSomaAliq[4]),PesqPict("SD2","D2_TOTAL",14))+Space(8)+Transform(Abs(aSomaAliq[5]),PesqPict("SD2","D2_TOTAL",14))+Space(06)+Transform(Abs(aSomaAliq[6]),PesqPict("SD2","D2_TOTAL",14)),,)
		If cTipo == "PIS"
			aTotApur[01][01]  += nGValDebi-nGValCred
			aTotApur[01][02]  += aDedRet[1]
			aTotApur[01][03]  += (nGValDebi-nGValCred)-aDedRet[1]
		Else
			aTotApur[02][01]  += nGValDebi-nGValCred
			aTotApur[02][02]  += aDedRet[2]
			aTotApur[02][03]  += (nGValDebi-nGValCred)-aDedRet[2]
		Endif
	Endif
Return ( .T. )




















Static Function AjustaSX1()

Local cPerg    := "MTR906"
Local aHelpPor :={}
Local aHelpEng :={}
Local aHelpSpa :={}

aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}


Aadd( aHelpPor, "Informe numero do livro a ser processado" )
Aadd( aHelpEng, "Ledger Book number                      " )
Aadd( aHelpSpa, "Numero del Libro Fiscal                 " )

PutSx1(cPerg, "05","Livro Selecionado","Livro Seleccionado"	,"Selected Book","mv_ch5","C",3,0,0,"G",  			, "   ","","","mv_par05"," "," "," ","","","","","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)


aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe se deseja imprimir os valores   " )
Aadd( aHelpPor, "por filial, apresentando um resumo ao   " )
Aadd( aHelpPor, "final com o total das movimentacoes     " )
Aadd( aHelpEng, "Informe se deseja imprimir os valores   " )
Aadd( aHelpEng, "por filial, apresentando um resumo ao   " )
Aadd( aHelpEng, "final com o total das movimentacoes     " )
Aadd( aHelpSpa, "Informe se deseja imprimir os valores   " )
Aadd( aHelpSpa, "por filial, apresentando um resumo ao   " )
Aadd( aHelpSpa, "final com o total das movimentacoes     " )
PutSx1(cPerg, "06","Processa Filiais ?","Processa Filiais ?","Processa Filiais ?","mv_ch6","N",1,0,0,"C",,"","","","mv_par06","Sim","Sim","Sim","","Nao","Nao","Nao","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)


aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe a filial inicial a ser          " )
Aadd( aHelpPor, "processada, caso deseje imprimir o      " )
Aadd( aHelpPor, "relatorio por filial.                   " )
Aadd( aHelpEng, "Informe a filial inicial a ser          " )
Aadd( aHelpEng, "processada, caso deseje imprimir o      " )
Aadd( aHelpEng, "relatorio por filial.                   " )
Aadd( aHelpSpa, "Informe a filial inicial a ser          " )
Aadd( aHelpSpa, "processada, caso deseje imprimir o      " )
Aadd( aHelpSpa, "relatorio por filial.                   " )
PutSx1(cPerg, "07","Da Filial ?","Da Filial ?","Da Filial ?","mv_ch7","C",2,0,0,"G",,"","","","mv_par07","","","","","","","","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)


aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe a filial final a ser            " )
Aadd( aHelpPor, "processada, caso deseje imprimir o      " )
Aadd( aHelpPor, "relatorio por filial.                   " )
Aadd( aHelpEng, "Informe a filial final a ser            " )
Aadd( aHelpEng, "processada, caso deseje imprimir o      " )
Aadd( aHelpEng, "relatorio por filial.                   " )
Aadd( aHelpSpa, "Informe a filial final a ser            " )
Aadd( aHelpSpa, "processada, caso deseje imprimir o      " )
Aadd( aHelpSpa, "relatorio por filial.                   " )
PutSx1(cPerg, "08","Ate Filial ?","Ate Filial ?","Ate Filial ?","mv_ch8","C",2,0,0,"G",,"","","","mv_par08","","","","","","","","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)


aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe se deseja imprimir os totais   " )
Aadd( aHelpPor, "por dia. " )
Aadd( aHelpEng, "Informe se deseja imprimir os totais   " )
Aadd( aHelpEng, "por dia. " )
Aadd( aHelpSpa, "Informe se deseja imprimir os totais   " )
Aadd( aHelpSpa, "por dia. " )
PutSx1(cPerg, "09","Total por Dia ?","Total por Dia ?","Total por Dia ?","mv_ch9","N",1,0,0,"C",,"","","","mv_par09","Sim","Sim","Sim","","Nao","Nao","Nao","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)


aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe se deseja detalhar os CFOPs    " )
Aadd( aHelpPor, "processados em cada aliquota           " )
Aadd( aHelpPor, "apresentada no relatório.              " )
Aadd( aHelpEng, "Informe se deseja detalhar os CFOPs    " )
Aadd( aHelpEng, "processados em cada aliquota           " )
Aadd( aHelpEng, "apresentada no relatório.              " )
Aadd( aHelpSpa, "Informe se deseja detalhar os CFOPs    " )
Aadd( aHelpSpa, "processados em cada aliquota           " )
Aadd( aHelpSpa, "apresentada no relatório.              " )
PutSx1(cPerg, "10","Detalha CFOP ?","Detalha CFOP","Detalha CFOP","mv_cha","N",1,0,2,"C",,"","","","mv_par10","Sim","Sim","Sim","","Nao","Nao","Nao","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)


aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe se deseja agrupar os itens     " )
Aadd( aHelpPor, "das notas fiscais ao emitir relatório  " )
Aadd( aHelpPor, "de forma analítica                     " )
Aadd( aHelpEng, "Informe se deseja agrupar os itens     " )
Aadd( aHelpEng, "das notas fiscais ao emitir relatório  " )
Aadd( aHelpEng, "de forma analítica                     " )
Aadd( aHelpSpa, "Informe se deseja agrupar os itens     " )
Aadd( aHelpSpa, "das notas fiscais ao emitir relatório  " )
Aadd( aHelpSpa, "de forma analítica                     " )
PutSx1(cPerg, "11","Resume as Notas Fiscais?","Resume as Notas Fiscais?","Resume as Notas Fiscais?","mv_chb","N",1,0,2,"C",,"","","","mv_par11","Sim","Sim","Sim","","Nao","Nao","Nao","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)

aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe se o relatório a ser processado" )
Aadd( aHelpPor, "é referente à apuração do PIS / COFINS " )
Aadd( aHelpPor, "Cumulativo / Não cumulativo.	        " )
Aadd( aHelpPor, "Sim = Cumulativo / Não cumulativo.	    " )
Aadd( aHelpPor, "Não Cumulativo = Apenas não cumulativo." )
Aadd( aHelpPor, "Não = Não Imprime." )
Aadd( aHelpEng, "Informe se o relatório a ser processado" )
Aadd( aHelpEng, "é referente à apuração do PIS / COFINS " )
Aadd( aHelpEng, "Cumulativo / Não cumulativo.           " )
Aadd( aHelpEng, "Sim = Cumulativo / Não cumulativo.	    " )
Aadd( aHelpEng, "Não Cumulativo = Apenas não cumulativo." )
Aadd( aHelpEng, "Não = Não Imprime." )
Aadd( aHelpSpa, "Informe se o relatório a ser processado" )
Aadd( aHelpSpa, "é referente à apuração do PIS / COFINS " )
Aadd( aHelpSpa, "Cumulativo / Não cumulativo.           " )
Aadd( aHelpSpa, "Sim = Cumulativo / Não cumulativo.	    " )
Aadd( aHelpSpa, "Não Cumulativo = Apenas não cumulativo." )
Aadd( aHelpSpa, "Não = Não Imprime." )
PutSx1(cPerg, "12","Imp. Cum/Não Cum?","Imp. Cum/Não Cum?","Imp. Cum/Não Cum?","mv_chc","N",1,0,3,"C",,"","","","mv_par12","Sim","Sim","Sim","","Não Cumulativo","Não Cumulativo","Não Cumulativo","Não","Não","Não","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)

aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe se o relatório a ser processado" )
Aadd( aHelpPor, "é referente à apuração do PIS / COFINS " )
Aadd( aHelpPor, "com Diferimento de Orgãos Públicos.    " )
Aadd( aHelpPor, "Sim = Diferimento Orgãos Públicos.	    " )
Aadd( aHelpPor, "Não = Apuração Normal." )

Aadd( aHelpEng, "Informe se o relatório a ser processado" )
Aadd( aHelpEng, "é referente à apuração do PIS / COFINS " )
Aadd( aHelpEng, "com Diferimento de Orgãos Públicos.    " )
Aadd( aHelpEng, "Sim = Diferimento Orgãos Públicos.	    " )
Aadd( aHelpEng, "Não = Apuração Normal." )

Aadd( aHelpSpa, "Informe se o relatório a ser processado" )
Aadd( aHelpSpa, "é referente à apuração do PIS / COFINS " )
Aadd( aHelpSpa, "com Diferimento de Orgãos Públicos.    " )
Aadd( aHelpSpa, "Sim = Diferimento Orgãos Públicos.	    " )
Aadd( aHelpSpa, "Não = Apuração Normal." )
PutSx1(cPerg, "13","Dif. Orgão Público?","Dif. Orgão Público?","Dif. Orgão Público?","mv_chd","N",1,0,2,"C",,"","","","mv_par13","Sim","Sim","Sim","","Não","Não","Não","","Não","Não","Não","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)


aHelpPor	:=	{}
aHelpEng	:=	{}
aHelpSpa	:=	{}
Aadd( aHelpPor, "Informe se o resumo utilizara quebra   " )
Aadd( aHelpPor, "por CFOP e Cliente/Fornecedor ou apenas" )
Aadd( aHelpPor, "por CFOP.								" )
Aadd( aHelpPor, "1 = CFOP e Clie/Forn					" )
Aadd( aHelpPor, "2 = CFOP								" )

Aadd( aHelpEng, "Informe se o resumo utilizara quebra   " )
Aadd( aHelpEng, "por CFOP e Cliente/Fornecedor ou apenas" )
Aadd( aHelpEng, "por CFOP.								" )
Aadd( aHelpEng, "1 = CFOP e Clie/Forn					" )
Aadd( aHelpEng, "2 = CFOP								" )

Aadd( aHelpSpa, "Informe se o resumo utilizara quebra   " )
Aadd( aHelpSpa, "por CFOP e Cliente/Fornecedor ou apenas" )
Aadd( aHelpSpa, "por CFOP.								" )
Aadd( aHelpSpa, "1 = CFOP e Clie/Forn					" )
Aadd( aHelpSpa, "2 = CFOP								" )

PutSx1(cPerg, "14","Quebra do Resumo","Quebra do Resumo","Quebra do Resumo","mv_che","N",1,0,1,"C",,"","","","mv_par14","1-CFOP+CliFor","1-CFOP+CliFor","1-CFOP+CliFor","","2-CFOP","2-CFOP","2-CFOP","","","","","","","",""," ",aHelpPor,aHelpEng,aHelpSpa)

Return